<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>غزة تلكوم</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Cairo', sans-serif;
            background: linear-gradient(135deg, #e0e7ff, #c7d2fe);
            color: #1e1e2d;
            min-height: 100vh;
            padding: 20px;
            overflow-x: hidden;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        .header {
            background: linear-gradient(135deg, #3b0764, #6b21a8);
            color: white;
            padding: 40px 20px;
            border-radius: 25px;
            text-align: center;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
            margin-bottom: 30px;
            position: relative;
            z-index: 1;
            border: 2px solid rgba(255, 255, 255, 0.15);
            overflow: hidden;
        }
        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.15), transparent);
            z-index: -1;
        }
        .header img {
            height: 100px;
            margin-bottom: 15px;
            filter: drop-shadow(0 3px 6px rgba(0, 0, 0, 0.4));
            transition: transform 0.3s ease;
            clip-path: polygon(10% 0%, 100% 0%, 90% 100%, 0% 100%);
        }
        .header img:hover {
            transform: scale(1.05);
        }
        .header h2 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: 700;
            text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.3);
        }
        .header h4 {
            font-size: 1.5rem;
            opacity: 0.9;
            font-weight: 400;
            letter-spacing: 1px;
        }
        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
            margin: 30px 0;
        }
        .card {
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: #1e1e2d;
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 12px 35px rgba(0, 0, 0, 0.15);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(145deg, rgba(59, 7, 100, 0.2), rgba(107, 33, 168, 0.2));
            z-index: -1;
        }
        .card:hover {
            transform: translateY(-10px) scale(1.03);
            box-shadow: 0 15px 45px rgba(0, 0, 0, 0.25);
        }
        .card i {
            font-size: 3rem;
            margin-bottom: 15px;
            color: #3b0764;
            transition: transform 0.3s ease;
        }
        .card:hover i {
            transform: scale(1.2);
        }
        .card h5 {
            font-size: 1.4rem;
            margin-bottom: 15px;
            font-weight: 700;
            color: #3b0764;
        }
        .card p {
            font-size: 1.2rem;
            font-weight: 600;
            color: #1e1e2d;
            margin: 8px 0;
        }
        .actions {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin: 30px 0;
            justify-content: center;
        }
        .btn {
            background: linear-gradient(90deg, #3b0764, #6b21a8);
            color: white;
            padding: 12px 25px;
            border-radius: 50px;
            border: none;
            font-size: 1rem;
            cursor: pointer;
            transition: transform 0.3s ease, background 0.3s ease, box-shadow 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
        }
        .btn:hover {
            background: linear-gradient(90deg, #6b21a8, #3b0764);
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
        }
        .search-container {
            margin-bottom: 30px;
            display: flex;
            justify-content: center;
            gap: 20px;
            flex-wrap: wrap;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            padding: 20px;
            border-radius: 20px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
        }
        .search-container .filter-group {
            display: flex;
            flex-direction: column;
            max-width: 200px;
        }
        .search-container label {
            font-size: 1rem;
            font-weight: 600;
            color: #3b0764;
            margin-bottom: 8px;
        }
        .search-container select, .search-container input {
            width: 100%;
            max-width: 200px;
            padding: 12px 20px;
            border-radius: 30px;
            border: none;
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            color: #1e1e2d;
            font-size: 1rem;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            transition: box-shadow 0.3s ease, background 0.3s ease;
        }
        .search-container select:focus, .search-container input:focus {
            outline: none;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2);
            background: rgba(255, 255, 255, 0.3);
        }
        .table-container {
            overflow-x: auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.15);
            padding: 20px;
            margin-bottom: 20px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            padding: 15px;
            text-align: center;
            border-bottom: 1px solid #e0e0e0;
        }
        th {
            background: linear-gradient(90deg, #3b0764, #6b21a8);
            color: white;
            font-weight: 700;
        }
        td {
            color: #1e1e2d;
        }
        tr {
            cursor: pointer;
            transition: background 0.2s ease;
        }
        tr:hover {
            background-color: #f3e8ff;
        }
        .action-btn {
            cursor: pointer;
            margin: 0 8px;
            font-size: 1.4rem;
            transition: color 0.3s ease;
        }
        .action-btn.edit:hover {
            color: #3b82f6;
        }
        .action-btn.delete:hover {
            color: #ef4444;
        }
        .modal-content {
            border-radius: 25px;
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.3);
            border: none;
            background: linear-gradient(145deg, #ffffff, #f3e8ff);
            animation: slideIn 0.3s ease-out;
        }
        @keyframes slideIn {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .modal-header {
            background: linear-gradient(90deg, #3b0764, #6b21a8);
            color: white;
            border-top-left-radius: 25px;
            border-top-right-radius: 25px;
            padding: 20px;
            position: relative;
            overflow: hidden;
        }
        .modal-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.15), transparent);
            z-index: -1;
        }
        .modal-title {
            font-size: 1.6rem;
            font-weight: 700;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .modal-body {
            padding: 30px;
            background: #fff;
            border-radius: 0;
        }
        .modal-body .form-label {
            font-weight: 600;
            color: #3b0764;
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 10px;
        }
        .modal-body .form-control, .modal-body .form-select {
            border-radius: 15px;
            border: 1px solid #ddd;
            padding: 12px;
            font-size: 1rem;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
            background: #f3e8ff;
        }
        .modal-body .form-control:focus, .modal-body .form-select:focus {
            border-color: #3b0764;
            box-shadow: 0 0 8px rgba(59, 7, 100, 0.4);
            background: #fff;
        }
        .modal-footer {
            padding: 20px;
            background: linear-gradient(145deg, #f8f9fa, #e9ecef);
            border-bottom-left-radius: 25px;
            border-bottom-right-radius: 25px;
            justify-content: center;
            gap: 15px;
        }
        .modal-footer .btn {
            background: linear-gradient(90deg, #3b0764, #6b21a8);
            color: white;
            border-radius: 50px;
            padding: 12px 30px;
            font-size: 1rem;
            font-weight: 600;
            transition: background 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
        }
        .modal-footer .btn:hover {
            background: linear-gradient(90deg, #6b21a8, #3b0764);
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
        }
        .modal-footer .btn-secondary {
            background: linear-gradient(90deg, #6b7280, #4b5563);
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
        }
        .modal-footer .btn-secondary:hover {
            background: linear-gradient(90deg, #4b5563, #374151);
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
        }
        @media (max-width: 768px) {
            .header { padding: 30px 15px; border-radius: 15px; }
            .header img { height: 80px; }
            .header h2 { font-size: 2rem; }
            .header h4 { font-size: 1.2rem; }
            .dashboard { grid-template-columns: 1fr; }
            .card p { font-size: 1.1rem; }
            .btn { padding: 10px 20px; font-size: 0.9rem; }
            .search-container { padding: 15px; }
            .search-container .filter-group { width: 100%; max-width: 100%; }
            th, td { padding: 12px; font-size: 0.9rem; }
            .modal-title { font-size: 1.4rem; }
            .modal-body { padding: 20px; }
        }
        .swal2-popup {
            font-family: 'Cairo', sans-serif !important;
            border-radius: 20px !important;
        }
        .swal2-title {
            color: #3b0764 !important;
            font-weight: 700 !important;
        }
        .swal2-html-container {
            text-align: right !important;
            color: #1e1e2d !important;
        }
        .swal2-confirm {
            background: linear-gradient(90deg, #3b0764, #6b21a8) !important;
            border-radius: 50px !important;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2) !important;
        }
        .swal2-cancel {
            background: linear-gradient(90deg, #6b7280, #4b5563) !important;
            border-radius: 50px !important;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2) !important;
        }
        #qrCanvas { display: none; }
        #scannerContainer { text-align: center; margin: 20px 0; }
        #scannerVideo { max-width: 100%; border-radius: 15px; border: 2px solid #3b0764; }
        .scanner-buttons { display: flex; justify-content: center; gap: 15px; margin-top: 15px; }
        .swal2-actions { justify-content: center !important; gap: 15px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <img src="gaza_logo.png" alt="شعار غزة تلكوم">
            <h2>غزة تلكوم</h2>
            <h4>إدارة المعاملات المالية</h4>
        </div>
        <div class="dashboard">
            <div class="card">
                <i class="fas fa-arrow-down"></i>
                <h5>الصادر</h5>
                <p>مجموع الصادر: <span id="totalOut">0</span></p>
                <p>عدد الصادر: <span id="countOut">0</span></p>
                <p>مجموع فوائد الصادر: <span id="interestOut">0</span></p>
            </div>
            <div class="card">
                <i class="fas fa-arrow-up"></i>
                <h5>الوارد</h5>
                <p>مجموع الوارد: <span id="totalIn">0</span></p>
                <p>عدد الوارد: <span id="countIn">0</span></p>
                <p>مجموع فوائد الوارد: <span id="interestIn">0</span></p>
            </div>
            <div class="card">
                <i class="fas fa-wallet"></i>
                <h5>النهائي</h5>
                <p>النهائي 1: <span id="finalBalance">0</span></p>
                <p>النهائي 2: <span id="finalBalance2">0</span></p>
                <p>مجموع الفوائد: <span id="totalInterest">0</span></p>
            </div>
        </div>
        <div class="actions">
            <button class="btn" data-bs-toggle="modal" data-bs-target="#addTransactionModal"><i class="fas fa-plus"></i> إضافة معاملة</button>
            <button class="btn" onclick="exportToJSON()"><i class="fas fa-file-code"></i> تصدير إلى JSON</button>
            <button class="btn" onclick="exportToCSV()"><i class="fas fa-file-csv"></i> تصدير إلى CSV</button>
            <button class="btn" onclick="exportToPDF()"><i class="fas fa-file-pdf"></i> تصدير إلى PDF</button>
            <input type="file" id="importFile" accept=".json,.csv" style="display: none;" onchange="importFile(event)">
            <button class="btn" onclick="document.getElementById('importFile').click()"><i class="fas fa-file-import"></i> استيراد ملف</button>
            <button class="btn" onclick="generateQRCode()"><i class="fas fa-qrcode"></i> إنشاء QR Code</button>
            <button class="btn" onclick="startQRScanner()"><i class="fas fa-camera"></i> استقبال QR Code</button>
            <button class="btn" onclick="printTable()"><i class="fas fa-print"></i> طباعة</button>
            <button class="btn" onclick="showReport('weekly')"><i class="fas fa-chart-bar"></i> تقرير أسبوعي</button>
            <button class="btn" onclick="showReport('monthly')"><i class="fas fa-chart-line"></i> تقرير شهري</button>
            <button class="btn" onclick="showReport('yearly')"><i class="fas fa-chart-area"></i> تقرير سنوي</button>
        </div>
        <div class="search-container">
            <div class="filter-group">
                <label for="filterType">نوع التصفية</label>
                <select id="filterType" onchange="updateFilterInputs()">
                    <option value="today">اليوم</option>
                    <option value="yesterday">الأمس</option>
                    <option value="specific">تاريخ محدد</option>
                    <option value="range">بين تاريخين</option>
                </select>
            </div>
            <div class="filter-group" id="specificDateGroup" style="display: none;">
                <label for="specificDate">اختيار تاريخ</label>
                <input type="date" id="specificDate" onchange="filterTable()">
            </div>
            <div class="filter-group" id="startDateGroup" style="display: none;">
                <label for="startDate">من التاريخ</label>
                <input type="date" id="startDate" onchange="filterTable()">
            </div>
            <div class="filter-group" id="endDateGroup" style="display: none;">
                <label for="endDate">إلى التاريخ</label>
                <input type="date" id="endDate" onchange="filterTable()">
            </div>
            <div class="filter-group">
                <label for="typeFilter">نوع المعاملة</label>
                <select id="typeFilter" onchange="filterTable()">
                    <option value="all">الكل</option>
                    <option value="in">وارد</option>
                    <option value="out">صادر</option>
                </select>
            </div>
        </div>
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>#</th>
                        <th>الرقم التسلسلي</th>
                        <th>نوع المعاملة</th>
                        <th>التاريخ والوقت</th>
                        <th>المبلغ</th>
                        <th>الفائدة</th>
                        <th>الملاحظة</th>
                        <th>الإجراءات</th>
                    </tr>
                </thead>
                <tbody id="transactionsTable"></tbody>
            </table>
        </div>
        <canvas id="qrCanvas" style="display: none;"></canvas>
        <input type="file" id="qrImageInput" accept="image/*" style="display: none;" onchange="importQRFromImage(event)">
    </div>

    <!-- نافذة إضافة معاملة -->
    <div class="modal fade" id="addTransactionModal" tabindex="-1" aria-labelledby="addTransactionModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addTransactionModalLabel"><i class="fas fa-plus"></i> إضافة معاملة جديدة</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="addTransactionForm">
                        <div class="mb-3">
                            <label for="serialNumber" class="form-label"><i class="fas fa-barcode"></i> الرقم التسلسلي</label>
                            <input type="text" class="form-control" id="serialNumber" required>
                        </div>
                        <div class="mb-3">
                            <label for="type" class="form-label"><i class="fas fa-exchange-alt"></i> نوع المعاملة</label>
                            <select class="form-select" id="type" required>
                                <option value="in">وارد</option>
                                <option value="out">صادر</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="datetime" class="form-label"><i class="fas fa-calendar"></i> التاريخ والوقت</label>
                            <input type="datetime-local" class="form-control" id="datetime">
                        </div>
                        <div class="mb-3">
                            <label for="amount" class="form-label"><i class="fas fa-money-bill"></i> المبلغ</label>
                            <input type="number" class="form-control" id="amount" step="0.01" min="0" required>
                        </div>
                        <div class="mb-3">
                            <label for="interest" class="form-label"><i class="fas fa-percentage"></i> الفائدة</label>
                            <input type="number" class="form-control" id="interest" step="0.01" min="0">
                        </div>
                        <div class="mb-3">
                            <label for="note" class="form-label"><i class="fas fa-comment"></i> ملاحظة</label>
                            <input type="text" class="form-control" id="note">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
                    <button type="button" class="btn" onclick="addTransaction()">حفظ</button>
                </div>
            </div>
        </div>
    </div>

    <!-- نافذة تعديل معاملة -->
    <div class="modal fade" id="editTransactionModal" tabindex="-1" aria-labelledby="editTransactionModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editTransactionModalLabel"><i class="fas fa-edit"></i> تعديل معاملة</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="editTransactionForm">
                        <input type="hidden" id="editId">
                        <div class="mb-3">
                            <label for="editSerialNumber" class="form-label",><i class="fas fa-barcode"></i> الرقم التسلسلي</label>
                            <input type="text" class="form-control" id="editSerialNumber" required>
                        </div>
                        <div class="mb-3">
                            <label for="editType" class="form-label"><i class="fas fa-exchange-alt"></i> نوع المعاملة</label>
                            <select class="form-select" id="editType" required>
                                <option value="in">وارد</option>
                                <option value="out">صادر</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="editDatetime" class="form-label"><i class="fas fa-calendar"></i> التاريخ والوقت</label>
                            <input type="datetime-local" class="form-control" id="editDatetime">
                        </div>
                        <div class="mb-3">
                            <label for="editAmount" class="form-label"><i class="fas fa-money-bill"></i> المبلغ</label>
                            <input type="number" class="form-control" id="editAmount" step="0.01" min="0" required>
                        </div>
                        <div class="mb-3">
                            <label for="editInterest" class="form-label"><i class="fas fa-percentage"></i> الفائدة</label>
                            <input type="number" class="form-control" id="editInterest" step="0.01" min="0">
                        </div>
                        <div class="mb-3">
                            <label for="editNote" class="form-label"><i class="fas fa-comment"></i> ملاحظة</label>
                            <input type="text" class="form-control" id="editNote">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
                    <button type="button" class="btn" onclick="updateTransaction()">حفظ</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let transactions = [];
        let db;
        let stream = null;

        // إعداد IndexedDB
        const request = indexedDB.open('GazaTelecomDB', 1);
        request.onupgradeneeded = function(event) {
            db = event.target.result;
            const transactionStore = db.createObjectStore('transactions', { keyPath: 'id', autoIncrement: true });
            transactionStore.createIndex('serialNumber', 'serialNumber', { unique: true });
            transactionStore.createIndex('datetime', 'datetime');
            transactionStore.createIndex('type', 'type');
        };
        request.onsuccess = function(event) {
            db = event.target.result;
            loadTransactions();
            setDefaultFilter();
        };
        request.onerror = function(event) {
            Swal.fire({
                title: 'خطأ',
                text: 'فشل في فتح قاعدة البيانات!',
                icon: 'error',
                confirmButtonColor: '#3b0764'
            });
        };

        function formatDateTime(date) {
            return date.toLocaleString('en-US', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: false
            }).replace(/(\d+)\/(\d+)\/(\d+), (\d+):(\d+):(\d+)/, '$3-$1-$2 $4:$5:$6');
        }

        function loadTransactions() {
            const transaction = db.transaction(['transactions'], 'readonly');
            const store = transaction.objectStore('transactions');
            const request = store.getAll();
            request.onsuccess = function(event) {
                transactions = event.target.result;
                sortTransactionsByDate();
                filterTable();
            };
            request.onerror = function(event) {
                Swal.fire({
                    title: 'خطأ',
                    text: 'فشل في تحميل المعاملات!',
                    icon: 'error',
                    confirmButtonColor: '#3b0764'
                });
            };
        }

        function sortTransactionsByDate() {
            transactions.sort((a, b) => new Date(b.datetime) - new Date(a.datetime));
        }

        function setDefaultFilter() {
            document.getElementById('filterType').value = 'today';
            updateFilterInputs();
            filterTable();
        }

        function updateFilterInputs() {
            const filterType = document.getElementById('filterType').value;
            document.getElementById('specificDateGroup').style.display = filterType === 'specific' ? 'block' : 'none';
            document.getElementById('startDateGroup').style.display = filterType === 'range' ? 'block' : 'none';
            document.getElementById('endDateGroup').style.display = filterType === 'range' ? 'block' : 'none';
            filterTable();
        }

        function updateDashboard(filteredTransactions) {
            const inTransactions = filteredTransactions.filter(t => t.type === 'in');
            const outTransactions = filteredTransactions.filter(t => t.type === 'out');
            const totalIn = inTransactions.reduce((sum, t) => sum + parseFloat(t.amount), 0);
            const totalOut = outTransactions.reduce((sum, t) => sum + parseFloat(t.amount), 0);
            const interestIn = inTransactions.reduce((sum, t) => sum + (parseFloat(t.interest) || 0), 0);
            const interestOut = outTransactions.reduce((sum, t) => sum + (parseFloat(t.interest) || 0), 0);
            const finalBalance = totalOut - totalIn;
            const finalBalance2 = finalBalance * 10;
            const totalInterest = interestIn + interestOut;

            document.getElementById('totalIn').innerText = totalIn.toFixed(2);
            document.getElementById('countIn').innerText = inTransactions.length;
            document.getElementById('interestIn').innerText = interestIn.toFixed(2);
            document.getElementById('totalOut').innerText = totalOut.toFixed(2);
            document.getElementById('countOut').innerText = outTransactions.length;
            document.getElementById('interestOut').innerText = interestOut.toFixed(2);
            document.getElementById('finalBalance').innerText = finalBalance.toFixed(2);
            document.getElementById('finalBalance2').innerText = finalBalance2.toFixed(2);
            document.getElementById('totalInterest').innerText = totalInterest.toFixed(2);
        }

        function filterTable() {
            const filterType = document.getElementById('filterType').value;
            const specificDate = document.getElementById('specificDate').value;
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            const typeFilter = document.getElementById('typeFilter').value;

            let today = new Date();
            let start, end;

            if (filterType === 'today') {
                start = end = today.toISOString().split('T')[0];
            } else if (filterType === 'yesterday') {
                let yesterday = new Date(today);
                yesterday.setDate(today.getDate() - 1);
                start = end = yesterday.toISOString().split('T')[0];
            } else if (filterType === 'specific') {
                start = end = specificDate;
            } else if (filterType === 'range') {
                start = startDate;
                end = endDate;
            }

            const tableBody = document.getElementById('transactionsTable');
            tableBody.innerHTML = '';
            sortTransactionsByDate();

            const filteredTransactions = transactions.filter(transaction => {
                const transactionDate = transaction.datetime.split(' ')[0];
                const matchesDate = (
                    (!start || transactionDate >= start) &&
                    (!end || transactionDate <= end)
                );
                const matchesType = (
                    typeFilter === 'all' ||
                    (typeFilter === 'in' && transaction.type === 'in') ||
                    (typeFilter === 'out' && transaction.type === 'out')
                );
                return matchesDate && matchesType;
            });

            filteredTransactions.forEach((transaction, index) => {
                const row = document.createElement('tr');
                row.setAttribute('data-id', transaction.id);
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${transaction.serialNumber}</td>
                    <td>${transaction.type === 'in' ? 'وارد' : 'صادر'}</td>
                    <td>${transaction.datetime}</td>
                    <td>${transaction.amount}</td>
                    <td>${transaction.interest || '-'}</td>
                    <td>${transaction.note || '-'}</td>
                    <td>
                        <i class="fas fa-edit action-btn edit" onclick="editTransaction(${transaction.id});event.stopPropagation();"></i>
                        <i class="fas fa-trash action-btn delete" onclick="deleteTransaction(${transaction.id});event.stopPropagation();"></i>
                    </td>
                `;
                row.addEventListener('click', () => showTransactionDetails(transaction.id));
                tableBody.appendChild(row);
            });

            updateDashboard(filteredTransactions);
        }

        function showTransactionDetails(id) {
            const transaction = db.transaction(['transactions'], 'readonly');
            const store = transaction.objectStore('transactions');
            const request = store.get(id);
            request.onsuccess = function(event) {
                const t = event.target.result;
                Swal.fire({
                    title: 'تفاصيل المعاملة',
                    html: `
                        <div style="text-align: right; font-family: 'Cairo', sans-serif; color: #3b0764;">
                            <p><strong>الرقم التسلسلي:</strong> ${t.serialNumber}</p>
                            <p><strong>نوع المعاملة:</strong> ${t.type === 'in' ? 'وارد' : 'صادر'}</p>
                            <p><strong>التاريخ والوقت:</strong> ${t.datetime}</p>
                            <p><strong>المبلغ:</strong> ${t.amount}</p>
                            <p><strong>الفائدة:</strong> ${t.interest || '-'}</p>
                            <p><strong>الملاحظة:</strong> ${t.note || '-'}</p>
                        </div>
                    `,
                    icon: 'info',
                    confirmButtonText: 'إغلاق',
                    confirmButtonColor: '#3b0764',
                    customClass: { popup: 'swal2-rtl' }
                });
            };
        }

        function addTransaction() {
            const serialNumber = document.getElementById('serialNumber').value.trim();
            const type = document.getElementById('type').value;
            const datetime = document.getElementById('datetime').value;
            const amount = document.getElementById('amount').value;
            const interest = document.getElementById('interest').value;
            const note = document.getElementById('note').value.trim();

            if (!serialNumber || !type || !datetime || !amount) {
                Swal.fire({
                    title: 'خطأ في الإدخال',
                    text: 'الرجاء ملء جميع الحقول المطلوبة!',
                    icon: 'error',
                    confirmButtonColor: '#3b0764'
                });
                return;
            }

            const transaction = db.transaction(['transactions'], 'readwrite');
            const store = transaction.objectStore('transactions');
            const index = store.index('serialNumber');
            const request = index.get(serialNumber);
            request.onsuccess = function(event) {
                if (event.target.result) {
                    Swal.fire({
                        title: 'خطأ',
                        text: 'الرقم التسلسلي موجود مسبقًا!',
                        icon: 'error',
                        confirmButtonColor: '#3b0764'
                    });
                    return;
                }

                store.add({
                    serialNumber,
                    type,
                    datetime: datetime.replace('T', ' '),
                    amount,
                    interest: interest || null,
                    note: note || null
                });
                transaction.oncomplete = function() {
                    loadTransactions();
                    bootstrap.Modal.getInstance(document.getElementById('addTransactionModal')).hide();
                    document.getElementById('addTransactionForm').reset();
                    setCurrentDateTime();
                    Swal.fire({
                        title: 'نجاح',
                        text: 'تم إضافة المعاملة بنجاح!',
                        icon: 'success',
                        confirmButtonColor: '#3b0764'
                    });
                };
            };
        }

        function editTransaction(id) {
            const transaction = db.transaction(['transactions'], 'readonly');
            const store = transaction.objectStore('transactions');
            const request = store.get(id);
            request.onsuccess = function(event) {
                const t = event.target.result;
                document.getElementById('editId').value = t.id;
                document.getElementById('editSerialNumber').value = t.serialNumber;
                document.getElementById('editType').value = t.type;
                document.getElementById('editDatetime').value = t.datetime.replace(' ', 'T');
                document.getElementById('editAmount').value = t.amount;
                document.getElementById('editInterest').value = t.interest || '';
                document.getElementById('editNote').value = t.note || '';
                new bootstrap.Modal(document.getElementById('editTransactionModal')).show();
            };
        }

        function updateTransaction() {
            const id = parseInt(document.getElementById('editId').value);
            const serialNumber = document.getElementById('editSerialNumber').value.trim();
            const type = document.getElementById('editType').value;
            const datetime = document.getElementById('editDatetime').value;
            const amount = document.getElementById('editAmount').value;
            const interest = document.getElementById('editInterest').value;
            const note = document.getElementById('editNote').value.trim();

            if (!serialNumber || !type || !datetime || !amount) {
                Swal.fire({
                    title: 'خطأ في الإدخال',
                    text: 'الرجاء ملء جميع الحقول المطلوبة!',
                    icon: 'error',
                    confirmButtonColor: '#3b0764'
                });
                return;
            }

            const transaction = db.transaction(['transactions'], 'readwrite');
            const store = transaction.objectStore('transactions');
            const index = store.index('serialNumber');
            const request = index.get(serialNumber);
            request.onsuccess = function(event) {
                const existing = event.target.result;
                if (existing && existing.id !== id) {
                    Swal.fire({
                        title: 'خطأ',
                        text: 'الرقم التسلسلي موجود مسبقًا!',
                        icon: 'error',
                        confirmButtonColor: '#3b0764'
                    });
                    return;
                }

                store.put({
                    id,
                    serialNumber,
                    type,
                    datetime: datetime.replace('T', ' '),
                    amount,
                    interest: interest || null,
                    note: note || null
                });
                transaction.oncomplete = function() {
                    loadTransactions();
                    bootstrap.Modal.getInstance(document.getElementById('editTransactionModal')).hide();
                    Swal.fire({
                        title: 'نجاح',
                        text: 'تم تعديل المعاملة بنجاح!',
                        icon: 'success',
                        confirmButtonColor: '#3b0764'
                    });
                };
            };
        }

        function deleteTransaction(id) {
            Swal.fire({
                title: 'تأكيد الحذف',
                text: 'هل أنت متأكد من حذف هذه المعاملة؟',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'حذف',
                cancelButtonText: 'إلغاء',
                confirmButtonColor: '#ef4444',
                cancelButtonColor: '#6b7280'
            }).then((result) => {
                if (result.isConfirmed) {
                    const transaction = db.transaction(['transactions'], 'readwrite');
                    const store = transaction.objectStore('transactions');
                    store.delete(id);
                    transaction.oncomplete = function() {
                        loadTransactions();
                        Swal.fire({
                            title: 'نجاح',
                            text: 'تم حذف المعاملة بنجاح!',
                            icon: 'success',
                            confirmButtonColor: '#3b0764'
                        });
                    };
                }
            });
        }

        function exportToJSON() {
            const dataStr = JSON.stringify(transactions, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'gaza_transactions.json';
            a.click();
            URL.revokeObjectURL(url);
            Swal.fire({
                title: 'نجاح',
                text: 'تم تصدير البيانات إلى ملف JSON بنجاح!',
                icon: 'success',
                confirmButtonColor: '#3b0764'
            });
        }

        function exportToCSV() {
            const headers = ['الرقم التسلسلي,نوع المعاملة,التاريخ والوقت,المبلغ,الفائدة,الملاحظة'];
            const rows = transactions.map(t => `${t.serialNumber},${t.type === 'in' ? 'وارد' : 'صادر'},${t.datetime},${t.amount},${t.interest || ''},${t.note || ''}`);
            const csv = [headers, ...rows].join('\n');
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'gaza_transactions.csv';
            a.click();
            URL.revokeObjectURL(url);
            Swal.fire({
                title: 'نجاح',
                text: 'تم تصدير البيانات إلى ملف CSV بنجاح!',
                icon: 'success',
                confirmButtonColor: '#3b0764'
            });
        }

        function exportToPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({
                orientation: 'portrait',
                unit: 'mm',
                format: 'a4'
            });
            doc.setFont('Cairo');
            doc.setFontSize(16);
            doc.text('تقرير غزة تلكوم', 105, 20, { align: 'center' });
            doc.setFontSize(12);
            doc.text(`تاريخ الطباعة: ${new Date().toLocaleDateString('ar-SA')}`, 105, 30, { align: 'center' });

            doc.text(`النهائي 1: ${document.getElementById('finalBalance').innerText}`, 105, 40, { align: 'center' });
            doc.text(`النهائي 2: ${document.getElementById('finalBalance2').innerText}`, 105, 50, { align: 'center' });
            doc.text(`مجموع الوارد: ${document.getElementById('totalIn').innerText}`, 105, 60, { align: 'center' });
            doc.text(`مجموع الصادر: ${document.getElementById('totalOut').innerText}`, 105, 70, { align: 'center' });
            doc.text(`مجموع الفوائد: ${document.getElementById('totalInterest').innerText}`, 105, 80, { align: 'center' });

            doc.autoTable({
                startY: 90,
                head: [['#', 'الرقم التسلسلي', 'نوع المعاملة', 'التاريخ والوقت', 'المبلغ', 'الفائدة', 'الملاحظة']],
                body: transactions.map((t, i) => [
                    i + 1,
                    t.serialNumber,
                    t.type === 'in' ? 'وارد' : 'صادر',
                    t.datetime,
                    t.amount,
                    t.interest || '-',
                    t.note || '-'
                ]),
                styles: { font: 'Cairo', halign: 'center', cellPadding: 3 },
                headStyles: { fillColor: [59, 7, 100], textColor: [255, 255, 255] },
                alternateRowStyles: { fillColor: [243, 232, 255] },
                margin: { top: 90 }
            });

            doc.save('gaza_telecom_report.pdf');
            Swal.fire({
                title: 'نجاح',
                text: 'تم تصدير البيانات إلى ملف PDF بنجاح!',
                icon: 'success',
                confirmButtonColor: '#3b0764'
            });
        }

        function importFile(event) {
            const file = event.target.files[0];
            const reader = new FileReader();
            reader.onload = function(e) {
                let newTransactions = [];
                if (file.name.endsWith('.json')) {
                    newTransactions = JSON.parse(e.target.result);
                } else if (file.name.endsWith('.csv')) {
                    const data = e.target.result;
                    const rows = data.split('\n').slice(1).filter(row => row.trim());
                    newTransactions = rows.map(row => {
                        const [serialNumber, type, datetime, amount, interest, note] = row.split(',');
                        return {
                            serialNumber,
                            type: type === 'وارد' ? 'in' : 'out',
                            datetime,
                            amount: parseFloat(amount).toFixed(2),
                            interest: interest ? parseFloat(interest).toFixed(2) : null,
                            note: note || null
                        };
                    });
                }

                const invalidTransactions = newTransactions.filter(t => 
                    !t.serialNumber || !t.type || !t.datetime || !t.amount || isNaN(parseFloat(t.amount)) || parseFloat(t.amount) < 0
                );
                if (invalidTransactions.length > 0) {
                    Swal.fire({
                        title: 'خطأ في البيانات',
                        text: 'تم العثور على معاملات غير صالحة في الملف.',
                        icon: 'error',
                        confirmButtonColor: '#3b0764'
                    });
                    return;
                }

                const transaction = db.transaction(['transactions'], 'readwrite');
                const store = transaction.objectStore('transactions');
                const index = store.index('serialNumber');
                for (const t of newTransactions) {
                    const request = index.get(t.serialNumber);
                    request.onsuccess = function(event) {
                        if (event.target.result) {
                            Swal.fire({
                                title: 'خطأ',
                                text: `الرقم التسلسلي "${t.serialNumber}" موجود مسبقًا!`,
                                icon: 'error',
                                confirmButtonColor: '#3b0764'
                            });
                            return;
                        }
                        store.add(t);
                    };
                }
                transaction.oncomplete = function() {
                    loadTransactions();
                    Swal.fire({
                        title: 'نجاح',
                        text: 'تم استيراد البيانات بنجاح!',
                        icon: 'success',
                        confirmButtonColor: '#3b0764'
                    });
                };
            };
            if (file.name.endsWith('.json') || file.name.endsWith('.csv')) {
                reader.readAsText(file);
            } else {
                Swal.fire({
                    title: 'خطأ',
                    text: 'الرجاء تحميل ملف بصيغة JSON أو CSV!',
                    icon: 'error',
                    confirmButtonColor: '#3b0764'
                });
            }
        }

        function generateQRCode() {
            const dataString = JSON.stringify(transactions);
            const qrCanvas = document.getElementById('qrCanvas');
            QRCode.toCanvas(qrCanvas, dataString, { width: 300, margin: 2 }, (error) => {
                if (error) {
                    Swal.fire({
                        title: 'خطأ',
                        text: 'فشل في إنشاء رمز QR!',
                        icon: 'error',
                        confirmButtonColor: '#3b0764'
                    });
                    return;
                }
                Swal.fire({
                    title: 'رمز QR جاهز',
                    html: `
                        <canvas id="tempQRCanvas"></canvas>
                        <p>امسح هذا الرمز من جهاز آخر لنقل البيانات</p>
                        <div class="scanner-buttons">
                            <button class="btn" onclick="exportQRCode()">تصدير كصورة</button>
                        </div>
                    `,
                    showCancelButton: true,
                    confirmButtonText: 'إغلاق',
                    cancelButtonText: 'إلغاء',
                    confirmButtonColor: '#3b0764',
                    cancelButtonColor: '#6b7280',
                    customClass: { popup: 'swal2-rtl' },
                    width: '500px',
                    didOpen: () => {
                        const tempCanvas = document.getElementById('tempQRCanvas');
                        tempCanvas.width = qrCanvas.width;
                        tempCanvas.height = qrCanvas.height;
                        tempCanvas.getContext('2d').drawImage(qrCanvas, 0, 0);
                    }
                });
            });
        }

        function exportQRCode() {
            const qrCanvas = document.getElementById('qrCanvas');
            const dataURL = qrCanvas.toDataURL('image/png');
            const a = document.createElement('a');
            a.href = dataURL;
            a.download = 'qrcode.png';
            a.click();
            Swal.fire({
                title: 'نجاح',
                text: 'تم تصدير رمز QR كصورة بنجاح!',
                icon: 'success',
                confirmButtonColor: '#3b0764'
            });
        }

        function startQRScanner() {
            Swal.fire({
                title: 'مسح رمز QR',
                html: `
                    <div id="scannerContainer">
                        <video id="scannerVideo" autoplay playsinline style="max-width: 100%; border-radius: 15px; border: 2px solid #3b0764;"></video>
                        <div class="scanner-buttons">
                            <button class="btn" onclick="stopQRScanner()">إيقاف المسح</button>
                            <button class="btn" onclick="document.getElementById('qrImageInput').click()">استيراد من صورة</button>
                        </div>
                    </div>
                `,
                showConfirmButton: false,
                showCancelButton: true,
                cancelButtonText: 'إغلاق',
                cancelButtonColor: '#6b7280',
                customClass: { popup: 'swal2-rtl' },
                width: '600px',
                didOpen: async () => {
                    try {
                        stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
                        const video = document.getElementById('scannerVideo');
                        video.srcObject = stream;
                        video.play();

                        const canvas = document.createElement('canvas');
                        const context = canvas.getContext('2d');

                        function scan() {
                            if (video.readyState === video.HAVE_ENOUGH_DATA) {
                                canvas.width = video.videoWidth;
                                canvas.height = video.videoHeight;
                                context.drawImage(video, 0, 0, canvas.width, canvas.height);
                                const imageData = context.getImageData(0, 0, canvas.width, canvas.height);
                                const code = jsQR(imageData.data, imageData.width, imageData.height, {
                                    inversionAttempts: 'dontInvert'
                                });

                                if (code) {
                                    stopQRScanner();
                                    Swal.close();
                                    try {
                                        const data = JSON.parse(code.data);
                                        processQRData(data);
                                    } catch (e) {
                                        Swal.fire({
                                            title: 'خطأ',
                                            text: 'البيانات في رمز QR غير صالحة!',
                                            icon: 'error',
                                            confirmButtonColor: '#3b0764'
                                        });
                                    }
                                    return;
                                }
                            }
                            requestAnimationFrame(scan);
                        }
                        requestAnimationFrame(scan);
                    } catch (error) {
                        Swal.fire({
                            title: 'خطأ',
                            text: 'فشل في الوصول إلى الكاميرا! تأكد من منح الأذونات.',
                            icon: 'error',
                            confirmButtonColor: '#3b0764'
                        });
                    }
                },
                willClose: () => {
                    stopQRScanner();
                }
            });
        }

        function stopQRScanner() {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                stream = null;
            }
            const scannerContainer = document.getElementById('scannerContainer');
            if (scannerContainer) {
                scannerContainer.style.display = 'none';
            }
            const scannerVideo = document.getElementById('scannerVideo');
            if (scannerVideo) {
                scannerVideo.srcObject = null;
            }
        }

        function processQRData(data) {
            const newTransactions = data;
            const invalidTransactions = newTransactions.filter(t =>
                !t.serialNumber || !t.type || !t.datetime || !t.amount || isNaN(parseFloat(t.amount)) || parseFloat(t.amount) < 0
            );
            if (invalidTransactions.length > 0) {
                Swal.fire({
                    title: 'خطأ في البيانات',
                    text: 'تم العثور على معاملات غير صالحة.',
                    icon: 'error',
                    confirmButtonColor: '#3b0764'
                });
                return;
            }

            const transaction = db.transaction(['transactions'], 'readwrite');
            const store = transaction.objectStore('transactions');
            const index = store.index('serialNumber');
            for (const t of newTransactions) {
                const request = index.get(t.serialNumber);
                request.onsuccess = function(event) {
                    if (event.target.result) {
                        Swal.fire({
                            title: 'خطأ',
                            text: `الرقم التسلسلي "${t.serialNumber}" موجود مسبقًا!`,
                            icon: 'error',
                            confirmButtonColor: '#3b0764'
                        });
                        return;
                    }
                    store.add(t);
                };
            }
            transaction.oncomplete = function() {
                loadTransactions();
                Swal.fire({
                    title: 'نجاح',
                    text: 'تم استيراد البيانات من رمز QR بنجاح!',
                    icon: 'success',
                    confirmButtonColor: '#3b0764'
                });
            };
        }

        function importQRFromImage(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.src = e.target.result;
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    canvas.width = img.width;
                    canvas.height = img.height;
                    const context = canvas.getContext('2d');
                    context.drawImage(img, 0, 0, img.width, img.height);
                    const imageData = context.getImageData(0, 0, img.width, img.height);
                    const code = jsQR(imageData.data, imageData.width, imageData.height, {
                        inversionAttempts: 'dontInvert'
                    });

                    if (code) {
                        stopQRScanner();
                        Swal.close();
                        try {
                            const data = JSON.parse(code.data);
                            processQRData(data);
                        } catch (e) {
                            Swal.fire({
                                title: 'خطأ',
                                text: 'البيانات في رمز QR غير صالحة!',
                                icon: 'error',
                                confirmButtonColor: '#3b0764'
                            });
                        }
                    } else {
                        Swal.fire({
                            title: 'خطأ',
                            text: 'لم يتم العثور على رمز QR في الصورة!',
                            icon: 'error',
                            confirmButtonColor: '#3b0764'
                        });
                    }
                };
            };
            reader.readAsDataURL(file);
        }

        function showReport(period) {
            const now = new Date();
            let startDate, endDate;

            if (period === 'weekly') {
                startDate = new Date(now.setDate(now.getDate() - now.getDay()));
                endDate = new Date(now.setDate(now.getDate() - now.getDay() + 6));
            } else if (period === 'monthly') {
                startDate = new Date(now.getFullYear(), now.getMonth(), 1);
                endDate = new Date(now.getFullYear(), now.getMonth() + 1, 0);
            } else if (period === 'yearly') {
                startDate = new Date(now.getFullYear(), 0, 1);
                endDate = new Date(now.getFullYear(), 11, 31);
            }

            startDate = startDate.toISOString().split('T')[0];
            endDate = endDate.toISOString().split('T')[0];

            const filteredTransactions = transactions.filter(t => {
                const transactionDate = t.datetime.split(' ')[0];
                return transactionDate >= startDate && transactionDate <= endDate;
            });

            const inTransactions = filteredTransactions.filter(t => t.type === 'in');
            const outTransactions = filteredTransactions.filter(t => t.type === 'out');
            const totalIn = inTransactions.reduce((sum, t) => sum + parseFloat(t.amount), 0);
            const totalOut = outTransactions.reduce((sum, t) => sum + parseFloat(t.amount), 0);
            const interestIn = inTransactions.reduce((sum, t) => sum + (parseFloat(t.interest) || 0), 0);
            const interestOut = outTransactions.reduce((sum, t) => sum + (parseFloat(t.interest) || 0), 0);
            const finalBalance = totalOut - totalIn;
            const finalBalance2 = finalBalance * 10;
            const totalInterest = interestIn + interestOut;

            let tableHTML = `
                <table style="width: 100%; border-collapse: collapse; font-family: 'Cairo', sans-serif; direction: rtl;">
                    <thead>
                        <tr style="background: linear-gradient(90deg, #3b0764, #6b21a8); color: white;">
                            <th style="padding: 10px; border: 1px solid #ddd;">#</th>
                            <th style="padding: 10px; border: 1px solid #ddd;">الرقم التسلسلي</th>
                            <th style="padding: 10px; border: 1px solid #ddd;">نوع المعاملة</th>
                            <th style="padding: 10px; border: 1px solid #ddd;">التاريخ والوقت</th>
                            <th style="padding: 10px; border: 1px solid #ddd;">المبلغ</th>
                            <th style="padding: 10px; border: 1px solid #ddd;">الفائدة</th>
                            <th style="padding: 10px; border: 1px solid #ddd;">الملاحظة</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            filteredTransactions.forEach((t, index) => {
                tableHTML += `
                    <tr>
                        <td style="padding: 10px; border: 1px solid #ddd;">${index + 1}</td>
                        <td style="padding: 10px; border: 1px solid #ddd;">${t.serialNumber}</td>
                        <td style="padding: 10px; border: 1px solid #ddd;">${t.type === 'in' ? 'وارد' : 'صادر'}</td>
                        <td style="padding: 10px; border: 1px solid #ddd;">${t.datetime}</td>
                        <td style="padding: 10px; border: 1px solid #ddd;">${t.amount}</td>
                        <td style="padding: 10px; border: 1px solid #ddd;">${t.interest || '-'}</td>
                        <td style="padding: 10px; border: 1px solid #ddd;">${t.note || '-'}</td>
                    </tr>
                `;
            });
            tableHTML += `
                    </tbody>
                </table>
            `;
            Swal.fire({
                title: `تقرير ${period === 'weekly' ? 'أسبوعي' : period === 'monthly' ? 'شهري' : 'سنوي'}`,
                html: `
                    <div style="text-align: right; font-family: 'Cairo', sans-serif; color: #3b0764;">
                        <p><strong>مجموع الوارد:</strong> ${totalIn.toFixed(2)}</p>
                        <p><strong>مجموع الصادر:</strong> ${totalOut.toFixed(2)}</p>
                        <p><strong>فوائد الوارد:</strong> ${interestIn.toFixed(2)}</p>
                        <p><strong>فوائد الصادر:</strong> ${interestOut.toFixed(2)}</p>
                        <p><strong>النهائي 1:</strong> ${finalBalance.toFixed(2)}</p>
                        <p><strong>النهائي 2:</strong> ${finalBalance2.toFixed(2)}</p>
                        <p><strong>مجموع الفوائد:</strong> ${totalInterest.toFixed(2)}</p>
                        ${tableHTML}
                    </div>
                `,
                icon: 'info',
                confirmButtonText: 'إغلاق',
                confirmButtonColor: '#3b0764',
                customClass: { popup: 'swal2-rtl' },
                width: '800px'
            });
        }

        function printTable() {
            const itemsPerPage = 20;
            const filterType = document.getElementById('filterType').value;
            const specificDate = document.getElementById('specificDate').value;
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            const typeFilter = document.getElementById('typeFilter').value;

            let today = new Date();
            let start, end;

            if (filterType === 'today') {
                start = end = today.toISOString().split('T')[0];
            } else if (filterType === 'yesterday') {
                let yesterday = new Date(today);
                yesterday.setDate(today.getDate() - 1);
                start = end = yesterday.toISOString().split('T')[0];
            } else if (filterType === 'specific') {
                start = end = specificDate;
            } else if (filterType === 'range') {
                start = startDate;
                end = endDate;
            }

            const filteredTransactions = transactions.filter(t => {
                const transactionDate = t.datetime.split(' ')[0];
                const matchesDate = (
                    (!start || transactionDate >= start) &&
                    (!end || transactionDate <= end)
                );
                const matchesType = (
                    typeFilter === 'all' ||
                    (typeFilter === 'in' && t.type === 'in') ||
                    (typeFilter === 'out' && t.type === 'out')
                );
                return matchesDate && matchesType;
            });

            const inTransactions = filteredTransactions.filter(t => t.type === 'in');
            const outTransactions = filteredTransactions.filter(t => t.type === 'out');
            const totalIn = inTransactions.reduce((sum, t) => sum + parseFloat(t.amount), 0);
            const totalOut = outTransactions.reduce((sum, t) => sum + parseFloat(t.amount), 0);
            const interestIn = inTransactions.reduce((sum, t) => sum + (parseFloat(t.interest) || 0), 0);
            const interestOut = outTransactions.reduce((sum, t) => sum + (parseFloat(t.interest) || 0), 0);
            const finalBalance = totalOut - totalIn;
            const finalBalance2 = finalBalance * 10;
            const totalInterest = interestIn + interestOut;

            const inPages = Math.ceil(inTransactions.length / itemsPerPage);
            const outPages = Math.ceil(outTransactions.length / itemsPerPage);
            const totalPages = Math.max(inPages, outPages);

            const printWindow = window.open('', '_blank', 'height=700,width=1000');
            printWindow.document.write(`
                <html>
                <head>
                    <title>تقرير غزة تلكوم</title>
                    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
                    <style>
                        @page { size: A4; margin: 10mm; }
                        body { font-family: 'Cairo', sans-serif; direction: rtl; margin: 10mm; background: #fff; color: #000; }
                        .container { max-width: 1000px; margin: 0 auto; }
                        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 1px solid #000; }
                        .header img { height: 70px; clip-path: polygon(10% 0%, 100% 0%, 90% 100%, 0% 100%); margin-right: 10px; }
                        .header h1 { font-size: 1.6rem; font-weight: 700; margin: 0; text-align: center; flex-grow: 1; color: #3b0764; }
                        .dashboard-container { display: flex; justify-content: space-between; gap: 20px; margin-bottom: 20px; }
                        .dashboard-section { flex: 1; border: 1px solid #000; padding: 15px; border-radius: 5px; background: #fff; text-align: center; }
                        .dashboard-section h4 { font-size: 1.2rem; font-weight: 700; margin: 0 0 10px; border-bottom: 1px solid #000; padding-bottom: 5px; color: #3b0764; }
                        .dashboard-section p { margin: 5px 0; font-size: 1rem; line-height: 1.5; font-weight: 600; }
                        .balance-container { text-align: center; margin: 20px 0; border: 1px solid #000; padding: 10px; border-radius: 5px; background: #fff; }
                        .balance-container h4 { font-size: 1.2rem; font-weight: 700; margin: 0 0 10px; color: #3b0764; }
                        .balance-container p { font-size: 1.1rem; font-weight: 600; margin: 0; }
                        h2 { text-align: center; font-size: 1.7rem; font-weight: 700; margin: 20px 0; border-bottom: 1px solid #000; padding-bottom: 5px; color: #3b0764; }
                        .transactions-count { text-align: center; font-size: 1.1rem; font-weight: 600; margin-bottom: 10px; color: #6b21a8; }
                        .print-date { text-align: center; font-size: 1.1rem; font-weight: 600; margin-bottom: 20px; color: #3b0764; }
                        table { width: 100%; border-collapse: collapse; margin: 20px 0; border: 1px solid #000; }
                        th, td { padding: 12px; text-align: center; border: 1px solid #000; font-size: 1rem; }
                        th { background: linear-gradient(90deg, #3b0764, #6b21a8); color: white; font-weight: 700; }
                        td { background: #fff; color: #000; }
                        .page-break { page-break-before: always; }
                        .page-number { text-align: center; font-size: 1rem; margin-top: 10px; color: #3b0764; }
                        .footer { text-align: center; font-size: 1rem; font-weight: 600; margin-top: 10px; position: running(footer); color: #3b0764; }
                        @media print { .footer { position: fixed; bottom: 10mm; width: 100%; } }
                    </style>
                </head>
                <body>
                    <div class="container">
                        <div class="header">
                            <img src="gaza_logo.png" alt="شعار غزة تلكوم" onerror="this.src='https://via.placeholder.com/70x70.png?text=Logo';">
                            <h1>غزة تلكوم - تقرير المعاملات</h1>
                        </div>
                        <div class="print-date">تاريخ الطباعة: ${new Date().toLocaleDateString('ar-SA')}</div>
                        <div class="dashboard-container">
                            <div class="dashboard-section">
                                <h4>الوارد</h4>
                                <p>مجموع الوارد: ${totalIn.toFixed(2)}</p>
                                <p>عدد الوارد: ${inTransactions.length}</p>
                                <p>فوائد الوارد: ${interestIn.toFixed(2)}</p>
                            </div>
                            <div class="dashboard-section">
                                <h4>الصادر</h4>
                                <p>مجموع الصادر: