<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>بيع المنتجات</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!-- QR Code Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode@2.0.9/dist/html5-qrcode.min.js"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Cairo', sans-serif;
            background: linear-gradient(135deg, #f0f2f5, #d9e2ec);
            color: #333;
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .home-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: linear-gradient(90deg, #3F2A56, #5a3f73);
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            text-decoration: none;
            font-size: 1rem;
            font-weight: 600;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            transition: transform 0.2s ease, background 0.3s ease, box-shadow 0.3s ease;
            position: absolute;
            top: 20px;
            left: 20px;
        }
        .home-btn:hover {
            background: linear-gradient(90deg, #5a3f73, #3F2A56);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
        }
        .header {
            background: linear-gradient(135deg, #3F2A56, #5a3f73);
            color: white;
            padding: 40px 20px;
            border-radius: 25px;
            text-align: center;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
            margin-bottom: 30px;
            position: relative;
            z-index: 1;
            border: 2px solid rgba(255, 255, 255, 0.1);
        }
        .header img {
            height: 90px;
            margin-bottom: 15px;
            filter: drop-shadow(0 3px 6px rgba(0, 0, 0, 0.3));
        }
        .header h2 {
            font-size: 2.2rem;
            margin-bottom: 10px;
            font-weight: 700;
        }
        .header h4 {
            font-size: 1.4rem;
            opacity: 0.9;
            font-weight: 400;
        }
        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        .card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: #3F2A56;
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            text-align: center;
            transition: transform 0.3s ease;
        }
        .card:hover {
            transform: translateY(-10px);
        }
        .card i {
            font-size: 2.8rem;
            margin-bottom: 15px;
            color: #3F2A56;
        }
        .card h5 {
            font-size: 1.3rem;
            margin-bottom: 10px;
            font-weight: 600;
        }
        .card h3 {
            font-size: 1.8rem;
            font-weight: 700;
        }
        .section {
            background: white;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
            padding: 20px;
            margin: 20px 0;
        }
        .section h3 {
            font-size: 1.7rem;
            font-weight: 700;
            color: #3F2A56;
            margin-bottom: 15px;
            text-align: center;
        }
        .table-container {
            overflow-x: auto;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            padding: 12px;
            text-align: center;
            border-bottom: 1px solid #e0e0e0;
        }
        th {
            background: linear-gradient(90deg, #3F2A56, #5a3f73);
            color: white;
            font-weight: 700;
        }
        td {
            color: #3F2A56;
        }
        tr:hover {
            background-color: #f7f9fc;
        }
        .actions {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin: 25px 0;
            justify-content: center;
        }
        .btn {
            background: linear-gradient(90deg, #3F2A56, #5a3f73);
            color: white;
            padding: 12px 24px;
            border-radius: 30px;
            border: none;
            font-size: 1rem;
            cursor: pointer;
            transition: transform 0.2s ease, background 0.3s ease, box-shadow 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .btn:hover {
            background: linear-gradient(90deg, #5a3f73, #3F2A56);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.2);
        }
        .search-container {
            margin-bottom: 20px;
            display: flex;
            justify-content: center;
            align-items: flex-end; /* Align items to bottom for button */
            gap: 15px;
            flex-wrap: wrap;
        }
        .filter-group {
            display: flex;
            flex-direction: column;
            max-width: 200px;
        }
        .filter-group label {
            font-size: 0.9rem;
            font-weight: 600;
            color: #3F2A56;
            margin-bottom: 5px;
        }
        .filter-group input, .filter-group select {
            padding: 12px;
            border-radius: 30px;
            border: none;
            background: rgba(255, 255, 255, 0.1);
            color: #3F2A56;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        .filter-group input:focus, .filter-group select:focus {
            outline: none;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2);
        }
        #scanQrBtn {
            padding: 10px 15px; /* Adjust padding */
            height: 46px; /* Match input height */
            border-radius: 30px;
        }
         #qr-reader-container {
            margin-top: 10px;
            border: 1px solid #ccc;
            border-radius: 10px;
            padding:10px;
            background-color: #f9f9f9;
        }
        #qr-reader {
            width: 100%;
            max-width: 400px; /* Adjust as needed */
            margin: 0 auto;
        }

        .action-btn {
            cursor: pointer;
            margin: 0 6px;
            font-size: 1.3rem;
            transition: color 0.3s ease;
        }
        .action-btn.edit:hover { color: #007bff; }
        /* .action-btn.delete:hover { color: #dc3545; } */ /* Delete button removed from UI */
        .action-btn.print:hover { color: #28a745; }

        .modal-content {
            border-radius: 20px;
            background: linear-gradient(145deg, #ffffff, #f7f9fc);
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }
        .modal-header {
            background: linear-gradient(90deg, #3F2A56, #5a3f73);
            color: white;
            border-top-left-radius: 20px;
            border-top-right-radius: 20px;
            padding: 20px;
        }
        .modal-title {
            font-size: 1.5rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .modal-body {
            padding: 30px;
        }
        .modal-body .form-label {
            font-weight: 600;
            color: #3F2A56;
        }
        .modal-body .form-control, .modal-body .form-select {
            border-radius: 15px;
            padding: 12px;
            background: #f7f9fc;
            border: 1px solid #ddd;
        }
         .modal-body .form-control:focus, .modal-body .form-select:focus {
            border-color: #3F2A56;
            box-shadow: 0 0 0 0.25rem rgba(63, 42, 86, 0.25);
        }
        .modal-footer {
            padding: 20px;
            background: #f8f9fa;
            border-bottom-left-radius: 20px;
            border-bottom-right-radius: 20px;
        }
        .modal-footer .btn {
            padding: 12px 30px;
        }
        .product-table th, .product-table td {
            padding: 8px;
        }
        .modal-body .product-table th { /* Change header text color in modal product tables */
            color: white;
             background: linear-gradient(90deg, #3F2A56, #5a3f73); /* Optional: match main table header */
        }
        .status-paid { color: #198754; font-weight: 700; }
        .status-partial { color: #ffc107; font-weight: 700; }
        .status-unpaid { color: #dc3545; font-weight: 700; }
        .swal2-popup {
            font-family: 'Cairo', sans-serif !important;
            border-radius: 15px !important;
        }
        .swal2-title { color: #3F2A56 !important; }
        .swal2-html-container { text-align: right !important; }
        .swal2-confirm {
            background: linear-gradient(90deg, #3F2A56, #5a3f73) !important;
            border-radius: 20px !important;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2) !important;
        }
        .swal2-cancel, .swال2-deny {
            background: linear-gradient(90deg, #6c757d, #5a6268) !important;
            border-radius: 20px !important;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2) !important;
        }
        #productSuggestions div, #editProductSuggestions div {
            padding: 8px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        #productSuggestions div:hover, #editProductSuggestions div:hover {
            background-color: #f0f0f0;
        }

        @media (max-width: 768px) {
            .header { padding: 25px 15px; }
            .header img { height: 70px; }
            .header h2 { font-size: 1.7rem; }
            .btn { padding: 10px 18px; font-size: 0.9rem; }
            th, td { padding: 10px; font-size: 0.9rem; }
            .modal-body { padding: 20px; }
            .search-container { flex-direction: column; align-items: stretch;}
            .filter-group { max-width: none; }
            #scanQrBtn { width: 100%; margin-top: 10px;}
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <img src="logo.png" alt="شعار طيبة المدينة تلكوم" onerror="this.src='https://via.placeholder.com/90?text=Logo'; this.style.display='none';">
            <h2>طيبة المدينة تلكوم</h2>
            <h4>بيع المنتجات</h4>
            <a href="home.html" class="home-btn"><i class="fas fa-home"></i> للرئيسية</a>
        </div>
        <div class="dashboard">
            <div class="card">
                <i class="fas fa-check-circle"></i>
                <h5>الفواتير المدفوعة</h5>
                <h3 id="paidInvoices">0</h3>
            </div>
            <div class="card">
                <i class="fas fa-exclamation-circle"></i>
                <h5>الفواتير المدفوعة جزئيًا</h5>
                <h3 id="partialInvoices">0</h3>
            </div>
            <div class="card">
                <i class="fas fa-times-circle"></i>
                <h5>الفواتير غير المدفوعة</h5>
                <h3 id="unpaidInvoices">0</h3>
            </div>
        </div>
        <div class="actions">
            <button class="btn" data-bs-toggle="modal" data-bs-target="#addInvoiceModal"><i class="fas fa-plus"></i> إضافة فاتورة</button>
            <button class="btn" data-bs-toggle="modal" data-bs-target="#addCustomerModal"><i class="fas fa-user-plus"></i> إضافة زبون</button>
            <button class="btn" data-bs-toggle="modal" data-bs-target="#customerStatementModal"><i class="fas fa-file-alt"></i> كشف حساب زبون</button>
        </div>
        <div class="section">
            <h3>الفواتير</h3>
            <div class="search-container">
                <div class="filter-group">
                    <label for="searchInput">البحث</label>
                    <input type="text" id="searchInput" placeholder="ابحث بالزبون أو معرف الفاتورة" oninput="filterTable()">
                </div>
                <button id="scanQrBtn" class="btn btn-info" title="مسح QR Code للبحث عن فاتورة"><i class="fas fa-qrcode"></i> مسح</button>
                <div class="filter-group">
                    <label for="statusFilter">حالة الفاتورة</label>
                    <select id="statusFilter" onchange="filterTable()">
                        <option value="all">الكل</option>
                        <option value="paid">مدفوع</option>
                        <option value="partial">مدفوع جزئيًا</option>
                        <option value="unpaid">لم يتم الدفع</option>
                    </select>
                </div>
            </div>
             <div id="qr-reader-container" style="display: none;">
                <div id="qr-reader"></div>
                <button id="closeScannerBtn" class="btn btn-sm btn-danger mt-2" style="display:block; margin: 0 auto;">إغلاق الماسح</button>
            </div>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>معرف الفاتورة</th>
                            <th>الزبون</th>
                            <th>رقم الهاتف</th>
                            <th>المبلغ الكلي</th>
                            <th>حالة الفاتورة</th>
                            <th>الإجراءات</th>
                        </tr>
                    </thead>
                    <tbody id="invoicesTable"></tbody>
                </table>
            </div>
        </div>
        <div class="section">
            <h3>إدارة الزبائن</h3>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>الاسم</th>
                            <th>رقم الهاتف</th>
                            <th>العنوان</th>
                            <th>الإجراءات</th>
                        </tr>
                    </thead>
                    <tbody id="customersTable"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- نافذة إضافة فاتورة -->
    <div class="modal fade" id="addInvoiceModal" tabindex="-1" aria-labelledby="addInvoiceModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addInvoiceModalLabel"><i class="fas fa-file-invoice-dollar"></i> إضافة فاتورة جديدة</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="addInvoiceForm">
                        <div class="mb-3">
                            <label for="invoiceCustomer" class="form-label"><i class="fas fa-user"></i> الزبون</label>
                            <select class="form-select" id="invoiceCustomer" required>
                                <option value="">اختر زبونًا</option>
                            </select>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="customerPhoneDisplay" class="form-label"><i class="fas fa-phone"></i> رقم الهاتف</label>
                                <input type="text" class="form-control" id="customerPhoneDisplay" readonly>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="customerAddressDisplay" class="form-label"><i class="fas fa-map-marker-alt"></i> العنوان</label>
                                <input type="text" class="form-control" id="customerAddressDisplay" readonly>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="productSearch" class="form-label"><i class="fas fa-search"></i> البحث عن منتج</label>
                            <input type="text" class="form-control" id="productSearch" placeholder="ابحث بالاسم أو المعرف">
                            <div id="productSuggestions" class="mt-2 list-group" style="max-height: 150px; overflow-y: auto;"></div>
                        </div>
                        <h5><i class="fas fa-boxes"></i> المنتجات</h5>
                        <div class="table-container">
                            <table class="product-table table">
                                <thead>
                                    <tr>
                                        <th>اسم المنتج</th>
                                        <th>سعر البيع</th>
                                        <th>الكمية</th>
                                        <th>الملاحظة</th>
                                        <th>الإجمالي</th>
                                        <th>الإجراءات</th>
                                    </tr>
                                </thead>
                                <tbody id="invoiceProducts"></tbody>
                            </table>
                        </div>
                        <div class="mt-3">
                            <p><strong><i class="fas fa-calendar-alt"></i> التاريخ:</strong> <span id="invoiceDate"></span></p>
                            <p><strong><i class="fas fa-hashtag"></i> عدد المواد:</strong> <span id="totalItems">0</span></p>
                            <p><strong><i class="fas fa-coins"></i> المجموع الكلي:</strong> <span id="totalAmount">0.00</span></p>
                            <div class="mb-3">
                                <label for="amountPaid" class="form-label"><i class="fas fa-money-bill-wave"></i> المبلغ المدفوع</label>
                                <input type="number" class="form-control" id="amountPaid" step="0.01" min="0" value="0">
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
                    <button type="button" class="btn btn-primary" onclick="addInvoice()">حفظ الفاتورة</button>
                </div>
            </div>
        </div>
    </div>

    <!-- نافذة تعديل فاتورة -->
    <div class="modal fade" id="editInvoiceModal" tabindex="-1" aria-labelledby="editInvoiceModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editInvoiceModalLabel"><i class="fas fa-edit"></i> تعديل فاتورة</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="editInvoiceForm">
                        <input type="hidden" id="editInvoiceId">
                        <div class="mb-3">
                            <label for="editInvoiceCustomer" class="form-label"><i class="fas fa-user"></i> الزبون</label>
                            <select class="form-select" id="editInvoiceCustomer" required>
                                <option value="">اختر زبونًا</option>
                            </select>
                        </div>
                         <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="editCustomerPhoneDisplay" class="form-label"><i class="fas fa-phone"></i> رقم الهاتف</label>
                                <input type="text" class="form-control" id="editCustomerPhoneDisplay" readonly>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="editCustomerAddressDisplay" class="form-label"><i class="fas fa-map-marker-alt"></i> العنوان</label>
                                <input type="text" class="form-control" id="editCustomerAddressDisplay" readonly>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="editProductSearch" class="form-label"><i class="fas fa-search"></i> البحث عن منتج</label>
                            <input type="text" class="form-control" id="editProductSearch" placeholder="ابحث بالاسم أو المعرف">
                            <div id="editProductSuggestions" class="mt-2 list-group" style="max-height: 150px; overflow-y: auto;"></div>
                        </div>
                        <h5><i class="fas fa-boxes"></i> المنتجات</h5>
                        <div class="table-container">
                            <table class="product-table table">
                                <thead>
                                    <tr>
                                        <th>اسم المنتج</th>
                                        <th>سعر البيع</th>
                                        <th>الكمية</th>
                                        <th>الملاحظة</th>
                                        <th>الإجمالي</th>
                                        <th>الإجراءات</th>
                                    </tr>
                                </thead>
                                <tbody id="editInvoiceProducts"></tbody>
                            </table>
                        </div>
                        <div class="mt-3">
                            <p><strong><i class="fas fa-calendar-alt"></i> التاريخ:</strong> <span id="editInvoiceDate"></span></p>
                            <p><strong><i class="fas fa-hashtag"></i> عدد المواد:</strong> <span id="editTotalItems">0</span></p>
                            <p><strong><i class="fas fa-coins"></i> المجموع الكلي:</strong> <span id="editTotalAmount">0.00</span></p>
                            <div class="mb-3">
                                <label for="editAmountPaid" class="form-label"><i class="fas fa-money-bill-wave"></i> المبلغ المدفوع</label>
                                <input type="number" class="form-control" id="editAmountPaid" step="0.01" min="0" value="0">
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
                    <button type="button" class="btn btn-primary" onclick="updateInvoice()">حفظ التعديلات</button>
                </div>
            </div>
        </div>
    </div>

    <!-- نافذة إضافة زبون -->
    <div class="modal fade" id="addCustomerModal" tabindex="-1" aria-labelledby="addCustomerModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addCustomerModalLabel"><i class="fas fa-user-plus"></i> إضافة زبون</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="addCustomerForm">
                        <div class="mb-3">
                            <label for="customerName" class="form-label"><i class="fas fa-signature"></i> اسم الزبون (اختياري)</label>
                            <input type="text" class="form-control" id="customerName">
                        </div>
                        <div class="mb-3">
                            <label for="customerPhone" class="form-label"><i class="fas fa-mobile-alt"></i> رقم الهاتف (اختياري)</label>
                            <input type="tel" class="form-control" id="customerPhone">
                        </div>
                        <div class="mb-3">
                            <label for="customerAddress" class="form-label"><i class="fas fa-home"></i> العنوان (اختياري)</label>
                            <input type="text" class="form-control" id="customerAddress">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
                    <button type="button" class="btn btn-primary" onclick="addCustomer()">حفظ الزبون</button>
                </div>
            </div>
        </div>
    </div>

    <!-- نافذة تعديل زبون -->
    <div class="modal fade" id="editCustomerModal" tabindex="-1" aria-labelledby="editCustomerModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editCustomerModalLabel"><i class="fas fa-user-edit"></i> تعديل زبون</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="editCustomerForm">
                        <input type="hidden" id="editCustomerId">
                        <div class="mb-3">
                            <label for="editCustomerName" class="form-label"><i class="fas fa-signature"></i> اسم الزبون (اختياري)</label>
                            <input type="text" class="form-control" id="editCustomerName">
                        </div>
                        <div class="mb-3">
                            <label for="editCustomerPhone" class="form-label"><i class="fas fa-mobile-alt"></i> رقم الهاتف (اختياري)</label>
                            <input type="tel" class="form-control" id="editCustomerPhone">
                        </div>
                        <div class="mb-3">
                            <label for="editCustomerAddress" class="form-label"><i class="fas fa-home"></i> العنوان (اختياري)</label>
                            <input type="text" class="form-control" id="editCustomerAddress">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
                    <button type="button" class="btn btn-primary" onclick="updateCustomer()">حفظ التعديلات</button>
                </div>
            </div>
        </div>
    </div>

    <!-- نافذة كشف حساب زبون -->
    <div class="modal fade" id="customerStatementModal" tabindex="-1" aria-labelledby="customerStatementModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="customerStatementModalLabel"><i class="fas fa-file-invoice"></i> كشف حساب زبون</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="customerStatementForm">
                        <div class="mb-3">
                            <label for="statementCustomer" class="form-label"><i class="fas fa-user-check"></i> الزبون</label>
                            <select class="form-select" id="statementCustomer" required>
                                <option value="">اختر زبونًا</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="startDate" class="form-label"><i class="fas fa-calendar-day"></i> من تاريخ</label>
                            <input type="date" class="form-control" id="startDate" required>
                        </div>
                        <div class="mb-3">
                            <label for="endDate" class="form-label"><i class="fas fa-calendar-day"></i> إلى تاريخ</label>
                            <input type="date" class="form-control" id="endDate" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
                    <button type="button" class="btn btn-primary" onclick="generateCustomerStatement()">إنشاء الكشف</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let db;
        let html5QrCodeScanner; // For QR Code scanner instance

        // Helper function to format date as DD-MM-YYYY HH:MM
        function formatDateForDisplay(isoString) {
            if (!isoString) return 'N/A';
            const date = new Date(isoString);
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0'); // Months are 0-indexed
            const year = date.getFullYear();
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            return `${day}-${month}-${year} ${hours}:${minutes}`;
        }


        // إعداد IndexedDB
        function initDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open('InventoryDB', 2); 
                request.onupgradeneeded = (event) => {
                    db = event.target.result;
                    if (!db.objectStoreNames.contains('products')) {
                        db.createObjectStore('products', { keyPath: 'id' });
                    }
                    if (!db.objectStoreNames.contains('invoices')) {
                        const invoiceStore = db.createObjectStore('invoices', { keyPath: 'id' });
                        invoiceStore.createIndex('customerId', 'customerId', { unique: false });
                    }
                    if (!db.objectStoreNames.contains('customers')) {
                        const customerStore = db.createObjectStore('customers', { keyPath: 'id' });
                        customerStore.createIndex('phone', 'phone', { unique: false }); 
                    }
                };
                request.onsuccess = (event) => {
                    db = event.target.result;
                    resolve(db);
                };
                request.onerror = (event) => {
                    console.error("Database error: " + event.target.errorCode);
                    reject(event.target.error);
                };
            });
        }
        
        async function ensureDBInitialized() {
            if (!db) {
                try {
                    await initDB();
                } catch (error) {
                    console.error('Failed to initialize database:', error);
                    throw new Error('Failed to initialize database: ' + error.message);
                }
            }
            if (!db) { 
                throw new Error('Database not ready after initialization attempt.');
            }
        }

        async function generateUniqueId(storeName) {
            await ensureDBInitialized();
            let id;
            let isUnique = false;
            const existingIds = await getAllIds(storeName); 
            while (!isUnique) {
                id = Math.floor(10000 + Math.random() * 90000).toString();
                isUnique = !existingIds.includes(id);
            }
            return id;
        }

        function getAllIds(storeName) {
            return new Promise(async (resolve, reject) => {
                try {
                    await ensureDBInitialized();
                    const transaction = db.transaction([storeName], 'readonly');
                    const store = transaction.objectStore(storeName);
                    const request = store.getAllKeys(); 
                    request.onsuccess = () => {
                        resolve(request.result);
                    };
                    request.onerror = (event) => reject(event.target.error);
                } catch (error) {
                    reject(error);
                }
            });
        }

        function getAllProducts() {
            return new Promise(async (resolve, reject) => {
                try {
                    await ensureDBInitialized();
                    const transaction = db.transaction(['products'], 'readonly');
                    const store = transaction.objectStore('products');
                    const request = store.getAll();
                    request.onsuccess = () => resolve(request.result || []);
                    request.onerror = (event) => reject(event.target.error);
                } catch (error) {
                    reject(error);
                }
            });
        }
        
        function checkProductExists(productId) {
            return new Promise(async (resolve) => {
                try {
                    await ensureDBInitialized();
                    const transaction = db.transaction(['products'], 'readonly');
                    const store = transaction.objectStore('products');
                    const request = store.get(productId);
                    request.onsuccess = () => resolve(!!request.result); // True if product exists
                    request.onerror = () => resolve(false); // Error, assume not exists
                } catch (e) { resolve(false); }
            });
        }


        function getAllInvoices() {
            return new Promise(async (resolve, reject) => {
                try {
                    await ensureDBInitialized();
                    const transaction = db.transaction(['invoices'], 'readonly');
                    const store = transaction.objectStore('invoices');
                    const request = store.getAll();
                    request.onsuccess = () => resolve(request.result || []);
                    request.onerror = (event) => reject(event.target.error);
                } catch (error) {
                    reject(error);
                }
            });
        }

        function getAllCustomers() {
            return new Promise(async (resolve, reject) => {
                try {
                    await ensureDBInitialized();
                    const transaction = db.transaction(['customers'], 'readonly');
                    const store = transaction.objectStore('customers');
                    const request = store.getAll();
                    request.onsuccess = () => resolve(request.result || []);
                    request.onerror = (event) => reject(event.target.error);
                } catch (error) {
                    reject(error);
                }
            });
        }

        async function updateDashboard() {
            const invoices = await getAllInvoices();
            const paid = invoices.filter(i => parseFloat(i.amountPaid) >= parseFloat(i.totalAmount) && parseFloat(i.totalAmount) > 0).length;
            const partial = invoices.filter(i => parseFloat(i.amountPaid) > 0 && parseFloat(i.amountPaid) < parseFloat(i.totalAmount)).length;
            const unpaid = invoices.filter(i => parseFloat(i.amountPaid) === 0 && parseFloat(i.totalAmount) > 0).length;


            document.getElementById('paidInvoices').innerText = paid;
            document.getElementById('partialInvoices').innerText = partial;
            document.getElementById('unpaidInvoices').innerText = unpaid;
        }

        async function updateInvoicesTable() {
            const invoices = await getAllInvoices();
            const customers = await getAllCustomers();
            const tableBody = document.getElementById('invoicesTable');
            tableBody.innerHTML = '';

            invoices.sort((a, b) => new Date(b.date) - new Date(a.date)); 

            invoices.forEach((invoice, index) => {
                const customer = customers.find(c => c.id === invoice.customerId);
                const totalAmount = parseFloat(invoice.totalAmount);
                const amountPaid = parseFloat(invoice.amountPaid);
                let statusClass, statusText;

                if (totalAmount === 0 && amountPaid === 0) { // Consider invoices with 0 total and 0 paid (e.g. returns or empty)
                    statusClass = ''; // No specific class or a 'neutral' class
                    statusText = 'لا يوجد مبلغ';
                } else if (amountPaid >= totalAmount) {
                    statusClass = 'status-paid';
                    statusText = 'مدفوع';
                } else if (amountPaid > 0) {
                    statusClass = 'status-partial';
                    statusText = 'مدفوع جزئيًا';
                } else { // amountPaid is 0 and totalAmount > 0
                    statusClass = 'status-unpaid';
                    statusText = 'لم يتم الدفع';
                }


                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${invoice.id}</td>
                    <td>${customer?.name || 'زبون محذوف/غير معروف'}</td>
                    <td>${customer?.phone || '-'}</td>
                    <td>${totalAmount.toFixed(2)}</td>
                    <td class="${statusClass}">${statusText}</td>
                    <td>
                        <i class="fas fa-print action-btn print" onclick="printInvoice('${invoice.id}')" title="طباعة"></i>
                        <i class="fas fa-edit action-btn edit" onclick="editInvoice('${invoice.id}')" title="تعديل"></i>
                        <!-- Delete button removed from UI as requested -->
                    </td>
                `;
                tableBody.appendChild(row);
            });
            updateDashboard(); // Update dashboard after table is updated
            // filterTable(); // Call filterTable if you want to apply existing filters immediately after refresh
        }

        async function updateCustomersTable() {
            const customers = await getAllCustomers();
            const tableBody = document.getElementById('customersTable');
            tableBody.innerHTML = '';

            customers.forEach((customer, index) => {
                const row = document.createElement('tr');
                const displayName = customer.name || 'زبون بدون اسم';
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${displayName}</td>
                    <td>${customer.phone || '-'}</td>
                    <td>${customer.address || '-'}</td>
                    <td>
                        <i class="fas fa-edit action-btn edit" onclick="editCustomer('${customer.id}')" title="تعديل"></i>
                        <i class="fas fa-trash action-btn delete" onclick="deleteCustomer('${customer.id}')" title="حذف"></i>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }

        async function filterTable() {
            const searchInput = document.getElementById('searchInput').value.toLowerCase();
            const statusFilter = document.getElementById('statusFilter').value;
            const invoices = await getAllInvoices(); // Fetch fresh list
            const customers = await getAllCustomers(); // Fetch fresh list
            const tableBody = document.getElementById('invoicesTable');
            
            const filteredInvoices = invoices.filter(invoice => {
                const customer = customers.find(c => c.id === invoice.customerId);
                const customerName = customer?.name?.toLowerCase() || '';
                const matchesSearch = customerName.includes(searchInput) || invoice.id.includes(searchInput);
                
                if (!matchesSearch) return false;

                const totalAmount = parseFloat(invoice.totalAmount);
                const amountPaid = parseFloat(invoice.amountPaid);

                if (statusFilter === 'all') return true;
                if (statusFilter === 'paid') return amountPaid >= totalAmount && totalAmount > 0; // Ensure total > 0 for 'paid'
                if (statusFilter === 'partial') return amountPaid > 0 && amountPaid < totalAmount;
                if (statusFilter === 'unpaid') return amountPaid === 0 && totalAmount > 0; // Ensure total > 0 for 'unpaid'
                
                // This case should ideally not be reached if statusFilter has a valid value from the dropdown.
                // If it's reached, it means an unknown filter value, so include the item.
                return true; 
            });

            tableBody.innerHTML = ''; 
            filteredInvoices.sort((a, b) => new Date(b.date) - new Date(a.date)); // Re-sort filtered results

            filteredInvoices.forEach((invoice, index) => {
                const customer = customers.find(c => c.id === invoice.customerId);
                const totalAmount = parseFloat(invoice.totalAmount);
                const amountPaid = parseFloat(invoice.amountPaid);
                let statusClass, statusText;

                 if (totalAmount === 0 && amountPaid === 0) {
                    statusClass = ''; statusText = 'لا يوجد مبلغ';
                } else if (amountPaid >= totalAmount) {
                    statusClass = 'status-paid'; statusText = 'مدفوع';
                } else if (amountPaid > 0) {
                    statusClass = 'status-partial'; statusText = 'مدفوع جزئيًا';
                } else {
                    statusClass = 'status-unpaid'; statusText = 'لم يتم الدفع';
                }

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${invoice.id}</td>
                    <td>${customer?.name || 'زبون محذوف/غير معروف'}</td>
                    <td>${customer?.phone || '-'}</td>
                    <td>${totalAmount.toFixed(2)}</td>
                    <td class="${statusClass}">${statusText}</td>
                    <td>
                        <i class="fas fa-print action-btn print" onclick="printInvoice('${invoice.id}')" title="طباعة"></i>
                        <i class="fas fa-edit action-btn edit" onclick="editInvoice('${invoice.id}')" title="تعديل"></i>
                    </td>
                `;
                tableBody.appendChild(row);
            });
            // No need to call updateDashboard here as it's called in updateInvoicesTable which is called by other functions.
            // However, if filterTable is called independently (e.g., on search input), then dashboard might need update based on filtered view, or just reflect all invoices.
            // For simplicity, let dashboard always reflect all invoices. It's updated by main table update functions.
        }


        async function populateCustomerSelect(selectElementId) {
            const customers = await getAllCustomers();
            const select = document.getElementById(selectElementId);
            const currentValue = select.value; // Preserve current selection if possible
            select.innerHTML = '<option value="">اختر زبونًا...</option>'; 
            customers.forEach(customer => {
                const option = document.createElement('option');
                option.value = customer.id;
                option.textContent = customer.name || `زبون (${customer.phone || 'معرف: ' + customer.id.slice(0,5)})`;
                select.appendChild(option);
            });
            if (currentValue) { // Attempt to restore selection
                 select.value = currentValue;
            }
        }

        async function updateCustomerInfo(selectElementId, phoneElementId, addressElementId) {
            const customerId = document.getElementById(selectElementId).value;
            const phoneInput = document.getElementById(phoneElementId);
            const addressInput = document.getElementById(addressElementId);

            if (customerId) {
                const customers = await getAllCustomers(); // Fetch fresh customer data
                const customer = customers.find(c => c.id === customerId);
                phoneInput.value = customer?.phone || '';
                addressInput.value = customer?.address || '';
            } else {
                phoneInput.value = '';
                addressInput.value = '';
            }
        }
        
        async function setupProductSearch(searchElementId, suggestionsElementId, productsTableId, isEditModal = false) {
            const searchInput = document.getElementById(searchElementId);
            const suggestionsDiv = document.getElementById(suggestionsElementId);
            
            searchInput.addEventListener('input', async (e) => {
                const query = e.target.value.toLowerCase().trim();
                suggestionsDiv.innerHTML = ''; 
                if (query.length < 1) return; 

                const allProducts = await getAllProducts();
                const availableProducts = allProducts.filter(p => p.quantity > 0); 
                
                const filteredProducts = availableProducts.filter(p => 
                    p.name.toLowerCase().includes(query) || 
                    p.id.includes(query)
                ).slice(0, 10); 

                if (filteredProducts.length > 0) {
                    filteredProducts.forEach(product => {
                        const div = document.createElement('div');
                        div.className = 'list-group-item list-group-item-action';
                        
                        const salePriceFormatted = parseFloat(product.salePrice || 0).toFixed(2);
                        
                        // --- MODIFICATION FOR costPrice ---
                        let costPriceFormatted;
                        if (typeof product.costPrice === 'number') { // Handles 0 as a valid cost price
                            costPriceFormatted = parseFloat(product.costPrice).toFixed(2);
                        } else if (product.costPrice && !isNaN(parseFloat(product.costPrice))) { // Handles string numbers
                            costPriceFormatted = parseFloat(product.costPrice).toFixed(2);
                        } else {
                            costPriceFormatted = 'غ/م'; // Not available or not a valid number
                        }
                        // --- END MODIFICATION ---
                        
                        div.innerHTML = `
                            <strong>${product.name}</strong> (المعرف: ${product.id}) <br>
                            <small>
                                سعر البيع: ${salePriceFormatted} | 
                                سعر الشراء: ${costPriceFormatted} | 
                                الكمية المتوفرة: ${product.quantity}
                            </small>
                        `;
                        div.onclick = () => {
                            addProductToInvoice(product, productsTableId);
                            searchInput.value = ''; 
                            suggestionsDiv.innerHTML = ''; 
                        };
                        suggestionsDiv.appendChild(div);
                    });
                } else {
                    suggestionsDiv.innerHTML = '<div class="list-group-item">لا توجد منتجات مطابقة أو غير متوفرة.</div>';
                }
            });
        }


        function addProductToInvoice(product, productsTableId) {
            const tableBody = document.getElementById(productsTableId);
            const existingRow = Array.from(tableBody.rows).find(row => row.dataset.productId === product.id);

            if (existingRow) {
                const quantityInput = existingRow.querySelector('.quantity');
                const currentQuantity = parseInt(quantityInput.value);
                if (currentQuantity < product.quantity) { 
                    quantityInput.value = currentQuantity + 1;
                } else {
                    Swal.fire('تنبيه', `الكمية المطلوبة للمنتج "${product.name}" تتجاوز المخزون المتاح (${product.quantity}).`, 'warning');
                    return;
                }
            } else {
                if (product.quantity < 1) { 
                     Swal.fire('تنبيه', `المنتج "${product.name}" غير متوفر في المخزون.`, 'warning');
                    return;
                }
                const row = tableBody.insertRow();
                row.dataset.productId = product.id; 
                
                row.innerHTML = `
                    <td>${product.name}</td>
                    <td><input type="number" class="form-control form-control-sm sale-price" value="${parseFloat(product.salePrice || 0).toFixed(2)}" step="0.01" min="0.01"></td>
                    <td><input type="number" class="form-control form-control-sm quantity" value="1" min="1" max="${product.quantity}"></td>
                    <td><input type="text" class="form-control form-control-sm note" placeholder="ملاحظة (اختياري)"></td>
                    <td class="total">${parseFloat(product.salePrice || 0).toFixed(2)}</td>
                    <td><button type="button" class="btn btn-sm btn-danger" onclick="removeProductFromInvoice(this.closest('tr'), '${productsTableId}')"><i class="fas fa-trash-alt"></i></button></td>
                `;
                row.querySelector('.sale-price').addEventListener('input', () => updateInvoiceTotals(productsTableId));
                row.querySelector('.quantity').addEventListener('input', (e) => {
                    const requestedQuantity = parseInt(e.target.value);
                    const maxQuantityForThisProduct = parseInt(e.target.max); // Use the max attribute of the input

                    if (requestedQuantity > maxQuantityForThisProduct) {
                        e.target.value = maxQuantityForThisProduct; 
                        Swal.fire('تنبيه', `الكمية المطلوبة للمنتج "${product.name}" تتجاوز المخزون المتاح (${maxQuantityForThisProduct}). تم التعديل للحد الأقصى.`, 'warning');
                    }
                    updateInvoiceTotals(productsTableId);
                });
            }
            updateInvoiceTotals(productsTableId);
        }


        function removeProductFromInvoice(rowElement, productsTableId) {
            rowElement.remove();
            updateInvoiceTotals(productsTableId);
        }

        function updateInvoiceTotals(productsTableId) {
            const tableBody = document.getElementById(productsTableId);
            const rows = tableBody.querySelectorAll('tr');
            let totalAmount = 0;
            let totalItemsCount = 0; 

            rows.forEach(row => {
                const salePriceInput = row.querySelector('.sale-price');
                const quantityInput = row.querySelector('.quantity');
                
                const salePrice = parseFloat(salePriceInput.value) || 0;
                const quantity = parseInt(quantityInput.value) || 0;
                
                const itemTotal = salePrice * quantity;
                row.querySelector('.total').textContent = itemTotal.toFixed(2);
                totalAmount += itemTotal;
                totalItemsCount++; 
            });

            const isEditModal = productsTableId === 'editInvoiceProducts';
            document.getElementById(isEditModal ? 'editTotalItems' : 'totalItems').textContent = totalItemsCount; 
            document.getElementById(isEditModal ? 'editTotalAmount' : 'totalAmount').textContent = totalAmount.toFixed(2);
        }

        async function addInvoice() {
            const customerId = document.getElementById('invoiceCustomer').value;
            const amountPaidValue = document.getElementById('amountPaid').value;
            const productsTable = document.getElementById('invoiceProducts');
            const rows = productsTable.querySelectorAll('tr');

            if (!customerId) {
                Swal.fire('خطأ', 'الرجاء اختيار زبون!', 'error'); return;
            }
            if (rows.length === 0) {
                Swal.fire('خطأ', 'الرجاء إضافة منتج واحد على الأقل للفاتورة!', 'error'); return;
            }
            const amountPaid = parseFloat(amountPaidValue);
            if (isNaN(amountPaid) || amountPaid < 0) {
                 Swal.fire('خطأ', 'المبلغ المدفوع غير صحيح!', 'error'); return;
            }

            const productsInInvoice = [];
            let totalAmount = 0;
            let stockUpdatePromises = [];

            for (const row of rows) {
                const productId = row.dataset.productId;
                const name = row.cells[0].textContent;
                const salePrice = parseFloat(row.querySelector('.sale-price').value);
                const quantitySold = parseInt(row.querySelector('.quantity').value);
                const note = row.querySelector('.note').value;
                const itemTotal = salePrice * quantitySold;

                if (isNaN(salePrice) || salePrice <=0 || isNaN(quantitySold) || quantitySold <=0) {
                    Swal.fire('خطأ', `بيانات غير صالحة للمنتج "${name}". تأكد من السعر والكمية.`, 'error'); return;
                }

                productsInInvoice.push({ productId, name, salePrice, quantity: quantitySold, note, total: itemTotal });
                totalAmount += itemTotal;
                stockUpdatePromises.push(updateProductStock(productId, quantitySold));
            }
             if (amountPaid > totalAmount) {
                Swal.fire('خطأ', 'المبلغ المدفوع لا يمكن أن يكون أكبر من المجموع الكلي للفاتورة!', 'error'); return;
            }

            try {
                await Promise.all(stockUpdatePromises); 
            } catch (error) {
                Swal.fire('خطأ في تحديث المخزون', error.message, 'error');
                return;
            }

            const id = await generateUniqueId('invoices');
            const invoice = {
                id,
                customerId,
                products: productsInInvoice,
                totalAmount: totalAmount.toFixed(2),
                amountPaid: amountPaid.toFixed(2),
                date: new Date().toISOString()
            };

            const transaction = db.transaction(['invoices'], 'readwrite');
            const store = transaction.objectStore('invoices');
            const request = store.add(invoice);

            request.onsuccess = async () => {
                await updateInvoicesTable(); // This also updates dashboard
                bootstrap.Modal.getInstance(document.getElementById('addInvoiceModal')).hide();
                document.getElementById('addInvoiceForm').reset();
                document.getElementById('invoiceProducts').innerHTML = ''; 
                document.getElementById('totalItems').textContent = '0';
                document.getElementById('totalAmount').textContent = '0.00';
                document.getElementById('customerPhoneDisplay').value = '';
                document.getElementById('customerAddressDisplay').value = '';
                document.getElementById('invoiceDate').textContent = formatDateForDisplay(new Date().toISOString()); // Reset date
                await populateCustomerSelect('invoiceCustomer'); 
                Swal.fire('نجاح', 'تم إضافة الفاتورة وتحديث المخزون بنجاح!', 'success');
            };
            request.onerror = (e) => {
                console.error("Error adding invoice:", e.target.error);
                Swal.fire('خطأ', 'فشل في إضافة الفاتورة!', 'error');
            };
        }
        
        function updateProductStock(productId, quantitySold) {
            return new Promise(async (resolve, reject) => {
                try {
                    await ensureDBInitialized();
                    const transaction = db.transaction(['products'], 'readwrite');
                    const store = transaction.objectStore('products');
                    const getRequest = store.get(productId);

                    getRequest.onsuccess = () => {
                        const product = getRequest.result;
                        if (!product) {
                            reject(new Error(`المنتج بالمعرف ${productId} غير موجود.`));
                            return;
                        }
                        if (product.quantity < quantitySold) {
                            reject(new Error(`الكمية المطلوبة للمنتج "${product.name}" (${quantitySold}) تتجاوز المخزون المتاح (${product.quantity}).`));
                            return;
                        }
                        product.quantity -= quantitySold;
                        const updateRequest = store.put(product);
                        updateRequest.onsuccess = () => resolve();
                        updateRequest.onerror = (e) => reject(new Error(`فشل تحديث مخزون المنتج ${product.name}: ${e.target.error}`));
                    };
                    getRequest.onerror = (e) => reject(new Error(`فشل جلب المنتج ${productId} لتحديث المخزون: ${e.target.error}`));
                } catch (dbError) {
                    reject(dbError);
                }
            });
        }


        async function editInvoice(invoiceId) {
            try {
                await ensureDBInitialized();
                const transaction = db.transaction(['invoices', 'customers', 'products'], 'readonly'); 
                const invoiceStore = transaction.objectStore('invoices');
                const invoiceRequest = invoiceStore.get(invoiceId);

                invoiceRequest.onsuccess = async () => {
                    const invoice = invoiceRequest.result;
                    if (!invoice) {
                        Swal.fire('خطأ', 'الفاتورة غير موجودة!', 'error');
                        return;
                    }
                    
                    document.getElementById('editInvoiceModal').dataset.originalProducts = JSON.stringify(invoice.products);
                    document.getElementById('editInvoiceId').value = invoice.id;
                    
                    const customerSelect = document.getElementById('editInvoiceCustomer');
                    await populateCustomerSelect('editInvoiceCustomer'); 
                    customerSelect.value = invoice.customerId;
                    await updateCustomerInfo('editInvoiceCustomer', 'editCustomerPhoneDisplay', 'editCustomerAddressDisplay');

                    document.getElementById('editInvoiceDate').textContent = formatDateForDisplay(invoice.date);
                    document.getElementById('editAmountPaid').value = parseFloat(invoice.amountPaid).toFixed(2);

                    const tableBody = document.getElementById('editInvoiceProducts');
                    tableBody.innerHTML = ''; 

                    const allProductsFromDB = await getAllProducts(); 

                    invoice.products.forEach(pInInvoice => {
                        const productDetailsFromDB = allProductsFromDB.find(pDB => pDB.id === pInInvoice.productId);
                        const currentStockInDB = productDetailsFromDB ? productDetailsFromDB.quantity : 0;
                        const maxQuantityForInput = currentStockInDB + pInInvoice.quantity;


                        const row = tableBody.insertRow();
                        row.dataset.productId = pInInvoice.productId;
                        row.dataset.originalQuantityInInvoice = pInInvoice.quantity; 
                        row.dataset.maxEditableQuantity = maxQuantityForInput;


                        row.innerHTML = `
                            <td>${pInInvoice.name}</td>
                            <td><input type="number" class="form-control form-control-sm sale-price" value="${parseFloat(pInInvoice.salePrice).toFixed(2)}" step="0.01" min="0.01"></td>
                            <td><input type="number" class="form-control form-control-sm quantity" value="${pInInvoice.quantity}" min="1" max="${maxQuantityForInput}"></td>
                            <td><input type="text" class="form-control form-control-sm note" value="${pInInvoice.note || ''}" placeholder="ملاحظة"></td>
                            <td class="total">${parseFloat(pInInvoice.total).toFixed(2)}</td>
                            <td><button type="button" class="btn btn-sm btn-danger" onclick="removeProductFromInvoice(this.closest('tr'), 'editInvoiceProducts')"><i class="fas fa-trash-alt"></i></button></td>
                        `;
                        row.querySelector('.sale-price').addEventListener('input', () => updateInvoiceTotals('editInvoiceProducts'));
                        row.querySelector('.quantity').addEventListener('input', (e) => {
                             const requestedQuantity = parseInt(e.target.value);
                             const maxAllowed = parseInt(e.target.max); 
                             if (requestedQuantity > maxAllowed) {
                                e.target.value = maxAllowed;
                                Swal.fire('تنبيه', `الكمية المطلوبة للمنتج "${pInInvoice.name}" تتجاوز المخزون المتاح. تم التعديل للحد الأقصى (${maxAllowed}).`, 'warning');
                            }
                            updateInvoiceTotals('editInvoiceProducts');
                        });
                    });

                    updateInvoiceTotals('editInvoiceProducts');
                    new bootstrap.Modal(document.getElementById('editInvoiceModal')).show();
                };
                invoiceRequest.onerror = (e) => Swal.fire('خطأ', `فشل في جلب الفاتورة: ${e.target.error}`, 'error');
            } catch (dbError) {
                 Swal.fire('خطأ قاعدة البيانات', `فشل: ${dbError.message}`, 'error');
            }
        }


        async function updateInvoice() {
            const id = document.getElementById('editInvoiceId').value;
            const customerId = document.getElementById('editInvoiceCustomer').value;
            const amountPaidValue = document.getElementById('editAmountPaid').value;
            const productsTable = document.getElementById('editInvoiceProducts');
            const rows = productsTable.querySelectorAll('tr');
            
            const originalProductsJSON = document.getElementById('editInvoiceModal').dataset.originalProducts;
            const originalProductsInInvoice = JSON.parse(originalProductsJSON || "[]"); 


            if (!customerId) { Swal.fire('خطأ', 'الرجاء اختيار زبون!', 'error'); return; }
            if (rows.length === 0) { Swal.fire('خطأ', 'الفاتورة يجب أن تحتوي على منتج واحد على الأقل!', 'error'); return; }
            const amountPaid = parseFloat(amountPaidValue);
             if (isNaN(amountPaid) || amountPaid < 0) { Swal.fire('خطأ', 'المبلغ المدفوع غير صحيح!', 'error'); return; }


            const updatedProductsInInvoice = [];
            let newTotalAmount = 0;
            let stockAdjustmentPromises = []; 

            for (const row of rows) {
                const productId = row.dataset.productId;
                const name = row.cells[0].textContent;
                const salePrice = parseFloat(row.querySelector('.sale-price').value);
                const newQuantitySold = parseInt(row.querySelector('.quantity').value);
                const note = row.querySelector('.note').value;
                const itemTotal = salePrice * newQuantitySold;

                if (isNaN(salePrice) || salePrice <=0 || isNaN(newQuantitySold) || newQuantitySold <=0) {
                    Swal.fire('خطأ', `بيانات غير صالحة للمنتج "${name}". تأكد من السعر والكمية.`, 'error'); return;
                }

                updatedProductsInInvoice.push({ productId, name, salePrice, quantity: newQuantitySold, note, total: itemTotal });
                newTotalAmount += itemTotal;

                const originalProductInfo = originalProductsInInvoice.find(p => p.productId === productId);
                const originalQuantitySoldInThisInvoice = originalProductInfo ? originalProductInfo.quantity : 0;
                
                const quantityChangeForStock = originalQuantitySoldInThisInvoice - newQuantitySold; 
                
                if (quantityChangeForStock !== 0) {
                    const productExists = await checkProductExists(productId);
                    if (productExists) {
                         stockAdjustmentPromises.push(adjustProductStock(productId, quantityChangeForStock));
                    } else {
                        console.warn(`Product ${productId} not found in DB. Skipping stock adjustment for this item.`);
                    }
                }
            }
            
            originalProductsInInvoice.forEach(async origP => {
                if (!updatedProductsInInvoice.some(updP => updP.productId === origP.productId)) {
                    const productExists = await checkProductExists(origP.productId);
                     if (productExists) {
                        stockAdjustmentPromises.push(adjustProductStock(origP.productId, origP.quantity)); 
                     } else {
                        console.warn(`Product ${origP.productId} (removed from invoice) not found in DB. Skipping stock adjustment for this item.`);
                     }
                }
            });


            if (amountPaid > newTotalAmount) {
                Swal.fire('خطأ', 'المبلغ المدفوع لا يمكن أن يكون أكبر من المجموع الكلي للفاتورة!', 'error'); return;
            }

            try {
                if (stockAdjustmentPromises.length > 0) {
                    await Promise.all(stockAdjustmentPromises);
                }
            } catch (error) {
                Swal.fire('خطأ في تحديث المخزون', error.message, 'error');
                return; 
            }
            
            let invoiceDateStr = document.getElementById('editInvoiceDate').textContent;
            let invoiceDateISO;
            if (invoiceDateStr && invoiceDateStr !== 'N/A') {
                const parts = invoiceDateStr.match(/(\d{2})-(\d{2})-(\d{4}) (\d{2}):(\d{2})/);
                if (parts) {
                    // parts[1]=day, parts[2]=month, parts[3]=year, parts[4]=hour, parts[5]=minute
                    invoiceDateISO = new Date(Date.UTC(parts[3], parts[2] - 1, parts[1], parts[4], parts[5])).toISOString();
                } else {
                    invoiceDateISO = new Date().toISOString(); 
                }
            } else {
                 invoiceDateISO = new Date().toISOString(); 
            }


            const invoice = {
                id,
                customerId,
                products: updatedProductsInInvoice,
                totalAmount: newTotalAmount.toFixed(2),
                amountPaid: amountPaid.toFixed(2),
                date: invoiceDateISO 
            };

            const transaction = db.transaction(['invoices'], 'readwrite');
            const store = transaction.objectStore('invoices');
            const request = store.put(invoice);

            request.onsuccess = async () => {
                await updateInvoicesTable(); // This also updates dashboard
                bootstrap.Modal.getInstance(document.getElementById('editInvoiceModal')).hide();
                Swal.fire('نجاح', 'تم تعديل الفاتورة وتحديث المخزون بنجاح!', 'success');
            };
            request.onerror = (e) => {
                 console.error("Error updating invoice:", e.target.error);
                 Swal.fire('خطأ', 'فشل في تعديل الفاتورة!', 'error');
            };
        }

        function adjustProductStock(productId, quantityChange) {
            return new Promise(async (resolve, reject) => {
                try {
                    await ensureDBInitialized();
                    const transaction = db.transaction(['products'], 'readwrite');
                    const store = transaction.objectStore('products');
                    const getRequest = store.get(productId);

                    getRequest.onsuccess = () => {
                        const product = getRequest.result;
                        if (!product) {
                            // It's possible a product was deleted from inventory system externally
                            // while it was still in an invoice. Log this instead of hard failing the whole invoice update.
                            console.warn(`المنتج بالمعرف ${productId} غير موجود لتعديل المخزون. سيتم تخطي هذا المنتج.`);
                            resolve(); // Resolve to not block other stock adjustments
                            return;
                        }
                        
                        const newStock = product.quantity + quantityChange;
                        if (newStock < 0) { 
                             reject(new Error(`لا يمكن أن يكون مخزون المنتج "${product.name}" سالبًا. التغيير المطلوب للمخزون: ${quantityChange}, المخزون الحالي: ${product.quantity}.`));
                             return;
                        }
                        product.quantity = newStock;

                        const updateRequest = store.put(product);
                        updateRequest.onsuccess = () => resolve();
                        updateRequest.onerror = (e) => reject(new Error(`فشل تعديل مخزون المنتج ${product.name}: ${e.target.error}`));
                    };
                    getRequest.onerror = (e) => reject(new Error(`فشل جلب المنتج ${productId} لتعديل المخزون: ${e.target.error}`));
                } catch (dbError) {
                    reject(dbError);
                }
            });
        }

        async function deleteInvoice(invoiceId) { // This function is not called from UI but kept for potential use
            const result = await Swal.fire({
                title: 'تأكيد الحذف',
                text: 'هل أنت متأكد من حذف هذه الفاتورة؟ سيتم إرجاع الكميات المباعة إلى المخزون.',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'نعم، احذف',
                cancelButtonText: 'إلغاء',
                confirmButtonColor: '#dc3545',
                cancelButtonColor: '#6c757d'
            });

            if (result.isConfirmed) {
                try {
                    await ensureDBInitialized();
                    const readTx = db.transaction(['invoices'], 'readonly'); 
                    const invoiceStoreRead = readTx.objectStore('invoices');
                    const getInvoiceRequest = invoiceStoreRead.get(invoiceId);

                    getInvoiceRequest.onsuccess = async () => {
                        const invoiceToDelete = getInvoiceRequest.result;
                        if (!invoiceToDelete) {
                            Swal.fire('خطأ', 'الفاتورة غير موجودة.', 'error');
                            return;
                        }

                        let stockReturnPromises = [];
                        for (const p of invoiceToDelete.products) {
                            const productExists = await checkProductExists(p.productId);
                            if (productExists) {
                                stockReturnPromises.push(adjustProductStock(p.productId, p.quantity));
                            } else {
                                console.warn(`Product ${p.productId} from deleted invoice not found. Stock not returned for this item.`);
                            }
                        }
                        
                        try {
                            if (stockReturnPromises.length > 0) {
                                await Promise.all(stockReturnPromises); 
                            }

                            const writeTxDelete = db.transaction(['invoices'], 'readwrite');
                            const invoiceStoreWrite = writeTxDelete.objectStore('invoices');
                            const deleteRequest = invoiceStoreWrite.delete(invoiceId);

                            deleteRequest.onsuccess = async () => {
                                await updateInvoicesTable(); // This also updates dashboard
                                Swal.fire('نجاح', 'تم حذف الفاتورة وإرجاع المنتجات للمخزون بنجاح!', 'success');
                            };
                            deleteRequest.onerror = (e) => {
                                console.error("Error deleting invoice:", e.target.error);
                                Swal.fire('خطأ', 'فشل في حذف الفاتورة! (قد يكون المخزون أُرجع).', 'error');
                            };

                        } catch (stockError) {
                            Swal.fire('خطأ في إرجاع المخزون', stockError.message, 'error');
                        }
                    };
                    getInvoiceRequest.onerror = (e) => Swal.fire('خطأ', `فشل في جلب الفاتورة للحذف: ${e.target.error}`, 'error');

                } catch (dbError) {
                     Swal.fire('خطأ قاعدة البيانات', `فشل: ${dbError.message}`, 'error');
                }
            }
        }


        async function addCustomer() {
            const name = document.getElementById('customerName').value.trim();
            const phone = document.getElementById('customerPhone').value.trim();
            const address = document.getElementById('customerAddress').value.trim();
            
            if (!name && !phone && !address) {
                 Swal.fire('خطأ', 'يجب إدخال معلومة واحدة على الأقل للزبون (الاسم أو الهاتف أو العنوان).', 'error');
                 return;
            }

            if (phone) { 
                const customers = await getAllCustomers();
                if (customers.some(c => c.phone === phone && phone !== '')) { // Ensure phone isn't empty string
                    Swal.fire('خطأ', 'رقم الهاتف هذا مُسجل لزبون آخر!', 'error');
                    return;
                }
            }


            const id = await generateUniqueId('customers');
            const customer = { 
                id, 
                name: name || null, // Store null if empty for consistency
                phone: phone || null, 
                address: address || null 
            };


            const transaction = db.transaction(['customers'], 'readwrite');
            const store = transaction.objectStore('customers');
            const request = store.add(customer);

            request.onsuccess = async () => {
                await updateCustomersTable();
                await populateCustomerSelect('invoiceCustomer');
                await populateCustomerSelect('editInvoiceCustomer');
                await populateCustomerSelect('statementCustomer');
                bootstrap.Modal.getInstance(document.getElementById('addCustomerModal')).hide();
                document.getElementById('addCustomerForm').reset();
                Swal.fire('نجاح', 'تم إضافة الزبون بنجاح!', 'success');
            };
            request.onerror = (e) => Swal.fire('خطأ', `فشل في إضافة الزبون: ${e.target.error}`, 'error');
        }

        async function editCustomer(customerId) {
            try {
                await ensureDBInitialized();
                const transaction = db.transaction(['customers'], 'readonly');
                const store = transaction.objectStore('customers');
                const request = store.get(customerId);

                request.onsuccess = () => {
                    const customer = request.result;
                    if (!customer) {
                        Swal.fire('خطأ', 'الزبون غير موجود!', 'error');
                        return;
                    }
                    document.getElementById('editCustomerId').value = customer.id;
                    document.getElementById('editCustomerName').value = customer.name || '';
                    document.getElementById('editCustomerPhone').value = customer.phone || '';
                    document.getElementById('editCustomerAddress').value = customer.address || '';
                    new bootstrap.Modal(document.getElementById('editCustomerModal')).show();
                };
                request.onerror = (e) => Swal.fire('خطأ', `فشل في جلب بيانات الزبون: ${e.target.error}`, 'error');
            } catch (dbError) {
                 Swal.fire('خطأ قاعدة البيانات', `فشل: ${dbError.message}`, 'error');
            }
        }

        async function updateCustomer() {
            const id = document.getElementById('editCustomerId').value;
            const name = document.getElementById('editCustomerName').value.trim();
            const phone = document.getElementById('editCustomerPhone').value.trim();
            const address = document.getElementById('editCustomerAddress').value.trim();

             if (!name && !phone && !address) {
                 Swal.fire('خطأ', 'يجب إدخال معلومة واحدة على الأقل للزبون.', 'error');
                 return;
            }

            if (phone) { 
                const customers = await getAllCustomers();
                if (customers.some(c => c.id !== id && c.phone === phone && phone !== '')) { 
                    Swal.fire('خطأ', 'رقم الهاتف هذا مُسجل لزبون آخر!', 'error');
                    return;
                }
            }

            const customer = { 
                id, 
                name: name || null, 
                phone: phone || null, 
                address: address || null 
            };
            const transaction = db.transaction(['customers'], 'readwrite');
            const store = transaction.objectStore('customers');
            const request = store.put(customer);

            request.onsuccess = async () => {
                await updateCustomersTable();
                await updateInvoicesTable(); // Refresh invoices in case customer name changed
                await populateCustomerSelect('invoiceCustomer');
                await populateCustomerSelect('editInvoiceCustomer');
                await populateCustomerSelect('statementCustomer');
                bootstrap.Modal.getInstance(document.getElementById('editCustomerModal')).hide();
                Swal.fire('نجاح', 'تم تعديل بيانات الزبون بنجاح!', 'success');
            };
            request.onerror = (e) => Swal.fire('خطأ', `فشل في تعديل بيانات الزبون: ${e.target.error}`, 'error');
        }

        async function deleteCustomer(customerId) {
            const invoices = await getAllInvoices();
            if (invoices.some(i => i.customerId === customerId)) {
                Swal.fire('لا يمكن الحذف', 'لا يمكن حذف هذا الزبون لأنه مرتبط بفواتير حالية. يرجى تعديل الفواتير المرتبطة به لزبون آخر أو حذفها (إذا كانت هذه الإمكانية متاحة).', 'error');
                return;
            }


            const result = await Swal.fire({
                title: 'تأكيد الحذف',
                text: 'هل أنت متأكد من حذف هذا الزبون؟ لا يمكن التراجع عن هذا الإجراء.',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'نعم، احذف',
                cancelButtonText: 'إلغاء',
                confirmButtonColor: '#dc3545'
            });

            if (result.isConfirmed) {
                const transaction = db.transaction(['customers'], 'readwrite');
                const store = transaction.objectStore('customers');
                const request = store.delete(customerId);

                request.onsuccess = async () => {
                    await updateCustomersTable();
                    await populateCustomerSelect('invoiceCustomer');
                    await populateCustomerSelect('editInvoiceCustomer');
                    await populateCustomerSelect('statementCustomer');
                    Swal.fire('نجاح', 'تم حذف الزبون بنجاح!', 'success');
                };
                request.onerror = (e) => Swal.fire('خطأ', `فشل في حذف الزبون: ${e.target.error}`, 'error');
            }
        }
        
        async function printInvoice(invoiceId) {
            try {
                await ensureDBInitialized();
                const transaction = db.transaction(['invoices', 'customers'], 'readonly');
                const invoiceStore = transaction.objectStore('invoices');
                const invoiceRequest = invoiceStore.get(invoiceId);

                invoiceRequest.onsuccess = async () => {
                    const invoice = invoiceRequest.result;
                    if (!invoice) { Swal.fire('خطأ', 'الفاتورة غير موجودة.', 'error'); return; }

                    const customers = await getAllCustomers(); 
                    const customer = customers.find(c => c.id === invoice.customerId);
                    
                    const printWindow = window.open('', '_blank', 'height=800,width=600');
                    if (!printWindow) {
                         Swal.fire('خطأ', 'فشل فتح نافذة الطباعة. يرجى التأكد من تعطيل مانع النوافذ المنبثقة.', 'error'); return;
                    }
                    printWindow.document.write(`
                        <!DOCTYPE html>
                        <html lang="ar" dir="rtl">
                        <head>
                            <meta charset="UTF-8">
                            <title>فاتورة رقم: ${invoice.id}</title>
                            <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
                            <style>
                                @page { size: A5 landscape; margin: 5mm; }
                                body { font-family: 'Cairo', sans-serif; direction: rtl; margin: 5mm; font-size: 10pt; }
                                .container { width: 100%; margin: 0 auto; }
                                .header-print { text-align: center; margin-bottom: 10px; border-bottom: 1px solid #ccc; padding-bottom: 5px;}
                                .header-print img { max-height: 40px; margin-bottom: 3px; }
                                .header-print h1 { font-size: 1.1rem; color: #3F2A56; margin:0; }
                                .invoice-info-grid { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px;}
                                .invoice-details-text { flex-basis: 70%;} 
                                .invoice-details, .customer-details { font-size: 0.85rem;}
                                .invoice-details p, .customer-details p { margin: 2px 0; }
                                .qr-code-container { 
                                    flex-basis: auto; /* Adjust to content */
                                    min-width: 75px; 
                                    text-align: center; /* Center the QR code if div is wider */
                                    padding-left: 5px; 
                                } 
                                #invoiceQrCodeElement { /* The div where QR will be generated */
                                    display: inline-block; /* Helps with sizing and centering */
                                }
                                #invoiceQrCodeElement canvas,
                                #invoiceQrCodeElement img {
                                    border: 1px solid #eee; /* Add border to the QR itself */
                                }
                                .products-table { width: 100%; border-collapse: collapse; margin-bottom: 8px; }
                                .products-table th, .products-table td { padding: 4px; border: 1px solid #ccc; text-align: center; font-size: 0.8rem;}
                                .products-table th { background-color: #f2f2f2; color: #333; font-weight:600; }
                                .totals-section { margin-top: 10px; padding-top: 8px; border-top: 1px solid #ccc; text-align:left; font-size: 0.85rem;}
                                .totals-section p { margin: 3px 0; font-weight: 600; }
                                .footer-print { text-align: center; font-size: 0.75rem; margin-top: 15px; color: #777; }
                                @media print {
                                    body { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
                                }
                            </style>
                        </head>
                        <body>
                            <div class="container">
                                <div class="header-print">
                                    <img src="logo.png" alt="شعار" onerror="this.style.display='none';">
                                    <h1>طيبة المدينة تلكوم</h1>
                                    <p style="font-size:0.7rem;"><!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>بيع المنتجات</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!-- QR Code Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode@2.0.9/dist/html5-qrcode.min.js"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Cairo', sans-serif;
            background: linear-gradient(135deg, #f0f2f5, #d9e2ec);
            color: #333;
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .home-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: linear-gradient(90deg, #3F2A56, #5a3f73);
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            text-decoration: none;
            font-size: 1rem;
            font-weight: 600;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            transition: transform 0.2s ease, background 0.3s ease, box-shadow 0.3s ease;
            position: absolute;
            top: 20px;
            left: 20px;
        }
        .home-btn:hover {
            background: linear-gradient(90deg, #5a3f73, #3F2A56);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
        }
        .header {
            background: linear-gradient(135deg, #3F2A56, #5a3f73);
            color: white;
            padding: 40px 20px;
            border-radius: 25px;
            text-align: center;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
            margin-bottom: 30px;
            position: relative;
            z-index: 1;
            border: 2px solid rgba(255, 255, 255, 0.1);
        }
        .header img {
            height: 90px;
            margin-bottom: 15px;
            filter: drop-shadow(0 3px 6px rgba(0, 0, 0, 0.3));
        }
        .header h2 {
            font-size: 2.2rem;
            margin-bottom: 10px;
            font-weight: 700;
        }
        .header h4 {
            font-size: 1.4rem;
            opacity: 0.9;
            font-weight: 400;
        }
        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        .card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: #3F2A56;
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            text-align: center;
            transition: transform 0.3s ease;
        }
        .card:hover {
            transform: translateY(-10px);
        }
        .card i {
            font-size: 2.8rem;
            margin-bottom: 15px;
            color: #3F2A56;
        }
        .card h5 {
            font-size: 1.3rem;
            margin-bottom: 10px;
            font-weight: 600;
        }
        .card h3 {
            font-size: 1.8rem;
            font-weight: 700;
        }
        .section {
            background: white;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
            padding: 20px;
            margin: 20px 0;
        }
        .section h3 {
            font-size: 1.7rem;
            font-weight: 700;
            color: #3F2A56;
            margin-bottom: 15px;
            text-align: center;
        }
        .table-container {
            overflow-x: auto;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            padding: 12px;
            text-align: center;
            border-bottom: 1px solid #e0e0e0;
        }
        th {
            background: linear-gradient(90deg, #3F2A56, #5a3f73);
            color: white;
            font-weight: 700;
        }
        td {
            color: #3F2A56;
        }
        tr:hover {
            background-color: #f7f9fc;
        }
        .actions {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin: 25px 0;
            justify-content: center;
        }
        .btn {
            background: linear-gradient(90deg, #3F2A56, #5a3f73);
            color: white;
            padding: 12px 24px;
            border-radius: 30px;
            border: none;
            font-size: 1rem;
            cursor: pointer;
            transition: transform 0.2s ease, background 0.3s ease, box-shadow 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .btn:hover {
            background: linear-gradient(90deg, #5a3f73, #3F2A56);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.2);
        }
        .search-container {
            margin-bottom: 20px;
            display: flex;
            justify-content: center;
            align-items: flex-end; /* Align items to bottom for button */
            gap: 15px;
            flex-wrap: wrap;
        }
        .filter-group {
            display: flex;
            flex-direction: column;
            max-width: 200px;
        }
        .filter-group label {
            font-size: 0.9rem;
            font-weight: 600;
            color: #3F2A56;
            margin-bottom: 5px;
        }
        .filter-group input, .filter-group select {
            padding: 12px;
            border-radius: 30px;
            border: none;
            background: rgba(255, 255, 255, 0.1);
            color: #3F2A56;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        .filter-group input:focus, .filter-group select:focus {
            outline: none;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2);
        }
        #scanQrBtn {
            padding: 10px 15px; /* Adjust padding */
            height: 46px; /* Match input height */
            border-radius: 30px;
        }
         #qr-reader-container {
            margin-top: 10px;
            border: 1px solid #ccc;
            border-radius: 10px;
            padding:10px;
            background-color: #f9f9f9;
        }
        #qr-reader {
            width: 100%;
            max-width: 400px; /* Adjust as needed */
            margin: 0 auto;
        }

        .action-btn {
            cursor: pointer;
            margin: 0 6px;
            font-size: 1.3rem;
            transition: color 0.3s ease;
        }
        .action-btn.edit:hover { color: #007bff; }
        /* .action-btn.delete:hover { color: #dc3545; } */ /* Delete button removed from UI */
        .action-btn.print:hover { color: #28a745; }

        .modal-content {
            border-radius: 20px;
            background: linear-gradient(145deg, #ffffff, #f7f9fc);
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }
        .modal-header {
            background: linear-gradient(90deg, #3F2A56, #5a3f73);
            color: white;
            border-top-left-radius: 20px;
            border-top-right-radius: 20px;
            padding: 20px;
        }
        .modal-title {
            font-size: 1.5rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .modal-body {
            padding: 30px;
        }
        .modal-body .form-label {
            font-weight: 600;
            color: #3F2A56;
        }
        .modal-body .form-control, .modal-body .form-select {
            border-radius: 15px;
            padding: 12px;
            background: #f7f9fc;
            border: 1px solid #ddd;
        }
         .modal-body .form-control:focus, .modal-body .form-select:focus {
            border-color: #3F2A56;
            box-shadow: 0 0 0 0.25rem rgba(63, 42, 86, 0.25);
        }
        .modal-footer {
            padding: 20px;
            background: #f8f9fa;
            border-bottom-left-radius: 20px;
            border-bottom-right-radius: 20px;
        }
        .modal-footer .btn {
            padding: 12px 30px;
        }
        .product-table th, .product-table td {
            padding: 8px;
        }
        .modal-body .product-table th { /* Change header text color in modal product tables */
            color: white;
             background: linear-gradient(90deg, #3F2A56, #5a3f73); /* Optional: match main table header */
        }
        .status-paid { color: #198754; font-weight: 700; }
        .status-partial { color: #ffc107; font-weight: 700; }
        .status-unpaid { color: #dc3545; font-weight: 700; }
        .swal2-popup {
            font-family: 'Cairo', sans-serif !important;
            border-radius: 15px !important;
        }
        .swal2-title { color: #3F2A56 !important; }
        .swal2-html-container { text-align: right !important; }
        .swal2-confirm {
            background: linear-gradient(90deg, #3F2A56, #5a3f73) !important;
            border-radius: 20px !important;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2) !important;
        }
        .swal2-cancel, .swال2-deny {
            background: linear-gradient(90deg, #6c757d, #5a6268) !important;
            border-radius: 20px !important;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2) !important;
        }
        #productSuggestions div, #editProductSuggestions div {
            padding: 8px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        #productSuggestions div:hover, #editProductSuggestions div:hover {
            background-color: #f0f0f0;
        }

        @media (max-width: 768px) {
            .header { padding: 25px 15px; }
            .header img { height: 70px; }
            .header h2 { font-size: 1.7rem; }
            .btn { padding: 10px 18px; font-size: 0.9rem; }
            th, td { padding: 10px; font-size: 0.9rem; }
            .modal-body { padding: 20px; }
            .search-container { flex-direction: column; align-items: stretch;}
            .filter-group { max-width: none; }
            #scanQrBtn { width: 100%; margin-top: 10px;}
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <img src="logo.png" alt="شعار طيبة المدينة تلكوم" onerror="this.src='https://via.placeholder.com/90?text=Logo'; this.style.display='none';">
            <h2>طيبة المدينة تلكوم</h2>
            <h4>بيع المنتجات</h4>
            <a href="home.html" class="home-btn"><i class="fas fa-home"></i> للرئيسية</a>
        </div>
        <div class="dashboard">
            <div class="card">
                <i class="fas fa-check-circle"></i>
                <h5>الفواتير المدفوعة</h5>
                <h3 id="paidInvoices">0</h3>
            </div>
            <div class="card">
                <i class="fas fa-exclamation-circle"></i>
                <h5>الفواتير المدفوعة جزئيًا</h5>
                <h3 id="partialInvoices">0</h3>
            </div>
            <div class="card">
                <i class="fas fa-times-circle"></i>
                <h5>الفواتير غير المدفوعة</h5>
                <h3 id="unpaidInvoices">0</h3>
            </div>
        </div>
        <div class="actions">
            <button class="btn" data-bs-toggle="modal" data-bs-target="#addInvoiceModal"><i class="fas fa-plus"></i> إضافة فاتورة</button>
            <button class="btn" data-bs-toggle="modal" data-bs-target="#addCustomerModal"><i class="fas fa-user-plus"></i> إضافة زبون</button>
            <button class="btn" data-bs-toggle="modal" data-bs-target="#customerStatementModal"><i class="fas fa-file-alt"></i> كشف حساب زبون</button>
        </div>
        <div class="section">
            <h3>الفواتير</h3>
            <div class="search-container">
                <div class="filter-group">
                    <label for="searchInput">البحث</label>
                    <input type="text" id="searchInput" placeholder="ابحث بالزبون أو معرف الفاتورة" oninput="filterTable()">
                </div>
                <button id="scanQrBtn" class="btn btn-info" title="مسح QR Code للبحث عن فاتورة"><i class="fas fa-qrcode"></i> مسح</button>
                <div class="filter-group">
                    <label for="statusFilter">حالة الفاتورة</label>
                    <select id="statusFilter" onchange="filterTable()">
                        <option value="all">الكل</option>
                        <option value="paid">مدفوع</option>
                        <option value="partial">مدفوع جزئيًا</option>
                        <option value="unpaid">لم يتم الدفع</option>
                    </select>
                </div>
            </div>
             <div id="qr-reader-container" style="display: none;">
                <div id="qr-reader"></div>
                <button id="closeScannerBtn" class="btn btn-sm btn-danger mt-2" style="display:block; margin: 0 auto;">إغلاق الماسح</button>
            </div>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>معرف الفاتورة</th>
                            <th>الزبون</th>
                            <th>رقم الهاتف</th>
                            <th>المبلغ الكلي</th>
                            <th>حالة الفاتورة</th>
                            <th>الإجراءات</th>
                        </tr>
                    </thead>
                    <tbody id="invoicesTable"></tbody>
                </table>
            </div>
        </div>
        <div class="section">
            <h3>إدارة الزبائن</h3>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>الاسم</th>
                            <th>رقم الهاتف</th>
                            <th>العنوان</th>
                            <th>الإجراءات</th>
                        </tr>
                    </thead>
                    <tbody id="customersTable"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- نافذة إضافة فاتورة -->
    <div class="modal fade" id="addInvoiceModal" tabindex="-1" aria-labelledby="addInvoiceModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addInvoiceModalLabel"><i class="fas fa-file-invoice-dollar"></i> إضافة فاتورة جديدة</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="addInvoiceForm">
                        <div class="mb-3">
                            <label for="invoiceCustomer" class="form-label"><i class="fas fa-user"></i> الزبون</label>
                            <select class="form-select" id="invoiceCustomer" required>
                                <option value="">اختر زبونًا</option>
                            </select>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="customerPhoneDisplay" class="form-label"><i class="fas fa-phone"></i> رقم الهاتف</label>
                                <input type="text" class="form-control" id="customerPhoneDisplay" readonly>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="customerAddressDisplay" class="form-label"><i class="fas fa-map-marker-alt"></i> العنوان</label>
                                <input type="text" class="form-control" id="customerAddressDisplay" readonly>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="productSearch" class="form-label"><i class="fas fa-search"></i> البحث عن منتج</label>
                            <input type="text" class="form-control" id="productSearch" placeholder="ابحث بالاسم أو المعرف">
                            <div id="productSuggestions" class="mt-2 list-group" style="max-height: 150px; overflow-y: auto;"></div>
                        </div>
                        <h5><i class="fas fa-boxes"></i> المنتجات</h5>
                        <div class="table-container">
                            <table class="product-table table">
                                <thead>
                                    <tr>
                                        <th>اسم المنتج</th>
                                        <th>سعر البيع</th>
                                        <th>الكمية</th>
                                        <th>الملاحظة</th>
                                        <th>الإجمالي</th>
                                        <th>الإجراءات</th>
                                    </tr>
                                </thead>
                                <tbody id="invoiceProducts"></tbody>
                            </table>
                        </div>
                        <div class="mt-3">
                            <p><strong><i class="fas fa-calendar-alt"></i> التاريخ:</strong> <span id="invoiceDate"></span></p>
                            <p><strong><i class="fas fa-hashtag"></i> عدد المواد:</strong> <span id="totalItems">0</span></p>
                            <p><strong><i class="fas fa-coins"></i> المجموع الكلي:</strong> <span id="totalAmount">0.00</span></p>
                            <div class="mb-3">
                                <label for="amountPaid" class="form-label"><i class="fas fa-money-bill-wave"></i> المبلغ المدفوع</label>
                                <input type="number" class="form-control" id="amountPaid" step="0.01" min="0" value="0">
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
                    <button type="button" class="btn btn-primary" onclick="addInvoice()">حفظ الفاتورة</button>
                </div>
            </div>
        </div>
    </div>

    <!-- نافذة تعديل فاتورة -->
    <div class="modal fade" id="editInvoiceModal" tabindex="-1" aria-labelledby="editInvoiceModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editInvoiceModalLabel"><i class="fas fa-edit"></i> تعديل فاتورة</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="editInvoiceForm">
                        <input type="hidden" id="editInvoiceId">
                        <div class="mb-3">
                            <label for="editInvoiceCustomer" class="form-label"><i class="fas fa-user"></i> الزبون</label>
                            <select class="form-select" id="editInvoiceCustomer" required>
                                <option value="">اختر زبونًا</option>
                            </select>
                        </div>
                         <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="editCustomerPhoneDisplay" class="form-label"><i class="fas fa-phone"></i> رقم الهاتف</label>
                                <input type="text" class="form-control" id="editCustomerPhoneDisplay" readonly>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="editCustomerAddressDisplay" class="form-label"><i class="fas fa-map-marker-alt"></i> العنوان</label>
                                <input type="text" class="form-control" id="editCustomerAddressDisplay" readonly>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="editProductSearch" class="form-label"><i class="fas fa-search"></i> البحث عن منتج</label>
                            <input type="text" class="form-control" id="editProductSearch" placeholder="ابحث بالاسم أو المعرف">
                            <div id="editProductSuggestions" class="mt-2 list-group" style="max-height: 150px; overflow-y: auto;"></div>
                        </div>
                        <h5><i class="fas fa-boxes"></i> المنتجات</h5>
                        <div class="table-container">
                            <table class="product-table table">
                                <thead>
                                    <tr>
                                        <th>اسم المنتج</th>
                                        <th>سعر البيع</th>
                                        <th>الكمية</th>
                                        <th>الملاحظة</th>
                                        <th>الإجمالي</th>
                                        <th>الإجراءات</th>
                                    </tr>
                                </thead>
                                <tbody id="editInvoiceProducts"></tbody>
                            </table>
                        </div>
                        <div class="mt-3">
                            <p><strong><i class="fas fa-calendar-alt"></i> التاريخ:</strong> <span id="editInvoiceDate"></span></p>
                            <p><strong><i class="fas fa-hashtag"></i> عدد المواد:</strong> <span id="editTotalItems">0</span></p>
                            <p><strong><i class="fas fa-coins"></i> المجموع الكلي:</strong> <span id="editTotalAmount">0.00</span></p>
                            <div class="mb-3">
                                <label for="editAmountPaid" class="form-label"><i class="fas fa-money-bill-wave"></i> المبلغ المدفوع</label>
                                <input type="number" class="form-control" id="editAmountPaid" step="0.01" min="0" value="0">
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
                    <button type="button" class="btn btn-primary" onclick="updateInvoice()">حفظ التعديلات</button>
                </div>
            </div>
        </div>
    </div>

    <!-- نافذة إضافة زبون -->
    <div class="modal fade" id="addCustomerModal" tabindex="-1" aria-labelledby="addCustomerModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addCustomerModalLabel"><i class="fas fa-user-plus"></i> إضافة زبون</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="addCustomerForm">
                        <div class="mb-3">
                            <label for="customerName" class="form-label"><i class="fas fa-signature"></i> اسم الزبون (اختياري)</label>
                            <input type="text" class="form-control" id="customerName">
                        </div>
                        <div class="mb-3">
                            <label for="customerPhone" class="form-label"><i class="fas fa-mobile-alt"></i> رقم الهاتف (اختياري)</label>
                            <input type="tel" class="form-control" id="customerPhone">
                        </div>
                        <div class="mb-3">
                            <label for="customerAddress" class="form-label"><i class="fas fa-home"></i> العنوان (اختياري)</label>
                            <input type="text" class="form-control" id="customerAddress">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
                    <button type="button" class="btn btn-primary" onclick="addCustomer()">حفظ الزبون</button>
                </div>
            </div>
        </div>
    </div>

    <!-- نافذة تعديل زبون -->
    <div class="modal fade" id="editCustomerModal" tabindex="-1" aria-labelledby="editCustomerModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editCustomerModalLabel"><i class="fas fa-user-edit"></i> تعديل زبون</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="editCustomerForm">
                        <input type="hidden" id="editCustomerId">
                        <div class="mb-3">
                            <label for="editCustomerName" class="form-label"><i class="fas fa-signature"></i> اسم الزبون (اختياري)</label>
                            <input type="text" class="form-control" id="editCustomerName">
                        </div>
                        <div class="mb-3">
                            <label for="editCustomerPhone" class="form-label"><i class="fas fa-mobile-alt"></i> رقم الهاتف (اختياري)</label>
                            <input type="tel" class="form-control" id="editCustomerPhone">
                        </div>
                        <div class="mb-3">
                            <label for="editCustomerAddress" class="form-label"><i class="fas fa-home"></i> العنوان (اختياري)</label>
                            <input type="text" class="form-control" id="editCustomerAddress">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
                    <button type="button" class="btn btn-primary" onclick="updateCustomer()">حفظ التعديلات</button>
                </div>
            </div>
        </div>
    </div>

    <!-- نافذة كشف حساب زبون -->
    <div class="modal fade" id="customerStatementModal" tabindex="-1" aria-labelledby="customerStatementModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="customerStatementModalLabel"><i class="fas fa-file-invoice"></i> كشف حساب زبون</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="customerStatementForm">
                        <div class="mb-3">
                            <label for="statementCustomer" class="form-label"><i class="fas fa-user-check"></i> الزبون</label>
                            <select class="form-select" id="statementCustomer" required>
                                <option value="">اختر زبونًا</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="startDate" class="form-label"><i class="fas fa-calendar-day"></i> من تاريخ</label>
                            <input type="date" class="form-control" id="startDate" required>
                        </div>
                        <div class="mb-3">
                            <label for="endDate" class="form-label"><i class="fas fa-calendar-day"></i> إلى تاريخ</label>
                            <input type="date" class="form-control" id="endDate" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
                    <button type="button" class="btn btn-primary" onclick="generateCustomerStatement()">إنشاء الكشف</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let db;
        let html5QrCodeScanner; // For QR Code scanner instance

        // Helper function to format date as DD-MM-YYYY HH:MM
        function formatDateForDisplay(isoString) {
            if (!isoString) return 'N/A';
            const date = new Date(isoString);
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0'); // Months are 0-indexed
            const year = date.getFullYear();
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            return `${day}-${month}-${year} ${hours}:${minutes}`;
        }


        // إعداد IndexedDB
        function initDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open('InventoryDB', 2); 
                request.onupgradeneeded = (event) => {
                    db = event.target.result;
                    if (!db.objectStoreNames.contains('products')) {
                        db.createObjectStore('products', { keyPath: 'id' });
                    }
                    if (!db.objectStoreNames.contains('invoices')) {
                        const invoiceStore = db.createObjectStore('invoices', { keyPath: 'id' });
                        invoiceStore.createIndex('customerId', 'customerId', { unique: false });
                    }
                    if (!db.objectStoreNames.contains('customers')) {
                        const customerStore = db.createObjectStore('customers', { keyPath: 'id' });
                        customerStore.createIndex('phone', 'phone', { unique: false }); 
                    }
                };
                request.onsuccess = (event) => {
                    db = event.target.result;
                    resolve(db);
                };
                request.onerror = (event) => {
                    console.error("Database error: " + event.target.errorCode);
                    reject(event.target.error);
                };
            });
        }
        
        async function ensureDBInitialized() {
            if (!db) {
                try {
                    await initDB();
                } catch (error) {
                    console.error('Failed to initialize database:', error);
                    throw new Error('Failed to initialize database: ' + error.message);
                }
            }
            if (!db) { 
                throw new Error('Database not ready after initialization attempt.');
            }
        }

        async function generateUniqueId(storeName) {
            await ensureDBInitialized();
            let id;
            let isUnique = false;
            const existingIds = await getAllIds(storeName); 
            while (!isUnique) {
                id = Math.floor(10000 + Math.random() * 90000).toString();
                isUnique = !existingIds.includes(id);
            }
            return id;
        }

        function getAllIds(storeName) {
            return new Promise(async (resolve, reject) => {
                try {
                    await ensureDBInitialized();
                    const transaction = db.transaction([storeName], 'readonly');
                    const store = transaction.objectStore(storeName);
                    const request = store.getAllKeys(); 
                    request.onsuccess = () => {
                        resolve(request.result);
                    };
                    request.onerror = (event) => reject(event.target.error);
                } catch (error) {
                    reject(error);
                }
            });
        }

        function getAllProducts() {
            return new Promise(async (resolve, reject) => {
                try {
                    await ensureDBInitialized();
                    const transaction = db.transaction(['products'], 'readonly');
                    const store = transaction.objectStore('products');
                    const request = store.getAll();
                    request.onsuccess = () => resolve(request.result || []);
                    request.onerror = (event) => reject(event.target.error);
                } catch (error) {
                    reject(error);
                }
            });
        }
        
        function checkProductExists(productId) {
            return new Promise(async (resolve) => {
                try {
                    await ensureDBInitialized();
                    const transaction = db.transaction(['products'], 'readonly');
                    const store = transaction.objectStore('products');
                    const request = store.get(productId);
                    request.onsuccess = () => resolve(!!request.result); // True if product exists
                    request.onerror = () => resolve(false); // Error, assume not exists
                } catch (e) { resolve(false); }
            });
        }


        function getAllInvoices() {
            return new Promise(async (resolve, reject) => {
                try {
                    await ensureDBInitialized();
                    const transaction = db.transaction(['invoices'], 'readonly');
                    const store = transaction.objectStore('invoices');
                    const request = store.getAll();
                    request.onsuccess = () => resolve(request.result || []);
                    request.onerror = (event) => reject(event.target.error);
                } catch (error) {
                    reject(error);
                }
            });
        }

        function getAllCustomers() {
            return new Promise(async (resolve, reject) => {
                try {
                    await ensureDBInitialized();
                    const transaction = db.transaction(['customers'], 'readonly');
                    const store = transaction.objectStore('customers');
                    const request = store.getAll();
                    request.onsuccess = () => resolve(request.result || []);
                    request.onerror = (event) => reject(event.target.error);
                } catch (error) {
                    reject(error);
                }
            });
        }

        async function updateDashboard() {
            const invoices = await getAllInvoices();
            const paid = invoices.filter(i => parseFloat(i.amountPaid) >= parseFloat(i.totalAmount) && parseFloat(i.totalAmount) > 0).length;
            const partial = invoices.filter(i => parseFloat(i.amountPaid) > 0 && parseFloat(i.amountPaid) < parseFloat(i.totalAmount)).length;
            const unpaid = invoices.filter(i => parseFloat(i.amountPaid) === 0 && parseFloat(i.totalAmount) > 0).length;


            document.getElementById('paidInvoices').innerText = paid;
            document.getElementById('partialInvoices').innerText = partial;
            document.getElementById('unpaidInvoices').innerText = unpaid;
        }

        async function updateInvoicesTable() {
            const invoices = await getAllInvoices();
            const customers = await getAllCustomers();
            const tableBody = document.getElementById('invoicesTable');
            tableBody.innerHTML = '';

            invoices.sort((a, b) => new Date(b.date) - new Date(a.date)); 

            invoices.forEach((invoice, index) => {
                const customer = customers.find(c => c.id === invoice.customerId);
                const totalAmount = parseFloat(invoice.totalAmount);
                const amountPaid = parseFloat(invoice.amountPaid);
                let statusClass, statusText;

                if (totalAmount === 0 && amountPaid === 0) { // Consider invoices with 0 total and 0 paid (e.g. returns or empty)
                    statusClass = ''; // No specific class or a 'neutral' class
                    statusText = 'لا يوجد مبلغ';
                } else if (amountPaid >= totalAmount) {
                    statusClass = 'status-paid';
                    statusText = 'مدفوع';
                } else if (amountPaid > 0) {
                    statusClass = 'status-partial';
                    statusText = 'مدفوع جزئيًا';
                } else { // amountPaid is 0 and totalAmount > 0
                    statusClass = 'status-unpaid';
                    statusText = 'لم يتم الدفع';
                }


                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${invoice.id}</td>
                    <td>${customer?.name || 'زبون محذوف/غير معروف'}</td>
                    <td>${customer?.phone || '-'}</td>
                    <td>${totalAmount.toFixed(2)}</td>
                    <td class="${statusClass}">${statusText}</td>
                    <td>
                        <i class="fas fa-print action-btn print" onclick="printInvoice('${invoice.id}')" title="طباعة"></i>
                        <i class="fas fa-edit action-btn edit" onclick="editInvoice('${invoice.id}')" title="تعديل"></i>
                        <!-- Delete button removed from UI as requested -->
                    </td>
                `;
                tableBody.appendChild(row);
            });
            updateDashboard(); // Update dashboard after table is updated
            // filterTable(); // Call filterTable if you want to apply existing filters immediately after refresh
        }

        async function updateCustomersTable() {
            const customers = await getAllCustomers();
            const tableBody = document.getElementById('customersTable');
            tableBody.innerHTML = '';

            customers.forEach((customer, index) => {
                const row = document.createElement('tr');
                const displayName = customer.name || 'زبون بدون اسم';
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${displayName}</td>
                    <td>${customer.phone || '-'}</td>
                    <td>${customer.address || '-'}</td>
                    <td>
                        <i class="fas fa-edit action-btn edit" onclick="editCustomer('${customer.id}')" title="تعديل"></i>
                        <i class="fas fa-trash action-btn delete" onclick="deleteCustomer('${customer.id}')" title="حذف"></i>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }

        async function filterTable() {
            const searchInput = document.getElementById('searchInput').value.toLowerCase();
            const statusFilter = document.getElementById('statusFilter').value;
            const invoices = await getAllInvoices(); // Fetch fresh list
            const customers = await getAllCustomers(); // Fetch fresh list
            const tableBody = document.getElementById('invoicesTable');
            
            const filteredInvoices = invoices.filter(invoice => {
                const customer = customers.find(c => c.id === invoice.customerId);
                const customerName = customer?.name?.toLowerCase() || '';
                const matchesSearch = customerName.includes(searchInput) || invoice.id.includes(searchInput);
                
                if (!matchesSearch) return false;

                const totalAmount = parseFloat(invoice.totalAmount);
                const amountPaid = parseFloat(invoice.amountPaid);

                if (statusFilter === 'all') return true;
                if (statusFilter === 'paid') return amountPaid >= totalAmount && totalAmount > 0; // Ensure total > 0 for 'paid'
                if (statusFilter === 'partial') return amountPaid > 0 && amountPaid < totalAmount;
                if (statusFilter === 'unpaid') return amountPaid === 0 && totalAmount > 0; // Ensure total > 0 for 'unpaid'
                
                // This case should ideally not be reached if statusFilter has a valid value from the dropdown.
                // If it's reached, it means an unknown filter value, so include the item.
                return true; 
            });

            tableBody.innerHTML = ''; 
            filteredInvoices.sort((a, b) => new Date(b.date) - new Date(a.date)); // Re-sort filtered results

            filteredInvoices.forEach((invoice, index) => {
                const customer = customers.find(c => c.id === invoice.customerId);
                const totalAmount = parseFloat(invoice.totalAmount);
                const amountPaid = parseFloat(invoice.amountPaid);
                let statusClass, statusText;

                 if (totalAmount === 0 && amountPaid === 0) {
                    statusClass = ''; statusText = 'لا يوجد مبلغ';
                } else if (amountPaid >= totalAmount) {
                    statusClass = 'status-paid'; statusText = 'مدفوع';
                } else if (amountPaid > 0) {
                    statusClass = 'status-partial'; statusText = 'مدفوع جزئيًا';
                } else {
                    statusClass = 'status-unpaid'; statusText = 'لم يتم الدفع';
                }

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${invoice.id}</td>
                    <td>${customer?.name || 'زبون محذوف/غير معروف'}</td>
                    <td>${customer?.phone || '-'}</td>
                    <td>${totalAmount.toFixed(2)}</td>
                    <td class="${statusClass}">${statusText}</td>
                    <td>
                        <i class="fas fa-print action-btn print" onclick="printInvoice('${invoice.id}')" title="طباعة"></i>
                        <i class="fas fa-edit action-btn edit" onclick="editInvoice('${invoice.id}')" title="تعديل"></i>
                    </td>
                `;
                tableBody.appendChild(row);
            });
            // No need to call updateDashboard here as it's called in updateInvoicesTable which is called by other functions.
            // However, if filterTable is called independently (e.g., on search input), then dashboard might need update based on filtered view, or just reflect all invoices.
            // For simplicity, let dashboard always reflect all invoices. It's updated by main table update functions.
        }


        async function populateCustomerSelect(selectElementId) {
            const customers = await getAllCustomers();
            const select = document.getElementById(selectElementId);
            const currentValue = select.value; // Preserve current selection if possible
            select.innerHTML = '<option value="">اختر زبونًا...</option>'; 
            customers.forEach(customer => {
                const option = document.createElement('option');
                option.value = customer.id;
                option.textContent = customer.name || `زبون (${customer.phone || 'معرف: ' + customer.id.slice(0,5)})`;
                select.appendChild(option);
            });
            if (currentValue) { // Attempt to restore selection
                 select.value = currentValue;
            }
        }

        async function updateCustomerInfo(selectElementId, phoneElementId, addressElementId) {
            const customerId = document.getElementById(selectElementId).value;
            const phoneInput = document.getElementById(phoneElementId);
            const addressInput = document.getElementById(addressElementId);

            if (customerId) {
                const customers = await getAllCustomers(); // Fetch fresh customer data
                const customer = customers.find(c => c.id === customerId);
                phoneInput.value = customer?.phone || '';
                addressInput.value = customer?.address || '';
            } else {
                phoneInput.value = '';
                addressInput.value = '';
            }
        }
        
        async function setupProductSearch(searchElementId, suggestionsElementId, productsTableId, isEditModal = false) {
            const searchInput = document.getElementById(searchElementId);
            const suggestionsDiv = document.getElementById(suggestionsElementId);
            
            searchInput.addEventListener('input', async (e) => {
                const query = e.target.value.toLowerCase().trim();
                suggestionsDiv.innerHTML = ''; 
                if (query.length < 1) return; 

                const allProducts = await getAllProducts();
                const availableProducts = allProducts.filter(p => p.quantity > 0); 
                
                const filteredProducts = availableProducts.filter(p => 
                    p.name.toLowerCase().includes(query) || 
                    p.id.includes(query)
                ).slice(0, 10); 

                if (filteredProducts.length > 0) {
                    filteredProducts.forEach(product => {
                        const div = document.createElement('div');
                        div.className = 'list-group-item list-group-item-action';
                        
                        const salePriceFormatted = parseFloat(product.salePrice || 0).toFixed(2);
                        
                        // --- MODIFICATION FOR costPrice ---
                        let costPriceFormatted;
                        if (typeof product.costPrice === 'number') { // Handles 0 as a valid cost price
                            costPriceFormatted = parseFloat(product.costPrice).toFixed(2);
                        } else if (product.costPrice && !isNaN(parseFloat(product.costPrice))) { // Handles string numbers
                            costPriceFormatted = parseFloat(product.costPrice).toFixed(2);
                        } else {
                            costPriceFormatted = 'غ/م'; // Not available or not a valid number
                        }
                        // --- END MODIFICATION ---
                        
                        div.innerHTML = `
                            <strong>${product.name}</strong> (المعرف: ${product.id}) <br>
                            <small>
                                سعر البيع: ${salePriceFormatted} | 
                                سعر الشراء: ${costPriceFormatted} | 
                                الكمية المتوفرة: ${product.quantity}
                            </small>
                        `;
                        div.onclick = () => {
                            addProductToInvoice(product, productsTableId);
                            searchInput.value = ''; 
                            suggestionsDiv.innerHTML = ''; 
                        };
                        suggestionsDiv.appendChild(div);
                    });
                } else {
                    suggestionsDiv.innerHTML = '<div class="list-group-item">لا توجد منتجات مطابقة أو غير متوفرة.</div>';
                }
            });
        }


        function addProductToInvoice(product, productsTableId) {
            const tableBody = document.getElementById(productsTableId);
            const existingRow = Array.from(tableBody.rows).find(row => row.dataset.productId === product.id);

            if (existingRow) {
                const quantityInput = existingRow.querySelector('.quantity');
                const currentQuantity = parseInt(quantityInput.value);
                if (currentQuantity < product.quantity) { 
                    quantityInput.value = currentQuantity + 1;
                } else {
                    Swal.fire('تنبيه', `الكمية المطلوبة للمنتج "${product.name}" تتجاوز المخزون المتاح (${product.quantity}).`, 'warning');
                    return;
                }
            } else {
                if (product.quantity < 1) { 
                     Swal.fire('تنبيه', `المنتج "${product.name}" غير متوفر في المخزون.`, 'warning');
                    return;
                }
                const row = tableBody.insertRow();
                row.dataset.productId = product.id; 
                
                row.innerHTML = `
                    <td>${product.name}</td>
                    <td><input type="number" class="form-control form-control-sm sale-price" value="${parseFloat(product.salePrice || 0).toFixed(2)}" step="0.01" min="0.01"></td>
                    <td><input type="number" class="form-control form-control-sm quantity" value="1" min="1" max="${product.quantity}"></td>
                    <td><input type="text" class="form-control form-control-sm note" placeholder="ملاحظة (اختياري)"></td>
                    <td class="total">${parseFloat(product.salePrice || 0).toFixed(2)}</td>
                    <td><button type="button" class="btn btn-sm btn-danger" onclick="removeProductFromInvoice(this.closest('tr'), '${productsTableId}')"><i class="fas fa-trash-alt"></i></button></td>
                `;
                row.querySelector('.sale-price').addEventListener('input', () => updateInvoiceTotals(productsTableId));
                row.querySelector('.quantity').addEventListener('input', (e) => {
                    const requestedQuantity = parseInt(e.target.value);
                    const maxQuantityForThisProduct = parseInt(e.target.max); // Use the max attribute of the input

                    if (requestedQuantity > maxQuantityForThisProduct) {
                        e.target.value = maxQuantityForThisProduct; 
                        Swal.fire('تنبيه', `الكمية المطلوبة للمنتج "${product.name}" تتجاوز المخزون المتاح (${maxQuantityForThisProduct}). تم التعديل للحد الأقصى.`, 'warning');
                    }
                    updateInvoiceTotals(productsTableId);
                });
            }
            updateInvoiceTotals(productsTableId);
        }


        function removeProductFromInvoice(rowElement, productsTableId) {
            rowElement.remove();
            updateInvoiceTotals(productsTableId);
        }

        function updateInvoiceTotals(productsTableId) {
            const tableBody = document.getElementById(productsTableId);
            const rows = tableBody.querySelectorAll('tr');
            let totalAmount = 0;
            let totalItemsCount = 0; 

            rows.forEach(row => {
                const salePriceInput = row.querySelector('.sale-price');
                const quantityInput = row.querySelector('.quantity');
                
                const salePrice = parseFloat(salePriceInput.value) || 0;
                const quantity = parseInt(quantityInput.value) || 0;
                
                const itemTotal = salePrice * quantity;
                row.querySelector('.total').textContent = itemTotal.toFixed(2);
                totalAmount += itemTotal;
                totalItemsCount++; 
            });

            const isEditModal = productsTableId === 'editInvoiceProducts';
            document.getElementById(isEditModal ? 'editTotalItems' : 'totalItems').textContent = totalItemsCount; 
            document.getElementById(isEditModal ? 'editTotalAmount' : 'totalAmount').textContent = totalAmount.toFixed(2);
        }

        async function addInvoice() {
            const customerId = document.getElementById('invoiceCustomer').value;
            const amountPaidValue = document.getElementById('amountPaid').value;
            const productsTable = document.getElementById('invoiceProducts');
            const rows = productsTable.querySelectorAll('tr');

            if (!customerId) {
                Swal.fire('خطأ', 'الرجاء اختيار زبون!', 'error'); return;
            }
            if (rows.length === 0) {
                Swal.fire('خطأ', 'الرجاء إضافة منتج واحد على الأقل للفاتورة!', 'error'); return;
            }
            const amountPaid = parseFloat(amountPaidValue);
            if (isNaN(amountPaid) || amountPaid < 0) {
                 Swal.fire('خطأ', 'المبلغ المدفوع غير صحيح!', 'error'); return;
            }

            const productsInInvoice = [];
            let totalAmount = 0;
            let stockUpdatePromises = [];

            for (const row of rows) {
                const productId = row.dataset.productId;
                const name = row.cells[0].textContent;
                const salePrice = parseFloat(row.querySelector('.sale-price').value);
                const quantitySold = parseInt(row.querySelector('.quantity').value);
                const note = row.querySelector('.note').value;
                const itemTotal = salePrice * quantitySold;

                if (isNaN(salePrice) || salePrice <=0 || isNaN(quantitySold) || quantitySold <=0) {
                    Swal.fire('خطأ', `بيانات غير صالحة للمنتج "${name}". تأكد من السعر والكمية.`, 'error'); return;
                }

                productsInInvoice.push({ productId, name, salePrice, quantity: quantitySold, note, total: itemTotal });
                totalAmount += itemTotal;
                stockUpdatePromises.push(updateProductStock(productId, quantitySold));
            }
             if (amountPaid > totalAmount) {
                Swal.fire('خطأ', 'المبلغ المدفوع لا يمكن أن يكون أكبر من المجموع الكلي للفاتورة!', 'error'); return;
            }

            try {
                await Promise.all(stockUpdatePromises); 
            } catch (error) {
                Swal.fire('خطأ في تحديث المخزون', error.message, 'error');
                return;
            }

            const id = await generateUniqueId('invoices');
            const invoice = {
                id,
                customerId,
                products: productsInInvoice,
                totalAmount: totalAmount.toFixed(2),
                amountPaid: amountPaid.toFixed(2),
                date: new Date().toISOString()
            };

            const transaction = db.transaction(['invoices'], 'readwrite');
            const store = transaction.objectStore('invoices');
            const request = store.add(invoice);

            request.onsuccess = async () => {
                await updateInvoicesTable(); // This also updates dashboard
                bootstrap.Modal.getInstance(document.getElementById('addInvoiceModal')).hide();
                document.getElementById('addInvoiceForm').reset();
                document.getElementById('invoiceProducts').innerHTML = ''; 
                document.getElementById('totalItems').textContent = '0';
                document.getElementById('totalAmount').textContent = '0.00';
                document.getElementById('customerPhoneDisplay').value = '';
                document.getElementById('customerAddressDisplay').value = '';
                document.getElementById('invoiceDate').textContent = formatDateForDisplay(new Date().toISOString()); // Reset date
                await populateCustomerSelect('invoiceCustomer'); 
                Swal.fire('نجاح', 'تم إضافة الفاتورة وتحديث المخزون بنجاح!', 'success');
            };
            request.onerror = (e) => {
                console.error("Error adding invoice:", e.target.error);
                Swal.fire('خطأ', 'فشل في إضافة الفاتورة!', 'error');
            };
        }
        
        function updateProductStock(productId, quantitySold) {
            return new Promise(async (resolve, reject) => {
                try {
                    await ensureDBInitialized();
                    const transaction = db.transaction(['products'], 'readwrite');
                    const store = transaction.objectStore('products');
                    const getRequest = store.get(productId);

                    getRequest.onsuccess = () => {
                        const product = getRequest.result;
                        if (!product) {
                            reject(new Error(`المنتج بالمعرف ${productId} غير موجود.`));
                            return;
                        }
                        if (product.quantity < quantitySold) {
                            reject(new Error(`الكمية المطلوبة للمنتج "${product.name}" (${quantitySold}) تتجاوز المخزون المتاح (${product.quantity}).`));
                            return;
                        }
                        product.quantity -= quantitySold;
                        const updateRequest = store.put(product);
                        updateRequest.onsuccess = () => resolve();
                        updateRequest.onerror = (e) => reject(new Error(`فشل تحديث مخزون المنتج ${product.name}: ${e.target.error}`));
                    };
                    getRequest.onerror = (e) => reject(new Error(`فشل جلب المنتج ${productId} لتحديث المخزون: ${e.target.error}`));
                } catch (dbError) {
                    reject(dbError);
                }
            });
        }


        async function editInvoice(invoiceId) {
            try {
                await ensureDBInitialized();
                const transaction = db.transaction(['invoices', 'customers', 'products'], 'readonly'); 
                const invoiceStore = transaction.objectStore('invoices');
                const invoiceRequest = invoiceStore.get(invoiceId);

                invoiceRequest.onsuccess = async () => {
                    const invoice = invoiceRequest.result;
                    if (!invoice) {
                        Swal.fire('خطأ', 'الفاتورة غير موجودة!', 'error');
                        return;
                    }
                    
                    document.getElementById('editInvoiceModal').dataset.originalProducts = JSON.stringify(invoice.products);
                    document.getElementById('editInvoiceId').value = invoice.id;
                    
                    const customerSelect = document.getElementById('editInvoiceCustomer');
                    await populateCustomerSelect('editInvoiceCustomer'); 
                    customerSelect.value = invoice.customerId;
                    await updateCustomerInfo('editInvoiceCustomer', 'editCustomerPhoneDisplay', 'editCustomerAddressDisplay');

                    document.getElementById('editInvoiceDate').textContent = formatDateForDisplay(invoice.date);
                    document.getElementById('editAmountPaid').value = parseFloat(invoice.amountPaid).toFixed(2);

                    const tableBody = document.getElementById('editInvoiceProducts');
                    tableBody.innerHTML = ''; 

                    const allProductsFromDB = await getAllProducts(); 

                    invoice.products.forEach(pInInvoice => {
                        const productDetailsFromDB = allProductsFromDB.find(pDB => pDB.id === pInInvoice.productId);
                        const currentStockInDB = productDetailsFromDB ? productDetailsFromDB.quantity : 0;
                        const maxQuantityForInput = currentStockInDB + pInInvoice.quantity;


                        const row = tableBody.insertRow();
                        row.dataset.productId = pInInvoice.productId;
                        row.dataset.originalQuantityInInvoice = pInInvoice.quantity; 
                        row.dataset.maxEditableQuantity = maxQuantityForInput;


                        row.innerHTML = `
                            <td>${pInInvoice.name}</td>
                            <td><input type="number" class="form-control form-control-sm sale-price" value="${parseFloat(pInInvoice.salePrice).toFixed(2)}" step="0.01" min="0.01"></td>
                            <td><input type="number" class="form-control form-control-sm quantity" value="${pInInvoice.quantity}" min="1" max="${maxQuantityForInput}"></td>
                            <td><input type="text" class="form-control form-control-sm note" value="${pInInvoice.note || ''}" placeholder="ملاحظة"></td>
                            <td class="total">${parseFloat(pInInvoice.total).toFixed(2)}</td>
                            <td><button type="button" class="btn btn-sm btn-danger" onclick="removeProductFromInvoice(this.closest('tr'), 'editInvoiceProducts')"><i class="fas fa-trash-alt"></i></button></td>
                        `;
                        row.querySelector('.sale-price').addEventListener('input', () => updateInvoiceTotals('editInvoiceProducts'));
                        row.querySelector('.quantity').addEventListener('input', (e) => {
                             const requestedQuantity = parseInt(e.target.value);
                             const maxAllowed = parseInt(e.target.max); 
                             if (requestedQuantity > maxAllowed) {
                                e.target.value = maxAllowed;
                                Swal.fire('تنبيه', `الكمية المطلوبة للمنتج "${pInInvoice.name}" تتجاوز المخزون المتاح. تم التعديل للحد الأقصى (${maxAllowed}).`, 'warning');
                            }
                            updateInvoiceTotals('editInvoiceProducts');
                        });
                    });

                    updateInvoiceTotals('editInvoiceProducts');
                    new bootstrap.Modal(document.getElementById('editInvoiceModal')).show();
                };
                invoiceRequest.onerror = (e) => Swal.fire('خطأ', `فشل في جلب الفاتورة: ${e.target.error}`, 'error');
            } catch (dbError) {
                 Swal.fire('خطأ قاعدة البيانات', `فشل: ${dbError.message}`, 'error');
            }
        }


        async function updateInvoice() {
            const id = document.getElementById('editInvoiceId').value;
            const customerId = document.getElementById('editInvoiceCustomer').value;
            const amountPaidValue = document.getElementById('editAmountPaid').value;
            const productsTable = document.getElementById('editInvoiceProducts');
            const rows = productsTable.querySelectorAll('tr');
            
            const originalProductsJSON = document.getElementById('editInvoiceModal').dataset.originalProducts;
            const originalProductsInInvoice = JSON.parse(originalProductsJSON || "[]"); 


            if (!customerId) { Swal.fire('خطأ', 'الرجاء اختيار زبون!', 'error'); return; }
            if (rows.length === 0) { Swal.fire('خطأ', 'الفاتورة يجب أن تحتوي على منتج واحد على الأقل!', 'error'); return; }
            const amountPaid = parseFloat(amountPaidValue);
             if (isNaN(amountPaid) || amountPaid < 0) { Swal.fire('خطأ', 'المبلغ المدفوع غير صحيح!', 'error'); return; }


            const updatedProductsInInvoice = [];
            let newTotalAmount = 0;
            let stockAdjustmentPromises = []; 

            for (const row of rows) {
                const productId = row.dataset.productId;
                const name = row.cells[0].textContent;
                const salePrice = parseFloat(row.querySelector('.sale-price').value);
                const newQuantitySold = parseInt(row.querySelector('.quantity').value);
                const note = row.querySelector('.note').value;
                const itemTotal = salePrice * newQuantitySold;

                if (isNaN(salePrice) || salePrice <=0 || isNaN(newQuantitySold) || newQuantitySold <=0) {
                    Swal.fire('خطأ', `بيانات غير صالحة للمنتج "${name}". تأكد من السعر والكمية.`, 'error'); return;
                }

                updatedProductsInInvoice.push({ productId, name, salePrice, quantity: newQuantitySold, note, total: itemTotal });
                newTotalAmount += itemTotal;

                const originalProductInfo = originalProductsInInvoice.find(p => p.productId === productId);
                const originalQuantitySoldInThisInvoice = originalProductInfo ? originalProductInfo.quantity : 0;
                
                const quantityChangeForStock = originalQuantitySoldInThisInvoice - newQuantitySold; 
                
                if (quantityChangeForStock !== 0) {
                    const productExists = await checkProductExists(productId);
                    if (productExists) {
                         stockAdjustmentPromises.push(adjustProductStock(productId, quantityChangeForStock));
                    } else {
                        console.warn(`Product ${productId} not found in DB. Skipping stock adjustment for this item.`);
                    }
                }
            }
            
            originalProductsInInvoice.forEach(async origP => {
                if (!updatedProductsInInvoice.some(updP => updP.productId === origP.productId)) {
                    const productExists = await checkProductExists(origP.productId);
                     if (productExists) {
                        stockAdjustmentPromises.push(adjustProductStock(origP.productId, origP.quantity)); 
                     } else {
                        console.warn(`Product ${origP.productId} (removed from invoice) not found in DB. Skipping stock adjustment for this item.`);
                     }
                }
            });


            if (amountPaid > newTotalAmount) {
                Swal.fire('خطأ', 'المبلغ المدفوع لا يمكن أن يكون أكبر من المجموع الكلي للفاتورة!', 'error'); return;
            }

            try {
                if (stockAdjustmentPromises.length > 0) {
                    await Promise.all(stockAdjustmentPromises);
                }
            } catch (error) {
                Swal.fire('خطأ في تحديث المخزون', error.message, 'error');
                return; 
            }
            
            let invoiceDateStr = document.getElementById('editInvoiceDate').textContent;
            let invoiceDateISO;
            if (invoiceDateStr && invoiceDateStr !== 'N/A') {
                const parts = invoiceDateStr.match(/(\d{2})-(\d{2})-(\d{4}) (\d{2}):(\d{2})/);
                if (parts) {
                    // parts[1]=day, parts[2]=month, parts[3]=year, parts[4]=hour, parts[5]=minute
                    invoiceDateISO = new Date(Date.UTC(parts[3], parts[2] - 1, parts[1], parts[4], parts[5])).toISOString();
                } else {
                    invoiceDateISO = new Date().toISOString(); 
                }
            } else {
                 invoiceDateISO = new Date().toISOString(); 
            }


            const invoice = {
                id,
                customerId,
                products: updatedProductsInInvoice,
                totalAmount: newTotalAmount.toFixed(2),
                amountPaid: amountPaid.toFixed(2),
                date: invoiceDateISO 
            };

            const transaction = db.transaction(['invoices'], 'readwrite');
            const store = transaction.objectStore('invoices');
            const request = store.put(invoice);

            request.onsuccess = async () => {
                await updateInvoicesTable(); // This also updates dashboard
                bootstrap.Modal.getInstance(document.getElementById('editInvoiceModal')).hide();
                Swal.fire('نجاح', 'تم تعديل الفاتورة وتحديث المخزون بنجاح!', 'success');
            };
            request.onerror = (e) => {
                 console.error("Error updating invoice:", e.target.error);
                 Swal.fire('خطأ', 'فشل في تعديل الفاتورة!', 'error');
            };
        }

        function adjustProductStock(productId, quantityChange) {
            return new Promise(async (resolve, reject) => {
                try {
                    await ensureDBInitialized();
                    const transaction = db.transaction(['products'], 'readwrite');
                    const store = transaction.objectStore('products');
                    const getRequest = store.get(productId);

                    getRequest.onsuccess = () => {
                        const product = getRequest.result;
                        if (!product) {
                            // It's possible a product was deleted from inventory system externally
                            // while it was still in an invoice. Log this instead of hard failing the whole invoice update.
                            console.warn(`المنتج بالمعرف ${productId} غير موجود لتعديل المخزون. سيتم تخطي هذا المنتج.`);
                            resolve(); // Resolve to not block other stock adjustments
                            return;
                        }
                        
                        const newStock = product.quantity + quantityChange;
                        if (newStock < 0) { 
                             reject(new Error(`لا يمكن أن يكون مخزون المنتج "${product.name}" سالبًا. التغيير المطلوب للمخزون: ${quantityChange}, المخزون الحالي: ${product.quantity}.`));
                             return;
                        }
                        product.quantity = newStock;

                        const updateRequest = store.put(product);
                        updateRequest.onsuccess = () => resolve();
                        updateRequest.onerror = (e) => reject(new Error(`فشل تعديل مخزون المنتج ${product.name}: ${e.target.error}`));
                    };
                    getRequest.onerror = (e) => reject(new Error(`فشل جلب المنتج ${productId} لتعديل المخزون: ${e.target.error}`));
                } catch (dbError) {
                    reject(dbError);
                }
            });
        }

        async function deleteInvoice(invoiceId) { // This function is not called from UI but kept for potential use
            const result = await Swal.fire({
                title: 'تأكيد الحذف',
                text: 'هل أنت متأكد من حذف هذه الفاتورة؟ سيتم إرجاع الكميات المباعة إلى المخزون.',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'نعم، احذف',
                cancelButtonText: 'إلغاء',
                confirmButtonColor: '#dc3545',
                cancelButtonColor: '#6c757d'
            });

            if (result.isConfirmed) {
                try {
                    await ensureDBInitialized();
                    const readTx = db.transaction(['invoices'], 'readonly'); 
                    const invoiceStoreRead = readTx.objectStore('invoices');
                    const getInvoiceRequest = invoiceStoreRead.get(invoiceId);

                    getInvoiceRequest.onsuccess = async () => {
                        const invoiceToDelete = getInvoiceRequest.result;
                        if (!invoiceToDelete) {
                            Swal.fire('خطأ', 'الفاتورة غير موجودة.', 'error');
                            return;
                        }

                        let stockReturnPromises = [];
                        for (const p of invoiceToDelete.products) {
                            const productExists = await checkProductExists(p.productId);
                            if (productExists) {
                                stockReturnPromises.push(adjustProductStock(p.productId, p.quantity));
                            } else {
                                console.warn(`Product ${p.productId} from deleted invoice not found. Stock not returned for this item.`);
                            }
                        }
                        
                        try {
                            if (stockReturnPromises.length > 0) {
                                await Promise.all(stockReturnPromises); 
                            }

                            const writeTxDelete = db.transaction(['invoices'], 'readwrite');
                            const invoiceStoreWrite = writeTxDelete.objectStore('invoices');
                            const deleteRequest = invoiceStoreWrite.delete(invoiceId);

                            deleteRequest.onsuccess = async () => {
                                await updateInvoicesTable(); // This also updates dashboard
                                Swal.fire('نجاح', 'تم حذف الفاتورة وإرجاع المنتجات للمخزون بنجاح!', 'success');
                            };
                            deleteRequest.onerror = (e) => {
                                console.error("Error deleting invoice:", e.target.error);
                                Swal.fire('خطأ', 'فشل في حذف الفاتورة! (قد يكون المخزون أُرجع).', 'error');
                            };

                        } catch (stockError) {
                            Swal.fire('خطأ في إرجاع المخزون', stockError.message, 'error');
                        }
                    };
                    getInvoiceRequest.onerror = (e) => Swal.fire('خطأ', `فشل في جلب الفاتورة للحذف: ${e.target.error}`, 'error');

                } catch (dbError) {
                     Swal.fire('خطأ قاعدة البيانات', `فشل: ${dbError.message}`, 'error');
                }
            }
        }


        async function addCustomer() {
            const name = document.getElementById('customerName').value.trim();
            const phone = document.getElementById('customerPhone').value.trim();
            const address = document.getElementById('customerAddress').value.trim();
            
            if (!name && !phone && !address) {
                 Swal.fire('خطأ', 'يجب إدخال معلومة واحدة على الأقل للزبون (الاسم أو الهاتف أو العنوان).', 'error');
                 return;
            }

            if (phone) { 
                const customers = await getAllCustomers();
                if (customers.some(c => c.phone === phone && phone !== '')) { // Ensure phone isn't empty string
                    Swal.fire('خطأ', 'رقم الهاتف هذا مُسجل لزبون آخر!', 'error');
                    return;
                }
            }


            const id = await generateUniqueId('customers');
            const customer = { 
                id, 
                name: name || null, // Store null if empty for consistency
                phone: phone || null, 
                address: address || null 
            };


            const transaction = db.transaction(['customers'], 'readwrite');
            const store = transaction.objectStore('customers');
            const request = store.add(customer);

            request.onsuccess = async () => {
                await updateCustomersTable();
                await populateCustomerSelect('invoiceCustomer');
                await populateCustomerSelect('editInvoiceCustomer');
                await populateCustomerSelect('statementCustomer');
                bootstrap.Modal.getInstance(document.getElementById('addCustomerModal')).hide();
                document.getElementById('addCustomerForm').reset();
                Swal.fire('نجاح', 'تم إضافة الزبون بنجاح!', 'success');
            };
            request.onerror = (e) => Swal.fire('خطأ', `فشل في إضافة الزبون: ${e.target.error}`, 'error');
        }

        async function editCustomer(customerId) {
            try {
                await ensureDBInitialized();
                const transaction = db.transaction(['customers'], 'readonly');
                const store = transaction.objectStore('customers');
                const request = store.get(customerId);

                request.onsuccess = () => {
                    const customer = request.result;
                    if (!customer) {
                        Swal.fire('خطأ', 'الزبون غير موجود!', 'error');
                        return;
                    }
                    document.getElementById('editCustomerId').value = customer.id;
                    document.getElementById('editCustomerName').value = customer.name || '';
                    document.getElementById('editCustomerPhone').value = customer.phone || '';
                    document.getElementById('editCustomerAddress').value = customer.address || '';
                    new bootstrap.Modal(document.getElementById('editCustomerModal')).show();
                };
                request.onerror = (e) => Swal.fire('خطأ', `فشل في جلب بيانات الزبون: ${e.target.error}`, 'error');
            } catch (dbError) {
                 Swal.fire('خطأ قاعدة البيانات', `فشل: ${dbError.message}`, 'error');
            }
        }

        async function updateCustomer() {
            const id = document.getElementById('editCustomerId').value;
            const name = document.getElementById('editCustomerName').value.trim();
            const phone = document.getElementById('editCustomerPhone').value.trim();
            const address = document.getElementById('editCustomerAddress').value.trim();

             if (!name && !phone && !address) {
                 Swal.fire('خطأ', 'يجب إدخال معلومة واحدة على الأقل للزبون.', 'error');
                 return;
            }

            if (phone) { 
                const customers = await getAllCustomers();
                if (customers.some(c => c.id !== id && c.phone === phone && phone !== '')) { 
                    Swal.fire('خطأ', 'رقم الهاتف هذا مُسجل لزبون آخر!', 'error');
                    return;
                }
            }

            const customer = { 
                id, 
                name: name || null, 
                phone: phone || null, 
                address: address || null 
            };
            const transaction = db.transaction(['customers'], 'readwrite');
            const store = transaction.objectStore('customers');
            const request = store.put(customer);

            request.onsuccess = async () => {
                await updateCustomersTable();
                await updateInvoicesTable(); // Refresh invoices in case customer name changed
                await populateCustomerSelect('invoiceCustomer');
                await populateCustomerSelect('editInvoiceCustomer');
                await populateCustomerSelect('statementCustomer');
                bootstrap.Modal.getInstance(document.getElementById('editCustomerModal')).hide();
                Swal.fire('نجاح', 'تم تعديل بيانات الزبون بنجاح!', 'success');
            };
            request.onerror = (e) => Swal.fire('خطأ', `فشل في تعديل بيانات الزبون: ${e.target.error}`, 'error');
        }

        async function deleteCustomer(customerId) {
            const invoices = await getAllInvoices();
            if (invoices.some(i => i.customerId === customerId)) {
                Swal.fire('لا يمكن الحذف', 'لا يمكن حذف هذا الزبون لأنه مرتبط بفواتير حالية. يرجى تعديل الفواتير المرتبطة به لزبون آخر أو حذفها (إذا كانت هذه الإمكانية متاحة).', 'error');
                return;
            }


            const result = await Swal.fire({
                title: 'تأكيد الحذف',
                text: 'هل أنت متأكد من حذف هذا الزبون؟ لا يمكن التراجع عن هذا الإجراء.',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'نعم، احذف',
                cancelButtonText: 'إلغاء',
                confirmButtonColor: '#dc3545'
            });

            if (result.isConfirmed) {
                const transaction = db.transaction(['customers'], 'readwrite');
                const store = transaction.objectStore('customers');
                const request = store.delete(customerId);

                request.onsuccess = async () => {
                    await updateCustomersTable();
                    await populateCustomerSelect('invoiceCustomer');
                    await populateCustomerSelect('editInvoiceCustomer');
                    await populateCustomerSelect('statementCustomer');
                    Swal.fire('نجاح', 'تم حذف الزبون بنجاح!', 'success');
                };
                request.onerror = (e) => Swal.fire('خطأ', `فشل في حذف الزبون: ${e.target.error}`, 'error');
            }
        }
        
        async function printInvoice(invoiceId) {
            try {
                await ensureDBInitialized();
                const transaction = db.transaction(['invoices', 'customers'], 'readonly');
                const invoiceStore = transaction.objectStore('invoices');
                const invoiceRequest = invoiceStore.get(invoiceId);

                invoiceRequest.onsuccess = async () => {
                    const invoice = invoiceRequest.result;
                    if (!invoice) { Swal.fire('خطأ', 'الفاتورة غير موجودة.', 'error'); return; }

                    const customers = await getAllCustomers(); 
                    const customer = customers.find(c => c.id === invoice.customerId);
                    
                    const printWindow = window.open('', '_blank', 'height=800,width=600');
                    if (!printWindow) {
                         Swal.fire('خطأ', 'فشل فتح نافذة الطباعة. يرجى التأكد من تعطيل مانع النوافذ المنبثقة.', 'error'); return;
                    }
                    printWindow.document.write(`
                        <!DOCTYPE html>
                        <html lang="ar" dir="rtl">
                        <head>
                            <meta charset="UTF-8">
                            <title>فاتورة رقم: ${invoice.id}</title>
                            <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
                            <style>
                                @page { size: A5 landscape; margin: 5mm; }
                                body { font-family: 'Cairo', sans-serif; direction: rtl; margin: 5mm; font-size: 10pt; }
                                .container { width: 100%; margin: 0 auto; }
                                .header-print { text-align: center; margin-bottom: 10px; border-bottom: 1px solid #ccc; padding-bottom: 5px;}
                                .header-print img { max-height: 40px; margin-bottom: 3px; }
                                .header-print h1 { font-size: 1.1rem; color: #3F2A56; margin:0; }
                                .invoice-info-grid { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px;}
                                .invoice-details-text { flex-basis: 70%;} 
                                .invoice-details, .customer-details { font-size: 0.85rem;}
                                .invoice-details p, .customer-details p { margin: 2px 0; }
                                .qr-code-container { 
                                    flex-basis: auto; /* Adjust to content */
                                    min-width: 75px; 
                                    text-align: center; /* Center the QR code if div is wider */
                                    padding-left: 5px; 
                                } 
                                #invoiceQrCodeElement { /* The div where QR will be generated */
                                    display: inline-block; /* Helps with sizing and centering */
                                }
                                #invoiceQrCodeElement canvas,
                                #invoiceQrCodeElement img {
                                    border: 1px solid #eee; /* Add border to the QR itself */
                                }
                                .products-table { width: 100%; border-collapse: collapse; margin-bottom: 8px; }
                                .products-table th, .products-table td { padding: 4px; border: 1px solid #ccc; text-align: center; font-size: 0.8rem;}
                                .products-table th { background-color: #f2f2f2; color: #333; font-weight:600; }
                                .totals-section { margin-top: 10px; padding-top: 8px; border-top: 1px solid #ccc; text-align:left; font-size: 0.85rem;}
                                .totals-section p { margin: 3px 0; font-weight: 600; }
                                .footer-print { text-align: center; font-size: 0.75rem; margin-top: 15px; color: #777; }
                                @media print {
                                    body { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
                                }
                            </style>
                        </head>
                        <body>
                            <div class="container">
                                <div class="header-print">
                                    <img src="logo.png" alt="شعار" onerror="this.style.display='none';">
                                    <h1>طيبة المدينة تلكوم</h1>
                                    <p style="font-size:0.7rem;">للاتصالات وخدمات الجوال</p>
                                </div>
                                
                                <div class="invoice-info-grid">
                                    <div class="invoice-details-text">
                                        <div class="invoice-details">
                                            <p><strong>رقم الفاتورة:</strong> ${invoice.id}</p>
                                            <p><strong>التاريخ:</strong> ${formatDateForDisplay(invoice.date)}</p>
                                        </div>
                                        <div class="customer-details">
                                            <p><strong>الزبون:</strong> ${customer?.name || 'زبون نقدي'}</p>
                                            ${customer?.phone ? `<p><strong>الهاتف:</strong> ${customer.phone}</p>` : ''}
                                            ${customer?.address ? `<p><strong>العنوان:</strong> ${customer.address}</p>` : ''}
                                        </div>
                                    </div>
                                    <div class="qr-code-container">
                                        <div id="invoiceQrCodeElement"></div> <!-- Target for QRCode.js -->
                                    </div>
                                </div>

                                <table class="products-table">
                                    <thead>
                                        <tr>
                                            <th>م</th>
                                            <th>البيان (اسم المنتج)</th>
                                            <th>س. الوحدة</th>
                                            <th>الكمية</th>
                                            <th>الإجمالي</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${invoice.products.map((p, index) => `
                                            <tr>
                                                <td>${index + 1}</td>
                                                <td style="text-align:right;">${p.name} ${p.note ? `(${p.note})` : ''}</td>
                                                <td>${parseFloat(p.salePrice).toFixed(2)}</td>
                                                <td>${p.quantity}</td>
                                                <td>${parseFloat(p.total).toFixed(2)}</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                                <div class="totals-section">
                                    <p>المجموع الكلي: ${parseFloat(invoice.totalAmount).toFixed(2)}</p>
                                    <p>المبلغ المدفوع: ${parseFloat(invoice.amountPaid).toFixed(2)}</p>
                                    <p>المتبقي: ${(parseFloat(invoice.totalAmount) - parseFloat(invoice.amountPaid)).toFixed(2)}</p>
                                </div>
                                <div class="footer-print">
                                    <p>شكراً لتعاملكم معنا!</p>
                                </div>
                            </div>
                            <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"><\/script>
                            <script>
                                window.onload = function() { // This is the onload for the print window's content
                                    var qrElement = document.getElementById('invoiceQrCodeElement');
                                    if (qrElement && typeof QRCode !== 'undefined') {
                                        new QRCode(qrElement, {
                                            text: "${invoice.id}",
                                            width: 65,
                                            height: 65,
                                            colorDark : "#000000",
                                            colorLight : "#ffffff",
                                            correctLevel : QRCode.CorrectLevel.H
                                        });
                                    } else {
                                        console.error("QR Code generation failed in print window: Element or QRCode library not found.");
                                    }
                                };
                            <\/script>
                        </body>
                        </html>
                    `);
                    printWindow.document.close(); 
                    printWindow.onload = function() { // This is for the parent window's reference to the new window object
                        // The new window's own window.onload (for its content) should have fired by now.
                        // Add a slight delay to ensure rendering is complete before the print dialog.
                        setTimeout(function() {
                            printWindow.focus();
                            printWindow.print();
                            // printWindow.close(); // Optional: Close after print dialog
                        }, 300); // 300ms delay, adjust if needed.
                    }
                };
                invoiceRequest.onerror = (e) => Swal.fire('خطأ', `فشل في جلب الفاتورة للطباعة: ${e.target.error}`, 'error');
            } catch (dbError) {
                 Swal.fire('خطأ قاعدة البيانات', `فشل: ${dbError.message}`, 'error');
            }
        }

        async function generateCustomerStatement() {
            const customerId = document.getElementById('statementCustomer').value;
            const startDateValue = document.getElementById('startDate').value;
            const endDateValue = document.getElementById('endDate').value;

            if (!customerId || !startDateValue || !endDateValue) {
                Swal.fire('خطأ', 'الرجاء اختيار الزبون وتحديد نطاق التاريخ بشكل كامل!', 'error');
                return;
            }
            
            const startDate = new Date(startDateValue);
            const endDate = new Date(endDateValue);
            endDate.setHours(23, 59, 59, 999); 


            if (startDate > endDate) {
                Swal.fire('خطأ', 'تاريخ البداية يجب أن يكون قبل أو نفس تاريخ النهاية!', 'error');
                return;
            }

            const invoices = await getAllInvoices();
            const customers = await getAllCustomers();
            const customer = customers.find(c => c.id === customerId);

            const filteredInvoices = invoices.filter(i => {
                const invoiceDate = new Date(i.date);
                return i.customerId === customerId && invoiceDate >= startDate && invoiceDate <= endDate;
            }).sort((a, b) => new Date(a.date) - new Date(b.date)); 

            const printWindow = window.open('', '_blank', 'height=800,width=600');
             if (!printWindow) {
                 Swal.fire('خطأ', 'فشل فتح نافذة الطباعة. يرجى التأكد من تعطيل مانع النوافذ المنبثقة.', 'error'); return;
             }
            printWindow.document.write(`
                <!DOCTYPE html>
                <html lang="ar" dir="rtl">
                <head>
                    <meta charset="UTF-8">
                    <title>كشف حساب الزبون: ${customer?.name || 'غير معروف'}</title>
                    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
                    <style>
                        @page { size: A4; margin: 10mm; }
                        body { font-family: 'Cairo', sans-serif; direction: rtl; margin: 10mm; font-size:10pt; }
                        .container { width: 100%; margin: 0 auto; }
                        .header-print { text-align: center; margin-bottom: 20px; border-bottom: 1px solid #ccc; padding-bottom:10px;}
                        .header-print img { max-height: 60px; margin-bottom: 5px;}
                        .header-print h1 { font-size: 1.4rem; color: #3F2A56; margin:0; }
                        .info { margin-bottom: 15px; font-size:0.95rem; }
                        .info p { margin: 4px 0; }
                        .statement-table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
                        .statement-table th, .statement-table td { padding: 8px; border: 1px solid #ccc; text-align: center; font-size:0.9rem; }
                        .statement-table th { background-color: #f2f2f2; color: #333; font-weight:600; }
                        .status-paid { color: #198754; font-weight: 700; }
                        .status-partial { color: #ffc107; font-weight: 700; }
                        .status-unpaid { color: #dc3545; font-weight: 700; }
                        .summary { margin-top: 20px; padding-top:10px; border-top: 1px solid #ccc; text-align:left; font-size:1rem;}
                        .summary p {margin: 5px 0; font-weight:600;}
                         @media print {
                            body { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
                        }
                    </style>
                </head>
                <body>
                    <div class="container">
                        <div class="header-print">
                             <img src="logo.png" alt="شعار" onerror="this.style.display='none';">
                            <h1>طيبة المدينة تلكوم</h1>
                            <h2>كشف حساب زبون</h2>
                        </div>
                        <div class="info">
                            <p><strong>الزبون:</strong> ${customer?.name || 'زبون غير محدد'}</p>
                            ${customer?.phone ? `<p><strong>الهاتف:</strong> ${customer.phone}</p>` : ''}
                            <p><strong>الفترة من:</strong> ${new Date(startDateValue).toLocaleDateString('ar-SA-u-nu-latn', { year: 'numeric', month: '2-digit', day: '2-digit' })}</p>
                            <p><strong>إلى:</strong> ${new Date(endDateValue).toLocaleDateString('ar-SA-u-nu-latn', { year: 'numeric', month: '2-digit', day: '2-digit' })}</p>
                        </div>
                        <table class="statement-table">
                            <thead>
                                <tr>
                                    <th>رقم الفاتورة</th>
                                    <th>التاريخ</th>
                                    <th>إجمالي الفاتورة</th>
                                    <th>المدفوع</th>
                                    <th>المتبقي</th>
                                    <th>الحالة</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${filteredInvoices.length > 0 ? filteredInvoices.map(i => {
                                    const totalAmount = parseFloat(i.totalAmount);
                                    const amountPaid = parseFloat(i.amountPaid);
                                    const remaining = totalAmount - amountPaid;
                                    let statusText, statusClassSuffix;
                                    if (totalAmount === 0 && amountPaid === 0) { statusText = 'لا يوجد مبلغ'; statusClassSuffix = '';}
                                    else if (amountPaid >= totalAmount) { statusText = 'مدفوع'; statusClassSuffix = 'paid'; }
                                    else if (amountPaid > 0) { statusText = 'مدفوع جزئيًا'; statusClassSuffix = 'partial'; }
                                    else { statusText = 'لم يتم الدفع'; statusClassSuffix = 'unpaid'; }
                                    

                                    return `
                                        <tr>
                                            <td>${i.id}</td>
                                            <td>${formatDateForDisplay(i.date)}</td>
                                            <td>${totalAmount.toFixed(2)}</td>
                                            <td>${amountPaid.toFixed(2)}</td>
                                            <td>${remaining.toFixed(2)}</td>
                                            <td class="status-${statusClassSuffix}">${statusText}</td>
                                        </tr>
                                    `;
                                }).join('') : '<tr><td colspan="6">لا توجد فواتير لهذا الزبون في الفترة المحددة.</td></tr>'}
                            </tbody>
                        </table>
                        ${filteredInvoices.length > 0 ? `
                        <div class="summary">
                            <p>إجمالي قيمة الفواتير: ${filteredInvoices.reduce((sum, i) => sum + parseFloat(i.totalAmount), 0).toFixed(2)}</p>
                            <p>إجمالي المدفوعات: ${filteredInvoices.reduce((sum, i) => sum + parseFloat(i.amountPaid), 0).toFixed(2)}</p>
                            <p>إجمالي المتبقي: ${filteredInvoices.reduce((sum, i) => sum + (parseFloat(i.totalAmount) - parseFloat(i.amountPaid)), 0).toFixed(2)}</p>
                        </div>
                        ` : ''}
                    </div>
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.onload = function() { // Parent window's reference onload
                setTimeout(function() { // Delay to ensure rendering, especially if print window has complex content
                    printWindow.focus();
                    printWindow.print();
                }, 300);
            }
            bootstrap.Modal.getInstance(document.getElementById('customerStatementModal')).hide();
            document.getElementById('customerStatementForm').reset();
        }

        function startQrScanner() {
            const qrReaderContainer = document.getElementById('qr-reader-container');
            
            if (html5QrCodeScanner) {
                 try {
                    if (html5QrCodeScanner.getState() === Html5QrcodeScannerState.SCANNING) {
                        stopQrScanner(); 
                    }
                 } catch (e) { console.warn("Error checking scanner state, attempting to stop anyway:", e); stopQrScanner(); }
            }

            qrReaderContainer.style.display = 'block';
            
            if (typeof Html5Qrcode === "undefined") {
                Swal.fire('خطأ', 'مكتبة مسح QR غير محملة بشكل صحيح.', 'error');
                qrReaderContainer.style.display = 'none'; 
                return;
            }

            html5QrCodeScanner = new Html5Qrcode("qr-reader"); 
            const qrCodeSuccessCallback = (decodedText, decodedResult) => {
                document.getElementById('searchInput').value = decodedText;
                filterTable();
                stopQrScanner(); 
                Swal.fire('نجاح!', `تم العثور على الفاتورة: ${decodedText}`, 'success');
            };
            const config = { fps: 10, qrbox: {width: 250, height: 250}, aspectRatio: 1.0 }; 
            
             html5QrCodeScanner.start(
                { facingMode: "environment" }, 
                config,
                qrCodeSuccessCallback,
                (errorMessage) => {
                    // console.warn(`QR Code no match or error: ${errorMessage}`);
                })
            .catch((err) => {
                console.error(`Unable to start QR scanning, error: ${err}`);
                Swal.fire('خطأ', 'لم يتمكن من تشغيل ماسح QR. تأكد من صلاحيات الكاميرا أو أن الكاميرا غير مستخدمة بواسطة تطبيق آخر.', 'error');
                stopQrScanner(); 
            });
        }

        function stopQrScanner() {
            const qrReaderContainer = document.getElementById('qr-reader-container');
            if (html5QrCodeScanner) {
                html5QrCodeScanner.stop().then(ignore => {
                    console.log("QR Code scanning stopped.");
                    if (html5QrCodeScanner && typeof html5QrCodeScanner.clear === 'function') {
                        html5QrCodeScanner.clear(); 
                    }
                    // html5QrCodeScanner = null; // Do not nullify here if you want to reuse, but for safety, it's good
                }).catch(err => {
                    console.error("Failed to stop QR Code scanner.", err);
                    // html5QrCodeScanner = null; 
                }).finally(() => {
                     qrReaderContainer.style.display = 'none'; 
                });
            } else {
                 qrReaderContainer.style.display = 'none'; 
            }
        }


        document.addEventListener('DOMContentLoaded', async () => {
            try {
                await initDB();
                await Promise.all([
                    updateInvoicesTable(), 
                    updateCustomersTable(),
                    populateCustomerSelect('invoiceCustomer'),
                    populateCustomerSelect('editInvoiceCustomer'),
                    populateCustomerSelect('statementCustomer')
                ]);
                
                setupProductSearch('productSearch', 'productSuggestions', 'invoiceProducts');
                setupProductSearch('editProductSearch', 'editProductSuggestions', 'editInvoiceProducts', true);
                
                document.getElementById('invoiceDate').textContent = formatDateForDisplay(new Date().toISOString());
                
                document.getElementById('invoiceCustomer').addEventListener('change', (e) => updateCustomerInfo('invoiceCustomer', 'customerPhoneDisplay', 'customerAddressDisplay'));
                document.getElementById('editInvoiceCustomer').addEventListener('change', (e) => updateCustomerInfo('editInvoiceCustomer', 'editCustomerPhoneDisplay', 'editCustomerAddressDisplay'));

                document.getElementById('scanQrBtn').addEventListener('click', startQrScanner);
                document.getElementById('closeScannerBtn').addEventListener('click', stopQrScanner);


            } catch (error) {
                console.error("Initialization failed:", error);
                Swal.fire('فشل التهيئة', `حدث خطأ أثناء تحميل الصفحة: ${error.message}`, 'error');
            }
        });
    </script>
</body>
</html><!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>بيع المنتجات</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!-- QR Code Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode@2.0.9/dist/html5-qrcode.min.js"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Cairo', sans-serif;
            background: linear-gradient(135deg, #f0f2f5, #d9e2ec);
            color: #333;
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .home-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: linear-gradient(90deg, #3F2A56, #5a3f73);
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            text-decoration: none;
            font-size: 1rem;
            font-weight: 600;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            transition: transform 0.2s ease, background 0.3s ease, box-shadow 0.3s ease;
            position: absolute;
            top: 20px;
            left: 20px;
        }
        .home-btn:hover {
            background: linear-gradient(90deg, #5a3f73, #3F2A56);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
        }
        .header {
            background: linear-gradient(135deg, #3F2A56, #5a3f73);
            color: white;
            padding: 40px 20px;
            border-radius: 25px;
            text-align: center;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
            margin-bottom: 30px;
            position: relative;
            z-index: 1;
            border: 2px solid rgba(255, 255, 255, 0.1);
        }
        .header img {
            height: 90px;
            margin-bottom: 15px;
            filter: drop-shadow(0 3px 6px rgba(0, 0, 0, 0.3));
        }
        .header h2 {
            font-size: 2.2rem;
            margin-bottom: 10px;
            font-weight: 700;
        }
        .header h4 {
            font-size: 1.4rem;
            opacity: 0.9;
            font-weight: 400;
        }
        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        .card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: #3F2A56;
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            text-align: center;
            transition: transform 0.3s ease;
        }
        .card:hover {
            transform: translateY(-10px);
        }
        .card i {
            font-size: 2.8rem;
            margin-bottom: 15px;
            color: #3F2A56;
        }
        .card h5 {
            font-size: 1.3rem;
            margin-bottom: 10px;
            font-weight: 600;
        }
        .card h3 {
            font-size: 1.8rem;
            font-weight: 700;
        }
        .section {
            background: white;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
            padding: 20px;
            margin: 20px 0;
        }
        .section h3 {
            font-size: 1.7rem;
            font-weight: 700;
            color: #3F2A56;
            margin-bottom: 15px;
            text-align: center;
        }
        .table-container {
            overflow-x: auto;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            padding: 12px;
            text-align: center;
            border-bottom: 1px solid #e0e0e0;
        }
        th {
            background: linear-gradient(90deg, #3F2A56, #5a3f73);
            color: white;
            font-weight: 700;
        }
        td {
            color: #3F2A56;
        }
        tr:hover {
            background-color: #f7f9fc;
        }
        .actions {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin: 25px 0;
            justify-content: center;
        }
        .btn {
            background: linear-gradient(90deg, #3F2A56, #5a3f73);
            color: white;
            padding: 12px 24px;
            border-radius: 30px;
            border: none;
            font-size: 1rem;
            cursor: pointer;
            transition: transform 0.2s ease, background 0.3s ease, box-shadow 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .btn:hover {
            background: linear-gradient(90deg, #5a3f73, #3F2A56);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.2);
        }
        .search-container {
            margin-bottom: 20px;
            display: flex;
            justify-content: center;
            align-items: flex-end; /* Align items to bottom for button */
            gap: 15px;
            flex-wrap: wrap;
        }
        .filter-group {
            display: flex;
            flex-direction: column;
            max-width: 200px;
        }
        .filter-group label {
            font-size: 0.9rem;
            font-weight: 600;
            color: #3F2A56;
            margin-bottom: 5px;
        }
        .filter-group input, .filter-group select {
            padding: 12px;
            border-radius: 30px;
            border: none;
            background: rgba(255, 255, 255, 0.1);
            color: #3F2A56;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        .filter-group input:focus, .filter-group select:focus {
            outline: none;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2);
        }
        #scanQrBtn {
            padding: 10px 15px; /* Adjust padding */
            height: 46px; /* Match input height */
            border-radius: 30px;
        }
         #qr-reader-container {
            margin-top: 10px;
            border: 1px solid #ccc;
            border-radius: 10px;
            padding:10px;
            background-color: #f9f9f9;
        }
        #qr-reader {
            width: 100%;
            max-width: 400px; /* Adjust as needed */
            margin: 0 auto;
        }

        .action-btn {
            cursor: pointer;
            margin: 0 6px;
            font-size: 1.3rem;
            transition: color 0.3s ease;
        }
        .action-btn.edit:hover { color: #007bff; }
        /* .action-btn.delete:hover { color: #dc3545; } */ /* Delete button removed from UI */
        .action-btn.print:hover { color: #28a745; }

        .modal-content {
            border-radius: 20px;
            background: linear-gradient(145deg, #ffffff, #f7f9fc);
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }
        .modal-header {
            background: linear-gradient(90deg, #3F2A56, #5a3f73);
            color: white;
            border-top-left-radius: 20px;
            border-top-right-radius: 20px;
            padding: 20px;
        }
        .modal-title {
            font-size: 1.5rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .modal-body {
            padding: 30px;
        }
        .modal-body .form-label {
            font-weight: 600;
            color: #3F2A56;
        }
        .modal-body .form-control, .modal-body .form-select {
            border-radius: 15px;
            padding: 12px;
            background: #f7f9fc;
            border: 1px solid #ddd;
        }
         .modal-body .form-control:focus, .modal-body .form-select:focus {
            border-color: #3F2A56;
            box-shadow: 0 0 0 0.25rem rgba(63, 42, 86, 0.25);
        }
        .modal-footer {
            padding: 20px;
            background: #f8f9fa;
            border-bottom-left-radius: 20px;
            border-bottom-right-radius: 20px;
        }
        .modal-footer .btn {
            padding: 12px 30px;
        }
        .product-table th, .product-table td {
            padding: 8px;
        }
        .modal-body .product-table th { /* Change header text color in modal product tables */
            color: white;
             background: linear-gradient(90deg, #3F2A56, #5a3f73); /* Optional: match main table header */
        }
        .status-paid { color: #198754; font-weight: 700; }
        .status-partial { color: #ffc107; font-weight: 700; }
        .status-unpaid { color: #dc3545; font-weight: 700; }
        .swal2-popup {
            font-family: 'Cairo', sans-serif !important;
            border-radius: 15px !important;
        }
        .swal2-title { color: #3F2A56 !important; }
        .swal2-html-container { text-align: right !important; }
        .swal2-confirm {
            background: linear-gradient(90deg, #3F2A56, #5a3f73) !important;
            border-radius: 20px !important;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2) !important;
        }
        .swal2-cancel, .swال2-deny {
            background: linear-gradient(90deg, #6c757d, #5a6268) !important;
            border-radius: 20px !important;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2) !important;
        }
        #productSuggestions div, #editProductSuggestions div {
            padding: 8px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        #productSuggestions div:hover, #editProductSuggestions div:hover {
            background-color: #f0f0f0;
        }

        @media (max-width: 768px) {
            .header { padding: 25px 15px; }
            .header img { height: 70px; }
            .header h2 { font-size: 1.7rem; }
            .btn { padding: 10px 18px; font-size: 0.9rem; }
            th, td { padding: 10px; font-size: 0.9rem; }
            .modal-body { padding: 20px; }
            .search-container { flex-direction: column; align-items: stretch;}
            .filter-group { max-width: none; }
            #scanQrBtn { width: 100%; margin-top: 10px;}
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <img src="logo.png" alt="شعار طيبة المدينة تلكوم" onerror="this.src='https://via.placeholder.com/90?text=Logo'; this.style.display='none';">
            <h2>طيبة المدينة تلكوم</h2>
            <h4>بيع المنتجات</h4>
            <a href="home.html" class="home-btn"><i class="fas fa-home"></i> للرئيسية</a>
        </div>
        <div class="dashboard">
            <div class="card">
                <i class="fas fa-check-circle"></i>
                <h5>الفواتير المدفوعة</h5>
                <h3 id="paidInvoices">0</h3>
            </div>
            <div class="card">
                <i class="fas fa-exclamation-circle"></i>
                <h5>الفواتير المدفوعة جزئيًا</h5>
                <h3 id="partialInvoices">0</h3>
            </div>
            <div class="card">
                <i class="fas fa-times-circle"></i>
                <h5>الفواتير غير المدفوعة</h5>
                <h3 id="unpaidInvoices">0</h3>
            </div>
        </div>
        <div class="actions">
            <button class="btn" data-bs-toggle="modal" data-bs-target="#addInvoiceModal"><i class="fas fa-plus"></i> إضافة فاتورة</button>
            <button class="btn" data-bs-toggle="modal" data-bs-target="#addCustomerModal"><i class="fas fa-user-plus"></i> إضافة زبون</button>
            <button class="btn" data-bs-toggle="modal" data-bs-target="#customerStatementModal"><i class="fas fa-file-alt"></i> كشف حساب زبون</button>
        </div>
        <div class="section">
            <h3>الفواتير</h3>
            <div class="search-container">
                <div class="filter-group">
                    <label for="searchInput">البحث</label>
                    <input type="text" id="searchInput" placeholder="ابحث بالزبون أو معرف الفاتورة" oninput="filterTable()">
                </div>
                <button id="scanQrBtn" class="btn btn-info" title="مسح QR Code للبحث عن فاتورة"><i class="fas fa-qrcode"></i> مسح</button>
                <div class="filter-group">
                    <label for="statusFilter">حالة الفاتورة</label>
                    <select id="statusFilter" onchange="filterTable()">
                        <option value="all">الكل</option>
                        <option value="paid">مدفوع</option>
                        <option value="partial">مدفوع جزئيًا</option>
                        <option value="unpaid">لم يتم الدفع</option>
                    </select>
                </div>
            </div>
             <div id="qr-reader-container" style="display: none;">
                <div id="qr-reader"></div>
                <button id="closeScannerBtn" class="btn btn-sm btn-danger mt-2" style="display:block; margin: 0 auto;">إغلاق الماسح</button>
            </div>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>معرف الفاتورة</th>
                            <th>الزبون</th>
                            <th>رقم الهاتف</th>
                            <th>المبلغ الكلي</th>
                            <th>حالة الفاتورة</th>
                            <th>الإجراءات</th>
                        </tr>
                    </thead>
                    <tbody id="invoicesTable"></tbody>
                </table>
            </div>
        </div>
        <div class="section">
            <h3>إدارة الزبائن</h3>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>الاسم</th>
                            <th>رقم الهاتف</th>
                            <th>العنوان</th>
                            <th>الإجراءات</th>
                        </tr>
                    </thead>
                    <tbody id="customersTable"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- نافذة إضافة فاتورة -->
    <div class="modal fade" id="addInvoiceModal" tabindex="-1" aria-labelledby="addInvoiceModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addInvoiceModalLabel"><i class="fas fa-file-invoice-dollar"></i> إضافة فاتورة جديدة</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="addInvoiceForm">
                        <div class="mb-3">
                            <label for="invoiceCustomer" class="form-label"><i class="fas fa-user"></i> الزبون</label>
                            <select class="form-select" id="invoiceCustomer" required>
                                <option value="">اختر زبونًا</option>
                            </select>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="customerPhoneDisplay" class="form-label"><i class="fas fa-phone"></i> رقم الهاتف</label>
                                <input type="text" class="form-control" id="customerPhoneDisplay" readonly>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="customerAddressDisplay" class="form-label"><i class="fas fa-map-marker-alt"></i> العنوان</label>
                                <input type="text" class="form-control" id="customerAddressDisplay" readonly>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="productSearch" class="form-label"><i class="fas fa-search"></i> البحث عن منتج</label>
                            <input type="text" class="form-control" id="productSearch" placeholder="ابحث بالاسم أو المعرف">
                            <div id="productSuggestions" class="mt-2 list-group" style="max-height: 150px; overflow-y: auto;"></div>
                        </div>
                        <h5><i class="fas fa-boxes"></i> المنتجات</h5>
                        <div class="table-container">
                            <table class="product-table table">
                                <thead>
                                    <tr>
                                        <th>اسم المنتج</th>
                                        <th>سعر البيع</th>
                                        <th>الكمية</th>
                                        <th>الملاحظة</th>
                                        <th>الإجمالي</th>
                                        <th>الإجراءات</th>
                                    </tr>
                                </thead>
                                <tbody id="invoiceProducts"></tbody>
                            </table>
                        </div>
                        <div class="mt-3">
                            <p><strong><i class="fas fa-calendar-alt"></i> التاريخ:</strong> <span id="invoiceDate"></span></p>
                            <p><strong><i class="fas fa-hashtag"></i> عدد المواد:</strong> <span id="totalItems">0</span></p>
                            <p><strong><i class="fas fa-coins"></i> المجموع الكلي:</strong> <span id="totalAmount">0.00</span></p>
                            <div class="mb-3">
                                <label for="amountPaid" class="form-label"><i class="fas fa-money-bill-wave"></i> المبلغ المدفوع</label>
                                <input type="number" class="form-control" id="amountPaid" step="0.01" min="0" value="0">
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
                    <button type="button" class="btn btn-primary" onclick="addInvoice()">حفظ الفاتورة</button>
                </div>
            </div>
        </div>
    </div>

    <!-- نافذة تعديل فاتورة -->
    <div class="modal fade" id="editInvoiceModal" tabindex="-1" aria-labelledby="editInvoiceModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editInvoiceModalLabel"><i class="fas fa-edit"></i> تعديل فاتورة</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="editInvoiceForm">
                        <input type="hidden" id="editInvoiceId">
                        <div class="mb-3">
                            <label for="editInvoiceCustomer" class="form-label"><i class="fas fa-user"></i> الزبون</label>
                            <select class="form-select" id="editInvoiceCustomer" required>
                                <option value="">اختر زبونًا</option>
                            </select>
                        </div>
                         <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="editCustomerPhoneDisplay" class="form-label"><i class="fas fa-phone"></i> رقم الهاتف</label>
                                <input type="text" class="form-control" id="editCustomerPhoneDisplay" readonly>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="editCustomerAddressDisplay" class="form-label"><i class="fas fa-map-marker-alt"></i> العنوان</label>
                                <input type="text" class="form-control" id="editCustomerAddressDisplay" readonly>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="editProductSearch" class="form-label"><i class="fas fa-search"></i> البحث عن منتج</label>
                            <input type="text" class="form-control" id="editProductSearch" placeholder="ابحث بالاسم أو المعرف">
                            <div id="editProductSuggestions" class="mt-2 list-group" style="max-height: 150px; overflow-y: auto;"></div>
                        </div>
                        <h5><i class="fas fa-boxes"></i> المنتجات</h5>
                        <div class="table-container">
                            <table class="product-table table">
                                <thead>
                                    <tr>
                                        <th>اسم المنتج</th>
                                        <th>سعر البيع</th>
                                        <th>الكمية</th>
                                        <th>الملاحظة</th>
                                        <th>الإجمالي</th>
                                        <th>الإجراءات</th>
                                    </tr>
                                </thead>
                                <tbody id="editInvoiceProducts"></tbody>
                            </table>
                        </div>
                        <div class="mt-3">
                            <p><strong><i class="fas fa-calendar-alt"></i> التاريخ:</strong> <span id="editInvoiceDate"></span></p>
                            <p><strong><i class="fas fa-hashtag"></i> عدد المواد:</strong> <span id="editTotalItems">0</span></p>
                            <p><strong><i class="fas fa-coins"></i> المجموع الكلي:</strong> <span id="editTotalAmount">0.00</span></p>
                            <div class="mb-3">
                                <label for="editAmountPaid" class="form-label"><i class="fas fa-money-bill-wave"></i> المبلغ المدفوع</label>
                                <input type="number" class="form-control" id="editAmountPaid" step="0.01" min="0" value="0">
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
                    <button type="button" class="btn btn-primary" onclick="updateInvoice()">حفظ التعديلات</button>
                </div>
            </div>
        </div>
    </div>

    <!-- نافذة إضافة زبون -->
    <div class="modal fade" id="addCustomerModal" tabindex="-1" aria-labelledby="addCustomerModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addCustomerModalLabel"><i class="fas fa-user-plus"></i> إضافة زبون</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="addCustomerForm">
                        <div class="mb-3">
                            <label for="customerName" class="form-label"><i class="fas fa-signature"></i> اسم الزبون (اختياري)</label>
                            <input type="text" class="form-control" id="customerName">
                        </div>
                        <div class="mb-3">
                            <label for="customerPhone" class="form-label"><i class="fas fa-mobile-alt"></i> رقم الهاتف (اختياري)</label>
                            <input type="tel" class="form-control" id="customerPhone">
                        </div>
                        <div class="mb-3">
                            <label for="customerAddress" class="form-label"><i class="fas fa-home"></i> العنوان (اختياري)</label>
                            <input type="text" class="form-control" id="customerAddress">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
                    <button type="button" class="btn btn-primary" onclick="addCustomer()">حفظ الزبون</button>
                </div>
            </div>
        </div>
    </div>

    <!-- نافذة تعديل زبون -->
    <div class="modal fade" id="editCustomerModal" tabindex="-1" aria-labelledby="editCustomerModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editCustomerModalLabel"><i class="fas fa-user-edit"></i> تعديل زبون</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="editCustomerForm">
                        <input type="hidden" id="editCustomerId">
                        <div class="mb-3">
                            <label for="editCustomerName" class="form-label"><i class="fas fa-signature"></i> اسم الزبون (اختياري)</label>
                            <input type="text" class="form-control" id="editCustomerName">
                        </div>
                        <div class="mb-3">
                            <label for="editCustomerPhone" class="form-label"><i class="fas fa-mobile-alt"></i> رقم الهاتف (اختياري)</label>
                            <input type="tel" class="form-control" id="editCustomerPhone">
                        </div>
                        <div class="mb-3">
                            <label for="editCustomerAddress" class="form-label"><i class="fas fa-home"></i> العنوان (اختياري)</label>
                            <input type="text" class="form-control" id="editCustomerAddress">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
                    <button type="button" class="btn btn-primary" onclick="updateCustomer()">حفظ التعديلات</button>
                </div>
            </div>
        </div>
    </div>

    <!-- نافذة كشف حساب زبون -->
    <div class="modal fade" id="customerStatementModal" tabindex="-1" aria-labelledby="customerStatementModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="customerStatementModalLabel"><i class="fas fa-file-invoice"></i> كشف حساب زبون</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="customerStatementForm">
                        <div class="mb-3">
                            <label for="statementCustomer" class="form-label"><i class="fas fa-user-check"></i> الزبون</label>
                            <select class="form-select" id="statementCustomer" required>
                                <option value="">اختر زبونًا</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="startDate" class="form-label"><i class="fas fa-calendar-day"></i> من تاريخ</label>
                            <input type="date" class="form-control" id="startDate" required>
                        </div>
                        <div class="mb-3">
                            <label for="endDate" class="form-label"><i class="fas fa-calendar-day"></i> إلى تاريخ</label>
                            <input type="date" class="form-control" id="endDate" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
                    <button type="button" class="btn btn-primary" onclick="generateCustomerStatement()">إنشاء الكشف</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let db;
        let html5QrCodeScanner; // For QR Code scanner instance

        // Helper function to format date as DD-MM-YYYY HH:MM
        function formatDateForDisplay(isoString) {
            if (!isoString) return 'N/A';
            const date = new Date(isoString);
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0'); // Months are 0-indexed
            const year = date.getFullYear();
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            return `${day}-${month}-${year} ${hours}:${minutes}`;
        }


        // إعداد IndexedDB
        function initDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open('InventoryDB', 2); 
                request.onupgradeneeded = (event) => {
                    db = event.target.result;
                    if (!db.objectStoreNames.contains('products')) {
                        db.createObjectStore('products', { keyPath: 'id' });
                    }
                    if (!db.objectStoreNames.contains('invoices')) {
                        const invoiceStore = db.createObjectStore('invoices', { keyPath: 'id' });
                        invoiceStore.createIndex('customerId', 'customerId', { unique: false });
                    }
                    if (!db.objectStoreNames.contains('customers')) {
                        const customerStore = db.createObjectStore('customers', { keyPath: 'id' });
                        customerStore.createIndex('phone', 'phone', { unique: false }); 
                    }
                };
                request.onsuccess = (event) => {
                    db = event.target.result;
                    resolve(db);
                };
                request.onerror = (event) => {
                    console.error("Database error: " + event.target.errorCode);
                    reject(event.target.error);
                };
            });
        }
        
        async function ensureDBInitialized() {
            if (!db) {
                try {
                    await initDB();
                } catch (error) {
                    console.error('Failed to initialize database:', error);
                    throw new Error('Failed to initialize database: ' + error.message);
                }
            }
            if (!db) { 
                throw new Error('Database not ready after initialization attempt.');
            }
        }

        async function generateUniqueId(storeName) {
            await ensureDBInitialized();
            let id;
            let isUnique = false;
            const existingIds = await getAllIds(storeName); 
            while (!isUnique) {
                id = Math.floor(10000 + Math.random() * 90000).toString();
                isUnique = !existingIds.includes(id);
            }
            return id;
        }

        function getAllIds(storeName) {
            return new Promise(async (resolve, reject) => {
                try {
                    await ensureDBInitialized();
                    const transaction = db.transaction([storeName], 'readonly');
                    const store = transaction.objectStore(storeName);
                    const request = store.getAllKeys(); 
                    request.onsuccess = () => {
                        resolve(request.result);
                    };
                    request.onerror = (event) => reject(event.target.error);
                } catch (error) {
                    reject(error);
                }
            });
        }

        function getAllProducts() {
            return new Promise(async (resolve, reject) => {
                try {
                    await ensureDBInitialized();
                    const transaction = db.transaction(['products'], 'readonly');
                    const store = transaction.objectStore('products');
                    const request = store.getAll();
                    request.onsuccess = () => resolve(request.result || []);
                    request.onerror = (event) => reject(event.target.error);
                } catch (error) {
                    reject(error);
                }
            });
        }
        
        function checkProductExists(productId) {
            return new Promise(async (resolve) => {
                try {
                    await ensureDBInitialized();
                    const transaction = db.transaction(['products'], 'readonly');
                    const store = transaction.objectStore('products');
                    const request = store.get(productId);
                    request.onsuccess = () => resolve(!!request.result); // True if product exists
                    request.onerror = () => resolve(false); // Error, assume not exists
                } catch (e) { resolve(false); }
            });
        }


        function getAllInvoices() {
            return new Promise(async (resolve, reject) => {
                try {
                    await ensureDBInitialized();
                    const transaction = db.transaction(['invoices'], 'readonly');
                    const store = transaction.objectStore('invoices');
                    const request = store.getAll();
                    request.onsuccess = () => resolve(request.result || []);
                    request.onerror = (event) => reject(event.target.error);
                } catch (error) {
                    reject(error);
                }
            });
        }

        function getAllCustomers() {
            return new Promise(async (resolve, reject) => {
                try {
                    await ensureDBInitialized();
                    const transaction = db.transaction(['customers'], 'readonly');
                    const store = transaction.objectStore('customers');
                    const request = store.getAll();
                    request.onsuccess = () => resolve(request.result || []);
                    request.onerror = (event) => reject(event.target.error);
                } catch (error) {
                    reject(error);
                }
            });
        }

        async function updateDashboard() {
            const invoices = await getAllInvoices();
            const paid = invoices.filter(i => parseFloat(i.amountPaid) >= parseFloat(i.totalAmount) && parseFloat(i.totalAmount) > 0).length;
            const partial = invoices.filter(i => parseFloat(i.amountPaid) > 0 && parseFloat(i.amountPaid) < parseFloat(i.totalAmount)).length;
            const unpaid = invoices.filter(i => parseFloat(i.amountPaid) === 0 && parseFloat(i.totalAmount) > 0).length;


            document.getElementById('paidInvoices').innerText = paid;
            document.getElementById('partialInvoices').innerText = partial;
            document.getElementById('unpaidInvoices').innerText = unpaid;
        }

        async function updateInvoicesTable() {
            const invoices = await getAllInvoices();
            const customers = await getAllCustomers();
            const tableBody = document.getElementById('invoicesTable');
            tableBody.innerHTML = '';

            invoices.sort((a, b) => new Date(b.date) - new Date(a.date)); 

            invoices.forEach((invoice, index) => {
                const customer = customers.find(c => c.id === invoice.customerId);
                const totalAmount = parseFloat(invoice.totalAmount);
                const amountPaid = parseFloat(invoice.amountPaid);
                let statusClass, statusText;

                if (totalAmount === 0 && amountPaid === 0) { // Consider invoices with 0 total and 0 paid (e.g. returns or empty)
                    statusClass = ''; // No specific class or a 'neutral' class
                    statusText = 'لا يوجد مبلغ';
                } else if (amountPaid >= totalAmount) {
                    statusClass = 'status-paid';
                    statusText = 'مدفوع';
                } else if (amountPaid > 0) {
                    statusClass = 'status-partial';
                    statusText = 'مدفوع جزئيًا';
                } else { // amountPaid is 0 and totalAmount > 0
                    statusClass = 'status-unpaid';
                    statusText = 'لم يتم الدفع';
                }


                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${invoice.id}</td>
                    <td>${customer?.name || 'زبون محذوف/غير معروف'}</td>
                    <td>${customer?.phone || '-'}</td>
                    <td>${totalAmount.toFixed(2)}</td>
                    <td class="${statusClass}">${statusText}</td>
                    <td>
                        <i class="fas fa-print action-btn print" onclick="printInvoice('${invoice.id}')" title="طباعة"></i>
                        <i class="fas fa-edit action-btn edit" onclick="editInvoice('${invoice.id}')" title="تعديل"></i>
                        <!-- Delete button removed from UI as requested -->
                    </td>
                `;
                tableBody.appendChild(row);
            });
            updateDashboard(); // Update dashboard after table is updated
            // filterTable(); // Call filterTable if you want to apply existing filters immediately after refresh
        }

        async function updateCustomersTable() {
            const customers = await getAllCustomers();
            const tableBody = document.getElementById('customersTable');
            tableBody.innerHTML = '';

            customers.forEach((customer, index) => {
                const row = document.createElement('tr');
                const displayName = customer.name || 'زبون بدون اسم';
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${displayName}</td>
                    <td>${customer.phone || '-'}</td>
                    <td>${customer.address || '-'}</td>
                    <td>
                        <i class="fas fa-edit action-btn edit" onclick="editCustomer('${customer.id}')" title="تعديل"></i>
                        <i class="fas fa-trash action-btn delete" onclick="deleteCustomer('${customer.id}')" title="حذف"></i>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }

        async function filterTable() {
            const searchInput = document.getElementById('searchInput').value.toLowerCase();
            const statusFilter = document.getElementById('statusFilter').value;
            const invoices = await getAllInvoices(); // Fetch fresh list
            const customers = await getAllCustomers(); // Fetch fresh list
            const tableBody = document.getElementById('invoicesTable');
            
            const filteredInvoices = invoices.filter(invoice => {
                const customer = customers.find(c => c.id === invoice.customerId);
                const customerName = customer?.name?.toLowerCase() || '';
                const matchesSearch = customerName.includes(searchInput) || invoice.id.includes(searchInput);
                
                if (!matchesSearch) return false;

                const totalAmount = parseFloat(invoice.totalAmount);
                const amountPaid = parseFloat(invoice.amountPaid);

                if (statusFilter === 'all') return true;
                if (statusFilter === 'paid') return amountPaid >= totalAmount && totalAmount > 0; // Ensure total > 0 for 'paid'
                if (statusFilter === 'partial') return amountPaid > 0 && amountPaid < totalAmount;
                if (statusFilter === 'unpaid') return amountPaid === 0 && totalAmount > 0; // Ensure total > 0 for 'unpaid'
                
                // This case should ideally not be reached if statusFilter has a valid value from the dropdown.
                // If it's reached, it means an unknown filter value, so include the item.
                return true; 
            });

            tableBody.innerHTML = ''; 
            filteredInvoices.sort((a, b) => new Date(b.date) - new Date(a.date)); // Re-sort filtered results

            filteredInvoices.forEach((invoice, index) => {
                const customer = customers.find(c => c.id === invoice.customerId);
                const totalAmount = parseFloat(invoice.totalAmount);
                const amountPaid = parseFloat(invoice.amountPaid);
                let statusClass, statusText;

                 if (totalAmount === 0 && amountPaid === 0) {
                    statusClass = ''; statusText = 'لا يوجد مبلغ';
                } else if (amountPaid >= totalAmount) {
                    statusClass = 'status-paid'; statusText = 'مدفوع';
                } else if (amountPaid > 0) {
                    statusClass = 'status-partial'; statusText = 'مدفوع جزئيًا';
                } else {
                    statusClass = 'status-unpaid'; statusText = 'لم يتم الدفع';
                }

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${invoice.id}</td>
                    <td>${customer?.name || 'زبون محذوف/غير معروف'}</td>
                    <td>${customer?.phone || '-'}</td>
                    <td>${totalAmount.toFixed(2)}</td>
                    <td class="${statusClass}">${statusText}</td>
                    <td>
                        <i class="fas fa-print action-btn print" onclick="printInvoice('${invoice.id}')" title="طباعة"></i>
                        <i class="fas fa-edit action-btn edit" onclick="editInvoice('${invoice.id}')" title="تعديل"></i>
                    </td>
                `;
                tableBody.appendChild(row);
            });
            // No need to call updateDashboard here as it's called in updateInvoicesTable which is called by other functions.
            // However, if filterTable is called independently (e.g., on search input), then dashboard might need update based on filtered view, or just reflect all invoices.
            // For simplicity, let dashboard always reflect all invoices. It's updated by main table update functions.
        }


        async function populateCustomerSelect(selectElementId) {
            const customers = await getAllCustomers();
            const select = document.getElementById(selectElementId);
            const currentValue = select.value; // Preserve current selection if possible
            select.innerHTML = '<option value="">اختر زبونًا...</option>'; 
            customers.forEach(customer => {
                const option = document.createElement('option');
                option.value = customer.id;
                option.textContent = customer.name || `زبون (${customer.phone || 'معرف: ' + customer.id.slice(0,5)})`;
                select.appendChild(option);
            });
            if (currentValue) { // Attempt to restore selection
                 select.value = currentValue;
            }
        }

        async function updateCustomerInfo(selectElementId, phoneElementId, addressElementId) {
            const customerId = document.getElementById(selectElementId).value;
            const phoneInput = document.getElementById(phoneElementId);
            const addressInput = document.getElementById(addressElementId);

            if (customerId) {
                const customers = await getAllCustomers(); // Fetch fresh customer data
                const customer = customers.find(c => c.id === customerId);
                phoneInput.value = customer?.phone || '';
                addressInput.value = customer?.address || '';
            } else {
                phoneInput.value = '';
                addressInput.value = '';
            }
        }
        
        async function setupProductSearch(searchElementId, suggestionsElementId, productsTableId, isEditModal = false) {
            const searchInput = document.getElementById(searchElementId);
            const suggestionsDiv = document.getElementById(suggestionsElementId);
            
            searchInput.addEventListener('input', async (e) => {
                const query = e.target.value.toLowerCase().trim();
                suggestionsDiv.innerHTML = ''; 
                if (query.length < 1) return; 

                const allProducts = await getAllProducts();
                const availableProducts = allProducts.filter(p => p.quantity > 0); 
                
                const filteredProducts = availableProducts.filter(p => 
                    p.name.toLowerCase().includes(query) || 
                    p.id.includes(query)
                ).slice(0, 10); 

                if (filteredProducts.length > 0) {
                    filteredProducts.forEach(product => {
                        const div = document.createElement('div');
                        div.className = 'list-group-item list-group-item-action';
                        
                        const salePriceFormatted = parseFloat(product.salePrice || 0).toFixed(2);
                        
                        // --- MODIFICATION FOR costPrice ---
                        let costPriceFormatted;
                        if (typeof product.costPrice === 'number') { // Handles 0 as a valid cost price
                            costPriceFormatted = parseFloat(product.costPrice).toFixed(2);
                        } else if (product.costPrice && !isNaN(parseFloat(product.costPrice))) { // Handles string numbers
                            costPriceFormatted = parseFloat(product.costPrice).toFixed(2);
                        } else {
                            costPriceFormatted = 'غ/م'; // Not available or not a valid number
                        }
                        // --- END MODIFICATION ---
                        
                        div.innerHTML = `
                            <strong>${product.name}</strong> (المعرف: ${product.id}) <br>
                            <small>
                                سعر البيع: ${salePriceFormatted} | 
                                سعر الشراء: ${costPriceFormatted} | 
                                الكمية المتوفرة: ${product.quantity}
                            </small>
                        `;
                        div.onclick = () => {
                            addProductToInvoice(product, productsTableId);
                            searchInput.value = ''; 
                            suggestionsDiv.innerHTML = ''; 
                        };
                        suggestionsDiv.appendChild(div);
                    });
                } else {
                    suggestionsDiv.innerHTML = '<div class="list-group-item">لا توجد منتجات مطابقة أو غير متوفرة.</div>';
                }
            });
        }


        function addProductToInvoice(product, productsTableId) {
            const tableBody = document.getElementById(productsTableId);
            const existingRow = Array.from(tableBody.rows).find(row => row.dataset.productId === product.id);

            if (existingRow) {
                const quantityInput = existingRow.querySelector('.quantity');
                const currentQuantity = parseInt(quantityInput.value);
                if (currentQuantity < product.quantity) { 
                    quantityInput.value = currentQuantity + 1;
                } else {
                    Swal.fire('تنبيه', `الكمية المطلوبة للمنتج "${product.name}" تتجاوز المخزون المتاح (${product.quantity}).`, 'warning');
                    return;
                }
            } else {
                if (product.quantity < 1) { 
                     Swal.fire('تنبيه', `المنتج "${product.name}" غير متوفر في المخزون.`, 'warning');
                    return;
                }
                const row = tableBody.insertRow();
                row.dataset.productId = product.id; 
                
                row.innerHTML = `
                    <td>${product.name}</td>
                    <td><input type="number" class="form-control form-control-sm sale-price" value="${parseFloat(product.salePrice || 0).toFixed(2)}" step="0.01" min="0.01"></td>
                    <td><input type="number" class="form-control form-control-sm quantity" value="1" min="1" max="${product.quantity}"></td>
                    <td><input type="text" class="form-control form-control-sm note" placeholder="ملاحظة (اختياري)"></td>
                    <td class="total">${parseFloat(product.salePrice || 0).toFixed(2)}</td>
                    <td><button type="button" class="btn btn-sm btn-danger" onclick="removeProductFromInvoice(this.closest('tr'), '${productsTableId}')"><i class="fas fa-trash-alt"></i></button></td>
                `;
                row.querySelector('.sale-price').addEventListener('input', () => updateInvoiceTotals(productsTableId));
                row.querySelector('.quantity').addEventListener('input', (e) => {
                    const requestedQuantity = parseInt(e.target.value);
                    const maxQuantityForThisProduct = parseInt(e.target.max); // Use the max attribute of the input

                    if (requestedQuantity > maxQuantityForThisProduct) {
                        e.target.value = maxQuantityForThisProduct; 
                        Swal.fire('تنبيه', `الكمية المطلوبة للمنتج "${product.name}" تتجاوز المخزون المتاح (${maxQuantityForThisProduct}). تم التعديل للحد الأقصى.`, 'warning');
                    }
                    updateInvoiceTotals(productsTableId);
                });
            }
            updateInvoiceTotals(productsTableId);
        }


        function removeProductFromInvoice(rowElement, productsTableId) {
            rowElement.remove();
            updateInvoiceTotals(productsTableId);
        }

        function updateInvoiceTotals(productsTableId) {
            const tableBody = document.getElementById(productsTableId);
            const rows = tableBody.querySelectorAll('tr');
            let totalAmount = 0;
            let totalItemsCount = 0; 

            rows.forEach(row => {
                const salePriceInput = row.querySelector('.sale-price');
                const quantityInput = row.querySelector('.quantity');
                
                const salePrice = parseFloat(salePriceInput.value) || 0;
                const quantity = parseInt(quantityInput.value) || 0;
                
                const itemTotal = salePrice * quantity;
                row.querySelector('.total').textContent = itemTotal.toFixed(2);
                totalAmount += itemTotal;
                totalItemsCount++; 
            });

            const isEditModal = productsTableId === 'editInvoiceProducts';
            document.getElementById(isEditModal ? 'editTotalItems' : 'totalItems').textContent = totalItemsCount; 
            document.getElementById(isEditModal ? 'editTotalAmount' : 'totalAmount').textContent = totalAmount.toFixed(2);
        }

        async function addInvoice() {
            const customerId = document.getElementById('invoiceCustomer').value;
            const amountPaidValue = document.getElementById('amountPaid').value;
            const productsTable = document.getElementById('invoiceProducts');
            const rows = productsTable.querySelectorAll('tr');

            if (!customerId) {
                Swal.fire('خطأ', 'الرجاء اختيار زبون!', 'error'); return;
            }
            if (rows.length === 0) {
                Swal.fire('خطأ', 'الرجاء إضافة منتج واحد على الأقل للفاتورة!', 'error'); return;
            }
            const amountPaid = parseFloat(amountPaidValue);
            if (isNaN(amountPaid) || amountPaid < 0) {
                 Swal.fire('خطأ', 'المبلغ المدفوع غير صحيح!', 'error'); return;
            }

            const productsInInvoice = [];
            let totalAmount = 0;
            let stockUpdatePromises = [];

            for (const row of rows) {
                const productId = row.dataset.productId;
                const name = row.cells[0].textContent;
                const salePrice = parseFloat(row.querySelector('.sale-price').value);
                const quantitySold = parseInt(row.querySelector('.quantity').value);
                const note = row.querySelector('.note').value;
                const itemTotal = salePrice * quantitySold;

                if (isNaN(salePrice) || salePrice <=0 || isNaN(quantitySold) || quantitySold <=0) {
                    Swal.fire('خطأ', `بيانات غير صالحة للمنتج "${name}". تأكد من السعر والكمية.`, 'error'); return;
                }

                productsInInvoice.push({ productId, name, salePrice, quantity: quantitySold, note, total: itemTotal });
                totalAmount += itemTotal;
                stockUpdatePromises.push(updateProductStock(productId, quantitySold));
            }
             if (amountPaid > totalAmount) {
                Swal.fire('خطأ', 'المبلغ المدفوع لا يمكن أن يكون أكبر من المجموع الكلي للفاتورة!', 'error'); return;
            }

            try {
                await Promise.all(stockUpdatePromises); 
            } catch (error) {
                Swal.fire('خطأ في تحديث المخزون', error.message, 'error');
                return;
            }

            const id = await generateUniqueId('invoices');
            const invoice = {
                id,
                customerId,
                products: productsInInvoice,
                totalAmount: totalAmount.toFixed(2),
                amountPaid: amountPaid.toFixed(2),
                date: new Date().toISOString()
            };

            const transaction = db.transaction(['invoices'], 'readwrite');
            const store = transaction.objectStore('invoices');
            const request = store.add(invoice);

            request.onsuccess = async () => {
                await updateInvoicesTable(); // This also updates dashboard
                bootstrap.Modal.getInstance(document.getElementById('addInvoiceModal')).hide();
                document.getElementById('addInvoiceForm').reset();
                document.getElementById('invoiceProducts').innerHTML = ''; 
                document.getElementById('totalItems').textContent = '0';
                document.getElementById('totalAmount').textContent = '0.00';
                document.getElementById('customerPhoneDisplay').value = '';
                document.getElementById('customerAddressDisplay').value = '';
                document.getElementById('invoiceDate').textContent = formatDateForDisplay(new Date().toISOString()); // Reset date
                await populateCustomerSelect('invoiceCustomer'); 
                Swal.fire('نجاح', 'تم إضافة الفاتورة وتحديث المخزون بنجاح!', 'success');
            };
            request.onerror = (e) => {
                console.error("Error adding invoice:", e.target.error);
                Swal.fire('خطأ', 'فشل في إضافة الفاتورة!', 'error');
            };
        }
        
        function updateProductStock(productId, quantitySold) {
            return new Promise(async (resolve, reject) => {
                try {
                    await ensureDBInitialized();
                    const transaction = db.transaction(['products'], 'readwrite');
                    const store = transaction.objectStore('products');
                    const getRequest = store.get(productId);

                    getRequest.onsuccess = () => {
                        const product = getRequest.result;
                        if (!product) {
                            reject(new Error(`المنتج بالمعرف ${productId} غير موجود.`));
                            return;
                        }
                        if (product.quantity < quantitySold) {
                            reject(new Error(`الكمية المطلوبة للمنتج "${product.name}" (${quantitySold}) تتجاوز المخزون المتاح (${product.quantity}).`));
                            return;
                        }
                        product.quantity -= quantitySold;
                        const updateRequest = store.put(product);
                        updateRequest.onsuccess = () => resolve();
                        updateRequest.onerror = (e) => reject(new Error(`فشل تحديث مخزون المنتج ${product.name}: ${e.target.error}`));
                    };
                    getRequest.onerror = (e) => reject(new Error(`فشل جلب المنتج ${productId} لتحديث المخزون: ${e.target.error}`));
                } catch (dbError) {
                    reject(dbError);
                }
            });
        }


        async function editInvoice(invoiceId) {
            try {
                await ensureDBInitialized();
                const transaction = db.transaction(['invoices', 'customers', 'products'], 'readonly'); 
                const invoiceStore = transaction.objectStore('invoices');
                const invoiceRequest = invoiceStore.get(invoiceId);

                invoiceRequest.onsuccess = async () => {
                    const invoice = invoiceRequest.result;
                    if (!invoice) {
                        Swal.fire('خطأ', 'الفاتورة غير موجودة!', 'error');
                        return;
                    }
                    
                    document.getElementById('editInvoiceModal').dataset.originalProducts = JSON.stringify(invoice.products);
                    document.getElementById('editInvoiceId').value = invoice.id;
                    
                    const customerSelect = document.getElementById('editInvoiceCustomer');
                    await populateCustomerSelect('editInvoiceCustomer'); 
                    customerSelect.value = invoice.customerId;
                    await updateCustomerInfo('editInvoiceCustomer', 'editCustomerPhoneDisplay', 'editCustomerAddressDisplay');

                    document.getElementById('editInvoiceDate').textContent = formatDateForDisplay(invoice.date);
                    document.getElementById('editAmountPaid').value = parseFloat(invoice.amountPaid).toFixed(2);

                    const tableBody = document.getElementById('editInvoiceProducts');
                    tableBody.innerHTML = ''; 

                    const allProductsFromDB = await getAllProducts(); 

                    invoice.products.forEach(pInInvoice => {
                        const productDetailsFromDB = allProductsFromDB.find(pDB => pDB.id === pInInvoice.productId);
                        const currentStockInDB = productDetailsFromDB ? productDetailsFromDB.quantity : 0;
                        const maxQuantityForInput = currentStockInDB + pInInvoice.quantity;


                        const row = tableBody.insertRow();
                        row.dataset.productId = pInInvoice.productId;
                        row.dataset.originalQuantityInInvoice = pInInvoice.quantity; 
                        row.dataset.maxEditableQuantity = maxQuantityForInput;


                        row.innerHTML = `
                            <td>${pInInvoice.name}</td>
                            <td><input type="number" class="form-control form-control-sm sale-price" value="${parseFloat(pInInvoice.salePrice).toFixed(2)}" step="0.01" min="0.01"></td>
                            <td><input type="number" class="form-control form-control-sm quantity" value="${pInInvoice.quantity}" min="1" max="${maxQuantityForInput}"></td>
                            <td><input type="text" class="form-control form-control-sm note" value="${pInInvoice.note || ''}" placeholder="ملاحظة"></td>
                            <td class="total">${parseFloat(pInInvoice.total).toFixed(2)}</td>
                            <td><button type="button" class="btn btn-sm btn-danger" onclick="removeProductFromInvoice(this.closest('tr'), 'editInvoiceProducts')"><i class="fas fa-trash-alt"></i></button></td>
                        `;
                        row.querySelector('.sale-price').addEventListener('input', () => updateInvoiceTotals('editInvoiceProducts'));
                        row.querySelector('.quantity').addEventListener('input', (e) => {
                             const requestedQuantity = parseInt(e.target.value);
                             const maxAllowed = parseInt(e.target.max); 
                             if (requestedQuantity > maxAllowed) {
                                e.target.value = maxAllowed;
                                Swal.fire('تنبيه', `الكمية المطلوبة للمنتج "${pInInvoice.name}" تتجاوز المخزون المتاح. تم التعديل للحد الأقصى (${maxAllowed}).`, 'warning');
                            }
                            updateInvoiceTotals('editInvoiceProducts');
                        });
                    });

                    updateInvoiceTotals('editInvoiceProducts');
                    new bootstrap.Modal(document.getElementById('editInvoiceModal')).show();
                };
                invoiceRequest.onerror = (e) => Swal.fire('خطأ', `فشل في جلب الفاتورة: ${e.target.error}`, 'error');
            } catch (dbError) {
                 Swal.fire('خطأ قاعدة البيانات', `فشل: ${dbError.message}`, 'error');
            }
        }


        async function updateInvoice() {
            const id = document.getElementById('editInvoiceId').value;
            const customerId = document.getElementById('editInvoiceCustomer').value;
            const amountPaidValue = document.getElementById('editAmountPaid').value;
            const productsTable = document.getElementById('editInvoiceProducts');
            const rows = productsTable.querySelectorAll('tr');
            
            const originalProductsJSON = document.getElementById('editInvoiceModal').dataset.originalProducts;
            const originalProductsInInvoice = JSON.parse(originalProductsJSON || "[]"); 


            if (!customerId) { Swal.fire('خطأ', 'الرجاء اختيار زبون!', 'error'); return; }
            if (rows.length === 0) { Swal.fire('خطأ', 'الفاتورة يجب أن تحتوي على منتج واحد على الأقل!', 'error'); return; }
            const amountPaid = parseFloat(amountPaidValue);
             if (isNaN(amountPaid) || amountPaid < 0) { Swal.fire('خطأ', 'المبلغ المدفوع غير صحيح!', 'error'); return; }


            const updatedProductsInInvoice = [];
            let newTotalAmount = 0;
            let stockAdjustmentPromises = []; 

            for (const row of rows) {
                const productId = row.dataset.productId;
                const name = row.cells[0].textContent;
                const salePrice = parseFloat(row.querySelector('.sale-price').value);
                const newQuantitySold = parseInt(row.querySelector('.quantity').value);
                const note = row.querySelector('.note').value;
                const itemTotal = salePrice * newQuantitySold;

                if (isNaN(salePrice) || salePrice <=0 || isNaN(newQuantitySold) || newQuantitySold <=0) {
                    Swal.fire('خطأ', `بيانات غير صالحة للمنتج "${name}". تأكد من السعر والكمية.`, 'error'); return;
                }

                updatedProductsInInvoice.push({ productId, name, salePrice, quantity: newQuantitySold, note, total: itemTotal });
                newTotalAmount += itemTotal;

                const originalProductInfo = originalProductsInInvoice.find(p => p.productId === productId);
                const originalQuantitySoldInThisInvoice = originalProductInfo ? originalProductInfo.quantity : 0;
                
                const quantityChangeForStock = originalQuantitySoldInThisInvoice - newQuantitySold; 
                
                if (quantityChangeForStock !== 0) {
                    const productExists = await checkProductExists(productId);
                    if (productExists) {
                         stockAdjustmentPromises.push(adjustProductStock(productId, quantityChangeForStock));
                    } else {
                        console.warn(`Product ${productId} not found in DB. Skipping stock adjustment for this item.`);
                    }
                }
            }
            
            originalProductsInInvoice.forEach(async origP => {
                if (!updatedProductsInInvoice.some(updP => updP.productId === origP.productId)) {
                    const productExists = await checkProductExists(origP.productId);
                     if (productExists) {
                        stockAdjustmentPromises.push(adjustProductStock(origP.productId, origP.quantity)); 
                     } else {
                        console.warn(`Product ${origP.productId} (removed from invoice) not found in DB. Skipping stock adjustment for this item.`);
                     }
                }
            });


            if (amountPaid > newTotalAmount) {
                Swal.fire('خطأ', 'المبلغ المدفوع لا يمكن أن يكون أكبر من المجموع الكلي للفاتورة!', 'error'); return;
            }

            try {
                if (stockAdjustmentPromises.length > 0) {
                    await Promise.all(stockAdjustmentPromises);
                }
            } catch (error) {
                Swal.fire('خطأ في تحديث المخزون', error.message, 'error');
                return; 
            }
            
            let invoiceDateStr = document.getElementById('editInvoiceDate').textContent;
            let invoiceDateISO;
            if (invoiceDateStr && invoiceDateStr !== 'N/A') {
                const parts = invoiceDateStr.match(/(\d{2})-(\d{2})-(\d{4}) (\d{2}):(\d{2})/);
                if (parts) {
                    // parts[1]=day, parts[2]=month, parts[3]=year, parts[4]=hour, parts[5]=minute
                    invoiceDateISO = new Date(Date.UTC(parts[3], parts[2] - 1, parts[1], parts[4], parts[5])).toISOString();
                } else {
                    invoiceDateISO = new Date().toISOString(); 
                }
            } else {
                 invoiceDateISO = new Date().toISOString(); 
            }


            const invoice = {
                id,
                customerId,
                products: updatedProductsInInvoice,
                totalAmount: newTotalAmount.toFixed(2),
                amountPaid: amountPaid.toFixed(2),
                date: invoiceDateISO 
            };

            const transaction = db.transaction(['invoices'], 'readwrite');
            const store = transaction.objectStore('invoices');
            const request = store.put(invoice);

            request.onsuccess = async () => {
                await updateInvoicesTable(); // This also updates dashboard
                bootstrap.Modal.getInstance(document.getElementById('editInvoiceModal')).hide();
                Swal.fire('نجاح', 'تم تعديل الفاتورة وتحديث المخزون بنجاح!', 'success');
            };
            request.onerror = (e) => {
                 console.error("Error updating invoice:", e.target.error);
                 Swal.fire('خطأ', 'فشل في تعديل الفاتورة!', 'error');
            };
        }

        function adjustProductStock(productId, quantityChange) {
            return new Promise(async (resolve, reject) => {
                try {
                    await ensureDBInitialized();
                    const transaction = db.transaction(['products'], 'readwrite');
                    const store = transaction.objectStore('products');
                    const getRequest = store.get(productId);

                    getRequest.onsuccess = () => {
                        const product = getRequest.result;
                        if (!product) {
                            // It's possible a product was deleted from inventory system externally
                            // while it was still in an invoice. Log this instead of hard failing the whole invoice update.
                            console.warn(`المنتج بالمعرف ${productId} غير موجود لتعديل المخزون. سيتم تخطي هذا المنتج.`);
                            resolve(); // Resolve to not block other stock adjustments
                            return;
                        }
                        
                        const newStock = product.quantity + quantityChange;
                        if (newStock < 0) { 
                             reject(new Error(`لا يمكن أن يكون مخزون المنتج "${product.name}" سالبًا. التغيير المطلوب للمخزون: ${quantityChange}, المخزون الحالي: ${product.quantity}.`));
                             return;
                        }
                        product.quantity = newStock;

                        const updateRequest = store.put(product);
                        updateRequest.onsuccess = () => resolve();
                        updateRequest.onerror = (e) => reject(new Error(`فشل تعديل مخزون المنتج ${product.name}: ${e.target.error}`));
                    };
                    getRequest.onerror = (e) => reject(new Error(`فشل جلب المنتج ${productId} لتعديل المخزون: ${e.target.error}`));
                } catch (dbError) {
                    reject(dbError);
                }
            });
        }

        async function deleteInvoice(invoiceId) { // This function is not called from UI but kept for potential use
            const result = await Swal.fire({
                title: 'تأكيد الحذف',
                text: 'هل أنت متأكد من حذف هذه الفاتورة؟ سيتم إرجاع الكميات المباعة إلى المخزون.',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'نعم، احذف',
                cancelButtonText: 'إلغاء',
                confirmButtonColor: '#dc3545',
                cancelButtonColor: '#6c757d'
            });

            if (result.isConfirmed) {
                try {
                    await ensureDBInitialized();
                    const readTx = db.transaction(['invoices'], 'readonly'); 
                    const invoiceStoreRead = readTx.objectStore('invoices');
                    const getInvoiceRequest = invoiceStoreRead.get(invoiceId);

                    getInvoiceRequest.onsuccess = async () => {
                        const invoiceToDelete = getInvoiceRequest.result;
                        if (!invoiceToDelete) {
                            Swal.fire('خطأ', 'الفاتورة غير موجودة.', 'error');
                            return;
                        }

                        let stockReturnPromises = [];
                        for (const p of invoiceToDelete.products) {
                            const productExists = await checkProductExists(p.productId);
                            if (productExists) {
                                stockReturnPromises.push(adjustProductStock(p.productId, p.quantity));
                            } else {
                                console.warn(`Product ${p.productId} from deleted invoice not found. Stock not returned for this item.`);
                            }
                        }
                        
                        try {
                            if (stockReturnPromises.length > 0) {
                                await Promise.all(stockReturnPromises); 
                            }

                            const writeTxDelete = db.transaction(['invoices'], 'readwrite');
                            const invoiceStoreWrite = writeTxDelete.objectStore('invoices');
                            const deleteRequest = invoiceStoreWrite.delete(invoiceId);

                            deleteRequest.onsuccess = async () => {
                                await updateInvoicesTable(); // This also updates dashboard
                                Swal.fire('نجاح', 'تم حذف الفاتورة وإرجاع المنتجات للمخزون بنجاح!', 'success');
                            };
                            deleteRequest.onerror = (e) => {
                                console.error("Error deleting invoice:", e.target.error);
                                Swal.fire('خطأ', 'فشل في حذف الفاتورة! (قد يكون المخزون أُرجع).', 'error');
                            };

                        } catch (stockError) {
                            Swal.fire('خطأ في إرجاع المخزون', stockError.message, 'error');
                        }
                    };
                    getInvoiceRequest.onerror = (e) => Swal.fire('خطأ', `فشل في جلب الفاتورة للحذف: ${e.target.error}`, 'error');

                } catch (dbError) {
                     Swal.fire('خطأ قاعدة البيانات', `فشل: ${dbError.message}`, 'error');
                }
            }
        }


        async function addCustomer() {
            const name = document.getElementById('customerName').value.trim();
            const phone = document.getElementById('customerPhone').value.trim();
            const address = document.getElementById('customerAddress').value.trim();
            
            if (!name && !phone && !address) {
                 Swal.fire('خطأ', 'يجب إدخال معلومة واحدة على الأقل للزبون (الاسم أو الهاتف أو العنوان).', 'error');
                 return;
            }

            if (phone) { 
                const customers = await getAllCustomers();
                if (customers.some(c => c.phone === phone && phone !== '')) { // Ensure phone isn't empty string
                    Swal.fire('خطأ', 'رقم الهاتف هذا مُسجل لزبون آخر!', 'error');
                    return;
                }
            }


            const id = await generateUniqueId('customers');
            const customer = { 
                id, 
                name: name || null, // Store null if empty for consistency
                phone: phone || null, 
                address: address || null 
            };


            const transaction = db.transaction(['customers'], 'readwrite');
            const store = transaction.objectStore('customers');
            const request = store.add(customer);

            request.onsuccess = async () => {
                await updateCustomersTable();
                await populateCustomerSelect('invoiceCustomer');
                await populateCustomerSelect('editInvoiceCustomer');
                await populateCustomerSelect('statementCustomer');
                bootstrap.Modal.getInstance(document.getElementById('addCustomerModal')).hide();
                document.getElementById('addCustomerForm').reset();
                Swal.fire('نجاح', 'تم إضافة الزبون بنجاح!', 'success');
            };
            request.onerror = (e) => Swal.fire('خطأ', `فشل في إضافة الزبون: ${e.target.error}`, 'error');
        }

        async function editCustomer(customerId) {
            try {
                await ensureDBInitialized();
                const transaction = db.transaction(['customers'], 'readonly');
                const store = transaction.objectStore('customers');
                const request = store.get(customerId);

                request.onsuccess = () => {
                    const customer = request.result;
                    if (!customer) {
                        Swal.fire('خطأ', 'الزبون غير موجود!', 'error');
                        return;
                    }
                    document.getElementById('editCustomerId').value = customer.id;
                    document.getElementById('editCustomerName').value = customer.name || '';
                    document.getElementById('editCustomerPhone').value = customer.phone || '';
                    document.getElementById('editCustomerAddress').value = customer.address || '';
                    new bootstrap.Modal(document.getElementById('editCustomerModal')).show();
                };
                request.onerror = (e) => Swal.fire('خطأ', `فشل في جلب بيانات الزبون: ${e.target.error}`, 'error');
            } catch (dbError) {
                 Swal.fire('خطأ قاعدة البيانات', `فشل: ${dbError.message}`, 'error');
            }
        }

        async function updateCustomer() {
            const id = document.getElementById('editCustomerId').value;
            const name = document.getElementById('editCustomerName').value.trim();
            const phone = document.getElementById('editCustomerPhone').value.trim();
            const address = document.getElementById('editCustomerAddress').value.trim();

             if (!name && !phone && !address) {
                 Swal.fire('خطأ', 'يجب إدخال معلومة واحدة على الأقل للزبون.', 'error');
                 return;
            }

            if (phone) { 
                const customers = await getAllCustomers();
                if (customers.some(c => c.id !== id && c.phone === phone && phone !== '')) { 
                    Swal.fire('خطأ', 'رقم الهاتف هذا مُسجل لزبون آخر!', 'error');
                    return;
                }
            }

            const customer = { 
                id, 
                name: name || null, 
                phone: phone || null, 
                address: address || null 
            };
            const transaction = db.transaction(['customers'], 'readwrite');
            const store = transaction.objectStore('customers');
            const request = store.put(customer);

            request.onsuccess = async () => {
                await updateCustomersTable();
                await updateInvoicesTable(); // Refresh invoices in case customer name changed
                await populateCustomerSelect('invoiceCustomer');
                await populateCustomerSelect('editInvoiceCustomer');
                await populateCustomerSelect('statementCustomer');
                bootstrap.Modal.getInstance(document.getElementById('editCustomerModal')).hide();
                Swal.fire('نجاح', 'تم تعديل بيانات الزبون بنجاح!', 'success');
            };
            request.onerror = (e) => Swal.fire('خطأ', `فشل في تعديل بيانات الزبون: ${e.target.error}`, 'error');
        }

        async function deleteCustomer(customerId) {
            const invoices = await getAllInvoices();
            if (invoices.some(i => i.customerId === customerId)) {
                Swal.fire('لا يمكن الحذف', 'لا يمكن حذف هذا الزبون لأنه مرتبط بفواتير حالية. يرجى تعديل الفواتير المرتبطة به لزبون آخر أو حذفها (إذا كانت هذه الإمكانية متاحة).', 'error');
                return;
            }


            const result = await Swal.fire({
                title: 'تأكيد الحذف',
                text: 'هل أنت متأكد من حذف هذا الزبون؟ لا يمكن التراجع عن هذا الإجراء.',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'نعم، احذف',
                cancelButtonText: 'إلغاء',
                confirmButtonColor: '#dc3545'
            });

            if (result.isConfirmed) {
                const transaction = db.transaction(['customers'], 'readwrite');
                const store = transaction.objectStore('customers');
                const request = store.delete(customerId);

                request.onsuccess = async () => {
                    await updateCustomersTable();
                    await populateCustomerSelect('invoiceCustomer');
                    await populateCustomerSelect('editInvoiceCustomer');
                    await populateCustomerSelect('statementCustomer');
                    Swal.fire('نجاح', 'تم حذف الزبون بنجاح!', 'success');
                };
                request.onerror = (e) => Swal.fire('خطأ', `فشل في حذف الزبون: ${e.target.error}`, 'error');
            }
        }
        
        async function printInvoice(invoiceId) {
            try {
                await ensureDBInitialized();
                const transaction = db.transaction(['invoices', 'customers'], 'readonly');
                const invoiceStore = transaction.objectStore('invoices');
                const invoiceRequest = invoiceStore.get(invoiceId);

                invoiceRequest.onsuccess = async () => {
                    const invoice = invoiceRequest.result;
                    if (!invoice) { Swal.fire('خطأ', 'الفاتورة غير موجودة.', 'error'); return; }

                    const customers = await getAllCustomers(); 
                    const customer = customers.find(c => c.id === invoice.customerId);
                    
                    const printWindow = window.open('', '_blank', 'height=800,width=600');
                    if (!printWindow) {
                         Swal.fire('خطأ', 'فشل فتح نافذة الطباعة. يرجى التأكد من تعطيل مانع النوافذ المنبثقة.', 'error'); return;
                    }
                    printWindow.document.write(`
                        <!DOCTYPE html>
                        <html lang="ar" dir="rtl">
                        <head>
                            <meta charset="UTF-8">
                            <title>فاتورة رقم: ${invoice.id}</title>
                            <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
                            <style>
                                @page { size: A5 landscape; margin: 5mm; }
                                body { font-family: 'Cairo', sans-serif; direction: rtl; margin: 5mm; font-size: 10pt; }
                                .container { width: 100%; margin: 0 auto; }
                                .header-print { text-align: center; margin-bottom: 10px; border-bottom: 1px solid #ccc; padding-bottom: 5px;}
                                .header-print img { max-height: 40px; margin-bottom: 3px; }
                                .header-print h1 { font-size: 1.1rem; color: #3F2A56; margin:0; }
                                .invoice-info-grid { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px;}
                                .invoice-details-text { flex-basis: 70%;} 
                                .invoice-details, .customer-details { font-size: 0.85rem;}
                                .invoice-details p, .customer-details p { margin: 2px 0; }
                                .qr-code-container { 
                                    flex-basis: auto; /* Adjust to content */
                                    min-width: 75px; 
                                    text-align: center; /* Center the QR code if div is wider */
                                    padding-left: 5px; 
                                } 
                                #invoiceQrCodeElement { /* The div where QR will be generated */
                                    display: inline-block; /* Helps with sizing and centering */
                                }
                                #invoiceQrCodeElement canvas,
                                #invoiceQrCodeElement img {
                                    border: 1px solid #eee; /* Add border to the QR itself */
                                }
                                .products-table { width: 100%; border-collapse: collapse; margin-bottom: 8px; }
                                .products-table th, .products-table td { padding: 4px; border: 1px solid #ccc; text-align: center; font-size: 0.8rem;}
                                .products-table th { background-color: #f2f2f2; color: #333; font-weight:600; }
                                .totals-section { margin-top: 10px; padding-top: 8px; border-top: 1px solid #ccc; text-align:left; font-size: 0.85rem;}
                                .totals-section p { margin: 3px 0; font-weight: 600; }
                                .footer-print { text-align: center; font-size: 0.75rem; margin-top: 15px; color: #777; }
                                @media print {
                                    body { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
                                }
                            </style>
                        </head>
                        <body>
                            <div class="container">
                                <div class="header-print">
                                    <img src="logo.png" alt="شعار" onerror="this.style.display='none';">
                                    <h1>طيبة المدينة تلكوم</h1>
                                    <p style="font-size:0.7rem;">للاتصالات وخدمات الجوال</p>
                                </div>
                                
                                <div class="invoice-info-grid">
                                    <div class="invoice-details-text">
                                        <div class="invoice-details">
                                            <p><strong>رقم الفاتورة:</strong> ${invoice.id}</p>
                                            <p><strong>التاريخ:</strong> ${formatDateForDisplay(invoice.date)}</p>
                                        </div>
                                        <div class="customer-details">
                                            <p><strong>الزبون:</strong> ${customer?.name || 'زبون نقدي'}</p>
                                            ${customer?.phone ? `<p><strong>الهاتف:</strong> ${customer.phone}</p>` : ''}
                                            ${customer?.address ? `<p><strong>العنوان:</strong> ${customer.address}</p>` : ''}
                                        </div>
                                    </div>
                                    <div class="qr-code-container">
                                        <div id="invoiceQrCodeElement"></div> <!-- Target for QRCode.js -->
                                    </div>
                                </div>

                                <table class="products-table">
                                    <thead>
                                        <tr>
                                            <th>م</th>
                                            <th>البيان (اسم المنتج)</th>
                                            <th>س. الوحدة</th>
                                            <th>الكمية</th>
                                            <th>الإجمالي</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${invoice.products.map((p, index) => `
                                            <tr>
                                                <td>${index + 1}</td>
                                                <td style="text-align:right;">${p.name} ${p.note ? `(${p.note})` : ''}</td>
                                                <td>${parseFloat(p.salePrice).toFixed(2)}</td>
                                                <td>${p.quantity}</td>
                                                <td>${parseFloat(p.total).toFixed(2)}</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                                <div class="totals-section">
                                    <p>المجموع الكلي: ${parseFloat(invoice.totalAmount).toFixed(2)}</p>
                                    <p>المبلغ المدفوع: ${parseFloat(invoice.amountPaid).toFixed(2)}</p>
                                    <p>المتبقي: ${(parseFloat(invoice.totalAmount) - parseFloat(invoice.amountPaid)).toFixed(2)}</p>
                                </div>
                                <div class="footer-print">
                                    <p>شكراً لتعاملكم معنا!</p>
                                </div>
                            </div>
                            <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"><\/script>
                            <script>
                                window.onload = function() { // This is the onload for the print window's content
                                    var qrElement = document.getElementById('invoiceQrCodeElement');
                                    if (qrElement && typeof QRCode !== 'undefined') {
                                        new QRCode(qrElement, {
                                            text: "${invoice.id}",
                                            width: 65,
                                            height: 65,
                                            colorDark : "#000000",
                                            colorLight : "#ffffff",
                                            correctLevel : QRCode.CorrectLevel.H
                                        });
                                    } else {
                                        console.error("QR Code generation failed in print window: Element or QRCode library not found.");
                                    }
                                };
                            <\/script>
                        </body>
                        </html>
                    `);
                    printWindow.document.close(); 
                    printWindow.onload = function() { // This is for the parent window's reference to the new window object
                        // The new window's own window.onload (for its content) should have fired by now.
                        // Add a slight delay to ensure rendering is complete before the print dialog.
                        setTimeout(function() {
                            printWindow.focus();
                            printWindow.print();
                            // printWindow.close(); // Optional: Close after print dialog
                        }, 300); // 300ms delay, adjust if needed.
                    }
                };
                invoiceRequest.onerror = (e) => Swal.fire('خطأ', `فشل في جلب الفاتورة للطباعة: ${e.target.error}`, 'error');
            } catch (dbError) {
                 Swal.fire('خطأ قاعدة البيانات', `فشل: ${dbError.message}`, 'error');
            }
        }

        async function generateCustomerStatement() {
            const customerId = document.getElementById('statementCustomer').value;
            const startDateValue = document.getElementById('startDate').value;
            const endDateValue = document.getElementById('endDate').value;

            if (!customerId || !startDateValue || !endDateValue) {
                Swal.fire('خطأ', 'الرجاء اختيار الزبون وتحديد نطاق التاريخ بشكل كامل!', 'error');
                return;
            }
            
            const startDate = new Date(startDateValue);
            const endDate = new Date(endDateValue);
            endDate.setHours(23, 59, 59, 999); 


            if (startDate > endDate) {
                Swal.fire('خطأ', 'تاريخ البداية يجب أن يكون قبل أو نفس تاريخ النهاية!', 'error');
                return;
            }

            const invoices = await getAllInvoices();
            const customers = await getAllCustomers();
            const customer = customers.find(c => c.id === customerId);

            const filteredInvoices = invoices.filter(i => {
                const invoiceDate = new Date(i.date);
                return i.customerId === customerId && invoiceDate >= startDate && invoiceDate <= endDate;
            }).sort((a, b) => new Date(a.date) - new Date(b.date)); 

            const printWindow = window.open('', '_blank', 'height=800,width=600');
             if (!printWindow) {
                 Swal.fire('خطأ', 'فشل فتح نافذة الطباعة. يرجى التأكد من تعطيل مانع النوافذ المنبثقة.', 'error'); return;
             }
            printWindow.document.write(`
                <!DOCTYPE html>
                <html lang="ar" dir="rtl">
                <head>
                    <meta charset="UTF-8">
                    <title>كشف حساب الزبون: ${customer?.name || 'غير معروف'}</title>
                    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
                    <style>
                        @page { size: A4; margin: 10mm; }
                        body { font-family: 'Cairo', sans-serif; direction: rtl; margin: 10mm; font-size:10pt; }
                        .container { width: 100%; margin: 0 auto; }
                        .header-print { text-align: center; margin-bottom: 20px; border-bottom: 1px solid #ccc; padding-bottom:10px;}
                        .header-print img { max-height: 60px; margin-bottom: 5px;}
                        .header-print h1 { font-size: 1.4rem; color: #3F2A56; margin:0; }
                        .info { margin-bottom: 15px; font-size:0.95rem; }
                        .info p { margin: 4px 0; }
                        .statement-table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
                        .statement-table th, .statement-table td { padding: 8px; border: 1px solid #ccc; text-align: center; font-size:0.9rem; }
                        .statement-table th { background-color: #f2f2f2; color: #333; font-weight:600; }
                        .status-paid { color: #198754; font-weight: 700; }
                        .status-partial { color: #ffc107; font-weight: 700; }
                        .status-unpaid { color: #dc3545; font-weight: 700; }
                        .summary { margin-top: 20px; padding-top:10px; border-top: 1px solid #ccc; text-align:left; font-size:1rem;}
                        .summary p {margin: 5px 0; font-weight:600;}
                         @media print {
                            body { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
                        }
                    </style>
                </head>
                <body>
                    <div class="container">
                        <div class="header-print">
                             <img src="logo.png" alt="شعار" onerror="this.style.display='none';">
                            <h1>طيبة المدينة تلكوم</h1>
                            <h2>كشف حساب زبون</h2>
                        </div>
                        <div class="info">
                            <p><strong>الزبون:</strong> ${customer?.name || 'زبون غير محدد'}</p>
                            ${customer?.phone ? `<p><strong>الهاتف:</strong> ${customer.phone}</p>` : ''}
                            <p><strong>الفترة من:</strong> ${new Date(startDateValue).toLocaleDateString('ar-SA-u-nu-latn', { year: 'numeric', month: '2-digit', day: '2-digit' })}</p>
                            <p><strong>إلى:</strong> ${new Date(endDateValue).toLocaleDateString('ar-SA-u-nu-latn', { year: 'numeric', month: '2-digit', day: '2-digit' })}</p>
                        </div>
                        <table class="statement-table">
                            <thead>
                                <tr>
                                    <th>رقم الفاتورة</th>
                                    <th>التاريخ</th>
                                    <th>إجمالي الفاتورة</th>
                                    <th>المدفوع</th>
                                    <th>المتبقي</th>
                                    <th>الحالة</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${filteredInvoices.length > 0 ? filteredInvoices.map(i => {
                                    const totalAmount = parseFloat(i.totalAmount);
                                    const amountPaid = parseFloat(i.amountPaid);
                                    const remaining = totalAmount - amountPaid;
                                    let statusText, statusClassSuffix;
                                    if (totalAmount === 0 && amountPaid === 0) { statusText = 'لا يوجد مبلغ'; statusClassSuffix = '';}
                                    else if (amountPaid >= totalAmount) { statusText = 'مدفوع'; statusClassSuffix = 'paid'; }
                                    else if (amountPaid > 0) { statusText = 'مدفوع جزئيًا'; statusClassSuffix = 'partial'; }
                                    else { statusText = 'لم يتم الدفع'; statusClassSuffix = 'unpaid'; }
                                    

                                    return `
                                        <tr>
                                            <td>${i.id}</td>
                                            <td>${formatDateForDisplay(i.date)}</td>
                                            <td>${totalAmount.toFixed(2)}</td>
                                            <td>${amountPaid.toFixed(2)}</td>
                                            <td>${remaining.toFixed(2)}</td>
                                            <td class="status-${statusClassSuffix}">${statusText}</td>
                                        </tr>
                                    `;
                                }).join('') : '<tr><td colspan="6">لا توجد فواتير لهذا الزبون في الفترة المحددة.</td></tr>'}
                            </tbody>
                        </table>
                        ${filteredInvoices.length > 0 ? `
                        <div class="summary">
                            <p>إجمالي قيمة الفواتير: ${filteredInvoices.reduce((sum, i) => sum + parseFloat(i.totalAmount), 0).toFixed(2)}</p>
                            <p>إجمالي المدفوعات: ${filteredInvoices.reduce((sum, i) => sum + parseFloat(i.amountPaid), 0).toFixed(2)}</p>
                            <p>إجمالي المتبقي: ${filteredInvoices.reduce((sum, i) => sum + (parseFloat(i.totalAmount) - parseFloat(i.amountPaid)), 0).toFixed(2)}</p>
                        </div>
                        ` : ''}
                    </div>
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.onload = function() { // Parent window's reference onload
                setTimeout(function() { // Delay to ensure rendering, especially if print window has complex content
                    printWindow.focus();
                    printWindow.print();
                }, 300);
            }
            bootstrap.Modal.getInstance(document.getElementById('customerStatementModal')).hide();
            document.getElementById('customerStatementForm').reset();
        }

        function startQrScanner() {
            const qrReaderContainer = document.getElementById('qr-reader-container');
            
            if (html5QrCodeScanner) {
                 try {
                    if (html5QrCodeScanner.getState() === Html5QrcodeScannerState.SCANNING) {
                        stopQrScanner(); 
                    }
                 } catch (e) { console.warn("Error checking scanner state, attempting to stop anyway:", e); stopQrScanner(); }
            }

            qrReaderContainer.style.display = 'block';
            
            if (typeof Html5Qrcode === "undefined") {
                Swal.fire('خطأ', 'مكتبة مسح QR غير محملة بشكل صحيح.', 'error');
                qrReaderContainer.style.display = 'none'; 
                return;
            }

            html5QrCodeScanner = new Html5Qrcode("qr-reader"); 
            const qrCodeSuccessCallback = (decodedText, decodedResult) => {
                document.getElementById('searchInput').value = decodedText;
                filterTable();
                stopQrScanner(); 
                Swal.fire('نجاح!', `تم العثور على الفاتورة: ${decodedText}`, 'success');
            };
            const config = { fps: 10, qrbox: {width: 250, height: 250}, aspectRatio: 1.0 }; 
            
             html5QrCodeScanner.start(
                { facingMode: "environment" }, 
                config,
                qrCodeSuccessCallback,
                (errorMessage) => {
                    // console.warn(`QR Code no match or error: ${errorMessage}`);
                })
            .catch((err) => {
                console.error(`Unable to start QR scanning, error: ${err}`);
                Swal.fire('خطأ', 'لم يتمكن من تشغيل ماسح QR. تأكد من صلاحيات الكاميرا أو أن الكاميرا غير مستخدمة بواسطة تطبيق آخر.', 'error');
                stopQrScanner(); 
            });
        }

        function stopQrScanner() {
            const qrReaderContainer = document.getElementById('qr-reader-container');
            if (html5QrCodeScanner) {
                html5QrCodeScanner.stop().then(ignore => {
                    console.log("QR Code scanning stopped.");
                    if (html5QrCodeScanner && typeof html5QrCodeScanner.clear === 'function') {
                        html5QrCodeScanner.clear(); 
                    }
                    // html5QrCodeScanner = null; // Do not nullify here if you want to reuse, but for safety, it's good
                }).catch(err => {
                    console.error("Failed to stop QR Code scanner.", err);
                    // html5QrCodeScanner = null; 
                }).finally(() => {
                     qrReaderContainer.style.display = 'none'; 
                });
            } else {
                 qrReaderContainer.style.display = 'none'; 
            }
        }


        document.addEventListener('DOMContentLoaded', async () => {
            try {
                await initDB();
                await Promise.all([
                    updateInvoicesTable(), 
                    updateCustomersTable(),
                    populateCustomerSelect('invoiceCustomer'),
                    populateCustomerSelect('editInvoiceCustomer'),
                    populateCustomerSelect('statementCustomer')
                ]);
                
                setupProductSearch('productSearch', 'productSuggestions', 'invoiceProducts');
                setupProductSearch('editProductSearch', 'editProductSuggestions', 'editInvoiceProducts', true);
                
                document.getElementById('invoiceDate').textContent = formatDateForDisplay(new Date().toISOString());
                
                document.getElementById('invoiceCustomer').addEventListener('change', (e) => updateCustomerInfo('invoiceCustomer', 'customerPhoneDisplay', 'customerAddressDisplay'));
                document.getElementById('editInvoiceCustomer').addEventListener('change', (e) => updateCustomerInfo('editInvoiceCustomer', 'editCustomerPhoneDisplay', 'editCustomerAddressDisplay'));

                document.getElementById('scanQrBtn').addEventListener('click', startQrScanner);
                document.getElementById('closeScannerBtn').addEventListener('click', stopQrScanner);


            } catch (error) {
                console.error("Initialization failed:", error);
                Swal.fire('فشل التهيئة', `حدث خطأ أثناء تحميل الصفحة: ${error.message}`, 'error');
            }
        });
    </script>
</body>
</html><!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>بيع المنتجات</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!-- QR Code Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode@2.0.9/dist/html5-qrcode.min.js"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Cairo', sans-serif;
            background: linear-gradient(135deg, #f0f2f5, #d9e2ec);
            color: #333;
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .home-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: linear-gradient(90deg, #3F2A56, #5a3f73);
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            text-decoration: none;
            font-size: 1rem;
            font-weight: 600;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            transition: transform 0.2s ease, background 0.3s ease, box-shadow 0.3s ease;
            position: absolute;
            top: 20px;
            left: 20px;
        }
        .home-btn:hover {
            background: linear-gradient(90deg, #5a3f73, #3F2A56);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
        }
        .header {
            background: linear-gradient(135deg, #3F2A56, #5a3f73);
            color: white;
            padding: 40px 20px;
            border-radius: 25px;
            text-align: center;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
            margin-bottom: 30px;
            position: relative;
            z-index: 1;
            border: 2px solid rgba(255, 255, 255, 0.1);
        }
        .header img {
            height: 90px;
            margin-bottom: 15px;
            filter: drop-shadow(0 3px 6px rgba(0, 0, 0, 0.3));
        }
        .header h2 {
            font-size: 2.2rem;
            margin-bottom: 10px;
            font-weight: 700;
        }
        .header h4 {
            font-size: 1.4rem;
            opacity: 0.9;
            font-weight: 400;
        }
        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        .card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: #3F2A56;
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            text-align: center;
            transition: transform 0.3s ease;
        }
        .card:hover {
            transform: translateY(-10px);
        }
        .card i {
            font-size: 2.8rem;
            margin-bottom: 15px;
            color: #3F2A56;
        }
        .card h5 {
            font-size: 1.3rem;
            margin-bottom: 10px;
            font-weight: 600;
        }
        .card h3 {
            font-size: 1.8rem;
            font-weight: 700;
        }
        .section {
            background: white;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
            padding: 20px;
            margin: 20px 0;
        }
        .section h3 {
            font-size: 1.7rem;
            font-weight: 700;
            color: #3F2A56;
            margin-bottom: 15px;
            text-align: center;
        }
        .table-container {
            overflow-x: auto;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            padding: 12px;
            text-align: center;
            border-bottom: 1px solid #e0e0e0;
        }
        th {
            background: linear-gradient(90deg, #3F2A56, #5a3f73);
            color: white;
            font-weight: 700;
        }
        td {
            color: #3F2A56;
        }
        tr:hover {
            background-color: #f7f9fc;
        }
        .actions {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin: 25px 0;
            justify-content: center;
        }
        .btn {
            background: linear-gradient(90deg, #3F2A56, #5a3f73);
            color: white;
            padding: 12px 24px;
            border-radius: 30px;
            border: none;
            font-size: 1rem;
            cursor: pointer;
            transition: transform 0.2s ease, background 0.3s ease, box-shadow 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .btn:hover {
            background: linear-gradient(90deg, #5a3f73, #3F2A56);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.2);
        }
        .search-container {
            margin-bottom: 20px;
            display: flex;
            justify-content: center;
            align-items: flex-end; /* Align items to bottom for button */
            gap: 15px;
            flex-wrap: wrap;
        }
        .filter-group {
            display: flex;
            flex-direction: column;
            max-width: 200px;
        }
        .filter-group label {
            font-size: 0.9rem;
            font-weight: 600;
            color: #3F2A56;
            margin-bottom: 5px;
        }
        .filter-group input, .filter-group select {
            padding: 12px;
            border-radius: 30px;
            border: none;
            background: rgba(255, 255, 255, 0.1);
            color: #3F2A56;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        .filter-group input:focus, .filter-group select:focus {
            outline: none;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2);
        }
        #scanQrBtn {
            padding: 10px 15px; /* Adjust padding */
            height: 46px; /* Match input height */
            border-radius: 30px;
        }
         #qr-reader-container {
            margin-top: 10px;
            border: 1px solid #ccc;
            border-radius: 10px;
            padding:10px;
            background-color: #f9f9f9;
        }
        #qr-reader {
            width: 100%;
            max-width: 400px; /* Adjust as needed */
            margin: 0 auto;
        }

        .action-btn {
            cursor: pointer;
            margin: 0 6px;
            font-size: 1.3rem;
            transition: color 0.3s ease;
        }
        .action-btn.edit:hover { color: #007bff; }
        /* .action-btn.delete:hover { color: #dc3545; } */ /* Delete button removed from UI */
        .action-btn.print:hover { color: #28a745; }

        .modal-content {
            border-radius: 20px;
            background: linear-gradient(145deg, #ffffff, #f7f9fc);
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }
        .modal-header {
            background: linear-gradient(90deg, #3F2A56, #5a3f73);
            color: white;
            border-top-left-radius: 20px;
            border-top-right-radius: 20px;
            padding: 20px;
        }
        .modal-title {
            font-size: 1.5rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .modal-body {
            padding: 30px;
        }
        .modal-body .form-label {
            font-weight: 600;
            color: #3F2A56;
        }
        .modal-body .form-control, .modal-body .form-select {
            border-radius: 15px;
            padding: 12px;
            background: #f7f9fc;
            border: 1px solid #ddd;
        }
         .modal-body .form-control:focus, .modal-body .form-select:focus {
            border-color: #3F2A56;
            box-shadow: 0 0 0 0.25rem rgba(63, 42, 86, 0.25);
        }
        .modal-footer {
            padding: 20px;
            background: #f8f9fa;
            border-bottom-left-radius: 20px;
            border-bottom-right-radius: 20px;
        }
        .modal-footer .btn {
            padding: 12px 30px;
        }
        .product-table th, .product-table td {
            padding: 8px;
        }
        .modal-body .product-table th { /* Change header text color in modal product tables */
            color: white;
             background: linear-gradient(90deg, #3F2A56, #5a3f73); /* Optional: match main table header */
        }
        .status-paid { color: #198754; font-weight: 700; }
        .status-partial { color: #ffc107; font-weight: 700; }
        .status-unpaid { color: #dc3545; font-weight: 700; }
        .swal2-popup {
            font-family: 'Cairo', sans-serif !important;
            border-radius: 15px !important;
        }
        .swal2-title { color: #3F2A56 !important; }
        .swal2-html-container { text-align: right !important; }
        .swal2-confirm {
            background: linear-gradient(90deg, #3F2A56, #5a3f73) !important;
            border-radius: 20px !important;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2) !important;
        }
        .swal2-cancel, .swال2-deny {
            background: linear-gradient(90deg, #6c757d, #5a6268) !important;
            border-radius: 20px !important;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2) !important;
        }
        #productSuggestions div, #editProductSuggestions div {
            padding: 8px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        #productSuggestions div:hover, #editProductSuggestions div:hover {
            background-color: #f0f0f0;
        }

        @media (max-width: 768px) {
            .header { padding: 25px 15px; }
            .header img { height: 70px; }
            .header h2 { font-size: 1.7rem; }
            .btn { padding: 10px 18px; font-size: 0.9rem; }
            th, td { padding: 10px; font-size: 0.9rem; }
            .modal-body { padding: 20px; }
            .search-container { flex-direction: column; align-items: stretch;}
            .filter-group { max-width: none; }
            #scanQrBtn { width: 100%; margin-top: 10px;}
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <img src="logo.png" alt="شعار طيبة المدينة تلكوم" onerror="this.src='https://via.placeholder.com/90?text=Logo'; this.style.display='none';">
            <h2>طيبة المدينة تلكوم</h2>
            <h4>بيع المنتجات</h4>
            <a href="home.html" class="home-btn"><i class="fas fa-home"></i> للرئيسية</a>
        </div>
        <div class="dashboard">
            <div class="card">
                <i class="fas fa-check-circle"></i>
                <h5>الفواتير المدفوعة</h5>
                <h3 id="paidInvoices">0</h3>
            </div>
            <div class="card">
                <i class="fas fa-exclamation-circle"></i>
                <h5>الفواتير المدفوعة جزئيًا</h5>
                <h3 id="partialInvoices">0</h3>
            </div>
            <div class="card">
                <i class="fas fa-times-circle"></i>
                <h5>الفواتير غير المدفوعة</h5>
                <h3 id="unpaidInvoices">0</h3>
            </div>
        </div>
        <div class="actions">
            <button class="btn" data-bs-toggle="modal" data-bs-target="#addInvoiceModal"><i class="fas fa-plus"></i> إضافة فاتورة</button>
            <button class="btn" data-bs-toggle="modal" data-bs-target="#addCustomerModal"><i class="fas fa-user-plus"></i> إضافة زبون</button>
            <button class="btn" data-bs-toggle="modal" data-bs-target="#customerStatementModal"><i class="fas fa-file-alt"></i> كشف حساب زبون</button>
        </div>
        <div class="section">
            <h3>الفواتير</h3>
            <div class="search-container">
                <div class="filter-group">
                    <label for="searchInput">البحث</label>
                    <input type="text" id="searchInput" placeholder="ابحث بالزبون أو معرف الفاتورة" oninput="filterTable()">
                </div>
                <button id="scanQrBtn" class="btn btn-info" title="مسح QR Code للبحث عن فاتورة"><i class="fas fa-qrcode"></i> مسح</button>
                <div class="filter-group">
                    <label for="statusFilter">حالة الفاتورة</label>
                    <select id="statusFilter" onchange="filterTable()">
                        <option value="all">الكل</option>
                        <option value="paid">مدفوع</option>
                        <option value="partial">مدفوع جزئيًا</option>
                        <option value="unpaid">لم يتم الدفع</option>
                    </select>
                </div>
            </div>
             <div id="qr-reader-container" style="display: none;">
                <div id="qr-reader"></div>
                <button id="closeScannerBtn" class="btn btn-sm btn-danger mt-2" style="display:block; margin: 0 auto;">إغلاق الماسح</button>
            </div>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>معرف الفاتورة</th>
                            <th>الزبون</th>
                            <th>رقم الهاتف</th>
                            <th>المبلغ الكلي</th>
                            <th>حالة الفاتورة</th>
                            <th>الإجراءات</th>
                        </tr>
                    </thead>
                    <tbody id="invoicesTable"></tbody>
                </table>
            </div>
        </div>
        <div class="section">
            <h3>إدارة الزبائن</h3>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>الاسم</th>
                            <th>رقم الهاتف</th>
                            <th>العنوان</th>
                            <th>الإجراءات</th>
                        </tr>
                    </thead>
                    <tbody id="customersTable"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- نافذة إضافة فاتورة -->
    <div class="modal fade" id="addInvoiceModal" tabindex="-1" aria-labelledby="addInvoiceModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addInvoiceModalLabel"><i class="fas fa-file-invoice-dollar"></i> إضافة فاتورة جديدة</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="addInvoiceForm">
                        <div class="mb-3">
                            <label for="invoiceCustomer" class="form-label"><i class="fas fa-user"></i> الزبون</label>
                            <select class="form-select" id="invoiceCustomer" required>
                                <option value="">اختر زبونًا</option>
                            </select>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="customerPhoneDisplay" class="form-label"><i class="fas fa-phone"></i> رقم الهاتف</label>
                                <input type="text" class="form-control" id="customerPhoneDisplay" readonly>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="customerAddressDisplay" class="form-label"><i class="fas fa-map-marker-alt"></i> العنوان</label>
                                <input type="text" class="form-control" id="customerAddressDisplay" readonly>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="productSearch" class="form-label"><i class="fas fa-search"></i> البحث عن منتج</label>
                            <input type="text" class="form-control" id="productSearch" placeholder="ابحث بالاسم أو المعرف">
                            <div id="productSuggestions" class="mt-2 list-group" style="max-height: 150px; overflow-y: auto;"></div>
                        </div>
                        <h5><i class="fas fa-boxes"></i> المنتجات</h5>
                        <div class="table-container">
                            <table class="product-table table">
                                <thead>
                                    <tr>
                                        <th>اسم المنتج</th>
                                        <th>سعر البيع</th>
                                        <th>الكمية</th>
                                        <th>الملاحظة</th>
                                        <th>الإجمالي</th>
                                        <th>الإجراءات</th>
                                    </tr>
                                </thead>
                                <tbody id="invoiceProducts"></tbody>
                            </table>
                        </div>
                        <div class="mt-3">
                            <p><strong><i class="fas fa-calendar-alt"></i> التاريخ:</strong> <span id="invoiceDate"></span></p>
                            <p><strong><i class="fas fa-hashtag"></i> عدد المواد:</strong> <span id="totalItems">0</span></p>
                            <p><strong><i class="fas fa-coins"></i> المجموع الكلي:</strong> <span id="totalAmount">0.00</span></p>
                            <div class="mb-3">
                                <label for="amountPaid" class="form-label"><i class="fas fa-money-bill-wave"></i> المبلغ المدفوع</label>
                                <input type="number" class="form-control" id="amountPaid" step="0.01" min="0" value="0">
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
                    <button type="button" class="btn btn-primary" onclick="addInvoice()">حفظ الفاتورة</button>
                </div>
            </div>
        </div>
    </div>

    <!-- نافذة تعديل فاتورة -->
    <div class="modal fade" id="editInvoiceModal" tabindex="-1" aria-labelledby="editInvoiceModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editInvoiceModalLabel"><i class="fas fa-edit"></i> تعديل فاتورة</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="editInvoiceForm">
                        <input type="hidden" id="editInvoiceId">
                        <div class="mb-3">
                            <label for="editInvoiceCustomer" class="form-label"><i class="fas fa-user"></i> الزبون</label>
                            <select class="form-select" id="editInvoiceCustomer" required>
                                <option value="">اختر زبونًا</option>
                            </select>
                        </div>
                         <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="editCustomerPhoneDisplay" class="form-label"><i class="fas fa-phone"></i> رقم الهاتف</label>
                                <input type="text" class="form-control" id="editCustomerPhoneDisplay" readonly>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="editCustomerAddressDisplay" class="form-label"><i class="fas fa-map-marker-alt"></i> العنوان</label>
                                <input type="text" class="form-control" id="editCustomerAddressDisplay" readonly>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="editProductSearch" class="form-label"><i class="fas fa-search"></i> البحث عن منتج</label>
                            <input type="text" class="form-control" id="editProductSearch" placeholder="ابحث بالاسم أو المعرف">
                            <div id="editProductSuggestions" class="mt-2 list-group" style="max-height: 150px; overflow-y: auto;"></div>
                        </div>
                        <h5><i class="fas fa-boxes"></i> المنتجات</h5>
                        <div class="table-container">
                            <table class="product-table table">
                                <thead>
                                    <tr>
                                        <th>اسم المنتج</th>
                                        <th>سعر البيع</th>
                                        <th>الكمية</th>
                                        <th>الملاحظة</th>
                                        <th>الإجمالي</th>
                                        <th>الإجراءات</th>
                                    </tr>
                                </thead>
                                <tbody id="editInvoiceProducts"></tbody>
                            </table>
                        </div>
                        <div class="mt-3">
                            <p><strong><i class="fas fa-calendar-alt"></i> التاريخ:</strong> <span id="editInvoiceDate"></span></p>
                            <p><strong><i class="fas fa-hashtag"></i> عدد المواد:</strong> <span id="editTotalItems">0</span></p>
                            <p><strong><i class="fas fa-coins"></i> المجموع الكلي:</strong> <span id="editTotalAmount">0.00</span></p>
                            <div class="mb-3">
                                <label for="editAmountPaid" class="form-label"><i class="fas fa-money-bill-wave"></i> المبلغ المدفوع</label>
                                <input type="number" class="form-control" id="editAmountPaid" step="0.01" min="0" value="0">
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
                    <button type="button" class="btn btn-primary" onclick="updateInvoice()">حفظ التعديلات</button>
                </div>
            </div>
        </div>
    </div>

    <!-- نافذة إضافة زبون -->
    <div class="modal fade" id="addCustomerModal" tabindex="-1" aria-labelledby="addCustomerModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addCustomerModalLabel"><i class="fas fa-user-plus"></i> إضافة زبون</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="addCustomerForm">
                        <div class="mb-3">
                            <label for="customerName" class="form-label"><i class="fas fa-signature"></i> اسم الزبون (اختياري)</label>
                            <input type="text" class="form-control" id="customerName">
                        </div>
                        <div class="mb-3">
                            <label for="customerPhone" class="form-label"><i class="fas fa-mobile-alt"></i> رقم الهاتف (اختياري)</label>
                            <input type="tel" class="form-control" id="customerPhone">
                        </div>
                        <div class="mb-3">
                            <label for="customerAddress" class="form-label"><i class="fas fa-home"></i> العنوان (اختياري)</label>
                            <input type="text" class="form-control" id="customerAddress">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
                    <button type="button" class="btn btn-primary" onclick="addCustomer()">حفظ الزبون</button>
                </div>
            </div>
        </div>
    </div>

    <!-- نافذة تعديل زبون -->
    <div class="modal fade" id="editCustomerModal" tabindex="-1" aria-labelledby="editCustomerModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editCustomerModalLabel"><i class="fas fa-user-edit"></i> تعديل زبون</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="editCustomerForm">
                        <input type="hidden" id="editCustomerId">
                        <div class="mb-3">
                            <label for="editCustomerName" class="form-label"><i class="fas fa-signature"></i> اسم الزبون (اختياري)</label>
                            <input type="text" class="form-control" id="editCustomerName">
                        </div>
                        <div class="mb-3">
                            <label for="editCustomerPhone" class="form-label"><i class="fas fa-mobile-alt"></i> رقم الهاتف (اختياري)</label>
                            <input type="tel" class="form-control" id="editCustomerPhone">
                        </div>
                        <div class="mb-3">
                            <label for="editCustomerAddress" class="form-label"><i class="fas fa-home"></i> العنوان (اختياري)</label>
                            <input type="text" class="form-control" id="editCustomerAddress">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
                    <button type="button" class="btn btn-primary" onclick="updateCustomer()">حفظ التعديلات</button>
                </div>
            </div>
        </div>
    </div>

    <!-- نافذة كشف حساب زبون -->
    <div class="modal fade" id="customerStatementModal" tabindex="-1" aria-labelledby="customerStatementModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="customerStatementModalLabel"><i class="fas fa-file-invoice"></i> كشف حساب زبون</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="customerStatementForm">
                        <div class="mb-3">
                            <label for="statementCustomer" class="form-label"><i class="fas fa-user-check"></i> الزبون</label>
                            <select class="form-select" id="statementCustomer" required>
                                <option value="">اختر زبونًا</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="startDate" class="form-label"><i class="fas fa-calendar-day"></i> من تاريخ</label>
                            <input type="date" class="form-control" id="startDate" required>
                        </div>
                        <div class="mb-3">
                            <label for="endDate" class="form-label"><i class="fas fa-calendar-day"></i> إلى تاريخ</label>
                            <input type="date" class="form-control" id="endDate" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
                    <button type="button" class="btn btn-primary" onclick="generateCustomerStatement()">إنشاء الكشف</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let db;
        let html5QrCodeScanner; // For QR Code scanner instance

        // Helper function to format date as DD-MM-YYYY HH:MM
        function formatDateForDisplay(isoString) {
            if (!isoString) return 'N/A';
            const date = new Date(isoString);
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0'); // Months are 0-indexed
            const year = date.getFullYear();
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            return `${day}-${month}-${year} ${hours}:${minutes}`;
        }


        // إعداد IndexedDB
        function initDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open('InventoryDB', 2); 
                request.onupgradeneeded = (event) => {
                    db = event.target.result;
                    if (!db.objectStoreNames.contains('products')) {
                        db.createObjectStore('products', { keyPath: 'id' });
                    }
                    if (!db.objectStoreNames.contains('invoices')) {
                        const invoiceStore = db.createObjectStore('invoices', { keyPath: 'id' });
                        invoiceStore.createIndex('customerId', 'customerId', { unique: false });
                    }
                    if (!db.objectStoreNames.contains('customers')) {
                        const customerStore = db.createObjectStore('customers', { keyPath: 'id' });
                        customerStore.createIndex('phone', 'phone', { unique: false }); 
                    }
                };
                request.onsuccess = (event) => {
                    db = event.target.result;
                    resolve(db);
                };
                request.onerror = (event) => {
                    console.error("Database error: " + event.target.errorCode);
                    reject(event.target.error);
                };
            });
        }
        
        async function ensureDBInitialized() {
            if (!db) {
                try {
                    await initDB();
                } catch (error) {
                    console.error('Failed to initialize database:', error);
                    throw new Error('Failed to initialize database: ' + error.message);
                }
            }
            if (!db) { 
                throw new Error('Database not ready after initialization attempt.');
            }
        }

        async function generateUniqueId(storeName) {
            await ensureDBInitialized();
            let id;
            let isUnique = false;
            const existingIds = await getAllIds(storeName); 
            while (!isUnique) {
                id = Math.floor(10000 + Math.random() * 90000).toString();
                isUnique = !existingIds.includes(id);
            }
            return id;
        }

        function getAllIds(storeName) {
            return new Promise(async (resolve, reject) => {
                try {
                    await ensureDBInitialized();
                    const transaction = db.transaction([storeName], 'readonly');
                    const store = transaction.objectStore(storeName);
                    const request = store.getAllKeys(); 
                    request.onsuccess = () => {
                        resolve(request.result);
                    };
                    request.onerror = (event) => reject(event.target.error);
                } catch (error) {
                    reject(error);
                }
            });
        }

        function getAllProducts() {
            return new Promise(async (resolve, reject) => {
                try {
                    await ensureDBInitialized();
                    const transaction = db.transaction(['products'], 'readonly');
                    const store = transaction.objectStore('products');
                    const request = store.getAll();
                    request.onsuccess = () => resolve(request.result || []);
                    request.onerror = (event) => reject(event.target.error);
                } catch (error) {
                    reject(error);
                }
            });
        }
        
        function checkProductExists(productId) {
            return new Promise(async (resolve) => {
                try {
                    await ensureDBInitialized();
                    const transaction = db.transaction(['products'], 'readonly');
                    const store = transaction.objectStore('products');
                    const request = store.get(productId);
                    request.onsuccess = () => resolve(!!request.result); // True if product exists
                    request.onerror = () => resolve(false); // Error, assume not exists
                } catch (e) { resolve(false); }
            });
        }


        function getAllInvoices() {
            return new Promise(async (resolve, reject) => {
                try {
                    await ensureDBInitialized();
                    const transaction = db.transaction(['invoices'], 'readonly');
                    const store = transaction.objectStore('invoices');
                    const request = store.getAll();
                    request.onsuccess = () => resolve(request.result || []);
                    request.onerror = (event) => reject(event.target.error);
                } catch (error) {
                    reject(error);
                }
            });
        }

        function getAllCustomers() {
            return new Promise(async (resolve, reject) => {
                try {
                    await ensureDBInitialized();
                    const transaction = db.transaction(['customers'], 'readonly');
                    const store = transaction.objectStore('customers');
                    const request = store.getAll();
                    request.onsuccess = () => resolve(request.result || []);
                    request.onerror = (event) => reject(event.target.error);
                } catch (error) {
                    reject(error);
                }
            });
        }

        async function updateDashboard() {
            const invoices = await getAllInvoices();
            const paid = invoices.filter(i => parseFloat(i.amountPaid) >= parseFloat(i.totalAmount) && parseFloat(i.totalAmount) > 0).length;
            const partial = invoices.filter(i => parseFloat(i.amountPaid) > 0 && parseFloat(i.amountPaid) < parseFloat(i.totalAmount)).length;
            const unpaid = invoices.filter(i => parseFloat(i.amountPaid) === 0 && parseFloat(i.totalAmount) > 0).length;


            document.getElementById('paidInvoices').innerText = paid;
            document.getElementById('partialInvoices').innerText = partial;
            document.getElementById('unpaidInvoices').innerText = unpaid;
        }

        async function updateInvoicesTable() {
            const invoices = await getAllInvoices();
            const customers = await getAllCustomers();
            const tableBody = document.getElementById('invoicesTable');
            tableBody.innerHTML = '';

            invoices.sort((a, b) => new Date(b.date) - new Date(a.date)); 

            invoices.forEach((invoice, index) => {
                const customer = customers.find(c => c.id === invoice.customerId);
                const totalAmount = parseFloat(invoice.totalAmount);
                const amountPaid = parseFloat(invoice.amountPaid);
                let statusClass, statusText;

                if (totalAmount === 0 && amountPaid === 0) { // Consider invoices with 0 total and 0 paid (e.g. returns or empty)
                    statusClass = ''; // No specific class or a 'neutral' class
                    statusText = 'لا يوجد مبلغ';
                } else if (amountPaid >= totalAmount) {
                    statusClass = 'status-paid';
                    statusText = 'مدفوع';
                } else if (amountPaid > 0) {
                    statusClass = 'status-partial';
                    statusText = 'مدفوع جزئيًا';
                } else { // amountPaid is 0 and totalAmount > 0
                    statusClass = 'status-unpaid';
                    statusText = 'لم يتم الدفع';
                }


                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${invoice.id}</td>
                    <td>${customer?.name || 'زبون محذوف/غير معروف'}</td>
                    <td>${customer?.phone || '-'}</td>
                    <td>${totalAmount.toFixed(2)}</td>
                    <td class="${statusClass}">${statusText}</td>
                    <td>
                        <i class="fas fa-print action-btn print" onclick="printInvoice('${invoice.id}')" title="طباعة"></i>
                        <i class="fas fa-edit action-btn edit" onclick="editInvoice('${invoice.id}')" title="تعديل"></i>
                        <!-- Delete button removed from UI as requested -->
                    </td>
                `;
                tableBody.appendChild(row);
            });
            updateDashboard(); // Update dashboard after table is updated
            // filterTable(); // Call filterTable if you want to apply existing filters immediately after refresh
        }

        async function updateCustomersTable() {
            const customers = await getAllCustomers();
            const tableBody = document.getElementById('customersTable');
            tableBody.innerHTML = '';

            customers.forEach((customer, index) => {
                const row = document.createElement('tr');
                const displayName = customer.name || 'زبون بدون اسم';
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${displayName}</td>
                    <td>${customer.phone || '-'}</td>
                    <td>${customer.address || '-'}</td>
                    <td>
                        <i class="fas fa-edit action-btn edit" onclick="editCustomer('${customer.id}')" title="تعديل"></i>
                        <i class="fas fa-trash action-btn delete" onclick="deleteCustomer('${customer.id}')" title="حذف"></i>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }

        async function filterTable() {
            const searchInput = document.getElementById('searchInput').value.toLowerCase();
            const statusFilter = document.getElementById('statusFilter').value;
            const invoices = await getAllInvoices(); // Fetch fresh list
            const customers = await getAllCustomers(); // Fetch fresh list
            const tableBody = document.getElementById('invoicesTable');
            
            const filteredInvoices = invoices.filter(invoice => {
                const customer = customers.find(c => c.id === invoice.customerId);
                const customerName = customer?.name?.toLowerCase() || '';
                const matchesSearch = customerName.includes(searchInput) || invoice.id.includes(searchInput);
                
                if (!matchesSearch) return false;

                const totalAmount = parseFloat(invoice.totalAmount);
                const amountPaid = parseFloat(invoice.amountPaid);

                if (statusFilter === 'all') return true;
                if (statusFilter === 'paid') return amountPaid >= totalAmount && totalAmount > 0; // Ensure total > 0 for 'paid'
                if (statusFilter === 'partial') return amountPaid > 0 && amountPaid < totalAmount;
                if (statusFilter === 'unpaid') return amountPaid === 0 && totalAmount > 0; // Ensure total > 0 for 'unpaid'
                
                // This case should ideally not be reached if statusFilter has a valid value from the dropdown.
                // If it's reached, it means an unknown filter value, so include the item.
                return true; 
            });

            tableBody.innerHTML = ''; 
            filteredInvoices.sort((a, b) => new Date(b.date) - new Date(a.date)); // Re-sort filtered results

            filteredInvoices.forEach((invoice, index) => {
                const customer = customers.find(c => c.id === invoice.customerId);
                const totalAmount = parseFloat(invoice.totalAmount);
                const amountPaid = parseFloat(invoice.amountPaid);
                let statusClass, statusText;

                 if (totalAmount === 0 && amountPaid === 0) {
                    statusClass = ''; statusText = 'لا يوجد مبلغ';
                } else if (amountPaid >= totalAmount) {
                    statusClass = 'status-paid'; statusText = 'مدفوع';
                } else if (amountPaid > 0) {
                    statusClass = 'status-partial'; statusText = 'مدفوع جزئيًا';
                } else {
                    statusClass = 'status-unpaid'; statusText = 'لم يتم الدفع';
                }

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${invoice.id}</td>
                    <td>${customer?.name || 'زبون محذوف/غير معروف'}</td>
                    <td>${customer?.phone || '-'}</td>
                    <td>${totalAmount.toFixed(2)}</td>
                    <td class="${statusClass}">${statusText}</td>
                    <td>
                        <i class="fas fa-print action-btn print" onclick="printInvoice('${invoice.id}')" title="طباعة"></i>
                        <i class="fas fa-edit action-btn edit" onclick="editInvoice('${invoice.id}')" title="تعديل"></i>
                    </td>
                `;
                tableBody.appendChild(row);
            });
            // No need to call updateDashboard here as it's called in updateInvoicesTable which is called by other functions.
            // However, if filterTable is called independently (e.g., on search input), then dashboard might need update based on filtered view, or just reflect all invoices.
            // For simplicity, let dashboard always reflect all invoices. It's updated by main table update functions.
        }


        async function populateCustomerSelect(selectElementId) {
            const customers = await getAllCustomers();
            const select = document.getElementById(selectElementId);
            const currentValue = select.value; // Preserve current selection if possible
            select.innerHTML = '<option value="">اختر زبونًا...</option>'; 
            customers.forEach(customer => {
                const option = document.createElement('option');
                option.value = customer.id;
                option.textContent = customer.name || `زبون (${customer.phone || 'معرف: ' + customer.id.slice(0,5)})`;
                select.appendChild(option);
            });
            if (currentValue) { // Attempt to restore selection
                 select.value = currentValue;
            }
        }

        async function updateCustomerInfo(selectElementId, phoneElementId, addressElementId) {
            const customerId = document.getElementById(selectElementId).value;
            const phoneInput = document.getElementById(phoneElementId);
            const addressInput = document.getElementById(addressElementId);

            if (customerId) {
                const customers = await getAllCustomers(); // Fetch fresh customer data
                const customer = customers.find(c => c.id === customerId);
                phoneInput.value = customer?.phone || '';
                addressInput.value = customer?.address || '';
            } else {
                phoneInput.value = '';
                addressInput.value = '';
            }
        }
        
        async function setupProductSearch(searchElementId, suggestionsElementId, productsTableId, isEditModal = false) {
            const searchInput = document.getElementById(searchElementId);
            const suggestionsDiv = document.getElementById(suggestionsElementId);
            
            searchInput.addEventListener('input', async (e) => {
                const query = e.target.value.toLowerCase().trim();
                suggestionsDiv.innerHTML = ''; 
                if (query.length < 1) return; 

                const allProducts = await getAllProducts();
                const availableProducts = allProducts.filter(p => p.quantity > 0); 
                
                const filteredProducts = availableProducts.filter(p => 
                    p.name.toLowerCase().includes(query) || 
                    p.id.includes(query)
                ).slice(0, 10); 

                if (filteredProducts.length > 0) {
                    filteredProducts.forEach(product => {
                        const div = document.createElement('div');
                        div.className = 'list-group-item list-group-item-action';
                        
                        const salePriceFormatted = parseFloat(product.salePrice || 0).toFixed(2);
                        
                        // --- MODIFICATION FOR costPrice ---
                        let costPriceFormatted;
                        if (typeof product.costPrice === 'number') { // Handles 0 as a valid cost price
                            costPriceFormatted = parseFloat(product.costPrice).toFixed(2);
                        } else if (product.costPrice && !isNaN(parseFloat(product.costPrice))) { // Handles string numbers
                            costPriceFormatted = parseFloat(product.costPrice).toFixed(2);
                        } else {
                            costPriceFormatted = 'غ/م'; // Not available or not a valid number
                        }
                        // --- END MODIFICATION ---
                        
                        div.innerHTML = `
                            <strong>${product.name}</strong> (المعرف: ${product.id}) <br>
                            <small>
                                سعر البيع: ${salePriceFormatted} | 
                                سعر الشراء: ${costPriceFormatted} | 
                                الكمية المتوفرة: ${product.quantity}
                            </small>
                        `;
                        div.onclick = () => {
                            addProductToInvoice(product, productsTableId);
                            searchInput.value = ''; 
                            suggestionsDiv.innerHTML = ''; 
                        };
                        suggestionsDiv.appendChild(div);
                    });
                } else {
                    suggestionsDiv.innerHTML = '<div class="list-group-item">لا توجد منتجات مطابقة أو غير متوفرة.</div>';
                }
            });
        }


        function addProductToInvoice(product, productsTableId) {
            const tableBody = document.getElementById(productsTableId);
            const existingRow = Array.from(tableBody.rows).find(row => row.dataset.productId === product.id);

            if (existingRow) {
                const quantityInput = existingRow.querySelector('.quantity');
                const currentQuantity = parseInt(quantityInput.value);
                if (currentQuantity < product.quantity) { 
                    quantityInput.value = currentQuantity + 1;
                } else {
                    Swal.fire('تنبيه', `الكمية المطلوبة للمنتج "${product.name}" تتجاوز المخزون المتاح (${product.quantity}).`, 'warning');
                    return;
                }
            } else {
                if (product.quantity < 1) { 
                     Swal.fire('تنبيه', `المنتج "${product.name}" غير متوفر في المخزون.`, 'warning');
                    return;
                }
                const row = tableBody.insertRow();
                row.dataset.productId = product.id; 
                
                row.innerHTML = `
                    <td>${product.name}</td>
                    <td><input type="number" class="form-control form-control-sm sale-price" value="${parseFloat(product.salePrice || 0).toFixed(2)}" step="0.01" min="0.01"></td>
                    <td><input type="number" class="form-control form-control-sm quantity" value="1" min="1" max="${product.quantity}"></td>
                    <td><input type="text" class="form-control form-control-sm note" placeholder="ملاحظة (اختياري)"></td>
                    <td class="total">${parseFloat(product.salePrice || 0).toFixed(2)}</td>
                    <td><button type="button" class="btn btn-sm btn-danger" onclick="removeProductFromInvoice(this.closest('tr'), '${productsTableId}')"><i class="fas fa-trash-alt"></i></button></td>
                `;
                row.querySelector('.sale-price').addEventListener('input', () => updateInvoiceTotals(productsTableId));
                row.querySelector('.quantity').addEventListener('input', (e) => {
                    const requestedQuantity = parseInt(e.target.value);
                    const maxQuantityForThisProduct = parseInt(e.target.max); // Use the max attribute of the input

                    if (requestedQuantity > maxQuantityForThisProduct) {
                        e.target.value = maxQuantityForThisProduct; 
                        Swal.fire('تنبيه', `الكمية المطلوبة للمنتج "${product.name}" تتجاوز المخزون المتاح (${maxQuantityForThisProduct}). تم التعديل للحد الأقصى.`, 'warning');
                    }
                    updateInvoiceTotals(productsTableId);
                });
            }
            updateInvoiceTotals(productsTableId);
        }


        function removeProductFromInvoice(rowElement, productsTableId) {
            rowElement.remove();
            updateInvoiceTotals(productsTableId);
        }

        function updateInvoiceTotals(productsTableId) {
            const tableBody = document.getElementById(productsTableId);
            const rows = tableBody.querySelectorAll('tr');
            let totalAmount = 0;
            let totalItemsCount = 0; 

            rows.forEach(row => {
                const salePriceInput = row.querySelector('.sale-price');
                const quantityInput = row.querySelector('.quantity');
                
                const salePrice = parseFloat(salePriceInput.value) || 0;
                const quantity = parseInt(quantityInput.value) || 0;
                
                const itemTotal = salePrice * quantity;
                row.querySelector('.total').textContent = itemTotal.toFixed(2);
                totalAmount += itemTotal;
                totalItemsCount++; 
            });

            const isEditModal = productsTableId === 'editInvoiceProducts';
            document.getElementById(isEditModal ? 'editTotalItems' : 'totalItems').textContent = totalItemsCount; 
            document.getElementById(isEditModal ? 'editTotalAmount' : 'totalAmount').textContent = totalAmount.toFixed(2);
        }

        async function addInvoice() {
            const customerId = document.getElementById('invoiceCustomer').value;
            const amountPaidValue = document.getElementById('amountPaid').value;
            const productsTable = document.getElementById('invoiceProducts');
            const rows = productsTable.querySelectorAll('tr');

            if (!customerId) {
                Swal.fire('خطأ', 'الرجاء اختيار زبون!', 'error'); return;
            }
            if (rows.length === 0) {
                Swal.fire('خطأ', 'الرجاء إضافة منتج واحد على الأقل للفاتورة!', 'error'); return;
            }
            const amountPaid = parseFloat(amountPaidValue);
            if (isNaN(amountPaid) || amountPaid < 0) {
                 Swal.fire('خطأ', 'المبلغ المدفوع غير صحيح!', 'error'); return;
            }

            const productsInInvoice = [];
            let totalAmount = 0;
            let stockUpdatePromises = [];

            for (const row of rows) {
                const productId = row.dataset.productId;
                const name = row.cells[0].textContent;
                const salePrice = parseFloat(row.querySelector('.sale-price').value);
                const quantitySold = parseInt(row.querySelector('.quantity').value);
                const note = row.querySelector('.note').value;
                const itemTotal = salePrice * quantitySold;

                if (isNaN(salePrice) || salePrice <=0 || isNaN(quantitySold) || quantitySold <=0) {
                    Swal.fire('خطأ', `بيانات غير صالحة للمنتج "${name}". تأكد من السعر والكمية.`, 'error'); return;
                }

                productsInInvoice.push({ productId, name, salePrice, quantity: quantitySold, note, total: itemTotal });
                totalAmount += itemTotal;
                stockUpdatePromises.push(updateProductStock(productId, quantitySold));
            }
             if (amountPaid > totalAmount) {
                Swal.fire('خطأ', 'المبلغ المدفوع لا يمكن أن يكون أكبر من المجموع الكلي للفاتورة!', 'error'); return;
            }

            try {
                await Promise.all(stockUpdatePromises); 
            } catch (error) {
                Swal.fire('خطأ في تحديث المخزون', error.message, 'error');
                return;
            }

            const id = await generateUniqueId('invoices');
            const invoice = {
                id,
                customerId,
                products: productsInInvoice,
                totalAmount: totalAmount.toFixed(2),
                amountPaid: amountPaid.toFixed(2),
                date: new Date().toISOString()
            };

            const transaction = db.transaction(['invoices'], 'readwrite');
            const store = transaction.objectStore('invoices');
            const request = store.add(invoice);

            request.onsuccess = async () => {
                await updateInvoicesTable(); // This also updates dashboard
                bootstrap.Modal.getInstance(document.getElementById('addInvoiceModal')).hide();
                document.getElementById('addInvoiceForm').reset();
                document.getElementById('invoiceProducts').innerHTML = ''; 
                document.getElementById('totalItems').textContent = '0';
                document.getElementById('totalAmount').textContent = '0.00';
                document.getElementById('customerPhoneDisplay').value = '';
                document.getElementById('customerAddressDisplay').value = '';
                document.getElementById('invoiceDate').textContent = formatDateForDisplay(new Date().toISOString()); // Reset date
                await populateCustomerSelect('invoiceCustomer'); 
                Swal.fire('نجاح', 'تم إضافة الفاتورة وتحديث المخزون بنجاح!', 'success');
            };
            request.onerror = (e) => {
                console.error("Error adding invoice:", e.target.error);
                Swal.fire('خطأ', 'فشل في إضافة الفاتورة!', 'error');
            };
        }
        
        function updateProductStock(productId, quantitySold) {
            return new Promise(async (resolve, reject) => {
                try {
                    await ensureDBInitialized();
                    const transaction = db.transaction(['products'], 'readwrite');
                    const store = transaction.objectStore('products');
                    const getRequest = store.get(productId);

                    getRequest.onsuccess = () => {
                        const product = getRequest.result;
                        if (!product) {
                            reject(new Error(`المنتج بالمعرف ${productId} غير موجود.`));
                            return;
                        }
                        if (product.quantity < quantitySold) {
                            reject(new Error(`الكمية المطلوبة للمنتج "${product.name}" (${quantitySold}) تتجاوز المخزون المتاح (${product.quantity}).`));
                            return;
                        }
                        product.quantity -= quantitySold;
                        const updateRequest = store.put(product);
                        updateRequest.onsuccess = () => resolve();
                        updateRequest.onerror = (e) => reject(new Error(`فشل تحديث مخزون المنتج ${product.name}: ${e.target.error}`));
                    };
                    getRequest.onerror = (e) => reject(new Error(`فشل جلب المنتج ${productId} لتحديث المخزون: ${e.target.error}`));
                } catch (dbError) {
                    reject(dbError);
                }
            });
        }


        async function editInvoice(invoiceId) {
            try {
                await ensureDBInitialized();
                const transaction = db.transaction(['invoices', 'customers', 'products'], 'readonly'); 
                const invoiceStore = transaction.objectStore('invoices');
                const invoiceRequest = invoiceStore.get(invoiceId);

                invoiceRequest.onsuccess = async () => {
                    const invoice = invoiceRequest.result;
                    if (!invoice) {
                        Swal.fire('خطأ', 'الفاتورة غير موجودة!', 'error');
                        return;
                    }
                    
                    document.getElementById('editInvoiceModal').dataset.originalProducts = JSON.stringify(invoice.products);
                    document.getElementById('editInvoiceId').value = invoice.id;
                    
                    const customerSelect = document.getElementById('editInvoiceCustomer');
                    await populateCustomerSelect('editInvoiceCustomer'); 
                    customerSelect.value = invoice.customerId;
                    await updateCustomerInfo('editInvoiceCustomer', 'editCustomerPhoneDisplay', 'editCustomerAddressDisplay');

                    document.getElementById('editInvoiceDate').textContent = formatDateForDisplay(invoice.date);
                    document.getElementById('editAmountPaid').value = parseFloat(invoice.amountPaid).toFixed(2);

                    const tableBody = document.getElementById('editInvoiceProducts');
                    tableBody.innerHTML = ''; 

                    const allProductsFromDB = await getAllProducts(); 

                    invoice.products.forEach(pInInvoice => {
                        const productDetailsFromDB = allProductsFromDB.find(pDB => pDB.id === pInInvoice.productId);
                        const currentStockInDB = productDetailsFromDB ? productDetailsFromDB.quantity : 0;
                        const maxQuantityForInput = currentStockInDB + pInInvoice.quantity;


                        const row = tableBody.insertRow();
                        row.dataset.productId = pInInvoice.productId;
                        row.dataset.originalQuantityInInvoice = pInInvoice.quantity; 
                        row.dataset.maxEditableQuantity = maxQuantityForInput;


                        row.innerHTML = `
                            <td>${pInInvoice.name}</td>
                            <td><input type="number" class="form-control form-control-sm sale-price" value="${parseFloat(pInInvoice.salePrice).toFixed(2)}" step="0.01" min="0.01"></td>
                            <td><input type="number" class="form-control form-control-sm quantity" value="${pInInvoice.quantity}" min="1" max="${maxQuantityForInput}"></td>
                            <td><input type="text" class="form-control form-control-sm note" value="${pInInvoice.note || ''}" placeholder="ملاحظة"></td>
                            <td class="total">${parseFloat(pInInvoice.total).toFixed(2)}</td>
                            <td><button type="button" class="btn btn-sm btn-danger" onclick="removeProductFromInvoice(this.closest('tr'), 'editInvoiceProducts')"><i class="fas fa-trash-alt"></i></button></td>
                        `;
                        row.querySelector('.sale-price').addEventListener('input', () => updateInvoiceTotals('editInvoiceProducts'));
                        row.querySelector('.quantity').addEventListener('input', (e) => {
                             const requestedQuantity = parseInt(e.target.value);
                             const maxAllowed = parseInt(e.target.max); 
                             if (requestedQuantity > maxAllowed) {
                                e.target.value = maxAllowed;
                                Swal.fire('تنبيه', `الكمية المطلوبة للمنتج "${pInInvoice.name}" تتجاوز المخزون المتاح. تم التعديل للحد الأقصى (${maxAllowed}).`, 'warning');
                            }
                            updateInvoiceTotals('editInvoiceProducts');
                        });
                    });

                    updateInvoiceTotals('editInvoiceProducts');
                    new bootstrap.Modal(document.getElementById('editInvoiceModal')).show();
                };
                invoiceRequest.onerror = (e) => Swal.fire('خطأ', `فشل في جلب الفاتورة: ${e.target.error}`, 'error');
            } catch (dbError) {
                 Swal.fire('خطأ قاعدة البيانات', `فشل: ${dbError.message}`, 'error');
            }
        }


        async function updateInvoice() {
            const id = document.getElementById('editInvoiceId').value;
            const customerId = document.getElementById('editInvoiceCustomer').value;
            const amountPaidValue = document.getElementById('editAmountPaid').value;
            const productsTable = document.getElementById('editInvoiceProducts');
            const rows = productsTable.querySelectorAll('tr');
            
            const originalProductsJSON = document.getElementById('editInvoiceModal').dataset.originalProducts;
            const originalProductsInInvoice = JSON.parse(originalProductsJSON || "[]"); 


            if (!customerId) { Swal.fire('خطأ', 'الرجاء اختيار زبون!', 'error'); return; }
            if (rows.length === 0) { Swal.fire('خطأ', 'الفاتورة يجب أن تحتوي على منتج واحد على الأقل!', 'error'); return; }
            const amountPaid = parseFloat(amountPaidValue);
             if (isNaN(amountPaid) || amountPaid < 0) { Swal.fire('خطأ', 'المبلغ المدفوع غير صحيح!', 'error'); return; }


            const updatedProductsInInvoice = [];
            let newTotalAmount = 0;
            let stockAdjustmentPromises = []; 

            for (const row of rows) {
                const productId = row.dataset.productId;
                const name = row.cells[0].textContent;
                const salePrice = parseFloat(row.querySelector('.sale-price').value);
                const newQuantitySold = parseInt(row.querySelector('.quantity').value);
                const note = row.querySelector('.note').value;
                const itemTotal = salePrice * newQuantitySold;

                if (isNaN(salePrice) || salePrice <=0 || isNaN(newQuantitySold) || newQuantitySold <=0) {
                    Swal.fire('خطأ', `بيانات غير صالحة للمنتج "${name}". تأكد من السعر والكمية.`, 'error'); return;
                }

                updatedProductsInInvoice.push({ productId, name, salePrice, quantity: newQuantitySold, note, total: itemTotal });
                newTotalAmount += itemTotal;

                const originalProductInfo = originalProductsInInvoice.find(p => p.productId === productId);
                const originalQuantitySoldInThisInvoice = originalProductInfo ? originalProductInfo.quantity : 0;
                
                const quantityChangeForStock = originalQuantitySoldInThisInvoice - newQuantitySold; 
                
                if (quantityChangeForStock !== 0) {
                    const productExists = await checkProductExists(productId);
                    if (productExists) {
                         stockAdjustmentPromises.push(adjustProductStock(productId, quantityChangeForStock));
                    } else {
                        console.warn(`Product ${productId} not found in DB. Skipping stock adjustment for this item.`);
                    }
                }
            }
            
            originalProductsInInvoice.forEach(async origP => {
                if (!updatedProductsInInvoice.some(updP => updP.productId === origP.productId)) {
                    const productExists = await checkProductExists(origP.productId);
                     if (productExists) {
                        stockAdjustmentPromises.push(adjustProductStock(origP.productId, origP.quantity)); 
                     } else {
                        console.warn(`Product ${origP.productId} (removed from invoice) not found in DB. Skipping stock adjustment for this item.`);
                     }
                }
            });


            if (amountPaid > newTotalAmount) {
                Swal.fire('خطأ', 'المبلغ المدفوع لا يمكن أن يكون أكبر من المجموع الكلي للفاتورة!', 'error'); return;
            }

            try {
                if (stockAdjustmentPromises.length > 0) {
                    await Promise.all(stockAdjustmentPromises);
                }
            } catch (error) {
                Swal.fire('خطأ في تحديث المخزون', error.message, 'error');
                return; 
            }
            
            let invoiceDateStr = document.getElementById('editInvoiceDate').textContent;
            let invoiceDateISO;
            if (invoiceDateStr && invoiceDateStr !== 'N/A') {
                const parts = invoiceDateStr.match(/(\d{2})-(\d{2})-(\d{4}) (\d{2}):(\d{2})/);
                if (parts) {
                    // parts[1]=day, parts[2]=month, parts[3]=year, parts[4]=hour, parts[5]=minute
                    invoiceDateISO = new Date(Date.UTC(parts[3], parts[2] - 1, parts[1], parts[4], parts[5])).toISOString();
                } else {
                    invoiceDateISO = new Date().toISOString(); 
                }
            } else {
                 invoiceDateISO = new Date().toISOString(); 
            }


            const invoice = {
                id,
                customerId,
                products: updatedProductsInInvoice,
                totalAmount: newTotalAmount.toFixed(2),
                amountPaid: amountPaid.toFixed(2),
                date: invoiceDateISO 
            };

            const transaction = db.transaction(['invoices'], 'readwrite');
            const store = transaction.objectStore('invoices');
            const request = store.put(invoice);

            request.onsuccess = async () => {
                await updateInvoicesTable(); // This also updates dashboard
                bootstrap.Modal.getInstance(document.getElementById('editInvoiceModal')).hide();
                Swal.fire('نجاح', 'تم تعديل الفاتورة وتحديث المخزون بنجاح!', 'success');
            };
            request.onerror = (e) => {
                 console.error("Error updating invoice:", e.target.error);
                 Swal.fire('خطأ', 'فشل في تعديل الفاتورة!', 'error');
            };
        }

        function adjustProductStock(productId, quantityChange) {
            return new Promise(async (resolve, reject) => {
                try {
                    await ensureDBInitialized();
                    const transaction = db.transaction(['products'], 'readwrite');
                    const store = transaction.objectStore('products');
                    const getRequest = store.get(productId);

                    getRequest.onsuccess = () => {
                        const product = getRequest.result;
                        if (!product) {
                            // It's possible a product was deleted from inventory system externally
                            // while it was still in an invoice. Log this instead of hard failing the whole invoice update.
                            console.warn(`المنتج بالمعرف ${productId} غير موجود لتعديل المخزون. سيتم تخطي هذا المنتج.`);
                            resolve(); // Resolve to not block other stock adjustments
                            return;
                        }
                        
                        const newStock = product.quantity + quantityChange;
                        if (newStock < 0) { 
                             reject(new Error(`لا يمكن أن يكون مخزون المنتج "${product.name}" سالبًا. التغيير المطلوب للمخزون: ${quantityChange}, المخزون الحالي: ${product.quantity}.`));
                             return;
                        }
                        product.quantity = newStock;

                        const updateRequest = store.put(product);
                        updateRequest.onsuccess = () => resolve();
                        updateRequest.onerror = (e) => reject(new Error(`فشل تعديل مخزون المنتج ${product.name}: ${e.target.error}`));
                    };
                    getRequest.onerror = (e) => reject(new Error(`فشل جلب المنتج ${productId} لتعديل المخزون: ${e.target.error}`));
                } catch (dbError) {
                    reject(dbError);
                }
            });
        }

        async function deleteInvoice(invoiceId) { // This function is not called from UI but kept for potential use
            const result = await Swal.fire({
                title: 'تأكيد الحذف',
                text: 'هل أنت متأكد من حذف هذه الفاتورة؟ سيتم إرجاع الكميات المباعة إلى المخزون.',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'نعم، احذف',
                cancelButtonText: 'إلغاء',
                confirmButtonColor: '#dc3545',
                cancelButtonColor: '#6c757d'
            });

            if (result.isConfirmed) {
                try {
                    await ensureDBInitialized();
                    const readTx = db.transaction(['invoices'], 'readonly'); 
                    const invoiceStoreRead = readTx.objectStore('invoices');
                    const getInvoiceRequest = invoiceStoreRead.get(invoiceId);

                    getInvoiceRequest.onsuccess = async () => {
                        const invoiceToDelete = getInvoiceRequest.result;
                        if (!invoiceToDelete) {
                            Swal.fire('خطأ', 'الفاتورة غير موجودة.', 'error');
                            return;
                        }

                        let stockReturnPromises = [];
                        for (const p of invoiceToDelete.products) {
                            const productExists = await checkProductExists(p.productId);
                            if (productExists) {
                                stockReturnPromises.push(adjustProductStock(p.productId, p.quantity));
                            } else {
                                console.warn(`Product ${p.productId} from deleted invoice not found. Stock not returned for this item.`);
                            }
                        }
                        
                        try {
                            if (stockReturnPromises.length > 0) {
                                await Promise.all(stockReturnPromises); 
                            }

                            const writeTxDelete = db.transaction(['invoices'], 'readwrite');
                            const invoiceStoreWrite = writeTxDelete.objectStore('invoices');
                            const deleteRequest = invoiceStoreWrite.delete(invoiceId);

                            deleteRequest.onsuccess = async () => {
                                await updateInvoicesTable(); // This also updates dashboard
                                Swal.fire('نجاح', 'تم حذف الفاتورة وإرجاع المنتجات للمخزون بنجاح!', 'success');
                            };
                            deleteRequest.onerror = (e) => {
                                console.error("Error deleting invoice:", e.target.error);
                                Swal.fire('خطأ', 'فشل في حذف الفاتورة! (قد يكون المخزون أُرجع).', 'error');
                            };

                        } catch (stockError) {
                            Swal.fire('خطأ في إرجاع المخزون', stockError.message, 'error');
                        }
                    };
                    getInvoiceRequest.onerror = (e) => Swal.fire('خطأ', `فشل في جلب الفاتورة للحذف: ${e.target.error}`, 'error');

                } catch (dbError) {
                     Swal.fire('خطأ قاعدة البيانات', `فشل: ${dbError.message}`, 'error');
                }
            }
        }


        async function addCustomer() {
            const name = document.getElementById('customerName').value.trim();
            const phone = document.getElementById('customerPhone').value.trim();
            const address = document.getElementById('customerAddress').value.trim();
            
            if (!name && !phone && !address) {
                 Swal.fire('خطأ', 'يجب إدخال معلومة واحدة على الأقل للزبون (الاسم أو الهاتف أو العنوان).', 'error');
                 return;
            }

            if (phone) { 
                const customers = await getAllCustomers();
                if (customers.some(c => c.phone === phone && phone !== '')) { // Ensure phone isn't empty string
                    Swal.fire('خطأ', 'رقم الهاتف هذا مُسجل لزبون آخر!', 'error');
                    return;
                }
            }


            const id = await generateUniqueId('customers');
            const customer = { 
                id, 
                name: name || null, // Store null if empty for consistency
                phone: phone || null, 
                address: address || null 
            };


            const transaction = db.transaction(['customers'], 'readwrite');
            const store = transaction.objectStore('customers');
            const request = store.add(customer);

            request.onsuccess = async () => {
                await updateCustomersTable();
                await populateCustomerSelect('invoiceCustomer');
                await populateCustomerSelect('editInvoiceCustomer');
                await populateCustomerSelect('statementCustomer');
                bootstrap.Modal.getInstance(document.getElementById('addCustomerModal')).hide();
                document.getElementById('addCustomerForm').reset();
                Swal.fire('نجاح', 'تم إضافة الزبون بنجاح!', 'success');
            };
            request.onerror = (e) => Swal.fire('خطأ', `فشل في إضافة الزبون: ${e.target.error}`, 'error');
        }

        async function editCustomer(customerId) {
            try {
                await ensureDBInitialized();
                const transaction = db.transaction(['customers'], 'readonly');
                const store = transaction.objectStore('customers');
                const request = store.get(customerId);

                request.onsuccess = () => {
                    const customer = request.result;
                    if (!customer) {
                        Swal.fire('خطأ', 'الزبون غير موجود!', 'error');
                        return;
                    }
                    document.getElementById('editCustomerId').value = customer.id;
                    document.getElementById('editCustomerName').value = customer.name || '';
                    document.getElementById('editCustomerPhone').value = customer.phone || '';
                    document.getElementById('editCustomerAddress').value = customer.address || '';
                    new bootstrap.Modal(document.getElementById('editCustomerModal')).show();
                };
                request.onerror = (e) => Swal.fire('خطأ', `فشل في جلب بيانات الزبون: ${e.target.error}`, 'error');
            } catch (dbError) {
                 Swal.fire('خطأ قاعدة البيانات', `فشل: ${dbError.message}`, 'error');
            }
        }

        async function updateCustomer() {
            const id = document.getElementById('editCustomerId').value;
            const name = document.getElementById('editCustomerName').value.trim();
            const phone = document.getElementById('editCustomerPhone').value.trim();
            const address = document.getElementById('editCustomerAddress').value.trim();

             if (!name && !phone && !address) {
                 Swal.fire('خطأ', 'يجب إدخال معلومة واحدة على الأقل للزبون.', 'error');
                 return;
            }

            if (phone) { 
                const customers = await getAllCustomers();
                if (customers.some(c => c.id !== id && c.phone === phone && phone !== '')) { 
                    Swal.fire('خطأ', 'رقم الهاتف هذا مُسجل لزبون آخر!', 'error');
                    return;
                }
            }

            const customer = { 
                id, 
                name: name || null, 
                phone: phone || null, 
                address: address || null 
            };
            const transaction = db.transaction(['customers'], 'readwrite');
            const store = transaction.objectStore('customers');
            const request = store.put(customer);

            request.onsuccess = async () => {
                await updateCustomersTable();
                await updateInvoicesTable(); // Refresh invoices in case customer name changed
                await populateCustomerSelect('invoiceCustomer');
                await populateCustomerSelect('editInvoiceCustomer');
                await populateCustomerSelect('statementCustomer');
                bootstrap.Modal.getInstance(document.getElementById('editCustomerModal')).hide();
                Swal.fire('نجاح', 'تم تعديل بيانات الزبون بنجاح!', 'success');
            };
            request.onerror = (e) => Swal.fire('خطأ', `فشل في تعديل بيانات الزبون: ${e.target.error}`, 'error');
        }

        async function deleteCustomer(customerId) {
            const invoices = await getAllInvoices();
            if (invoices.some(i => i.customerId === customerId)) {
                Swal.fire('لا يمكن الحذف', 'لا يمكن حذف هذا الزبون لأنه مرتبط بفواتير حالية. يرجى تعديل الفواتير المرتبطة به لزبون آخر أو حذفها (إذا كانت هذه الإمكانية متاحة).', 'error');
                return;
            }


            const result = await Swal.fire({
                title: 'تأكيد الحذف',
                text: 'هل أنت متأكد من حذف هذا الزبون؟ لا يمكن التراجع عن هذا الإجراء.',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'نعم، احذف',
                cancelButtonText: 'إلغاء',
                confirmButtonColor: '#dc3545'
            });

            if (result.isConfirmed) {
                const transaction = db.transaction(['customers'], 'readwrite');
                const store = transaction.objectStore('customers');
                const request = store.delete(customerId);

                request.onsuccess = async () => {
                    await updateCustomersTable();
                    await populateCustomerSelect('invoiceCustomer');
                    await populateCustomerSelect('editInvoiceCustomer');
                    await populateCustomerSelect('statementCustomer');
                    Swal.fire('نجاح', 'تم حذف الزبون بنجاح!', 'success');
                };
                request.onerror = (e) => Swal.fire('خطأ', `فشل في حذف الزبون: ${e.target.error}`, 'error');
            }
        }
        
        async function printInvoice(invoiceId) {
            try {
                await ensureDBInitialized();
                const transaction = db.transaction(['invoices', 'customers'], 'readonly');
                const invoiceStore = transaction.objectStore('invoices');
                const invoiceRequest = invoiceStore.get(invoiceId);

                invoiceRequest.onsuccess = async () => {
                    const invoice = invoiceRequest.result;
                    if (!invoice) { Swal.fire('خطأ', 'الفاتورة غير موجودة.', 'error'); return; }

                    const customers = await getAllCustomers(); 
                    const customer = customers.find(c => c.id === invoice.customerId);
                    
                    const printWindow = window.open('', '_blank', 'height=800,width=600');
                    if (!printWindow) {
                         Swal.fire('خطأ', 'فشل فتح نافذة الطباعة. يرجى التأكد من تعطيل مانع النوافذ المنبثقة.', 'error'); return;
                    }
                    printWindow.document.write(`
                        <!DOCTYPE html>
                        <html lang="ar" dir="rtl">
                        <head>
                            <meta charset="UTF-8">
                            <title>فاتورة رقم: ${invoice.id}</title>
                            <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
                            <style>
                                @page { size: A5 landscape; margin: 5mm; }
                                body { font-family: 'Cairo', sans-serif; direction: rtl; margin: 5mm; font-size: 10pt; }
                                .container { width: 100%; margin: 0 auto; }
                                .header-print { text-align: center; margin-bottom: 10px; border-bottom: 1px solid #ccc; padding-bottom: 5px;}
                                .header-print img { max-height: 40px; margin-bottom: 3px; }
                                .header-print h1 { font-size: 1.1rem; color: #3F2A56; margin:0; }
                                .invoice-info-grid { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px;}
                                .invoice-details-text { flex-basis: 70%;} 
                                .invoice-details, .customer-details { font-size: 0.85rem;}
                                .invoice-details p, .customer-details p { margin: 2px 0; }
                                .qr-code-container { 
                                    flex-basis: auto; /* Adjust to content */
                                    min-width: 75px; 
                                    text-align: center; /* Center the QR code if div is wider */
                                    padding-left: 5px; 
                                } 
                                #invoiceQrCodeElement { /* The div where QR will be generated */
                                    display: inline-block; /* Helps with sizing and centering */
                                }
                                #invoiceQrCodeElement canvas,
                                #invoiceQrCodeElement img {
                                    border: 1px solid #eee; /* Add border to the QR itself */
                                }
                                .products-table { width: 100%; border-collapse: collapse; margin-bottom: 8px; }
                                .products-table th, .products-table td { padding: 4px; border: 1px solid #ccc; text-align: center; font-size: 0.8rem;}
                                .products-table th { background-color: #f2f2f2; color: #333; font-weight:600; }
                                .totals-section { margin-top: 10px; padding-top: 8px; border-top: 1px solid #ccc; text-align:left; font-size: 0.85rem;}
                                .totals-section p { margin: 3px 0; font-weight: 600; }
                                .footer-print { text-align: center; font-size: 0.75rem; margin-top: 15px; color: #777; }
                                @media print {
                                    body { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
                                }
                            </style>
                        </head>
                        <body>
                            <div class="container">
                                <div class="header-print">
                                    <img src="logo.png" alt="شعار" onerror="this.style.display='none';">
                                    <h1>طيبة المدينة تلكوم</h1>
                                    <p style="font-size:0.7rem;">للاتصالات وخدمات الجوال</p>
                                </div>
                                
                                <div class="invoice-info-grid">
                                    <div class="invoice-details-text">
                                        <div class="invoice-details">
                                            <p><strong>رقم الفاتورة:</strong> ${invoice.id}</p>
                                            <p><strong>التاريخ:</strong> ${formatDateForDisplay(invoice.date)}</p>
                                        </div>
                                        <div class="customer-details">
                                            <p><strong>الزبون:</strong> ${customer?.name || 'زبون نقدي'}</p>
                                            ${customer?.phone ? `<p><strong>الهاتف:</strong> ${customer.phone}</p>` : ''}
                                            ${customer?.address ? `<p><strong>العنوان:</strong> ${customer.address}</p>` : ''}
                                        </div>
                                    </div>
                                    <div class="qr-code-container">
                                        <div id="invoiceQrCodeElement"></div> <!-- Target for QRCode.js -->
                                    </div>
                                </div>

                                <table class="products-table">
                                    <thead>
                                        <tr>
                                            <th>م</th>
                                            <th>البيان (اسم المنتج)</th>
                                            <th>س. الوحدة</th>
                                            <th>الكمية</th>
                                            <th>الإجمالي</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${invoice.products.map((p, index) => `
                                            <tr>
                                                <td>${index + 1}</td>
                                                <td style="text-align:right;">${p.name} ${p.note ? `(${p.note})` : ''}</td>
                                                <td>${parseFloat(p.salePrice).toFixed(2)}</td>
                                                <td>${p.quantity}</td>
                                                <td>${parseFloat(p.total).toFixed(2)}</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                                <div class="totals-section">
                                    <p>المجموع الكلي: ${parseFloat(invoice.totalAmount).toFixed(2)}</p>
                                    <p>المبلغ المدفوع: ${parseFloat(invoice.amountPaid).toFixed(2)}</p>
                                    <p>المتبقي: ${(parseFloat(invoice.totalAmount) - parseFloat(invoice.amountPaid)).toFixed(2)}</p>
                                </div>
                                <div class="footer-print">
                                    <p>شكراً لتعاملكم معنا!</p>
                                </div>
                            </div>
                            <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"><\/script>
                            <script>
                                window.onload = function() { // This is the onload for the print window's content
                                    var qrElement = document.getElementById('invoiceQrCodeElement');
                                    if (qrElement && typeof QRCode !== 'undefined') {
                                        new QRCode(qrElement, {
                                            text: "${invoice.id}",
                                            width: 65,
                                            height: 65,
                                            colorDark : "#000000",
                                            colorLight : "#ffffff",
                                            correctLevel : QRCode.CorrectLevel.H
                                        });
                                    } else {
                                        console.error("QR Code generation failed in print window: Element or QRCode library not found.");
                                    }
                                };
                            <\/script>
                        </body>
                        </html>
                    `);
                    printWindow.document.close(); 
                    printWindow.onload = function() { // This is for the parent window's reference to the new window object
                        // The new window's own window.onload (for its content) should have fired by now.
                        // Add a slight delay to ensure rendering is complete before the print dialog.
                        setTimeout(function() {
                            printWindow.focus();
                            printWindow.print();
                            // printWindow.close(); // Optional: Close after print dialog
                        }, 300); // 300ms delay, adjust if needed.
                    }
                };
                invoiceRequest.onerror = (e) => Swal.fire('خطأ', `فشل في جلب الفاتورة للطباعة: ${e.target.error}`, 'error');
            } catch (dbError) {
                 Swal.fire('خطأ قاعدة البيانات', `فشل: ${dbError.message}`, 'error');
            }
        }

        async function generateCustomerStatement() {
            const customerId = document.getElementById('statementCustomer').value;
            const startDateValue = document.getElementById('startDate').value;
            const endDateValue = document.getElementById('endDate').value;

            if (!customerId || !startDateValue || !endDateValue) {
                Swal.fire('خطأ', 'الرجاء اختيار الزبون وتحديد نطاق التاريخ بشكل كامل!', 'error');
                return;
            }
            
            const startDate = new Date(startDateValue);
            const endDate = new Date(endDateValue);
            endDate.setHours(23, 59, 59, 999); 


            if (startDate > endDate) {
                Swal.fire('خطأ', 'تاريخ البداية يجب أن يكون قبل أو نفس تاريخ النهاية!', 'error');
                return;
            }

            const invoices = await getAllInvoices();
            const customers = await getAllCustomers();
            const customer = customers.find(c => c.id === customerId);

            const filteredInvoices = invoices.filter(i => {
                const invoiceDate = new Date(i.date);
                return i.customerId === customerId && invoiceDate >= startDate && invoiceDate <= endDate;
            }).sort((a, b) => new Date(a.date) - new Date(b.date)); 

            const printWindow = window.open('', '_blank', 'height=800,width=600');
             if (!printWindow) {
                 Swal.fire('خطأ', 'فشل فتح نافذة الطباعة. يرجى التأكد من تعطيل مانع النوافذ المنبثقة.', 'error'); return;
             }
            printWindow.document.write(`
                <!DOCTYPE html>
                <html lang="ar" dir="rtl">
                <head>
                    <meta charset="UTF-8">
                    <title>كشف حساب الزبون: ${customer?.name || 'غير معروف'}</title>
                    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
                    <style>
                        @page { size: A4; margin: 10mm; }
                        body { font-family: 'Cairo', sans-serif; direction: rtl; margin: 10mm; font-size:10pt; }
                        .container { width: 100%; margin: 0 auto; }
                        .header-print { text-align: center; margin-bottom: 20px; border-bottom: 1px solid #ccc; padding-bottom:10px;}
                        .header-print img { max-height: 60px; margin-bottom: 5px;}
                        .header-print h1 { font-size: 1.4rem; color: #3F2A56; margin:0; }
                        .info { margin-bottom: 15px; font-size:0.95rem; }
                        .info p { margin: 4px 0; }
                        .statement-table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
                        .statement-table th, .statement-table td { padding: 8px; border: 1px solid #ccc; text-align: center; font-size:0.9rem; }
                        .statement-table th { background-color: #f2f2f2; color: #333; font-weight:600; }
                        .status-paid { color: #198754; font-weight: 700; }
                        .status-partial { color: #ffc107; font-weight: 700; }
                        .status-unpaid { color: #dc3545; font-weight: 700; }
                        .summary { margin-top: 20px; padding-top:10px; border-top: 1px solid #ccc; text-align:left; font-size:1rem;}
                        .summary p {margin: 5px 0; font-weight:600;}
                         @media print {
                            body { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
                        }
                    </style>
                </head>
                <body>
                    <div class="container">
                        <div class="header-print">
                             <img src="logo.png" alt="شعار" onerror="this.style.display='none';">
                            <h1>طيبة المدينة تلكوم</h1>
                            <h2>كشف حساب زبون</h2>
                        </div>
                        <div class="info">
                            <p><strong>الزبون:</strong> ${customer?.name || 'زبون غير محدد'}</p>
                            ${customer?.phone ? `<p><strong>الهاتف:</strong> ${customer.phone}</p>` : ''}
                            <p><strong>الفترة من:</strong> ${new Date(startDateValue).toLocaleDateString('ar-SA-u-nu-latn', { year: 'numeric', month: '2-digit', day: '2-digit' })}</p>
                            <p><strong>إلى:</strong> ${new Date(endDateValue).toLocaleDateString('ar-SA-u-nu-latn', { year: 'numeric', month: '2-digit', day: '2-digit' })}</p>
                        </div>
                        <table class="statement-table">
                            <thead>
                                <tr>
                                    <th>رقم الفاتورة</th>
                                    <th>التاريخ</th>
                                    <th>إجمالي الفاتورة</th>
                                    <th>المدفوع</th>
                                    <th>المتبقي</th>
                                    <th>الحالة</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${filteredInvoices.length > 0 ? filteredInvoices.map(i => {
                                    const totalAmount = parseFloat(i.totalAmount);
                                    const amountPaid = parseFloat(i.amountPaid);
                                    const remaining = totalAmount - amountPaid;
                                    let statusText, statusClassSuffix;
                                    if (totalAmount === 0 && amountPaid === 0) { statusText = 'لا يوجد مبلغ'; statusClassSuffix = '';}
                                    else if (amountPaid >= totalAmount) { statusText = 'مدفوع'; statusClassSuffix = 'paid'; }
                                    else if (amountPaid > 0) { statusText = 'مدفوع جزئيًا'; statusClassSuffix = 'partial'; }
                                    else { statusText = 'لم يتم الدفع'; statusClassSuffix = 'unpaid'; }
                                    

                                    return `
                                        <tr>
                                            <td>${i.id}</td>
                                            <td>${formatDateForDisplay(i.date)}</td>
                                            <td>${totalAmount.toFixed(2)}</td>
                                            <td>${amountPaid.toFixed(2)}</td>
                                            <td>${remaining.toFixed(2)}</td>
                                            <td class="status-${statusClassSuffix}">${statusText}</td>
                                        </tr>
                                    `;
                                }).join('') : '<tr><td colspan="6">لا توجد فواتير لهذا الزبون في الفترة المحددة.</td></tr>'}
                            </tbody>
                        </table>
                        ${filteredInvoices.length > 0 ? `
                        <div class="summary">
                            <p>إجمالي قيمة الفواتير: ${filteredInvoices.reduce((sum, i) => sum + parseFloat(i.totalAmount), 0).toFixed(2)}</p>
                            <p>إجمالي المدفوعات: ${filteredInvoices.reduce((sum, i) => sum + parseFloat(i.amountPaid), 0).toFixed(2)}</p>
                            <p>إجمالي المتبقي: ${filteredInvoices.reduce((sum, i) => sum + (parseFloat(i.totalAmount) - parseFloat(i.amountPaid)), 0).toFixed(2)}</p>
                        </div>
                        ` : ''}
                    </div>
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.onload = function() { // Parent window's reference onload
                setTimeout(function() { // Delay to ensure rendering, especially if print window has complex content
                    printWindow.focus();
                    printWindow.print();
                }, 300);
            }
            bootstrap.Modal.getInstance(document.getElementById('customerStatementModal')).hide();
            document.getElementById('customerStatementForm').reset();
        }

        function startQrScanner() {
            const qrReaderContainer = document.getElementById('qr-reader-container');
            
            if (html5QrCodeScanner) {
                 try {
                    if (html5QrCodeScanner.getState() === Html5QrcodeScannerState.SCANNING) {
                        stopQrScanner(); 
                    }
                 } catch (e) { console.warn("Error checking scanner state, attempting to stop anyway:", e); stopQrScanner(); }
            }

            qrReaderContainer.style.display = 'block';
            
            if (typeof Html5Qrcode === "undefined") {
                Swal.fire('خطأ', 'مكتبة مسح QR غير محملة بشكل صحيح.', 'error');
                qrReaderContainer.style.display = 'none'; 
                return;
            }

            html5QrCodeScanner = new Html5Qrcode("qr-reader"); 
            const qrCodeSuccessCallback = (decodedText, decodedResult) => {
                document.getElementById('searchInput').value = decodedText;
                filterTable();
                stopQrScanner(); 
                Swal.fire('نجاح!', `تم العثور على الفاتورة: ${decodedText}`, 'success');
            };
            const config = { fps: 10, qrbox: {width: 250, height: 250}, aspectRatio: 1.0 }; 
            
             html5QrCodeScanner.start(
                { facingMode: "environment" }, 
                config,
                qrCodeSuccessCallback,
                (errorMessage) => {
                    // console.warn(`QR Code no match or error: ${errorMessage}`);
                })
            .catch((err) => {
                console.error(`Unable to start QR scanning, error: ${err}`);
                Swal.fire('خطأ', 'لم يتمكن من تشغيل ماسح QR. تأكد من صلاحيات الكاميرا أو أن الكاميرا غير مستخدمة بواسطة تطبيق آخر.', 'error');
                stopQrScanner(); 
            });
        }

        function stopQrScanner() {
            const qrReaderContainer = document.getElementById('qr-reader-container');
            if (html5QrCodeScanner) {
                html5QrCodeScanner.stop().then(ignore => {
                    console.log("QR Code scanning stopped.");
                    if (html5QrCodeScanner && typeof html5QrCodeScanner.clear === 'function') {
                        html5QrCodeScanner.clear(); 
                    }
                    // html5QrCodeScanner = null; // Do not nullify here if you want to reuse, but for safety, it's good
                }).catch(err => {
                    console.error("Failed to stop QR Code scanner.", err);
                    // html5QrCodeScanner = null; 
                }).finally(() => {
                     qrReaderContainer.style.display = 'none'; 
                });
            } else {
                 qrReaderContainer.style.display = 'none'; 
            }
        }


        document.addEventListener('DOMContentLoaded', async () => {
            try {
                await initDB();
                await Promise.all([
                    updateInvoicesTable(), 
                    updateCustomersTable(),
                    populateCustomerSelect('invoiceCustomer'),
                    populateCustomerSelect('editInvoiceCustomer'),
                    populateCustomerSelect('statementCustomer')
                ]);
                
                setupProductSearch('productSearch', 'productSuggestions', 'invoiceProducts');
                setupProductSearch('editProductSearch', 'editProductSuggestions', 'editInvoiceProducts', true);
                
                document.getElementById('invoiceDate').textContent = formatDateForDisplay(new Date().toISOString());
                
                document.getElementById('invoiceCustomer').addEventListener('change', (e) => updateCustomerInfo('invoiceCustomer', 'customerPhoneDisplay', 'customerAddressDisplay'));
                document.getElementById('editInvoiceCustomer').addEventListener('change', (e) => updateCustomerInfo('editInvoiceCustomer', 'editCustomerPhoneDisplay', 'editCustomerAddressDisplay'));

                document.getElementById('scanQrBtn').addEventListener('click', startQrScanner);
                document.getElementById('closeScannerBtn').addEventListener('click', stopQrScanner);


            } catch (error) {
                console.error("Initialization failed:", error);
                Swal.fire('فشل التهيئة', `حدث خطأ أثناء تحميل الصفحة: ${error.message}`, 'error');
            }
        });
    </script>
</body>
</html><!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>بيع المنتجات</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!-- QR Code Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode@2.0.9/dist/html5-qrcode.min.js"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Cairo', sans-serif;
            background: linear-gradient(135deg, #f0f2f5, #d9e2ec);
            color: #333;
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .home-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: linear-gradient(90deg, #3F2A56, #5a3f73);
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            text-decoration: none;
            font-size: 1rem;
            font-weight: 600;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            transition: transform 0.2s ease, background 0.3s ease, box-shadow 0.3s ease;
            position: absolute;
            top: 20px;
            left: 20px;
        }
        .home-btn:hover {
            background: linear-gradient(90deg, #5a3f73, #3F2A56);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
        }
        .header {
            background: linear-gradient(135deg, #3F2A56, #5a3f73);
            color: white;
            padding: 40px 20px;
            border-radius: 25px;
            text-align: center;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
            margin-bottom: 30px;
            position: relative;
            z-index: 1;
            border: 2px solid rgba(255, 255, 255, 0.1);
        }
        .header img {
            height: 90px;
            margin-bottom: 15px;
            filter: drop-shadow(0 3px 6px rgba(0, 0, 0, 0.3));
        }
        .header h2 {
            font-size: 2.2rem;
            margin-bottom: 10px;
            font-weight: 700;
        }
        .header h4 {
            font-size: 1.4rem;
            opacity: 0.9;
            font-weight: 400;
        }
        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        .card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: #3F2A56;
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            text-align: center;
            transition: transform 0.3s ease;
        }
        .card:hover {
            transform: translateY(-10px);
        }
        .card i {
            font-size: 2.8rem;
            margin-bottom: 15px;
            color: #3F2A56;
        }
        .card h5 {
            font-size: 1.3rem;
            margin-bottom: 10px;
            font-weight: 600;
        }
        .card h3 {
            font-size: 1.8rem;
            font-weight: 700;
        }
        .section {
            background: white;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
            padding: 20px;
            margin: 20px 0;
        }
        .section h3 {
            font-size: 1.7rem;
            font-weight: 700;
            color: #3F2A56;
            margin-bottom: 15px;
            text-align: center;
        }
        .table-container {
            overflow-x: auto;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            padding: 12px;
            text-align: center;
            border-bottom: 1px solid #e0e0e0;
        }
        th {
            background: linear-gradient(90deg, #3F2A56, #5a3f73);
            color: white;
            font-weight: 700;
        }
        td {
            color: #3F2A56;
        }
        tr:hover {
            background-color: #f7f9fc;
        }
        .actions {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin: 25px 0;
            justify-content: center;
        }
        .btn {
            background: linear-gradient(90deg, #3F2A56, #5a3f73);
            color: white;
            padding: 12px 24px;
            border-radius: 30px;
            border: none;
            font-size: 1rem;
            cursor: pointer;
            transition: transform 0.2s ease, background 0.3s ease, box-shadow 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .btn:hover {
            background: linear-gradient(90deg, #5a3f73, #3F2A56);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.2);
        }
        .search-container {
            margin-bottom: 20px;
            display: flex;
            justify-content: center;
            align-items: flex-end; /* Align items to bottom for button */
            gap: 15px;
            flex-wrap: wrap;
        }
        .filter-group {
            display: flex;
            flex-direction: column;
            max-width: 200px;
        }
        .filter-group label {
            font-size: 0.9rem;
            font-weight: 600;
            color: #3F2A56;
            margin-bottom: 5px;
        }
        .filter-group input, .filter-group select {
            padding: 12px;
            border-radius: 30px;
            border: none;
            background: rgba(255, 255, 255, 0.1);
            color: #3F2A56;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        .filter-group input:focus, .filter-group select:focus {
            outline: none;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2);
        }
        #scanQrBtn {
            padding: 10px 15px; /* Adjust padding */
            height: 46px; /* Match input height */
            border-radius: 30px;
        }
         #qr-reader-container {
            margin-top: 10px;
            border: 1px solid #ccc;
            border-radius: 10px;
            padding:10px;
            background-color: #f9f9f9;
        }
        #qr-reader {
            width: 100%;
            max-width: 400px; /* Adjust as needed */
            margin: 0 auto;
        }

        .action-btn {
            cursor: pointer;
            margin: 0 6px;
            font-size: 1.3rem;
            transition: color 0.3s ease;
        }
        .action-btn.edit:hover { color: #007bff; }
        /* .action-btn.delete:hover { color: #dc3545; } */ /* Delete button removed from UI */
        .action-btn.print:hover { color: #28a745; }

        .modal-content {
            border-radius: 20px;
            background: linear-gradient(145deg, #ffffff, #f7f9fc);
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }
        .modal-header {
            background: linear-gradient(90deg, #3F2A56, #5a3f73);
            color: white;
            border-top-left-radius: 20px;
            border-top-right-radius: 20px;
            padding: 20px;
        }
        .modal-title {
            font-size: 1.5rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .modal-body {
            padding: 30px;
        }
        .modal-body .form-label {
            font-weight: 600;
            color: #3F2A56;
        }
        .modal-body .form-control, .modal-body .form-select {
            border-radius: 15px;
            padding: 12px;
            background: #f7f9fc;
            border: 1px solid #ddd;
        }
         .modal-body .form-control:focus, .modal-body .form-select:focus {
            border-color: #3F2A56;
            box-shadow: 0 0 0 0.25rem rgba(63, 42, 86, 0.25);
        }
        .modal-footer {
            padding: 20px;
            background: #f8f9fa;
            border-bottom-left-radius: 20px;
            border-bottom-right-radius: 20px;
        }
        .modal-footer .btn {
            padding: 12px 30px;
        }
        .product-table th, .product-table td {
            padding: 8px;
        }
        .modal-body .product-table th { /* Change header text color in modal product tables */
            color: white;
             background: linear-gradient(90deg, #3F2A56, #5a3f73); /* Optional: match main table header */
        }
        .status-paid { color: #198754; font-weight: 700; }
        .status-partial { color: #ffc107; font-weight: 700; }
        .status-unpaid { color: #dc3545; font-weight: 700; }
        .swal2-popup {
            font-family: 'Cairo', sans-serif !important;
            border-radius: 15px !important;
        }
        .swal2-title { color: #3F2A56 !important; }
        .swal2-html-container { text-align: right !important; }
        .swal2-confirm {
            background: linear-gradient(90deg, #3F2A56, #5a3f73) !important;
            border-radius: 20px !important;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2) !important;
        }
        .swal2-cancel, .swال2-deny {
            background: linear-gradient(90deg, #6c757d, #5a6268) !important;
            border-radius: 20px !important;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2) !important;
        }
        #productSuggestions div, #editProductSuggestions div {
            padding: 8px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        #productSuggestions div:hover, #editProductSuggestions div:hover {
            background-color: #f0f0f0;
        }

        @media (max-width: 768px) {
            .header { padding: 25px 15px; }
            .header img { height: 70px; }
            .header h2 { font-size: 1.7rem; }
            .btn { padding: 10px 18px; font-size: 0.9rem; }
            th, td { padding: 10px; font-size: 0.9rem; }
            .modal-body { padding: 20px; }
            .search-container { flex-direction: column; align-items: stretch;}
            .filter-group { max-width: none; }
            #scanQrBtn { width: 100%; margin-top: 10px;}
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <img src="logo.png" alt="شعار طيبة المدينة تلكوم" onerror="this.src='https://via.placeholder.com/90?text=Logo'; this.style.display='none';">
            <h2>طيبة المدينة تلكوم</h2>
            <h4>بيع المنتجات</h4>
            <a href="home.html" class="home-btn"><i class="fas fa-home"></i> للرئيسية</a>
        </div>
        <div class="dashboard">
            <div class="card">
                <i class="fas fa-check-circle"></i>
                <h5>الفواتير المدفوعة</h5>
                <h3 id="paidInvoices">0</h3>
            </div>
            <div class="card">
                <i class="fas fa-exclamation-circle"></i>
                <h5>الفواتير المدفوعة جزئيًا</h5>
                <h3 id="partialInvoices">0</h3>
            </div>
            <div class="card">
                <i class="fas fa-times-circle"></i>
                <h5>الفواتير غير المدفوعة</h5>
                <h3 id="unpaidInvoices">0</h3>
            </div>
        </div>
        <div class="actions">
            <button class="btn" data-bs-toggle="modal" data-bs-target="#addInvoiceModal"><i class="fas fa-plus"></i> إضافة فاتورة</button>
            <button class="btn" data-bs-toggle="modal" data-bs-target="#addCustomerModal"><i class="fas fa-user-plus"></i> إضافة زبون</button>
            <button class="btn" data-bs-toggle="modal" data-bs-target="#customerStatementModal"><i class="fas fa-file-alt"></i> كشف حساب زبون</button>
        </div>
        <div class="section">
            <h3>الفواتير</h3>
            <div class="search-container">
                <div class="filter-group">
                    <label for="searchInput">البحث</label>
                    <input type="text" id="searchInput" placeholder="ابحث بالزبون أو معرف الفاتورة" oninput="filterTable()">
                </div>
                <button id="scanQrBtn" class="btn btn-info" title="مسح QR Code للبحث عن فاتورة"><i class="fas fa-qrcode"></i> مسح</button>
                <div class="filter-group">
                    <label for="statusFilter">حالة الفاتورة</label>
                    <select id="statusFilter" onchange="filterTable()">
                        <option value="all">الكل</option>
                        <option value="paid">مدفوع</option>
                        <option value="partial">مدفوع جزئيًا</option>
                        <option value="unpaid">لم يتم الدفع</option>
                    </select>
                </div>
            </div>
             <div id="qr-reader-container" style="display: none;">
                <div id="qr-reader"></div>
                <button id="closeScannerBtn" class="btn btn-sm btn-danger mt-2" style="display:block; margin: 0 auto;">إغلاق الماسح</button>
            </div>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>معرف الفاتورة</th>
                            <th>الزبون</th>
                            <th>رقم الهاتف</th>
                            <th>المبلغ الكلي</th>
                            <th>حالة الفاتورة</th>
                            <th>الإجراءات</th>
                        </tr>
                    </thead>
                    <tbody id="invoicesTable"></tbody>
                </table>
            </div>
        </div>
        <div class="section">
            <h3>إدارة الزبائن</h3>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>الاسم</th>
                            <th>رقم الهاتف</th>
                            <th>العنوان</th>
                            <th>الإجراءات</th>
                        </tr>
                    </thead>
                    <tbody id="customersTable"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- نافذة إضافة فاتورة -->
    <div class="modal fade" id="addInvoiceModal" tabindex="-1" aria-labelledby="addInvoiceModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addInvoiceModalLabel"><i class="fas fa-file-invoice-dollar"></i> إضافة فاتورة جديدة</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="addInvoiceForm">
                        <div class="mb-3">
                            <label for="invoiceCustomer" class="form-label"><i class="fas fa-user"></i> الزبون</label>
                            <select class="form-select" id="invoiceCustomer" required>
                                <option value="">اختر زبونًا</option>
                            </select>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="customerPhoneDisplay" class="form-label"><i class="fas fa-phone"></i> رقم الهاتف</label>
                                <input type="text" class="form-control" id="customerPhoneDisplay" readonly>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="customerAddressDisplay" class="form-label"><i class="fas fa-map-marker-alt"></i> العنوان</label>
                                <input type="text" class="form-control" id="customerAddressDisplay" readonly>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="productSearch" class="form-label"><i class="fas fa-search"></i> البحث عن منتج</label>
                            <input type="text" class="form-control" id="productSearch" placeholder="ابحث بالاسم أو المعرف">
                            <div id="productSuggestions" class="mt-2 list-group" style="max-height: 150px; overflow-y: auto;"></div>
                        </div>
                        <h5><i class="fas fa-boxes"></i> المنتجات</h5>
                        <div class="table-container">
                            <table class="product-table table">
                                <thead>
                                    <tr>
                                        <th>اسم المنتج</th>
                                        <th>سعر البيع</th>
                                        <th>الكمية</th>
                                        <th>الملاحظة</th>
                                        <th>الإجمالي</th>
                                        <th>الإجراءات</th>
                                    </tr>
                                </thead>
                                <tbody id="invoiceProducts"></tbody>
                            </table>
                        </div>
                        <div class="mt-3">
                            <p><strong><i class="fas fa-calendar-alt"></i> التاريخ:</strong> <span id="invoiceDate"></span></p>
                            <p><strong><i class="fas fa-hashtag"></i> عدد المواد:</strong> <span id="totalItems">0</span></p>
                            <p><strong><i class="fas fa-coins"></i> المجموع الكلي:</strong> <span id="totalAmount">0.00</span></p>
                            <div class="mb-3">
                                <label for="amountPaid" class="form-label"><i class="fas fa-money-bill-wave"></i> المبلغ المدفوع</label>
                                <input type="number" class="form-control" id="amountPaid" step="0.01" min="0" value="0">
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
                    <button type="button" class="btn btn-primary" onclick="addInvoice()">حفظ الفاتورة</button>
                </div>
            </div>
        </div>
    </div>

    <!-- نافذة تعديل فاتورة -->
    <div class="modal fade" id="editInvoiceModal" tabindex="-1" aria-labelledby="editInvoiceModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editInvoiceModalLabel"><i class="fas fa-edit"></i> تعديل فاتورة</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="editInvoiceForm">
                        <input type="hidden" id="editInvoiceId">
                        <div class="mb-3">
                            <label for="editInvoiceCustomer" class="form-label"><i class="fas fa-user"></i> الزبون</label>
                            <select class="form-select" id="editInvoiceCustomer" required>
                                <option value="">اختر زبونًا</option>
                            </select>
                        </div>
                         <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="editCustomerPhoneDisplay" class="form-label"><i class="fas fa-phone"></i> رقم الهاتف</label>
                                <input type="text" class="form-control" id="editCustomerPhoneDisplay" readonly>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="editCustomerAddressDisplay" class="form-label"><i class="fas fa-map-marker-alt"></i> العنوان</label>
                                <input type="text" class="form-control" id="editCustomerAddressDisplay" readonly>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="editProductSearch" class="form-label"><i class="fas fa-search"></i> البحث عن منتج</label>
                            <input type="text" class="form-control" id="editProductSearch" placeholder="ابحث بالاسم أو المعرف">
                            <div id="editProductSuggestions" class="mt-2 list-group" style="max-height: 150px; overflow-y: auto;"></div>
                        </div>
                        <h5><i class="fas fa-boxes"></i> المنتجات</h5>
                        <div class="table-container">
                            <table class="product-table table">
                                <thead>
                                    <tr>
                                        <th>اسم المنتج</th>
                                        <th>سعر البيع</th>
                                        <th>الكمية</th>
                                        <th>الملاحظة</th>
                                        <th>الإجمالي</th>
                                        <th>الإجراءات</th>
                                    </tr>
                                </thead>
                                <tbody id="editInvoiceProducts"></tbody>
                            </table>
                        </div>
                        <div class="mt-3">
                            <p><strong><i class="fas fa-calendar-alt"></i> التاريخ:</strong> <span id="editInvoiceDate"></span></p>
                            <p><strong><i class="fas fa-hashtag"></i> عدد المواد:</strong> <span id="editTotalItems">0</span></p>
                            <p><strong><i class="fas fa-coins"></i> المجموع الكلي:</strong> <span id="editTotalAmount">0.00</span></p>
                            <div class="mb-3">
                                <label for="editAmountPaid" class="form-label"><i class="fas fa-money-bill-wave"></i> المبلغ المدفوع</label>
                                <input type="number" class="form-control" id="editAmountPaid" step="0.01" min="0" value="0">
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
                    <button type="button" class="btn btn-primary" onclick="updateInvoice()">حفظ التعديلات</button>
                </div>
            </div>
        </div>
    </div>

    <!-- نافذة إضافة زبون -->
    <div class="modal fade" id="addCustomerModal" tabindex="-1" aria-labelledby="addCustomerModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addCustomerModalLabel"><i class="fas fa-user-plus"></i> إضافة زبون</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="addCustomerForm">
                        <div class="mb-3">
                            <label for="customerName" class="form-label"><i class="fas fa-signature"></i> اسم الزبون (اختياري)</label>
                            <input type="text" class="form-control" id="customerName">
                        </div>
                        <div class="mb-3">
                            <label for="customerPhone" class="form-label"><i class="fas fa-mobile-alt"></i> رقم الهاتف (اختياري)</label>
                            <input type="tel" class="form-control" id="customerPhone">
                        </div>
                        <div class="mb-3">
                            <label for="customerAddress" class="form-label"><i class="fas fa-home"></i> العنوان (اختياري)</label>
                            <input type="text" class="form-control" id="customerAddress">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
                    <button type="button" class="btn btn-primary" onclick="addCustomer()">حفظ الزبون</button>
                </div>
            </div>
        </div>
    </div>

    <!-- نافذة تعديل زبون -->
    <div class="modal fade" id="editCustomerModal" tabindex="-1" aria-labelledby="editCustomerModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editCustomerModalLabel"><i class="fas fa-user-edit"></i> تعديل زبون</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="editCustomerForm">
                        <input type="hidden" id="editCustomerId">
                        <div class="mb-3">
                            <label for="editCustomerName" class="form-label"><i class="fas fa-signature"></i> اسم الزبون (اختياري)</label>
                            <input type="text" class="form-control" id="editCustomerName">
                        </div>
                        <div class="mb-3">
                            <label for="editCustomerPhone" class="form-label"><i class="fas fa-mobile-alt"></i> رقم الهاتف (اختياري)</label>
                            <input type="tel" class="form-control" id="editCustomerPhone">
                        </div>
                        <div class="mb-3">
                            <label for="editCustomerAddress" class="form-label"><i class="fas fa-home"></i> العنوان (اختياري)</label>
                            <input type="text" class="form-control" id="editCustomerAddress">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
                    <button type="button" class="btn btn-primary" onclick="updateCustomer()">حفظ التعديلات</button>
                </div>
            </div>
        </div>
    </div>

    <!-- نافذة كشف حساب زبون -->
    <div class="modal fade" id="customerStatementModal" tabindex="-1" aria-labelledby="customerStatementModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="customerStatementModalLabel"><i class="fas fa-file-invoice"></i> كشف حساب زبون</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="customerStatementForm">
                        <div class="mb-3">
                            <label for="statementCustomer" class="form-label"><i class="fas fa-user-check"></i> الزبون</label>
                            <select class="form-select" id="statementCustomer" required>
                                <option value="">اختر زبونًا</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="startDate" class="form-label"><i class="fas fa-calendar-day"></i> من تاريخ</label>
                            <input type="date" class="form-control" id="startDate" required>
                        </div>
                        <div class="mb-3">
                            <label for="endDate" class="form-label"><i class="fas fa-calendar-day"></i> إلى تاريخ</label>
                            <input type="date" class="form-control" id="endDate" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
                    <button type="button" class="btn btn-primary" onclick="generateCustomerStatement()">إنشاء الكشف</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let db;
        let html5QrCodeScanner; // For QR Code scanner instance

        // Helper function to format date as DD-MM-YYYY HH:MM
        function formatDateForDisplay(isoString) {
            if (!isoString) return 'N/A';
            const date = new Date(isoString);
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0'); // Months are 0-indexed
            const year = date.getFullYear();
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            return `${day}-${month}-${year} ${hours}:${minutes}`;
        }


        // إعداد IndexedDB
        function initDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open('InventoryDB', 2); 
                request.onupgradeneeded = (event) => {
                    db = event.target.result;
                    if (!db.objectStoreNames.contains('products')) {
                        db.createObjectStore('products', { keyPath: 'id' });
                    }
                    if (!db.objectStoreNames.contains('invoices')) {
                        const invoiceStore = db.createObjectStore('invoices', { keyPath: 'id' });
                        invoiceStore.createIndex('customerId', 'customerId', { unique: false });
                    }
                    if (!db.objectStoreNames.contains('customers')) {
                        const customerStore = db.createObjectStore('customers', { keyPath: 'id' });
                        customerStore.createIndex('phone', 'phone', { unique: false }); 
                    }
                };
                request.onsuccess = (event) => {
                    db = event.target.result;
                    resolve(db);
                };
                request.onerror = (event) => {
                    console.error("Database error: " + event.target.errorCode);
                    reject(event.target.error);
                };
            });
        }
        
        async function ensureDBInitialized() {
            if (!db) {
                try {
                    await initDB();
                } catch (error) {
                    console.error('Failed to initialize database:', error);
                    throw new Error('Failed to initialize database: ' + error.message);
                }
            }
            if (!db) { 
                throw new Error('Database not ready after initialization attempt.');
            }
        }

        async function generateUniqueId(storeName) {
            await ensureDBInitialized();
            let id;
            let isUnique = false;
            const existingIds = await getAllIds(storeName); 
            while (!isUnique) {
                id = Math.floor(10000 + Math.random() * 90000).toString();
                isUnique = !existingIds.includes(id);
            }
            return id;
        }

        function getAllIds(storeName) {
            return new Promise(async (resolve, reject) => {
                try {
                    await ensureDBInitialized();
                    const transaction = db.transaction([storeName], 'readonly');
                    const store = transaction.objectStore(storeName);
                    const request = store.getAllKeys(); 
                    request.onsuccess = () => {
                        resolve(request.result);
                    };
                    request.onerror = (event) => reject(event.target.error);
                } catch (error) {
                    reject(error);
                }
            });
        }

        function getAllProducts() {
            return new Promise(async (resolve, reject) => {
                try {
                    await ensureDBInitialized();
                    const transaction = db.transaction(['products'], 'readonly');
                    const store = transaction.objectStore('products');
                    const request = store.getAll();
                    request.onsuccess = () => resolve(request.result || []);
                    request.onerror = (event) => reject(event.target.error);
                } catch (error) {
                    reject(error);
                }
            });
        }
        
        function checkProductExists(productId) {
            return new Promise(async (resolve) => {
                try {
                    await ensureDBInitialized();
                    const transaction = db.transaction(['products'], 'readonly');
                    const store = transaction.objectStore('products');
                    const request = store.get(productId);
                    request.onsuccess = () => resolve(!!request.result); // True if product exists
                    request.onerror = () => resolve(false); // Error, assume not exists
                } catch (e) { resolve(false); }
            });
        }


        function getAllInvoices() {
            return new Promise(async (resolve, reject) => {
                try {
                    await ensureDBInitialized();
                    const transaction = db.transaction(['invoices'], 'readonly');
                    const store = transaction.objectStore('invoices');
                    const request = store.getAll();
                    request.onsuccess = () => resolve(request.result || []);
                    request.onerror = (event) => reject(event.target.error);
                } catch (error) {
                    reject(error);
                }
            });
        }

        function getAllCustomers() {
            return new Promise(async (resolve, reject) => {
                try {
                    await ensureDBInitialized();
                    const transaction = db.transaction(['customers'], 'readonly');
                    const store = transaction.objectStore('customers');
                    const request = store.getAll();
                    request.onsuccess = () => resolve(request.result || []);
                    request.onerror = (event) => reject(event.target.error);
                } catch (error) {
                    reject(error);
                }
            });
        }

        async function updateDashboard() {
            const invoices = await getAllInvoices();
            const paid = invoices.filter(i => parseFloat(i.amountPaid) >= parseFloat(i.totalAmount) && parseFloat(i.totalAmount) > 0).length;
            const partial = invoices.filter(i => parseFloat(i.amountPaid) > 0 && parseFloat(i.amountPaid) < parseFloat(i.totalAmount)).length;
            const unpaid = invoices.filter(i => parseFloat(i.amountPaid) === 0 && parseFloat(i.totalAmount) > 0).length;


            document.getElementById('paidInvoices').innerText = paid;
            document.getElementById('partialInvoices').innerText = partial;
            document.getElementById('unpaidInvoices').innerText = unpaid;
        }

        async function updateInvoicesTable() {
            const invoices = await getAllInvoices();
            const customers = await getAllCustomers();
            const tableBody = document.getElementById('invoicesTable');
            tableBody.innerHTML = '';

            invoices.sort((a, b) => new Date(b.date) - new Date(a.date)); 

            invoices.forEach((invoice, index) => {
                const customer = customers.find(c => c.id === invoice.customerId);
                const totalAmount = parseFloat(invoice.totalAmount);
                const amountPaid = parseFloat(invoice.amountPaid);
                let statusClass, statusText;

                if (totalAmount === 0 && amountPaid === 0) { // Consider invoices with 0 total and 0 paid (e.g. returns or empty)
                    statusClass = ''; // No specific class or a 'neutral' class
                    statusText = 'لا يوجد مبلغ';
                } else if (amountPaid >= totalAmount) {
                    statusClass = 'status-paid';
                    statusText = 'مدفوع';
                } else if (amountPaid > 0) {
                    statusClass = 'status-partial';
                    statusText = 'مدفوع جزئيًا';
                } else { // amountPaid is 0 and totalAmount > 0
                    statusClass = 'status-unpaid';
                    statusText = 'لم يتم الدفع';
                }


                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${invoice.id}</td>
                    <td>${customer?.name || 'زبون محذوف/غير معروف'}</td>
                    <td>${customer?.phone || '-'}</td>
                    <td>${totalAmount.toFixed(2)}</td>
                    <td class="${statusClass}">${statusText}</td>
                    <td>
                        <i class="fas fa-print action-btn print" onclick="printInvoice('${invoice.id}')" title="طباعة"></i>
                        <i class="fas fa-edit action-btn edit" onclick="editInvoice('${invoice.id}')" title="تعديل"></i>
                        <!-- Delete button removed from UI as requested -->
                    </td>
                `;
                tableBody.appendChild(row);
            });
            updateDashboard(); // Update dashboard after table is updated
            // filterTable(); // Call filterTable if you want to apply existing filters immediately after refresh
        }

        async function updateCustomersTable() {
            const customers = await getAllCustomers();
            const tableBody = document.getElementById('customersTable');
            tableBody.innerHTML = '';

            customers.forEach((customer, index) => {
                const row = document.createElement('tr');
                const displayName = customer.name || 'زبون بدون اسم';
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${displayName}</td>
                    <td>${customer.phone || '-'}</td>
                    <td>${customer.address || '-'}</td>
                    <td>
                        <i class="fas fa-edit action-btn edit" onclick="editCustomer('${customer.id}')" title="تعديل"></i>
                        <i class="fas fa-trash action-btn delete" onclick="deleteCustomer('${customer.id}')" title="حذف"></i>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }

        async function filterTable() {
            const searchInput = document.getElementById('searchInput').value.toLowerCase();
            const statusFilter = document.getElementById('statusFilter').value;
            const invoices = await getAllInvoices(); // Fetch fresh list
            const customers = await getAllCustomers(); // Fetch fresh list
            const tableBody = document.getElementById('invoicesTable');
            
            const filteredInvoices = invoices.filter(invoice => {
                const customer = customers.find(c => c.id === invoice.customerId);
                const customerName = customer?.name?.toLowerCase() || '';
                const matchesSearch = customerName.includes(searchInput) || invoice.id.includes(searchInput);
                
                if (!matchesSearch) return false;

                const totalAmount = parseFloat(invoice.totalAmount);
                const amountPaid = parseFloat(invoice.amountPaid);

                if (statusFilter === 'all') return true;
                if (statusFilter === 'paid') return amountPaid >= totalAmount && totalAmount > 0; // Ensure total > 0 for 'paid'
                if (statusFilter === 'partial') return amountPaid > 0 && amountPaid < totalAmount;
                if (statusFilter === 'unpaid') return amountPaid === 0 && totalAmount > 0; // Ensure total > 0 for 'unpaid'
                
                // This case should ideally not be reached if statusFilter has a valid value from the dropdown.
                // If it's reached, it means an unknown filter value, so include the item.
                return true; 
            });

            tableBody.innerHTML = ''; 
            filteredInvoices.sort((a, b) => new Date(b.date) - new Date(a.date)); // Re-sort filtered results

            filteredInvoices.forEach((invoice, index) => {
                const customer = customers.find(c => c.id === invoice.customerId);
                const totalAmount = parseFloat(invoice.totalAmount);
                const amountPaid = parseFloat(invoice.amountPaid);
                let statusClass, statusText;

                 if (totalAmount === 0 && amountPaid === 0) {
                    statusClass = ''; statusText = 'لا يوجد مبلغ';
                } else if (amountPaid >= totalAmount) {
                    statusClass = 'status-paid'; statusText = 'مدفوع';
                } else if (amountPaid > 0) {
                    statusClass = 'status-partial'; statusText = 'مدفوع جزئيًا';
                } else {
                    statusClass = 'status-unpaid'; statusText = 'لم يتم الدفع';
                }

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${invoice.id}</td>
                    <td>${customer?.name || 'زبون محذوف/غير معروف'}</td>
                    <td>${customer?.phone || '-'}</td>
                    <td>${totalAmount.toFixed(2)}</td>
                    <td class="${statusClass}">${statusText}</td>
                    <td>
                        <i class="fas fa-print action-btn print" onclick="printInvoice('${invoice.id}')" title="طباعة"></i>
                        <i class="fas fa-edit action-btn edit" onclick="editInvoice('${invoice.id}')" title="تعديل"></i>
                    </td>
                `;
                tableBody.appendChild(row);
            });
            // No need to call updateDashboard here as it's called in updateInvoicesTable which is called by other functions.
            // However, if filterTable is called independently (e.g., on search input), then dashboard might need update based on filtered view, or just reflect all invoices.
            // For simplicity, let dashboard always reflect all invoices. It's updated by main table update functions.
        }


        async function populateCustomerSelect(selectElementId) {
            const customers = await getAllCustomers();
            const select = document.getElementById(selectElementId);
            const currentValue = select.value; // Preserve current selection if possible
            select.innerHTML = '<option value="">اختر زبونًا...</option>'; 
            customers.forEach(customer => {
                const option = document.createElement('option');
                option.value = customer.id;
                option.textContent = customer.name || `زبون (${customer.phone || 'معرف: ' + customer.id.slice(0,5)})`;
                select.appendChild(option);
            });
            if (currentValue) { // Attempt to restore selection
                 select.value = currentValue;
            }
        }

        async function updateCustomerInfo(selectElementId, phoneElementId, addressElementId) {
            const customerId = document.getElementById(selectElementId).value;
            const phoneInput = document.getElementById(phoneElementId);
            const addressInput = document.getElementById(addressElementId);

            if (customerId) {
                const customers = await getAllCustomers(); // Fetch fresh customer data
                const customer = customers.find(c => c.id === customerId);
                phoneInput.value = customer?.phone || '';
                addressInput.value = customer?.address || '';
            } else {
                phoneInput.value = '';
                addressInput.value = '';
            }
        }
        
        async function setupProductSearch(searchElementId, suggestionsElementId, productsTableId, isEditModal = false) {
            const searchInput = document.getElementById(searchElementId);
            const suggestionsDiv = document.getElementById(suggestionsElementId);
            
            searchInput.addEventListener('input', async (e) => {
                const query = e.target.value.toLowerCase().trim();
                suggestionsDiv.innerHTML = ''; 
                if (query.length < 1) return; 

                const allProducts = await getAllProducts();
                const availableProducts = allProducts.filter(p => p.quantity > 0); 
                
                const filteredProducts = availableProducts.filter(p => 
                    p.name.toLowerCase().includes(query) || 
                    p.id.includes(query)
                ).slice(0, 10); 

                if (filteredProducts.length > 0) {
                    filteredProducts.forEach(product => {
                        const div = document.createElement('div');
                        div.className = 'list-group-item list-group-item-action';
                        
                        const salePriceFormatted = parseFloat(product.salePrice || 0).toFixed(2);
                        
                        // --- MODIFICATION FOR costPrice ---
                        let costPriceFormatted;
                        if (typeof product.costPrice === 'number') { // Handles 0 as a valid cost price
                            costPriceFormatted = parseFloat(product.costPrice).toFixed(2);
                        } else if (product.costPrice && !isNaN(parseFloat(product.costPrice))) { // Handles string numbers
                            costPriceFormatted = parseFloat(product.costPrice).toFixed(2);
                        } else {
                            costPriceFormatted = 'غ/م'; // Not available or not a valid number
                        }
                        // --- END MODIFICATION ---
                        
                        div.innerHTML = `
                            <strong>${product.name}</strong> (المعرف: ${product.id}) <br>
                            <small>
                                سعر البيع: ${salePriceFormatted} | 
                                سعر الشراء: ${costPriceFormatted} | 
                                الكمية المتوفرة: ${product.quantity}
                            </small>
                        `;
                        div.onclick = () => {
                            addProductToInvoice(product, productsTableId);
                            searchInput.value = ''; 
                            suggestionsDiv.innerHTML = ''; 
                        };
                        suggestionsDiv.appendChild(div);
                    });
                } else {
                    suggestionsDiv.innerHTML = '<div class="list-group-item">لا توجد منتجات مطابقة أو غير متوفرة.</div>';
                }
            });
        }


        function addProductToInvoice(product, productsTableId) {
            const tableBody = document.getElementById(productsTableId);
            const existingRow = Array.from(tableBody.rows).find(row => row.dataset.productId === product.id);

            if (existingRow) {
                const quantityInput = existingRow.querySelector('.quantity');
                const currentQuantity = parseInt(quantityInput.value);
                if (currentQuantity < product.quantity) { 
                    quantityInput.value = currentQuantity + 1;
                } else {
                    Swal.fire('تنبيه', `الكمية المطلوبة للمنتج "${product.name}" تتجاوز المخزون المتاح (${product.quantity}).`, 'warning');
                    return;
                }
            } else {
                if (product.quantity < 1) { 
                     Swal.fire('تنبيه', `المنتج "${product.name}" غير متوفر في المخزون.`, 'warning');
                    return;
                }
                const row = tableBody.insertRow();
                row.dataset.productId = product.id; 
                
                row.innerHTML = `
                    <td>${product.name}</td>
                    <td><input type="number" class="form-control form-control-sm sale-price" value="${parseFloat(product.salePrice || 0).toFixed(2)}" step="0.01" min="0.01"></td>
                    <td><input type="number" class="form-control form-control-sm quantity" value="1" min="1" max="${product.quantity}"></td>
                    <td><input type="text" class="form-control form-control-sm note" placeholder="ملاحظة (اختياري)"></td>
                    <td class="total">${parseFloat(product.salePrice || 0).toFixed(2)}</td>
                    <td><button type="button" class="btn btn-sm btn-danger" onclick="removeProductFromInvoice(this.closest('tr'), '${productsTableId}')"><i class="fas fa-trash-alt"></i></button></td>
                `;
                row.querySelector('.sale-price').addEventListener('input', () => updateInvoiceTotals(productsTableId));
                row.querySelector('.quantity').addEventListener('input', (e) => {
                    const requestedQuantity = parseInt(e.target.value);
                    const maxQuantityForThisProduct = parseInt(e.target.max); // Use the max attribute of the input

                    if (requestedQuantity > maxQuantityForThisProduct) {
                        e.target.value = maxQuantityForThisProduct; 
                        Swal.fire('تنبيه', `الكمية المطلوبة للمنتج "${product.name}" تتجاوز المخزون المتاح (${maxQuantityForThisProduct}). تم التعديل للحد الأقصى.`, 'warning');
                    }
                    updateInvoiceTotals(productsTableId);
                });
            }
            updateInvoiceTotals(productsTableId);
        }


        function removeProductFromInvoice(rowElement, productsTableId) {
            rowElement.remove();
            updateInvoiceTotals(productsTableId);
        }

        function updateInvoiceTotals(productsTableId) {
            const tableBody = document.getElementById(productsTableId);
            const rows = tableBody.querySelectorAll('tr');
            let totalAmount = 0;
            let totalItemsCount = 0; 

            rows.forEach(row => {
                const salePriceInput = row.querySelector('.sale-price');
                const quantityInput = row.querySelector('.quantity');
                
                const salePrice = parseFloat(salePriceInput.value) || 0;
                const quantity = parseInt(quantityInput.value) || 0;
                
                const itemTotal = salePrice * quantity;
                row.querySelector('.total').textContent = itemTotal.toFixed(2);
                totalAmount += itemTotal;
                totalItemsCount++; 
            });

            const isEditModal = productsTableId === 'editInvoiceProducts';
            document.getElementById(isEditModal ? 'editTotalItems' : 'totalItems').textContent = totalItemsCount; 
            document.getElementById(isEditModal ? 'editTotalAmount' : 'totalAmount').textContent = totalAmount.toFixed(2);
        }

        async function addInvoice() {
            const customerId = document.getElementById('invoiceCustomer').value;
            const amountPaidValue = document.getElementById('amountPaid').value;
            const productsTable = document.getElementById('invoiceProducts');
            const rows = productsTable.querySelectorAll('tr');

            if (!customerId) {
                Swal.fire('خطأ', 'الرجاء اختيار زبون!', 'error'); return;
            }
            if (rows.length === 0) {
                Swal.fire('خطأ', 'الرجاء إضافة منتج واحد على الأقل للفاتورة!', 'error'); return;
            }
            const amountPaid = parseFloat(amountPaidValue);
            if (isNaN(amountPaid) || amountPaid < 0) {
                 Swal.fire('خطأ', 'المبلغ المدفوع غير صحيح!', 'error'); return;
            }

            const productsInInvoice = [];
            let totalAmount = 0;
            let stockUpdatePromises = [];

            for (const row of rows) {
                const productId = row.dataset.productId;
                const name = row.cells[0].textContent;
                const salePrice = parseFloat(row.querySelector('.sale-price').value);
                const quantitySold = parseInt(row.querySelector('.quantity').value);
                const note = row.querySelector('.note').value;
                const itemTotal = salePrice * quantitySold;

                if (isNaN(salePrice) || salePrice <=0 || isNaN(quantitySold) || quantitySold <=0) {
                    Swal.fire('خطأ', `بيانات غير صالحة للمنتج "${name}". تأكد من السعر والكمية.`, 'error'); return;
                }

                productsInInvoice.push({ productId, name, salePrice, quantity: quantitySold, note, total: itemTotal });
                totalAmount += itemTotal;
                stockUpdatePromises.push(updateProductStock(productId, quantitySold));
            }
             if (amountPaid > totalAmount) {
                Swal.fire('خطأ', 'المبلغ المدفوع لا يمكن أن يكون أكبر من المجموع الكلي للفاتورة!', 'error'); return;
            }

            try {
                await Promise.all(stockUpdatePromises); 
            } catch (error) {
                Swal.fire('خطأ في تحديث المخزون', error.message, 'error');
                return;
            }

            const id = await generateUniqueId('invoices');
            const invoice = {
                id,
                customerId,
                products: productsInInvoice,
                totalAmount: totalAmount.toFixed(2),
                amountPaid: amountPaid.toFixed(2),
                date: new Date().toISOString()
            };

            const transaction = db.transaction(['invoices'], 'readwrite');
            const store = transaction.objectStore('invoices');
            const request = store.add(invoice);

            request.onsuccess = async () => {
                await updateInvoicesTable(); // This also updates dashboard
                bootstrap.Modal.getInstance(document.getElementById('addInvoiceModal')).hide();
                document.getElementById('addInvoiceForm').reset();
                document.getElementById('invoiceProducts').innerHTML = ''; 
                document.getElementById('totalItems').textContent = '0';
                document.getElementById('totalAmount').textContent = '0.00';
                document.getElementById('customerPhoneDisplay').value = '';
                document.getElementById('customerAddressDisplay').value = '';
                document.getElementById('invoiceDate').textContent = formatDateForDisplay(new Date().toISOString()); // Reset date
                await populateCustomerSelect('invoiceCustomer'); 
                Swal.fire('نجاح', 'تم إضافة الفاتورة وتحديث المخزون بنجاح!', 'success');
            };
            request.onerror = (e) => {
                console.error("Error adding invoice:", e.target.error);
                Swal.fire('خطأ', 'فشل في إضافة الفاتورة!', 'error');
            };
        }
        
        function updateProductStock(productId, quantitySold) {
            return new Promise(async (resolve, reject) => {
                try {
                    await ensureDBInitialized();
                    const transaction = db.transaction(['products'], 'readwrite');
                    const store = transaction.objectStore('products');
                    const getRequest = store.get(productId);

                    getRequest.onsuccess = () => {
                        const product = getRequest.result;
                        if (!product) {
                            reject(new Error(`المنتج بالمعرف ${productId} غير موجود.`));
                            return;
                        }
                        if (product.quantity < quantitySold) {
                            reject(new Error(`الكمية المطلوبة للمنتج "${product.name}" (${quantitySold}) تتجاوز المخزون المتاح (${product.quantity}).`));
                            return;
                        }
                        product.quantity -= quantitySold;
                        const updateRequest = store.put(product);
                        updateRequest.onsuccess = () => resolve();
                        updateRequest.onerror = (e) => reject(new Error(`فشل تحديث مخزون المنتج ${product.name}: ${e.target.error}`));
                    };
                    getRequest.onerror = (e) => reject(new Error(`فشل جلب المنتج ${productId} لتحديث المخزون: ${e.target.error}`));
                } catch (dbError) {
                    reject(dbError);
                }
            });
        }


        async function editInvoice(invoiceId) {
            try {
                await ensureDBInitialized();
                const transaction = db.transaction(['invoices', 'customers', 'products'], 'readonly'); 
                const invoiceStore = transaction.objectStore('invoices');
                const invoiceRequest = invoiceStore.get(invoiceId);

                invoiceRequest.onsuccess = async () => {
                    const invoice = invoiceRequest.result;
                    if (!invoice) {
                        Swal.fire('خطأ', 'الفاتورة غير موجودة!', 'error');
                        return;
                    }
                    
                    document.getElementById('editInvoiceModal').dataset.originalProducts = JSON.stringify(invoice.products);
                    document.getElementById('editInvoiceId').value = invoice.id;
                    
                    const customerSelect = document.getElementById('editInvoiceCustomer');
                    await populateCustomerSelect('editInvoiceCustomer'); 
                    customerSelect.value = invoice.customerId;
                    await updateCustomerInfo('editInvoiceCustomer', 'editCustomerPhoneDisplay', 'editCustomerAddressDisplay');

                    document.getElementById('editInvoiceDate').textContent = formatDateForDisplay(invoice.date);
                    document.getElementById('editAmountPaid').value = parseFloat(invoice.amountPaid).toFixed(2);

                    const tableBody = document.getElementById('editInvoiceProducts');
                    tableBody.innerHTML = ''; 

                    const allProductsFromDB = await getAllProducts(); 

                    invoice.products.forEach(pInInvoice => {
                        const productDetailsFromDB = allProductsFromDB.find(pDB => pDB.id === pInInvoice.productId);
                        const currentStockInDB = productDetailsFromDB ? productDetailsFromDB.quantity : 0;
                        const maxQuantityForInput = currentStockInDB + pInInvoice.quantity;


                        const row = tableBody.insertRow();
                        row.dataset.productId = pInInvoice.productId;
                        row.dataset.originalQuantityInInvoice = pInInvoice.quantity; 
                        row.dataset.maxEditableQuantity = maxQuantityForInput;


                        row.innerHTML = `
                            <td>${pInInvoice.name}</td>
                            <td><input type="number" class="form-control form-control-sm sale-price" value="${parseFloat(pInInvoice.salePrice).toFixed(2)}" step="0.01" min="0.01"></td>
                            <td><input type="number" class="form-control form-control-sm quantity" value="${pInInvoice.quantity}" min="1" max="${maxQuantityForInput}"></td>
                            <td><input type="text" class="form-control form-control-sm note" value="${pInInvoice.note || ''}" placeholder="ملاحظة"></td>
                            <td class="total">${parseFloat(pInInvoice.total).toFixed(2)}</td>
                            <td><button type="button" class="btn btn-sm btn-danger" onclick="removeProductFromInvoice(this.closest('tr'), 'editInvoiceProducts')"><i class="fas fa-trash-alt"></i></button></td>
                        `;
                        row.querySelector('.sale-price').addEventListener('input', () => updateInvoiceTotals('editInvoiceProducts'));
                        row.querySelector('.quantity').addEventListener('input', (e) => {
                             const requestedQuantity = parseInt(e.target.value);
                             const maxAllowed = parseInt(e.target.max); 
                             if (requestedQuantity > maxAllowed) {
                                e.target.value = maxAllowed;
                                Swal.fire('تنبيه', `الكمية المطلوبة للمنتج "${pInInvoice.name}" تتجاوز المخزون المتاح. تم التعديل للحد الأقصى (${maxAllowed}).`, 'warning');
                            }
                            updateInvoiceTotals('editInvoiceProducts');
                        });
                    });

                    updateInvoiceTotals('editInvoiceProducts');
                    new bootstrap.Modal(document.getElementById('editInvoiceModal')).show();
                };
                invoiceRequest.onerror = (e) => Swal.fire('خطأ', `فشل في جلب الفاتورة: ${e.target.error}`, 'error');
            } catch (dbError) {
                 Swal.fire('خطأ قاعدة البيانات', `فشل: ${dbError.message}`, 'error');
            }
        }


        async function updateInvoice() {
            const id = document.getElementById('editInvoiceId').value;
            const customerId = document.getElementById('editInvoiceCustomer').value;
            const amountPaidValue = document.getElementById('editAmountPaid').value;
            const productsTable = document.getElementById('editInvoiceProducts');
            const rows = productsTable.querySelectorAll('tr');
            
            const originalProductsJSON = document.getElementById('editInvoiceModal').dataset.originalProducts;
            const originalProductsInInvoice = JSON.parse(originalProductsJSON || "[]"); 


            if (!customerId) { Swal.fire('خطأ', 'الرجاء اختيار زبون!', 'error'); return; }
            if (rows.length === 0) { Swal.fire('خطأ', 'الفاتورة يجب أن تحتوي على منتج واحد على الأقل!', 'error'); return; }
            const amountPaid = parseFloat(amountPaidValue);
             if (isNaN(amountPaid) || amountPaid < 0) { Swal.fire('خطأ', 'المبلغ المدفوع غير صحيح!', 'error'); return; }


            const updatedProductsInInvoice = [];
            let newTotalAmount = 0;
            let stockAdjustmentPromises = []; 

            for (const row of rows) {
                const productId = row.dataset.productId;
                const name = row.cells[0].textContent;
                const salePrice = parseFloat(row.querySelector('.sale-price').value);
                const newQuantitySold = parseInt(row.querySelector('.quantity').value);
                const note = row.querySelector('.note').value;
                const itemTotal = salePrice * newQuantitySold;

                if (isNaN(salePrice) || salePrice <=0 || isNaN(newQuantitySold) || newQuantitySold <=0) {
                    Swal.fire('خطأ', `بيانات غير صالحة للمنتج "${name}". تأكد من السعر والكمية.`, 'error'); return;
                }

                updatedProductsInInvoice.push({ productId, name, salePrice, quantity: newQuantitySold, note, total: itemTotal });
                newTotalAmount += itemTotal;

                const originalProductInfo = originalProductsInInvoice.find(p => p.productId === productId);
                const originalQuantitySoldInThisInvoice = originalProductInfo ? originalProductInfo.quantity : 0;
                
                const quantityChangeForStock = originalQuantitySoldInThisInvoice - newQuantitySold; 
                
                if (quantityChangeForStock !== 0) {
                    const productExists = await checkProductExists(productId);
                    if (productExists) {
                         stockAdjustmentPromises.push(adjustProductStock(productId, quantityChangeForStock));
                    } else {
                        console.warn(`Product ${productId} not found in DB. Skipping stock adjustment for this item.`);
                    }
                }
            }
            
            originalProductsInInvoice.forEach(async origP => {
                if (!updatedProductsInInvoice.some(updP => updP.productId === origP.productId)) {
                    const productExists = await checkProductExists(origP.productId);
                     if (productExists) {
                        stockAdjustmentPromises.push(adjustProductStock(origP.productId, origP.quantity)); 
                     } else {
                        console.warn(`Product ${origP.productId} (removed from invoice) not found in DB. Skipping stock adjustment for this item.`);
                     }
                }
            });


            if (amountPaid > newTotalAmount) {
                Swal.fire('خطأ', 'المبلغ المدفوع لا يمكن أن يكون أكبر من المجموع الكلي للفاتورة!', 'error'); return;
            }

            try {
                if (stockAdjustmentPromises.length > 0) {
                    await Promise.all(stockAdjustmentPromises);
                }
            } catch (error) {
                Swal.fire('خطأ في تحديث المخزون', error.message, 'error');
                return; 
            }
            
            let invoiceDateStr = document.getElementById('editInvoiceDate').textContent;
            let invoiceDateISO;
            if (invoiceDateStr && invoiceDateStr !== 'N/A') {
                const parts = invoiceDateStr.match(/(\d{2})-(\d{2})-(\d{4}) (\d{2}):(\d{2})/);
                if (parts) {
                    // parts[1]=day, parts[2]=month, parts[3]=year, parts[4]=hour, parts[5]=minute
                    invoiceDateISO = new Date(Date.UTC(parts[3], parts[2] - 1, parts[1], parts[4], parts[5])).toISOString();
                } else {
                    invoiceDateISO = new Date().toISOString(); 
                }
            } else {
                 invoiceDateISO = new Date().toISOString(); 
            }


            const invoice = {
                id,
                customerId,
                products: updatedProductsInInvoice,
                totalAmount: newTotalAmount.toFixed(2),
                amountPaid: amountPaid.toFixed(2),
                date: invoiceDateISO 
            };

            const transaction = db.transaction(['invoices'], 'readwrite');
            const store = transaction.objectStore('invoices');
            const request = store.put(invoice);

            request.onsuccess = async () => {
                await updateInvoicesTable(); // This also updates dashboard
                bootstrap.Modal.getInstance(document.getElementById('editInvoiceModal')).hide();
                Swal.fire('نجاح', 'تم تعديل الفاتورة وتحديث المخزون بنجاح!', 'success');
            };
            request.onerror = (e) => {
                 console.error("Error updating invoice:", e.target.error);
                 Swal.fire('خطأ', 'فشل في تعديل الفاتورة!', 'error');
            };
        }

        function adjustProductStock(productId, quantityChange) {
            return new Promise(async (resolve, reject) => {
                try {
                    await ensureDBInitialized();
                    const transaction = db.transaction(['products'], 'readwrite');
                    const store = transaction.objectStore('products');
                    const getRequest = store.get(productId);

                    getRequest.onsuccess = () => {
                        const product = getRequest.result;
                        if (!product) {
                            // It's possible a product was deleted from inventory system externally
                            // while it was still in an invoice. Log this instead of hard failing the whole invoice update.
                            console.warn(`المنتج بالمعرف ${productId} غير موجود لتعديل المخزون. سيتم تخطي هذا المنتج.`);
                            resolve(); // Resolve to not block other stock adjustments
                            return;
                        }
                        
                        const newStock = product.quantity + quantityChange;
                        if (newStock < 0) { 
                             reject(new Error(`لا يمكن أن يكون مخزون المنتج "${product.name}" سالبًا. التغيير المطلوب للمخزون: ${quantityChange}, المخزون الحالي: ${product.quantity}.`));
                             return;
                        }
                        product.quantity = newStock;

                        const updateRequest = store.put(product);
                        updateRequest.onsuccess = () => resolve();
                        updateRequest.onerror = (e) => reject(new Error(`فشل تعديل مخزون المنتج ${product.name}: ${e.target.error}`));
                    };
                    getRequest.onerror = (e) => reject(new Error(`فشل جلب المنتج ${productId} لتعديل المخزون: ${e.target.error}`));
                } catch (dbError) {
                    reject(dbError);
                }
            });
        }

        async function deleteInvoice(invoiceId) { // This function is not called from UI but kept for potential use
            const result = await Swal.fire({
                title: 'تأكيد الحذف',
                text: 'هل أنت متأكد من حذف هذه الفاتورة؟ سيتم إرجاع الكميات المباعة إلى المخزون.',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'نعم، احذف',
                cancelButtonText: 'إلغاء',
                confirmButtonColor: '#dc3545',
                cancelButtonColor: '#6c757d'
            });

            if (result.isConfirmed) {
                try {
                    await ensureDBInitialized();
                    const readTx = db.transaction(['invoices'], 'readonly'); 
                    const invoiceStoreRead = readTx.objectStore('invoices');
                    const getInvoiceRequest = invoiceStoreRead.get(invoiceId);

                    getInvoiceRequest.onsuccess = async () => {
                        const invoiceToDelete = getInvoiceRequest.result;
                        if (!invoiceToDelete) {
                            Swal.fire('خطأ', 'الفاتورة غير موجودة.', 'error');
                            return;
                        }

                        let stockReturnPromises = [];
                        for (const p of invoiceToDelete.products) {
                            const productExists = await checkProductExists(p.productId);
                            if (productExists) {
                                stockReturnPromises.push(adjustProductStock(p.productId, p.quantity));
                            } else {
                                console.warn(`Product ${p.productId} from deleted invoice not found. Stock not returned for this item.`);
                            }
                        }
                        
                        try {
                            if (stockReturnPromises.length > 0) {
                                await Promise.all(stockReturnPromises); 
                            }

                            const writeTxDelete = db.transaction(['invoices'], 'readwrite');
                            const invoiceStoreWrite = writeTxDelete.objectStore('invoices');
                            const deleteRequest = invoiceStoreWrite.delete(invoiceId);

                            deleteRequest.onsuccess = async () => {
                                await updateInvoicesTable(); // This also updates dashboard
                                Swal.fire('نجاح', 'تم حذف الفاتورة وإرجاع المنتجات للمخزون بنجاح!', 'success');
                            };
                            deleteRequest.onerror = (e) => {
                                console.error("Error deleting invoice:", e.target.error);
                                Swal.fire('خطأ', 'فشل في حذف الفاتورة! (قد يكون المخزون أُرجع).', 'error');
                            };

                        } catch (stockError) {
                            Swal.fire('خطأ في إرجاع المخزون', stockError.message, 'error');
                        }
                    };
                    getInvoiceRequest.onerror = (e) => Swal.fire('خطأ', `فشل في جلب الفاتورة للحذف: ${e.target.error}`, 'error');

                } catch (dbError) {
                     Swal.fire('خطأ قاعدة البيانات', `فشل: ${dbError.message}`, 'error');
                }
            }
        }


        async function addCustomer() {
            const name = document.getElementById('customerName').value.trim();
            const phone = document.getElementById('customerPhone').value.trim();
            const address = document.getElementById('customerAddress').value.trim();
            
            if (!name && !phone && !address) {
                 Swal.fire('خطأ', 'يجب إدخال معلومة واحدة على الأقل للزبون (الاسم أو الهاتف أو العنوان).', 'error');
                 return;
            }

            if (phone) { 
                const customers = await getAllCustomers();
                if (customers.some(c => c.phone === phone && phone !== '')) { // Ensure phone isn't empty string
                    Swal.fire('خطأ', 'رقم الهاتف هذا مُسجل لزبون آخر!', 'error');
                    return;
                }
            }


            const id = await generateUniqueId('customers');
            const customer = { 
                id, 
                name: name || null, // Store null if empty for consistency
                phone: phone || null, 
                address: address || null 
            };


            const transaction = db.transaction(['customers'], 'readwrite');
            const store = transaction.objectStore('customers');
            const request = store.add(customer);

            request.onsuccess = async () => {
                await updateCustomersTable();
                await populateCustomerSelect('invoiceCustomer');
                await populateCustomerSelect('editInvoiceCustomer');
                await populateCustomerSelect('statementCustomer');
                bootstrap.Modal.getInstance(document.getElementById('addCustomerModal')).hide();
                document.getElementById('addCustomerForm').reset();
                Swal.fire('نجاح', 'تم إضافة الزبون بنجاح!', 'success');
            };
            request.onerror = (e) => Swal.fire('خطأ', `فشل في إضافة الزبون: ${e.target.error}`, 'error');
        }

        async function editCustomer(customerId) {
            try {
                await ensureDBInitialized();
                const transaction = db.transaction(['customers'], 'readonly');
                const store = transaction.objectStore('customers');
                const request = store.get(customerId);

                request.onsuccess = () => {
                    const customer = request.result;
                    if (!customer) {
                        Swal.fire('خطأ', 'الزبون غير موجود!', 'error');
                        return;
                    }
                    document.getElementById('editCustomerId').value = customer.id;
                    document.getElementById('editCustomerName').value = customer.name || '';
                    document.getElementById('editCustomerPhone').value = customer.phone || '';
                    document.getElementById('editCustomerAddress').value = customer.address || '';
                    new bootstrap.Modal(document.getElementById('editCustomerModal')).show();
                };
                request.onerror = (e) => Swal.fire('خطأ', `فشل في جلب بيانات الزبون: ${e.target.error}`, 'error');
            } catch (dbError) {
                 Swal.fire('خطأ قاعدة البيانات', `فشل: ${dbError.message}`, 'error');
            }
        }

        async function updateCustomer() {
            const id = document.getElementById('editCustomerId').value;
            const name = document.getElementById('editCustomerName').value.trim();
            const phone = document.getElementById('editCustomerPhone').value.trim();
            const address = document.getElementById('editCustomerAddress').value.trim();

             if (!name && !phone && !address) {
                 Swal.fire('خطأ', 'يجب إدخال معلومة واحدة على الأقل للزبون.', 'error');
                 return;
            }

            if (phone) { 
                const customers = await getAllCustomers();
                if (customers.some(c => c.id !== id && c.phone === phone && phone !== '')) { 
                    Swal.fire('خطأ', 'رقم الهاتف هذا مُسجل لزبون آخر!', 'error');
                    return;
                }
            }

            const customer = { 
                id, 
                name: name || null, 
                phone: phone || null, 
                address: address || null 
            };
            const transaction = db.transaction(['customers'], 'readwrite');
            const store = transaction.objectStore('customers');
            const request = store.put(customer);

            request.onsuccess = async () => {
                await updateCustomersTable();
                await updateInvoicesTable(); // Refresh invoices in case customer name changed
                await populateCustomerSelect('invoiceCustomer');
                await populateCustomerSelect('editInvoiceCustomer');
                await populateCustomerSelect('statementCustomer');
                bootstrap.Modal.getInstance(document.getElementById('editCustomerModal')).hide();
                Swal.fire('نجاح', 'تم تعديل بيانات الزبون بنجاح!', 'success');
            };
            request.onerror = (e) => Swal.fire('خطأ', `فشل في تعديل بيانات الزبون: ${e.target.error}`, 'error');
        }

        async function deleteCustomer(customerId) {
            const invoices = await getAllInvoices();
            if (invoices.some(i => i.customerId === customerId)) {
                Swal.fire('لا يمكن الحذف', 'لا يمكن حذف هذا الزبون لأنه مرتبط بفواتير حالية. يرجى تعديل الفواتير المرتبطة به لزبون آخر أو حذفها (إذا كانت هذه الإمكانية متاحة).', 'error');
                return;
            }


            const result = await Swal.fire({
                title: 'تأكيد الحذف',
                text: 'هل أنت متأكد من حذف هذا الزبون؟ لا يمكن التراجع عن هذا الإجراء.',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'نعم، احذف',
                cancelButtonText: 'إلغاء',
                confirmButtonColor: '#dc3545'
            });

            if (result.isConfirmed) {
                const transaction = db.transaction(['customers'], 'readwrite');
                const store = transaction.objectStore('customers');
                const request = store.delete(customerId);

                request.onsuccess = async () => {
                    await updateCustomersTable();
                    await populateCustomerSelect('invoiceCustomer');
                    await populateCustomerSelect('editInvoiceCustomer');
                    await populateCustomerSelect('statementCustomer');
                    Swal.fire('نجاح', 'تم حذف الزبون بنجاح!', 'success');
                };
                request.onerror = (e) => Swal.fire('خطأ', `فشل في حذف الزبون: ${e.target.error}`, 'error');
            }
        }
        
        async function printInvoice(invoiceId) {
            try {
                await ensureDBInitialized();
                const transaction = db.transaction(['invoices', 'customers'], 'readonly');
                const invoiceStore = transaction.objectStore('invoices');
                const invoiceRequest = invoiceStore.get(invoiceId);

                invoiceRequest.onsuccess = async () => {
                    const invoice = invoiceRequest.result;
                    if (!invoice) { Swal.fire('خطأ', 'الفاتورة غير موجودة.', 'error'); return; }

                    const customers = await getAllCustomers(); 
                    const customer = customers.find(c => c.id === invoice.customerId);
                    
                    const printWindow = window.open('', '_blank', 'height=800,width=600');
                    if (!printWindow) {
                         Swal.fire('خطأ', 'فشل فتح نافذة الطباعة. يرجى التأكد من تعطيل مانع النوافذ المنبثقة.', 'error'); return;
                    }
                    printWindow.document.write(`
                        <!DOCTYPE html>
                        <html lang="ar" dir="rtl">
                        <head>
                            <meta charset="UTF-8">
                            <title>فاتورة رقم: ${invoice.id}</title>
                            <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
                            <style>
                                @page { size: A5 landscape; margin: 5mm; }
                                body { font-family: 'Cairo', sans-serif; direction: rtl; margin: 5mm; font-size: 10pt; }
                                .container { width: 100%; margin: 0 auto; }
                                .header-print { text-align: center; margin-bottom: 10px; border-bottom: 1px solid #ccc; padding-bottom: 5px;}
                                .header-print img { max-height: 40px; margin-bottom: 3px; }
                                .header-print h1 { font-size: 1.1rem; color: #3F2A56; margin:0; }
                                .invoice-info-grid { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px;}
                                .invoice-details-text { flex-basis: 70%;} 
                                .invoice-details, .customer-details { font-size: 0.85rem;}
                                .invoice-details p, .customer-details p { margin: 2px 0; }
                                .qr-code-container { 
                                    flex-basis: auto; /* Adjust to content */
                                    min-width: 75px; 
                                    text-align: center; /* Center the QR code if div is wider */
                                    padding-left: 5px; 
                                } 
                                #invoiceQrCodeElement { /* The div where QR will be generated */
                                    display: inline-block; /* Helps with sizing and centering */
                                }
                                #invoiceQrCodeElement canvas,
                                #invoiceQrCodeElement img {
                                    border: 1px solid #eee; /* Add border to the QR itself */
                                }
                                .products-table { width: 100%; border-collapse: collapse; margin-bottom: 8px; }
                                .products-table th, .products-table td { padding: 4px; border: 1px solid #ccc; text-align: center; font-size: 0.8rem;}
                                .products-table th { background-color: #f2f2f2; color: #333; font-weight:600; }
                                .totals-section { margin-top: 10px; padding-top: 8px; border-top: 1px solid #ccc; text-align:left; font-size: 0.85rem;}
                                .totals-section p { margin: 3px 0; font-weight: 600; }
                                .footer-print { text-align: center; font-size: 0.75rem; margin-top: 15px; color: #777; }
                                @media print {
                                    body { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
                                }
                            </style>
                        </head>
                        <body>
                            <div class="container">
                                <div class="header-print">
                                    <img src="logo.png" alt="شعار" onerror="this.style.display='none';">
                                    <h1>طيبة المدينة تلكوم</h1>
                                    <p style="font-size:0.7rem;">للاتصالات وخدمات الجوال</p>
                                </div>
                                
                                <div class="invoice-info-grid">
                                    <div class="invoice-details-text">
                                        <div class="invoice-details">
                                            <p><strong>رقم الفاتورة:</strong> ${invoice.id}</p>
                                            <p><strong>التاريخ:</strong> ${formatDateForDisplay(invoice.date)}</p>
                                        </div>
                                        <div class="customer-details">
                                            <p><strong>الزبون:</strong> ${customer?.name || 'زبون نقدي'}</p>
                                            ${customer?.phone ? `<p><strong>الهاتف:</strong> ${customer.phone}</p>` : ''}
                                            ${customer?.address ? `<p><strong>العنوان:</strong> ${customer.address}</p>` : ''}
                                        </div>
                                    </div>
                                    <div class="qr-code-container">
                                        <div id="invoiceQrCodeElement"></div> <!-- Target for QRCode.js -->
                                    </div>
                                </div>

                                <table class="products-table">
                                    <thead>
                                        <tr>
                                            <th>م</th>
                                            <th>البيان (اسم المنتج)</th>
                                            <th>س. الوحدة</th>
                                            <th>الكمية</th>
                                            <th>الإجمالي</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${invoice.products.map((p, index) => `
                                            <tr>
                                                <td>${index + 1}</td>
                                                <td style="text-align:right;">${p.name} ${p.note ? `(${p.note})` : ''}</td>
                                                <td>${parseFloat(p.salePrice).toFixed(2)}</td>
                                                <td>${p.quantity}</td>
                                                <td>${parseFloat(p.total).toFixed(2)}</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                                <div class="totals-section">
                                    <p>المجموع الكلي: ${parseFloat(invoice.totalAmount).toFixed(2)}</p>
                                    <p>المبلغ المدفوع: ${parseFloat(invoice.amountPaid).toFixed(2)}</p>
                                    <p>المتبقي: ${(parseFloat(invoice.totalAmount) - parseFloat(invoice.amountPaid)).toFixed(2)}</p>
                                </div>
                                <div class="footer-print">
                                    <p>شكراً لتعاملكم معنا!</p>
                                </div>
                            </div>
                            <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"><\/script>
                            <script>
                                window.onload = function() { // This is the onload for the print window's content
                                    var qrElement = document.getElementById('invoiceQrCodeElement');
                                    if (qrElement && typeof QRCode !== 'undefined') {
                                        new QRCode(qrElement, {
                                            text: "${invoice.id}",
                                            width: 65,
                                            height: 65,
                                            colorDark : "#000000",
                                            colorLight : "#ffffff",
                                            correctLevel : QRCode.CorrectLevel.H
                                        });
                                    } else {
                                        console.error("QR Code generation failed in print window: Element or QRCode library not found.");
                                    }
                                };
                            <\/script>
                        </body>
                        </html>
                    `);
                    printWindow.document.close(); 
                    printWindow.onload = function() { // This is for the parent window's reference to the new window object
                        // The new window's own window.onload (for its content) should have fired by now.
                        // Add a slight delay to ensure rendering is complete before the print dialog.
                        setTimeout(function() {
                            printWindow.focus();
                            printWindow.print();
                            // printWindow.close(); // Optional: Close after print dialog
                        }, 300); // 300ms delay, adjust if needed.
                    }
                };
                invoiceRequest.onerror = (e) => Swal.fire('خطأ', `فشل في جلب الفاتورة للطباعة: ${e.target.error}`, 'error');
            } catch (dbError) {
                 Swal.fire('خطأ قاعدة البيانات', `فشل: ${dbError.message}`, 'error');
            }
        }

        async function generateCustomerStatement() {
            const customerId = document.getElementById('statementCustomer').value;
            const startDateValue = document.getElementById('startDate').value;
            const endDateValue = document.getElementById('endDate').value;

            if (!customerId || !startDateValue || !endDateValue) {
                Swal.fire('خطأ', 'الرجاء اختيار الزبون وتحديد نطاق التاريخ بشكل كامل!', 'error');
                return;
            }
            
            const startDate = new Date(startDateValue);
            const endDate = new Date(endDateValue);
            endDate.setHours(23, 59, 59, 999); 


            if (startDate > endDate) {
                Swal.fire('خطأ', 'تاريخ البداية يجب أن يكون قبل أو نفس تاريخ النهاية!', 'error');
                return;
            }

            const invoices = await getAllInvoices();
            const customers = await getAllCustomers();
            const customer = customers.find(c => c.id === customerId);

            const filteredInvoices = invoices.filter(i => {
                const invoiceDate = new Date(i.date);
                return i.customerId === customerId && invoiceDate >= startDate && invoiceDate <= endDate;
            }).sort((a, b) => new Date(a.date) - new Date(b.date)); 

            const printWindow = window.open('', '_blank', 'height=800,width=600');
             if (!printWindow) {
                 Swal.fire('خطأ', 'فشل فتح نافذة الطباعة. يرجى التأكد من تعطيل مانع النوافذ المنبثقة.', 'error'); return;
             }
            printWindow.document.write(`
                <!DOCTYPE html>
                <html lang="ar" dir="rtl">
                <head>
                    <meta charset="UTF-8">
                    <title>كشف حساب الزبون: ${customer?.name || 'غير معروف'}</title>
                    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
                    <style>
                        @page { size: A4; margin: 10mm; }
                        body { font-family: 'Cairo', sans-serif; direction: rtl; margin: 10mm; font-size:10pt; }
                        .container { width: 100%; margin: 0 auto; }
                        .header-print { text-align: center; margin-bottom: 20px; border-bottom: 1px solid #ccc; padding-bottom:10px;}
                        .header-print img { max-height: 60px; margin-bottom: 5px;}
                        .header-print h1 { font-size: 1.4rem; color: #3F2A56; margin:0; }
                        .info { margin-bottom: 15px; font-size:0.95rem; }
                        .info p { margin: 4px 0; }
                        .statement-table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
                        .statement-table th, .statement-table td { padding: 8px; border: 1px solid #ccc; text-align: center; font-size:0.9rem; }
                        .statement-table th { background-color: #f2f2f2; color: #333; font-weight:600; }
                        .status-paid { color: #198754; font-weight: 700; }
                        .status-partial { color: #ffc107; font-weight: 700; }
                        .status-unpaid { color: #dc3545; font-weight: 700; }
                        .summary { margin-top: 20px; padding-top:10px; border-top: 1px solid #ccc; text-align:left; font-size:1rem;}
                        .summary p {margin: 5px 0; font-weight:600;}
                         @media print {
                            body { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
                        }
                    </style>
                </head>
                <body>
                    <div class="container">
                        <div class="header-print">
                             <img src="logo.png" alt="شعار" onerror="this.style.display='none';">
                            <h1>طيبة المدينة تلكوم</h1>
                            <h2>كشف حساب زبون</h2>
                        </div>
                        <div class="info">
                            <p><strong>الزبون:</strong> ${customer?.name || 'زبون غير محدد'}</p>
                            ${customer?.phone ? `<p><strong>الهاتف:</strong> ${customer.phone}</p>` : ''}
                            <p><strong>الفترة من:</strong> ${new Date(startDateValue).toLocaleDateString('ar-SA-u-nu-latn', { year: 'numeric', month: '2-digit', day: '2-digit' })}</p>
                            <p><strong>إلى:</strong> ${new Date(endDateValue).toLocaleDateString('ar-SA-u-nu-latn', { year: 'numeric', month: '2-digit', day: '2-digit' })}</p>
                        </div>
                        <table class="statement-table">
                            <thead>
                                <tr>
                                    <th>رقم الفاتورة</th>
                                    <th>التاريخ</th>
                                    <th>إجمالي الفاتورة</th>
                                    <th>المدفوع</th>
                                    <th>المتبقي</th>
                                    <th>الحالة</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${filteredInvoices.length > 0 ? filteredInvoices.map(i => {
                                    const totalAmount = parseFloat(i.totalAmount);
                                    const amountPaid = parseFloat(i.amountPaid);
                                    const remaining = totalAmount - amountPaid;
                                    let statusText, statusClassSuffix;
                                    if (totalAmount === 0 && amountPaid === 0) { statusText = 'لا يوجد مبلغ'; statusClassSuffix = '';}
                                    else if (amountPaid >= totalAmount) { statusText = 'مدفوع'; statusClassSuffix = 'paid'; }
                                    else if (amountPaid > 0) { statusText = 'مدفوع جزئيًا'; statusClassSuffix = 'partial'; }
                                    else { statusText = 'لم يتم الدفع'; statusClassSuffix = 'unpaid'; }
                                    

                                    return `
                                        <tr>
                                            <td>${i.id}</td>
                                            <td>${formatDateForDisplay(i.date)}</td>
                                            <td>${totalAmount.toFixed(2)}</td>
                                            <td>${amountPaid.toFixed(2)}</td>
                                            <td>${remaining.toFixed(2)}</td>
                                            <td class="status-${statusClassSuffix}">${statusText}</td>
                                        </tr>
                                    `;
                                }).join('') : '<tr><td colspan="6">لا توجد فواتير لهذا الزبون في الفترة المحددة.</td></tr>'}
                            </tbody>
                        </table>
                        ${filteredInvoices.length > 0 ? `
                        <div class="summary">
                            <p>إجمالي قيمة الفواتير: ${filteredInvoices.reduce((sum, i) => sum + parseFloat(i.totalAmount), 0).toFixed(2)}</p>
                            <p>إجمالي المدفوعات: ${filteredInvoices.reduce((sum, i) => sum + parseFloat(i.amountPaid), 0).toFixed(2)}</p>
                            <p>إجمالي المتبقي: ${filteredInvoices.reduce((sum, i) => sum + (parseFloat(i.totalAmount) - parseFloat(i.amountPaid)), 0).toFixed(2)}</p>
                        </div>
                        ` : ''}
                    </div>
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.onload = function() { // Parent window's reference onload
                setTimeout(function() { // Delay to ensure rendering, especially if print window has complex content
                    printWindow.focus();
                    printWindow.print();
                }, 300);
            }
            bootstrap.Modal.getInstance(document.getElementById('customerStatementModal')).hide();
            document.getElementById('customerStatementForm').reset();
        }

        function startQrScanner() {
            const qrReaderContainer = document.getElementById('qr-reader-container');
            
            if (html5QrCodeScanner) {
                 try {
                    if (html5QrCodeScanner.getState() === Html5QrcodeScannerState.SCANNING) {
                        stopQrScanner(); 
                    }
                 } catch (e) { console.warn("Error checking scanner state, attempting to stop anyway:", e); stopQrScanner(); }
            }

            qrReaderContainer.style.display = 'block';
            
            if (typeof Html5Qrcode === "undefined") {
                Swal.fire('خطأ', 'مكتبة مسح QR غير محملة بشكل صحيح.', 'error');
                qrReaderContainer.style.display = 'none'; 
                return;
            }

            html5QrCodeScanner = new Html5Qrcode("qr-reader"); 
            const qrCodeSuccessCallback = (decodedText, decodedResult) => {
                document.getElementById('searchInput').value = decodedText;
                filterTable();
                stopQrScanner(); 
                Swal.fire('نجاح!', `تم العثور على الفاتورة: ${decodedText}`, 'success');
            };
            const config = { fps: 10, qrbox: {width: 250, height: 250}, aspectRatio: 1.0 }; 
            
             html5QrCodeScanner.start(
                { facingMode: "environment" }, 
                config,
                qrCodeSuccessCallback,
                (errorMessage) => {
                    // console.warn(`QR Code no match or error: ${errorMessage}`);
                })
            .catch((err) => {
                console.error(`Unable to start QR scanning, error: ${err}`);
                Swal.fire('خطأ', 'لم يتمكن من تشغيل ماسح QR. تأكد من صلاحيات الكاميرا أو أن الكاميرا غير مستخدمة بواسطة تطبيق آخر.', 'error');
                stopQrScanner(); 
            });
        }

        function stopQrScanner() {
            const qrReaderContainer = document.getElementById('qr-reader-container');
            if (html5QrCodeScanner) {
                html5QrCodeScanner.stop().then(ignore => {
                    console.log("QR Code scanning stopped.");
                    if (html5QrCodeScanner && typeof html5QrCodeScanner.clear === 'function') {
                        html5QrCodeScanner.clear(); 
                    }
                    // html5QrCodeScanner = null; // Do not nullify here if you want to reuse, but for safety, it's good
                }).catch(err => {
                    console.error("Failed to stop QR Code scanner.", err);
                    // html5QrCodeScanner = null; 
                }).finally(() => {
                     qrReaderContainer.style.display = 'none'; 
                });
            } else {
                 qrReaderContainer.style.display = 'none'; 
            }
        }


        document.addEventListener('DOMContentLoaded', async () => {
            try {
                await initDB();
                await Promise.all([
                    updateInvoicesTable(), 
                    updateCustomersTable(),
                    populateCustomerSelect('invoiceCustomer'),
                    populateCustomerSelect('editInvoiceCustomer'),
                    populateCustomerSelect('statementCustomer')
                ]);
                
                setupProductSearch('productSearch', 'productSuggestions', 'invoiceProducts');
                setupProductSearch('editProductSearch', 'editProductSuggestions', 'editInvoiceProducts', true);
                
                document.getElementById('invoiceDate').textContent = formatDateForDisplay(new Date().toISOString());
                
                document.getElementById('invoiceCustomer').addEventListener('change', (e) => updateCustomerInfo('invoiceCustomer', 'customerPhoneDisplay', 'customerAddressDisplay'));
                document.getElementById('editInvoiceCustomer').addEventListener('change', (e) => updateCustomerInfo('editInvoiceCustomer', 'editCustomerPhoneDisplay', 'editCustomerAddressDisplay'));

                document.getElementById('scanQrBtn').addEventListener('click', startQrScanner);
                document.getElementById('closeScannerBtn').addEventListener('click', stopQrScanner);


            } catch (error) {
                console.error("Initialization failed:", error);
                Swal.fire('فشل التهيئة', `حدث خطأ أثناء تحميل الصفحة: ${error.message}`, 'error');
            }
        });
    </script>
</body>
</html><!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>بيع المنتجات</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!-- QR Code Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode@2.0.9/dist/html5-qrcode.min.js"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Cairo', sans-serif;
            background: linear-gradient(135deg, #f0f2f5, #d9e2ec);
            color: #333;
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .home-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: linear-gradient(90deg, #3F2A56, #5a3f73);
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            text-decoration: none;
            font-size: 1rem;
            font-weight: 600;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            transition: transform 0.2s ease, background 0.3s ease, box-shadow 0.3s ease;
            position: absolute;
            top: 20px;
            left: 20px;
        }
        .home-btn:hover {
            background: linear-gradient(90deg, #5a3f73, #3F2A56);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
        }
        .header {
            background: linear-gradient(135deg, #3F2A56, #5a3f73);
            color: white;
            padding: 40px 20px;
            border-radius: 25px;
            text-align: center;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
            margin-bottom: 30px;
            position: relative;
            z-index: 1;
            border: 2px solid rgba(255, 255, 255, 0.1);
        }
        .header img {
            height: 90px;
            margin-bottom: 15px;
            filter: drop-shadow(0 3px 6px rgba(0, 0, 0, 0.3));
        }
        .header h2 {
            font-size: 2.2rem;
            margin-bottom: 10px;
            font-weight: 700;
        }
        .header h4 {
            font-size: 1.4rem;
            opacity: 0.9;
            font-weight: 400;
        }
        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        .card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: #3F2A56;
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            text-align: center;
            transition: transform 0.3s ease;
        }
        .card:hover {
            transform: translateY(-10px);
        }
        .card i {
            font-size: 2.8rem;
            margin-bottom: 15px;
            color: #3F2A56;
        }
        .card h5 {
            font-size: 1.3rem;
            margin-bottom: 10px;
            font-weight: 600;
        }
        .card h3 {
            font-size: 1.8rem;
            font-weight: 700;
        }
        .section {
            background: white;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
            padding: 20px;
            margin: 20px 0;
        }
        .section h3 {
            font-size: 1.7rem;
            font-weight: 700;
            color: #3F2A56;
            margin-bottom: 15px;
            text-align: center;
        }
        .table-container {
            overflow-x: auto;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            padding: 12px;
            text-align: center;
            border-bottom: 1px solid #e0e0e0;
        }
        th {
            background: linear-gradient(90deg, #3F2A56, #5a3f73);
            color: white;
            font-weight: 700;
        }
        td {
            color: #3F2A56;
        }
        tr:hover {
            background-color: #f7f9fc;
        }
        .actions {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin: 25px 0;
            justify-content: center;
        }
        .btn {
            background: linear-gradient(90deg, #3F2A56, #5a3f73);
            color: white;
            padding: 12px 24px;
            border-radius: 30px;
            border: none;
            font-size: 1rem;
            cursor: pointer;
            transition: transform 0.2s ease, background 0.3s ease, box-shadow 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .btn:hover {
            background: linear-gradient(90deg, #5a3f73, #3F2A56);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.2);
        }
        .search-container {
            margin-bottom: 20px;
            display: flex;
            justify-content: center;
            align-items: flex-end; /* Align items to bottom for button */
            gap: 15px;
            flex-wrap: wrap;
        }
        .filter-group {
            display: flex;
            flex-direction: column;
            max-width: 200px;
        }
        .filter-group label {
            font-size: 0.9rem;
            font-weight: 600;
            color: #3F2A56;
            margin-bottom: 5px;
        }
        .filter-group input, .filter-group select {
            padding: 12px;
            border-radius: 30px;
            border: none;
            background: rgba(255, 255, 255, 0.1);
            color: #3F2A56;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        .filter-group input:focus, .filter-group select:focus {
            outline: none;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2);
        }
        #scanQrBtn {
            padding: 10px 15px; /* Adjust padding */
            height: 46px; /* Match input height */
            border-radius: 30px;
        }
         #qr-reader-container {
            margin-top: 10px;
            border: 1px solid #ccc;
            border-radius: 10px;
            padding:10px;
            background-color: #f9f9f9;
        }
        #qr-reader {
            width: 100%;
            max-width: 400px; /* Adjust as needed */
            margin: 0 auto;
        }

        .action-btn {
            cursor: pointer;
            margin: 0 6px;
            font-size: 1.3rem;
            transition: color 0.3s ease;
        }
        .action-btn.edit:hover { color: #007bff; }
        /* .action-btn.delete:hover { color: #dc3545; } */ /* Delete button removed from UI */
        .action-btn.print:hover { color: #28a745; }

        .modal-content {
            border-radius: 20px;
            background: linear-gradient(145deg, #ffffff, #f7f9fc);
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }
        .modal-header {
            background: linear-gradient(90deg, #3F2A56, #5a3f73);
            color: white;
            border-top-left-radius: 20px;
            border-top-right-radius: 20px;
            padding: 20px;
        }
        .modal-title {
            font-size: 1.5rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .modal-body {
            padding: 30px;
        }
        .modal-body .form-label {
            font-weight: 600;
            color: #3F2A56;
        }
        .modal-body .form-control, .modal-body .form-select {
            border-radius: 15px;
            padding: 12px;
            background: #f7f9fc;
            border: 1px solid #ddd;
        }
         .modal-body .form-control:focus, .modal-body .form-select:focus {
            border-color: #3F2A56;
            box-shadow: 0 0 0 0.25rem rgba(63, 42, 86, 0.25);
        }
        .modal-footer {
            padding: 20px;
            background: #f8f9fa;
            border-bottom-left-radius: 20px;
            border-bottom-right-radius: 20px;
        }
        .modal-footer .btn {
            padding: 12px 30px;
        }
        .product-table th, .product-table td {
            padding: 8px;
        }
        .modal-body .product-table th { /* Change header text color in modal product tables */
            color: white;
             background: linear-gradient(90deg, #3F2A56, #5a3f73); /* Optional: match main table header */
        }
        .status-paid { color: #198754; font-weight: 700; }
        .status-partial { color: #ffc107; font-weight: 700; }
        .status-unpaid { color: #dc3545; font-weight: 700; }
        .swal2-popup {
            font-family: 'Cairo', sans-serif !important;
            border-radius: 15px !important;
        }
        .swal2-title { color: #3F2A56 !important; }
        .swal2-html-container { text-align: right !important; }
        .swal2-confirm {
            background: linear-gradient(90deg, #3F2A56, #5a3f73) !important;
            border-radius: 20px !important;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2) !important;
        }
        .swal2-cancel, .swال2-deny {
            background: linear-gradient(90deg, #6c757d, #5a6268) !important;
            border-radius: 20px !important;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2) !important;
        }
        #productSuggestions div, #editProductSuggestions div {
            padding: 8px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        #productSuggestions div:hover, #editProductSuggestions div:hover {
            background-color: #f0f0f0;
        }

        @media (max-width: 768px) {
            .header { padding: 25px 15px; }
            .header img { height: 70px; }
            .header h2 { font-size: 1.7rem; }
            .btn { padding: 10px 18px; font-size: 0.9rem; }
            th, td { padding: 10px; font-size: 0.9rem; }
            .modal-body { padding: 20px; }
            .search-container { flex-direction: column; align-items: stretch;}
            .filter-group { max-width: none; }
            #scanQrBtn { width: 100%; margin-top: 10px;}
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <img src="logo.png" alt="شعار طيبة المدينة تلكوم" onerror="this.src='https://via.placeholder.com/90?text=Logo'; this.style.display='none';">
            <h2>طيبة المدينة تلكوم</h2>
            <h4>بيع المنتجات</h4>
            <a href="home.html" class="home-btn"><i class="fas fa-home"></i> للرئيسية</a>
        </div>
        <div class="dashboard">
            <div class="card">
                <i class="fas fa-check-circle"></i>
                <h5>الفواتير المدفوعة</h5>
                <h3 id="paidInvoices">0</h3>
            </div>
            <div class="card">
                <i class="fas fa-exclamation-circle"></i>
                <h5>الفواتير المدفوعة جزئيًا</h5>
                <h3 id="partialInvoices">0</h3>
            </div>
            <div class="card">
                <i class="fas fa-times-circle"></i>
                <h5>الفواتير غير المدفوعة</h5>
                <h3 id="unpaidInvoices">0</h3>
            </div>
        </div>
        <div class="actions">
            <button class="btn" data-bs-toggle="modal" data-bs-target="#addInvoiceModal"><i class="fas fa-plus"></i> إضافة فاتورة</button>
            <button class="btn" data-bs-toggle="modal" data-bs-target="#addCustomerModal"><i class="fas fa-user-plus"></i> إضافة زبون</button>
            <button class="btn" data-bs-toggle="modal" data-bs-target="#customerStatementModal"><i class="fas fa-file-alt"></i> كشف حساب زبون</button>
        </div>
        <div class="section">
            <h3>الفواتير</h3>
            <div class="search-container">
                <div class="filter-group">
                    <label for="searchInput">البحث</label>
                    <input type="text" id="searchInput" placeholder="ابحث بالزبون أو معرف الفاتورة" oninput="filterTable()">
                </div>
                <button id="scanQrBtn" class="btn btn-info" title="مسح QR Code للبحث عن فاتورة"><i class="fas fa-qrcode"></i> مسح</button>
                <div class="filter-group">
                    <label for="statusFilter">حالة الفاتورة</label>
                    <select id="statusFilter" onchange="filterTable()">
                        <option value="all">الكل</option>
                        <option value="paid">مدفوع</option>
                        <option value="partial">مدفوع جزئيًا</option>
                        <option value="unpaid">لم يتم الدفع</option>
                    </select>
                </div>
            </div>
             <div id="qr-reader-container" style="display: none;">
                <div id="qr-reader"></div>
                <button id="closeScannerBtn" class="btn btn-sm btn-danger mt-2" style="display:block; margin: 0 auto;">إغلاق الماسح</button>
            </div>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>معرف الفاتورة</th>
                            <th>الزبون</th>
                            <th>رقم الهاتف</th>
                            <th>المبلغ الكلي</th>
                            <th>حالة الفاتورة</th>
                            <th>الإجراءات</th>
                        </tr>
                    </thead>
                    <tbody id="invoicesTable"></tbody>
                </table>
            </div>
        </div>
        <div class="section">
            <h3>إدارة الزبائن</h3>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>الاسم</th>
                            <th>رقم الهاتف</th>
                            <th>العنوان</th>
                            <th>الإجراءات</th>
                        </tr>
                    </thead>
                    <tbody id="customersTable"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- نافذة إضافة فاتورة -->
    <div class="modal fade" id="addInvoiceModal" tabindex="-1" aria-labelledby="addInvoiceModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addInvoiceModalLabel"><i class="fas fa-file-invoice-dollar"></i> إضافة فاتورة جديدة</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="addInvoiceForm">
                        <div class="mb-3">
                            <label for="invoiceCustomer" class="form-label"><i class="fas fa-user"></i> الزبون</label>
                            <select class="form-select" id="invoiceCustomer" required>
                                <option value="">اختر زبونًا</option>
                            </select>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="customerPhoneDisplay" class="form-label"><i class="fas fa-phone"></i> رقم الهاتف</label>
                                <input type="text" class="form-control" id="customerPhoneDisplay" readonly>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="customerAddressDisplay" class="form-label"><i class="fas fa-map-marker-alt"></i> العنوان</label>
                                <input type="text" class="form-control" id="customerAddressDisplay" readonly>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="productSearch" class="form-label"><i class="fas fa-search"></i> البحث عن منتج</label>
                            <input type="text" class="form-control" id="productSearch" placeholder="ابحث بالاسم أو المعرف">
                            <div id="productSuggestions" class="mt-2 list-group" style="max-height: 150px; overflow-y: auto;"></div>
                        </div>
                        <h5><i class="fas fa-boxes"></i> المنتجات</h5>
                        <div class="table-container">
                            <table class="product-table table">
                                <thead>
                                    <tr>
                                        <th>اسم المنتج</th>
                                        <th>سعر البيع</th>
                                        <th>الكمية</th>
                                        <th>الملاحظة</th>
                                        <th>الإجمالي</th>
                                        <th>الإجراءات</th>
                                    </tr>
                                </thead>
                                <tbody id="invoiceProducts"></tbody>
                            </table>
                        </div>
                        <div class="mt-3">
                            <p><strong><i class="fas fa-calendar-alt"></i> التاريخ:</strong> <span id="invoiceDate"></span></p>
                            <p><strong><i class="fas fa-hashtag"></i> عدد المواد:</strong> <span id="totalItems">0</span></p>
                            <p><strong><i class="fas fa-coins"></i> المجموع الكلي:</strong> <span id="totalAmount">0.00</span></p>
                            <div class="mb-3">
                                <label for="amountPaid" class="form-label"><i class="fas fa-money-bill-wave"></i> المبلغ المدفوع</label>
                                <input type="number" class="form-control" id="amountPaid" step="0.01" min="0" value="0">
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
                    <button type="button" class="btn btn-primary" onclick="addInvoice()">حفظ الفاتورة</button>
                </div>
            </div>
        </div>
    </div>

    <!-- نافذة تعديل فاتورة -->
    <div class="modal fade" id="editInvoiceModal" tabindex="-1" aria-labelledby="editInvoiceModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editInvoiceModalLabel"><i class="fas fa-edit"></i> تعديل فاتورة</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="editInvoiceForm">
                        <input type="hidden" id="editInvoiceId">
                        <div class="mb-3">
                            <label for="editInvoiceCustomer" class="form-label"><i class="fas fa-user"></i> الزبون</label>
                            <select class="form-select" id="editInvoiceCustomer" required>
                                <option value="">اختر زبونًا</option>
                            </select>
                        </div>
                         <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="editCustomerPhoneDisplay" class="form-label"><i class="fas fa-phone"></i> رقم الهاتف</label>
                                <input type="text" class="form-control" id="editCustomerPhoneDisplay" readonly>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="editCustomerAddressDisplay" class="form-label"><i class="fas fa-map-marker-alt"></i> العنوان</label>
                                <input type="text" class="form-control" id="editCustomerAddressDisplay" readonly>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="editProductSearch" class="form-label"><i class="fas fa-search"></i> البحث عن منتج</label>
                            <input type="text" class="form-control" id="editProductSearch" placeholder="ابحث بالاسم أو المعرف">
                            <div id="editProductSuggestions" class="mt-2 list-group" style="max-height: 150px; overflow-y: auto;"></div>
                        </div>
                        <h5><i class="fas fa-boxes"></i> المنتجات</h5>
                        <div class="table-container">
                            <table class="product-table table">
                                <thead>
                                    <tr>
                                        <th>اسم المنتج</th>
                                        <th>سعر البيع</th>
                                        <th>الكمية</th>
                                        <th>الملاحظة</th>
                                        <th>الإجمالي</th>
                                        <th>الإجراءات</th>
                                    </tr>
                                </thead>
                                <tbody id="editInvoiceProducts"></tbody>
                            </table>
                        </div>
                        <div class="mt-3">
                            <p><strong><i class="fas fa-calendar-alt"></i> التاريخ:</strong> <span id="editInvoiceDate"></span></p>
                            <p><strong><i class="fas fa-hashtag"></i> عدد المواد:</strong> <span id="editTotalItems">0</span></p>
                            <p><strong><i class="fas fa-coins"></i> المجموع الكلي:</strong> <span id="editTotalAmount">0.00</span></p>
                            <div class="mb-3">
                                <label for="editAmountPaid" class="form-label"><i class="fas fa-money-bill-wave"></i> المبلغ المدفوع</label>
                                <input type="number" class="form-control" id="editAmountPaid" step="0.01" min="0" value="0">
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
                    <button type="button" class="btn btn-primary" onclick="updateInvoice()">حفظ التعديلات</button>
                </div>
            </div>
        </div>
    </div>

    <!-- نافذة إضافة زبون -->
    <div class="modal fade" id="addCustomerModal" tabindex="-1" aria-labelledby="addCustomerModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addCustomerModalLabel"><i class="fas fa-user-plus"></i> إضافة زبون</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="addCustomerForm">
                        <div class="mb-3">
                            <label for="customerName" class="form-label"><i class="fas fa-signature"></i> اسم الزبون (اختياري)</label>
                            <input type="text" class="form-control" id="customerName">
                        </div>
                        <div class="mb-3">
                            <label for="customerPhone" class="form-label"><i class="fas fa-mobile-alt"></i> رقم الهاتف (اختياري)</label>
                            <input type="tel" class="form-control" id="customerPhone">
                        </div>
                        <div class="mb-3">
                            <label for="customerAddress" class="form-label"><i class="fas fa-home"></i> العنوان (اختياري)</label>
                            <input type="text" class="form-control" id="customerAddress">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
                    <button type="button" class="btn btn-primary" onclick="addCustomer()">حفظ الزبون</button>
                </div>
            </div>
        </div>
    </div>

    <!-- نافذة تعديل زبون -->
    <div class="modal fade" id="editCustomerModal" tabindex="-1" aria-labelledby="editCustomerModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editCustomerModalLabel"><i class="fas fa-user-edit"></i> تعديل زبون</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="editCustomerForm">
                        <input type="hidden" id="editCustomerId">
                        <div class="mb-3">
                            <label for="editCustomerName" class="form-label"><i class="fas fa-signature"></i> اسم الزبون (اختياري)</label>
                            <input type="text" class="form-control" id="editCustomerName">
                        </div>
                        <div class="mb-3">
                            <label for="editCustomerPhone" class="form-label"><i class="fas fa-mobile-alt"></i> رقم الهاتف (اختياري)</label>
                            <input type="tel" class="form-control" id="editCustomerPhone">
                        </div>
                        <div class="mb-3">
                            <label for="editCustomerAddress" class="form-label"><i class="fas fa-home"></i> العنوان (اختياري)</label>
                            <input type="text" class="form-control" id="editCustomerAddress">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
                    <button type="button" class="btn btn-primary" onclick="updateCustomer()">حفظ التعديلات</button>
                </div>
            </div>
        </div>
    </div>

    <!-- نافذة كشف حساب زبون -->
    <div class="modal fade" id="customerStatementModal" tabindex="-1" aria-labelledby="customerStatementModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="customerStatementModalLabel"><i class="fas fa-file-invoice"></i> كشف حساب زبون</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="customerStatementForm">
                        <div class="mb-3">
                            <label for="statementCustomer" class="form-label"><i class="fas fa-user-check"></i> الزبون</label>
                            <select class="form-select" id="statementCustomer" required>
                                <option value="">اختر زبونًا</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="startDate" class="form-label"><i class="fas fa-calendar-day"></i> من تاريخ</label>
                            <input type="date" class="form-control" id="startDate" required>
                        </div>
                        <div class="mb-3">
                            <label for="endDate" class="form-label"><i class="fas fa-calendar-day"></i> إلى تاريخ</label>
                            <input type="date" class="form-control" id="endDate" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
                    <button type="button" class="btn btn-primary" onclick="generateCustomerStatement()">إنشاء الكشف</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let db;
        let html5QrCodeScanner; // For QR Code scanner instance

        // Helper function to format date as DD-MM-YYYY HH:MM
        function formatDateForDisplay(isoString) {
            if (!isoString) return 'N/A';
            const date = new Date(isoString);
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0'); // Months are 0-indexed
            const year = date.getFullYear();
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            return `${day}-${month}-${year} ${hours}:${minutes}`;
        }


        // إعداد IndexedDB
        function initDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open('InventoryDB', 2); 
                request.onupgradeneeded = (event) => {
                    db = event.target.result;
                    if (!db.objectStoreNames.contains('products')) {
                        db.createObjectStore('products', { keyPath: 'id' });
                    }
                    if (!db.objectStoreNames.contains('invoices')) {
                        const invoiceStore = db.createObjectStore('invoices', { keyPath: 'id' });
                        invoiceStore.createIndex('customerId', 'customerId', { unique: false });
                    }
                    if (!db.objectStoreNames.contains('customers')) {
                        const customerStore = db.createObjectStore('customers', { keyPath: 'id' });
                        customerStore.createIndex('phone', 'phone', { unique: false }); 
                    }
                };
                request.onsuccess = (event) => {
                    db = event.target.result;
                    resolve(db);
                };
                request.onerror = (event) => {
                    console.error("Database error: " + event.target.errorCode);
                    reject(event.target.error);
                };
            });
        }
        
        async function ensureDBInitialized() {
            if (!db) {
                try {
                    await initDB();
                } catch (error) {
                    console.error('Failed to initialize database:', error);
                    throw new Error('Failed to initialize database: ' + error.message);
                }
            }
            if (!db) { 
                throw new Error('Database not ready after initialization attempt.');
            }
        }

        async function generateUniqueId(storeName) {
            await ensureDBInitialized();
            let id;
            let isUnique = false;
            const existingIds = await getAllIds(storeName); 
            while (!isUnique) {
                id = Math.floor(10000 + Math.random() * 90000).toString();
                isUnique = !existingIds.includes(id);
            }
            return id;
        }

        function getAllIds(storeName) {
            return new Promise(async (resolve, reject) => {
                try {
                    await ensureDBInitialized();
                    const transaction = db.transaction([storeName], 'readonly');
                    const store = transaction.objectStore(storeName);
                    const request = store.getAllKeys(); 
                    request.onsuccess = () => {
                        resolve(request.result);
                    };
                    request.onerror = (event) => reject(event.target.error);
                } catch (error) {
                    reject(error);
                }
            });
        }

        function getAllProducts() {
            return new Promise(async (resolve, reject) => {
                try {
                    await ensureDBInitialized();
                    const transaction = db.transaction(['products'], 'readonly');
                    const store = transaction.objectStore('products');
                    const request = store.getAll();
                    request.onsuccess = () => resolve(request.result || []);
                    request.onerror = (event) => reject(event.target.error);
                } catch (error) {
                    reject(error);
                }
            });
        }
        
        function checkProductExists(productId) {
            return new Promise(async (resolve) => {
                try {
                    await ensureDBInitialized();
                    const transaction = db.transaction(['products'], 'readonly');
                    const store = transaction.objectStore('products');
                    const request = store.get(productId);
                    request.onsuccess = () => resolve(!!request.result); // True if product exists
                    request.onerror = () => resolve(false); // Error, assume not exists
                } catch (e) { resolve(false); }
            });
        }


        function getAllInvoices() {
            return new Promise(async (resolve, reject) => {
                try {
                    await ensureDBInitialized();
                    const transaction = db.transaction(['invoices'], 'readonly');
                    const store = transaction.objectStore('invoices');
                    const request = store.getAll();
                    request.onsuccess = () => resolve(request.result || []);
                    request.onerror = (event) => reject(event.target.error);
                } catch (error) {
                    reject(error);
                }
            });
        }

        function getAllCustomers() {
            return new Promise(async (resolve, reject) => {
                try {
                    await ensureDBInitialized();
                    const transaction = db.transaction(['customers'], 'readonly');
                    const store = transaction.objectStore('customers');
                    const request = store.getAll();
                    request.onsuccess = () => resolve(request.result || []);
                    request.onerror = (event) => reject(event.target.error);
                } catch (error) {
                    reject(error);
                }
            });
        }

        async function updateDashboard() {
            const invoices = await getAllInvoices();
            const paid = invoices.filter(i => parseFloat(i.amountPaid) >= parseFloat(i.totalAmount) && parseFloat(i.totalAmount) > 0).length;
            const partial = invoices.filter(i => parseFloat(i.amountPaid) > 0 && parseFloat(i.amountPaid) < parseFloat(i.totalAmount)).length;
            const unpaid = invoices.filter(i => parseFloat(i.amountPaid) === 0 && parseFloat(i.totalAmount) > 0).length;


            document.getElementById('paidInvoices').innerText = paid;
            document.getElementById('partialInvoices').innerText = partial;
            document.getElementById('unpaidInvoices').innerText = unpaid;
        }

        async function updateInvoicesTable() {
            const invoices = await getAllInvoices();
            const customers = await getAllCustomers();
            const tableBody = document.getElementById('invoicesTable');
            tableBody.innerHTML = '';

            invoices.sort((a, b) => new Date(b.date) - new Date(a.date)); 

            invoices.forEach((invoice, index) => {
                const customer = customers.find(c => c.id === invoice.customerId);
                const totalAmount = parseFloat(invoice.totalAmount);
                const amountPaid = parseFloat(invoice.amountPaid);
                let statusClass, statusText;

                if (totalAmount === 0 && amountPaid === 0) { // Consider invoices with 0 total and 0 paid (e.g. returns or empty)
                    statusClass = ''; // No specific class or a 'neutral' class
                    statusText = 'لا يوجد مبلغ';
                } else if (amountPaid >= totalAmount) {
                    statusClass = 'status-paid';
                    statusText = 'مدفوع';
                } else if (amountPaid > 0) {
                    statusClass = 'status-partial';
                    statusText = 'مدفوع جزئيًا';
                } else { // amountPaid is 0 and totalAmount > 0
                    statusClass = 'status-unpaid';
                    statusText = 'لم يتم الدفع';
                }


                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${invoice.id}</td>
                    <td>${customer?.name || 'زبون محذوف/غير معروف'}</td>
                    <td>${customer?.phone || '-'}</td>
                    <td>${totalAmount.toFixed(2)}</td>
                    <td class="${statusClass}">${statusText}</td>
                    <td>
                        <i class="fas fa-print action-btn print" onclick="printInvoice('${invoice.id}')" title="طباعة"></i>
                        <i class="fas fa-edit action-btn edit" onclick="editInvoice('${invoice.id}')" title="تعديل"></i>
                        <!-- Delete button removed from UI as requested -->
                    </td>
                `;
                tableBody.appendChild(row);
            });
            updateDashboard(); // Update dashboard after table is updated
            // filterTable(); // Call filterTable if you want to apply existing filters immediately after refresh
        }

        async function updateCustomersTable() {
            const customers = await getAllCustomers();
            const tableBody = document.getElementById('customersTable');
            tableBody.innerHTML = '';

            customers.forEach((customer, index) => {
                const row = document.createElement('tr');
                const displayName = customer.name || 'زبون بدون اسم';
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${displayName}</td>
                    <td>${customer.phone || '-'}</td>
                    <td>${customer.address || '-'}</td>
                    <td>
                        <i class="fas fa-edit action-btn edit" onclick="editCustomer('${customer.id}')" title="تعديل"></i>
                        <i class="fas fa-trash action-btn delete" onclick="deleteCustomer('${customer.id}')" title="حذف"></i>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }

        async function filterTable() {
            const searchInput = document.getElementById('searchInput').value.toLowerCase();
            const statusFilter = document.getElementById('statusFilter').value;
            const invoices = await getAllInvoices(); // Fetch fresh list
            const customers = await getAllCustomers(); // Fetch fresh list
            const tableBody = document.getElementById('invoicesTable');
            
            const filteredInvoices = invoices.filter(invoice => {
                const customer = customers.find(c => c.id === invoice.customerId);
                const customerName = customer?.name?.toLowerCase() || '';
                const matchesSearch = customerName.includes(searchInput) || invoice.id.includes(searchInput);
                
                if (!matchesSearch) return false;

                const totalAmount = parseFloat(invoice.totalAmount);
                const amountPaid = parseFloat(invoice.amountPaid);

                if (statusFilter === 'all') return true;
                if (statusFilter === 'paid') return amountPaid >= totalAmount && totalAmount > 0; // Ensure total > 0 for 'paid'
                if (statusFilter === 'partial') return amountPaid > 0 && amountPaid < totalAmount;
                if (statusFilter === 'unpaid') return amountPaid === 0 && totalAmount > 0; // Ensure total > 0 for 'unpaid'
                
                // This case should ideally not be reached if statusFilter has a valid value from the dropdown.
                // If it's reached, it means an unknown filter value, so include the item.
                return true; 
            });

            tableBody.innerHTML = ''; 
            filteredInvoices.sort((a, b) => new Date(b.date) - new Date(a.date)); // Re-sort filtered results

            filteredInvoices.forEach((invoice, index) => {
                const customer = customers.find(c => c.id === invoice.customerId);
                const totalAmount = parseFloat(invoice.totalAmount);
                const amountPaid = parseFloat(invoice.amountPaid);
                let statusClass, statusText;

                 if (totalAmount === 0 && amountPaid === 0) {
                    statusClass = ''; statusText = 'لا يوجد مبلغ';
                } else if (amountPaid >= totalAmount) {
                    statusClass = 'status-paid'; statusText = 'مدفوع';
                } else if (amountPaid > 0) {
                    statusClass = 'status-partial'; statusText = 'مدفوع جزئيًا';
                } else {
                    statusClass = 'status-unpaid'; statusText = 'لم يتم الدفع';
                }

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${invoice.id}</td>
                    <td>${customer?.name || 'زبون محذوف/غير معروف'}</td>
                    <td>${customer?.phone || '-'}</td>
                    <td>${totalAmount.toFixed(2)}</td>
                    <td class="${statusClass}">${statusText}</td>
                    <td>
                        <i class="fas fa-print action-btn print" onclick="printInvoice('${invoice.id}')" title="طباعة"></i>
                        <i class="fas fa-edit action-btn edit" onclick="editInvoice('${invoice.id}')" title="تعديل"></i>
                    </td>
                `;
                tableBody.appendChild(row);
            });
            // No need to call updateDashboard here as it's called in updateInvoicesTable which is called by other functions.
            // However, if filterTable is called independently (e.g., on search input), then dashboard might need update based on filtered view, or just reflect all invoices.
            // For simplicity, let dashboard always reflect all invoices. It's updated by main table update functions.
        }


        async function populateCustomerSelect(selectElementId) {
            const customers = await getAllCustomers();
            const select = document.getElementById(selectElementId);
            const currentValue = select.value; // Preserve current selection if possible
            select.innerHTML = '<option value="">اختر زبونًا...</option>'; 
            customers.forEach(customer => {
                const option = document.createElement('option');
                option.value = customer.id;
                option.textContent = customer.name || `زبون (${customer.phone || 'معرف: ' + customer.id.slice(0,5)})`;
                select.appendChild(option);
            });
            if (currentValue) { // Attempt to restore selection
                 select.value = currentValue;
            }
        }

        async function updateCustomerInfo(selectElementId, phoneElementId, addressElementId) {
            const customerId = document.getElementById(selectElementId).value;
            const phoneInput = document.getElementById(phoneElementId);
            const addressInput = document.getElementById(addressElementId);

            if (customerId) {
                const customers = await getAllCustomers(); // Fetch fresh customer data
                const customer = customers.find(c => c.id === customerId);
                phoneInput.value = customer?.phone || '';
                addressInput.value = customer?.address || '';
            } else {
                phoneInput.value = '';
                addressInput.value = '';
            }
        }
        
        async function setupProductSearch(searchElementId, suggestionsElementId, productsTableId, isEditModal = false) {
            const searchInput = document.getElementById(searchElementId);
            const suggestionsDiv = document.getElementById(suggestionsElementId);
            
            searchInput.addEventListener('input', async (e) => {
                const query = e.target.value.toLowerCase().trim();
                suggestionsDiv.innerHTML = ''; 
                if (query.length < 1) return; 

                const allProducts = await getAllProducts();
                const availableProducts = allProducts.filter(p => p.quantity > 0); 
                
                const filteredProducts = availableProducts.filter(p => 
                    p.name.toLowerCase().includes(query) || 
                    p.id.includes(query)
                ).slice(0, 10); 

                if (filteredProducts.length > 0) {
                    filteredProducts.forEach(product => {
                        const div = document.createElement('div');
                        div.className = 'list-group-item list-group-item-action';
                        
                        const salePriceFormatted = parseFloat(product.salePrice || 0).toFixed(2);
                        
                        // --- MODIFICATION FOR costPrice ---
                        let costPriceFormatted;
                        if (typeof product.costPrice === 'number') { // Handles 0 as a valid cost price
                            costPriceFormatted = parseFloat(product.costPrice).toFixed(2);
                        } else if (product.costPrice && !isNaN(parseFloat(product.costPrice))) { // Handles string numbers
                            costPriceFormatted = parseFloat(product.costPrice).toFixed(2);
                        } else {
                            costPriceFormatted = 'غ/م'; // Not available or not a valid number
                        }
                        // --- END MODIFICATION ---
                        
                        div.innerHTML = `
                            <strong>${product.name}</strong> (المعرف: ${product.id}) <br>
                            <small>
                                سعر البيع: ${salePriceFormatted} | 
                                سعر الشراء: ${costPriceFormatted} | 
                                الكمية المتوفرة: ${product.quantity}
                            </small>
                        `;
                        div.onclick = () => {
                            addProductToInvoice(product, productsTableId);
                            searchInput.value = ''; 
                            suggestionsDiv.innerHTML = ''; 
                        };
                        suggestionsDiv.appendChild(div);
                    });
                } else {
                    suggestionsDiv.innerHTML = '<div class="list-group-item">لا توجد منتجات مطابقة أو غير متوفرة.</div>';
                }
            });
        }


        function addProductToInvoice(product, productsTableId) {
            const tableBody = document.getElementById(productsTableId);
            const existingRow = Array.from(tableBody.rows).find(row => row.dataset.productId === product.id);

            if (existingRow) {
                const quantityInput = existingRow.querySelector('.quantity');
                const currentQuantity = parseInt(quantityInput.value);
                if (currentQuantity < product.quantity) { 
                    quantityInput.value = currentQuantity + 1;
                } else {
                    Swal.fire('تنبيه', `الكمية المطلوبة للمنتج "${product.name}" تتجاوز المخزون المتاح (${product.quantity}).`, 'warning');
                    return;
                }
            } else {
                if (product.quantity < 1) { 
                     Swal.fire('تنبيه', `المنتج "${product.name}" غير متوفر في المخزون.`, 'warning');
                    return;
                }
                const row = tableBody.insertRow();
                row.dataset.productId = product.id; 
                
                row.innerHTML = `
                    <td>${product.name}</td>
                    <td><input type="number" class="form-control form-control-sm sale-price" value="${parseFloat(product.salePrice || 0).toFixed(2)}" step="0.01" min="0.01"></td>
                    <td><input type="number" class="form-control form-control-sm quantity" value="1" min="1" max="${product.quantity}"></td>
                    <td><input type="text" class="form-control form-control-sm note" placeholder="ملاحظة (اختياري)"></td>
                    <td class="total">${parseFloat(product.salePrice || 0).toFixed(2)}</td>
                    <td><button type="button" class="btn btn-sm btn-danger" onclick="removeProductFromInvoice(this.closest('tr'), '${productsTableId}')"><i class="fas fa-trash-alt"></i></button></td>
                `;
                row.querySelector('.sale-price').addEventListener('input', () => updateInvoiceTotals(productsTableId));
                row.querySelector('.quantity').addEventListener('input', (e) => {
                    const requestedQuantity = parseInt(e.target.value);
                    const maxQuantityForThisProduct = parseInt(e.target.max); // Use the max attribute of the input

                    if (requestedQuantity > maxQuantityForThisProduct) {
                        e.target.value = maxQuantityForThisProduct; 
                        Swal.fire('تنبيه', `الكمية المطلوبة للمنتج "${product.name}" تتجاوز المخزون المتاح (${maxQuantityForThisProduct}). تم التعديل للحد الأقصى.`, 'warning');
                    }
                    updateInvoiceTotals(productsTableId);
                });
            }
            updateInvoiceTotals(productsTableId);
        }


        function removeProductFromInvoice(rowElement, productsTableId) {
            rowElement.remove();
            updateInvoiceTotals(productsTableId);
        }

        function updateInvoiceTotals(productsTableId) {
            const tableBody = document.getElementById(productsTableId);
            const rows = tableBody.querySelectorAll('tr');
            let totalAmount = 0;
            let totalItemsCount = 0; 

            rows.forEach(row => {
                const salePriceInput = row.querySelector('.sale-price');
                const quantityInput = row.querySelector('.quantity');
                
                const salePrice = parseFloat(salePriceInput.value) || 0;
                const quantity = parseInt(quantityInput.value) || 0;
                
                const itemTotal = salePrice * quantity;
                row.querySelector('.total').textContent = itemTotal.toFixed(2);
                totalAmount += itemTotal;
                totalItemsCount++; 
            });

            const isEditModal = productsTableId === 'editInvoiceProducts';
            document.getElementById(isEditModal ? 'editTotalItems' : 'totalItems').textContent = totalItemsCount; 
            document.getElementById(isEditModal ? 'editTotalAmount' : 'totalAmount').textContent = totalAmount.toFixed(2);
        }

        async function addInvoice() {
            const customerId = document.getElementById('invoiceCustomer').value;
            const amountPaidValue = document.getElementById('amountPaid').value;
            const productsTable = document.getElementById('invoiceProducts');
            const rows = productsTable.querySelectorAll('tr');

            if (!customerId) {
                Swal.fire('خطأ', 'الرجاء اختيار زبون!', 'error'); return;
            }
            if (rows.length === 0) {
                Swal.fire('خطأ', 'الرجاء إضافة منتج واحد على الأقل للفاتورة!', 'error'); return;
            }
            const amountPaid = parseFloat(amountPaidValue);
            if (isNaN(amountPaid) || amountPaid < 0) {
                 Swal.fire('خطأ', 'المبلغ المدفوع غير صحيح!', 'error'); return;
            }

            const productsInInvoice = [];
            let totalAmount = 0;
            let stockUpdatePromises = [];

            for (const row of rows) {
                const productId = row.dataset.productId;
                const name = row.cells[0].textContent;
                const salePrice = parseFloat(row.querySelector('.sale-price').value);
                const quantitySold = parseInt(row.querySelector('.quantity').value);
                const note = row.querySelector('.note').value;
                const itemTotal = salePrice * quantitySold;

                if (isNaN(salePrice) || salePrice <=0 || isNaN(quantitySold) || quantitySold <=0) {
                    Swal.fire('خطأ', `بيانات غير صالحة للمنتج "${name}". تأكد من السعر والكمية.`, 'error'); return;
                }

                productsInInvoice.push({ productId, name, salePrice, quantity: quantitySold, note, total: itemTotal });
                totalAmount += itemTotal;
                stockUpdatePromises.push(updateProductStock(productId, quantitySold));
            }
             if (amountPaid > totalAmount) {
                Swal.fire('خطأ', 'المبلغ المدفوع لا يمكن أن يكون أكبر من المجموع الكلي للفاتورة!', 'error'); return;
            }

            try {
                await Promise.all(stockUpdatePromises); 
            } catch (error) {
                Swal.fire('خطأ في تحديث المخزون', error.message, 'error');
                return;
            }

            const id = await generateUniqueId('invoices');
            const invoice = {
                id,
                customerId,
                products: productsInInvoice,
                totalAmount: totalAmount.toFixed(2),
                amountPaid: amountPaid.toFixed(2),
                date: new Date().toISOString()
            };

            const transaction = db.transaction(['invoices'], 'readwrite');
            const store = transaction.objectStore('invoices');
            const request = store.add(invoice);

            request.onsuccess = async () => {
                await updateInvoicesTable(); // This also updates dashboard
                bootstrap.Modal.getInstance(document.getElementById('addInvoiceModal')).hide();
                document.getElementById('addInvoiceForm').reset();
                document.getElementById('invoiceProducts').innerHTML = ''; 
                document.getElementById('totalItems').textContent = '0';
                document.getElementById('totalAmount').textContent = '0.00';
                document.getElementById('customerPhoneDisplay').value = '';
                document.getElementById('customerAddressDisplay').value = '';
                document.getElementById('invoiceDate').textContent = formatDateForDisplay(new Date().toISOString()); // Reset date
                await populateCustomerSelect('invoiceCustomer'); 
                Swal.fire('نجاح', 'تم إضافة الفاتورة وتحديث المخزون بنجاح!', 'success');
            };
            request.onerror = (e) => {
                console.error("Error adding invoice:", e.target.error);
                Swal.fire('خطأ', 'فشل في إضافة الفاتورة!', 'error');
            };
        }
        
        function updateProductStock(productId, quantitySold) {
            return new Promise(async (resolve, reject) => {
                try {
                    await ensureDBInitialized();
                    const transaction = db.transaction(['products'], 'readwrite');
                    const store = transaction.objectStore('products');
                    const getRequest = store.get(productId);

                    getRequest.onsuccess = () => {
                        const product = getRequest.result;
                        if (!product) {
                            reject(new Error(`المنتج بالمعرف ${productId} غير موجود.`));
                            return;
                        }
                        if (product.quantity < quantitySold) {
                            reject(new Error(`الكمية المطلوبة للمنتج "${product.name}" (${quantitySold}) تتجاوز المخزون المتاح (${product.quantity}).`));
                            return;
                        }
                        product.quantity -= quantitySold;
                        const updateRequest = store.put(product);
                        updateRequest.onsuccess = () => resolve();
                        updateRequest.onerror = (e) => reject(new Error(`فشل تحديث مخزون المنتج ${product.name}: ${e.target.error}`));
                    };
                    getRequest.onerror = (e) => reject(new Error(`فشل جلب المنتج ${productId} لتحديث المخزون: ${e.target.error}`));
                } catch (dbError) {
                    reject(dbError);
                }
            });
        }


        async function editInvoice(invoiceId) {
            try {
                await ensureDBInitialized();
                const transaction = db.transaction(['invoices', 'customers', 'products'], 'readonly'); 
                const invoiceStore = transaction.objectStore('invoices');
                const invoiceRequest = invoiceStore.get(invoiceId);

                invoiceRequest.onsuccess = async () => {
                    const invoice = invoiceRequest.result;
                    if (!invoice) {
                        Swal.fire('خطأ', 'الفاتورة غير موجودة!', 'error');
                        return;
                    }
                    
                    document.getElementById('editInvoiceModal').dataset.originalProducts = JSON.stringify(invoice.products);
                    document.getElementById('editInvoiceId').value = invoice.id;
                    
                    const customerSelect = document.getElementById('editInvoiceCustomer');
                    await populateCustomerSelect('editInvoiceCustomer'); 
                    customerSelect.value = invoice.customerId;
                    await updateCustomerInfo('editInvoiceCustomer', 'editCustomerPhoneDisplay', 'editCustomerAddressDisplay');

                    document.getElementById('editInvoiceDate').textContent = formatDateForDisplay(invoice.date);
                    document.getElementById('editAmountPaid').value = parseFloat(invoice.amountPaid).toFixed(2);

                    const tableBody = document.getElementById('editInvoiceProducts');
                    tableBody.innerHTML = ''; 

                    const allProductsFromDB = await getAllProducts(); 

                    invoice.products.forEach(pInInvoice => {
                        const productDetailsFromDB = allProductsFromDB.find(pDB => pDB.id === pInInvoice.productId);
                        const currentStockInDB = productDetailsFromDB ? productDetailsFromDB.quantity : 0;
                        const maxQuantityForInput = currentStockInDB + pInInvoice.quantity;


                        const row = tableBody.insertRow();
                        row.dataset.productId = pInInvoice.productId;
                        row.dataset.originalQuantityInInvoice = pInInvoice.quantity; 
                        row.dataset.maxEditableQuantity = maxQuantityForInput;


                        row.innerHTML = `
                            <td>${pInInvoice.name}</td>
                            <td><input type="number" class="form-control form-control-sm sale-price" value="${parseFloat(pInInvoice.salePrice).toFixed(2)}" step="0.01" min="0.01"></td>
                            <td><input type="number" class="form-control form-control-sm quantity" value="${pInInvoice.quantity}" min="1" max="${maxQuantityForInput}"></td>
                            <td><input type="text" class="form-control form-control-sm note" value="${pInInvoice.note || ''}" placeholder="ملاحظة"></td>
                            <td class="total">${parseFloat(pInInvoice.total).toFixed(2)}</td>
                            <td><button type="button" class="btn btn-sm btn-danger" onclick="removeProductFromInvoice(this.closest('tr'), 'editInvoiceProducts')"><i class="fas fa-trash-alt"></i></button></td>
                        `;
                        row.querySelector('.sale-price').addEventListener('input', () => updateInvoiceTotals('editInvoiceProducts'));
                        row.querySelector('.quantity').addEventListener('input', (e) => {
                             const requestedQuantity = parseInt(e.target.value);
                             const maxAllowed = parseInt(e.target.max); 
                             if (requestedQuantity > maxAllowed) {
                                e.target.value = maxAllowed;
                                Swal.fire('تنبيه', `الكمية المطلوبة للمنتج "${pInInvoice.name}" تتجاوز المخزون المتاح. تم التعديل للحد الأقصى (${maxAllowed}).`, 'warning');
                            }
                            updateInvoiceTotals('editInvoiceProducts');
                        });
                    });

                    updateInvoiceTotals('editInvoiceProducts');
                    new bootstrap.Modal(document.getElementById('editInvoiceModal')).show();
                };
                invoiceRequest.onerror = (e) => Swal.fire('خطأ', `فشل في جلب الفاتورة: ${e.target.error}`, 'error');
            } catch (dbError) {
                 Swal.fire('خطأ قاعدة البيانات', `فشل: ${dbError.message}`, 'error');
            }
        }


        async function updateInvoice() {
            const id = document.getElementById('editInvoiceId').value;
            const customerId = document.getElementById('editInvoiceCustomer').value;
            const amountPaidValue = document.getElementById('editAmountPaid').value;
            const productsTable = document.getElementById('editInvoiceProducts');
            const rows = productsTable.querySelectorAll('tr');
            
            const originalProductsJSON = document.getElementById('editInvoiceModal').dataset.originalProducts;
            const originalProductsInInvoice = JSON.parse(originalProductsJSON || "[]"); 


            if (!customerId) { Swal.fire('خطأ', 'الرجاء اختيار زبون!', 'error'); return; }
            if (rows.length === 0) { Swal.fire('خطأ', 'الفاتورة يجب أن تحتوي على منتج واحد على الأقل!', 'error'); return; }
            const amountPaid = parseFloat(amountPaidValue);
             if (isNaN(amountPaid) || amountPaid < 0) { Swal.fire('خطأ', 'المبلغ المدفوع غير صحيح!', 'error'); return; }


            const updatedProductsInInvoice = [];
            let newTotalAmount = 0;
            let stockAdjustmentPromises = []; 

            for (const row of rows) {
                const productId = row.dataset.productId;
                const name = row.cells[0].textContent;
                const salePrice = parseFloat(row.querySelector('.sale-price').value);
                const newQuantitySold = parseInt(row.querySelector('.quantity').value);
                const note = row.querySelector('.note').value;
                const itemTotal = salePrice * newQuantitySold;

                if (isNaN(salePrice) || salePrice <=0 || isNaN(newQuantitySold) || newQuantitySold <=0) {
                    Swal.fire('خطأ', `بيانات غير صالحة للمنتج "${name}". تأكد من السعر والكمية.`, 'error'); return;
                }

                updatedProductsInInvoice.push({ productId, name, salePrice, quantity: newQuantitySold, note, total: itemTotal });
                newTotalAmount += itemTotal;

                const originalProductInfo = originalProductsInInvoice.find(p => p.productId === productId);
                const originalQuantitySoldInThisInvoice = originalProductInfo ? originalProductInfo.quantity : 0;
                
                const quantityChangeForStock = originalQuantitySoldInThisInvoice - newQuantitySold; 
                
                if (quantityChangeForStock !== 0) {
                    const productExists = await checkProductExists(productId);
                    if (productExists) {
                         stockAdjustmentPromises.push(adjustProductStock(productId, quantityChangeForStock));
                    } else {
                        console.warn(`Product ${productId} not found in DB. Skipping stock adjustment for this item.`);
                    }
                }
            }
            
            originalProductsInInvoice.forEach(async origP => {
                if (!updatedProductsInInvoice.some(updP => updP.productId === origP.productId)) {
                    const productExists = await checkProductExists(origP.productId);
                     if (productExists) {
                        stockAdjustmentPromises.push(adjustProductStock(origP.productId, origP.quantity)); 
                     } else {
                        console.warn(`Product ${origP.productId} (removed from invoice) not found in DB. Skipping stock adjustment for this item.`);
                     }
                }
            });


            if (amountPaid > newTotalAmount) {
                Swal.fire('خطأ', 'المبلغ المدفوع لا يمكن أن يكون أكبر من المجموع الكلي للفاتورة!', 'error'); return;
            }

            try {
                if (stockAdjustmentPromises.length > 0) {
                    await Promise.all(stockAdjustmentPromises);
                }
            } catch (error) {
                Swal.fire('خطأ في تحديث المخزون', error.message, 'error');
                return; 
            }
            
            let invoiceDateStr = document.getElementById('editInvoiceDate').textContent;
            let invoiceDateISO;
            if (invoiceDateStr && invoiceDateStr !== 'N/A') {
                const parts = invoiceDateStr.match(/(\d{2})-(\d{2})-(\d{4}) (\d{2}):(\d{2})/);
                if (parts) {
                    // parts[1]=day, parts[2]=month, parts[3]=year, parts[4]=hour, parts[5]=minute
                    invoiceDateISO = new Date(Date.UTC(parts[3], parts[2] - 1, parts[1], parts[4], parts[5])).toISOString();
                } else {
                    invoiceDateISO = new Date().toISOString(); 
                }
            } else {
                 invoiceDateISO = new Date().toISOString(); 
            }


            const invoice = {
                id,
                customerId,
                products: updatedProductsInInvoice,
                totalAmount: newTotalAmount.toFixed(2),
                amountPaid: amountPaid.toFixed(2),
                date: invoiceDateISO 
            };

            const transaction = db.transaction(['invoices'], 'readwrite');
            const store = transaction.objectStore('invoices');
            const request = store.put(invoice);

            request.onsuccess = async () => {
                await updateInvoicesTable(); // This also updates dashboard
                bootstrap.Modal.getInstance(document.getElementById('editInvoiceModal')).hide();
                Swal.fire('نجاح', 'تم تعديل الفاتورة وتحديث المخزون بنجاح!', 'success');
            };
            request.onerror = (e) => {
                 console.error("Error updating invoice:", e.target.error);
                 Swal.fire('خطأ', 'فشل في تعديل الفاتورة!', 'error');
            };
        }

        function adjustProductStock(productId, quantityChange) {
            return new Promise(async (resolve, reject) => {
                try {
                    await ensureDBInitialized();
                    const transaction = db.transaction(['products'], 'readwrite');
                    const store = transaction.objectStore('products');
                    const getRequest = store.get(productId);

                    getRequest.onsuccess = () => {
                        const product = getRequest.result;
                        if (!product) {
                            // It's possible a product was deleted from inventory system externally
                            // while it was still in an invoice. Log this instead of hard failing the whole invoice update.
                            console.warn(`المنتج بالمعرف ${productId} غير موجود لتعديل المخزون. سيتم تخطي هذا المنتج.`);
                            resolve(); // Resolve to not block other stock adjustments
                            return;
                        }
                        
                        const newStock = product.quantity + quantityChange;
                        if (newStock < 0) { 
                             reject(new Error(`لا يمكن أن يكون مخزون المنتج "${product.name}" سالبًا. التغيير المطلوب للمخزون: ${quantityChange}, المخزون الحالي: ${product.quantity}.`));
                             return;
                        }
                        product.quantity = newStock;

                        const updateRequest = store.put(product);
                        updateRequest.onsuccess = () => resolve();
                        updateRequest.onerror = (e) => reject(new Error(`فشل تعديل مخزون المنتج ${product.name}: ${e.target.error}`));
                    };
                    getRequest.onerror = (e) => reject(new Error(`فشل جلب المنتج ${productId} لتعديل المخزون: ${e.target.error}`));
                } catch (dbError) {
                    reject(dbError);
                }
            });
        }

        async function deleteInvoice(invoiceId) { // This function is not called from UI but kept for potential use
            const result = await Swal.fire({
                title: 'تأكيد الحذف',
                text: 'هل أنت متأكد من حذف هذه الفاتورة؟ سيتم إرجاع الكميات المباعة إلى المخزون.',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'نعم، احذف',
                cancelButtonText: 'إلغاء',
                confirmButtonColor: '#dc3545',
                cancelButtonColor: '#6c757d'
            });

            if (result.isConfirmed) {
                try {
                    await ensureDBInitialized();
                    const readTx = db.transaction(['invoices'], 'readonly'); 
                    const invoiceStoreRead = readTx.objectStore('invoices');
                    const getInvoiceRequest = invoiceStoreRead.get(invoiceId);

                    getInvoiceRequest.onsuccess = async () => {
                        const invoiceToDelete = getInvoiceRequest.result;
                        if (!invoiceToDelete) {
                            Swal.fire('خطأ', 'الفاتورة غير موجودة.', 'error');
                            return;
                        }

                        let stockReturnPromises = [];
                        for (const p of invoiceToDelete.products) {
                            const productExists = await checkProductExists(p.productId);
                            if (productExists) {
                                stockReturnPromises.push(adjustProductStock(p.productId, p.quantity));
                            } else {
                                console.warn(`Product ${p.productId} from deleted invoice not found. Stock not returned for this item.`);
                            }
                        }
                        
                        try {
                            if (stockReturnPromises.length > 0) {
                                await Promise.all(stockReturnPromises); 
                            }

                            const writeTxDelete = db.transaction(['invoices'], 'readwrite');
                            const invoiceStoreWrite = writeTxDelete.objectStore('invoices');
                            const deleteRequest = invoiceStoreWrite.delete(invoiceId);

                            deleteRequest.onsuccess = async () => {
                                await updateInvoicesTable(); // This also updates dashboard
                                Swal.fire('نجاح', 'تم حذف الفاتورة وإرجاع المنتجات للمخزون بنجاح!', 'success');
                            };
                            deleteRequest.onerror = (e) => {
                                console.error("Error deleting invoice:", e.target.error);
                                Swal.fire('خطأ', 'فشل في حذف الفاتورة! (قد يكون المخزون أُرجع).', 'error');
                            };

                        } catch (stockError) {
                            Swal.fire('خطأ في إرجاع المخزون', stockError.message, 'error');
                        }
                    };
                    getInvoiceRequest.onerror = (e) => Swal.fire('خطأ', `فشل في جلب الفاتورة للحذف: ${e.target.error}`, 'error');

                } catch (dbError) {
                     Swal.fire('خطأ قاعدة البيانات', `فشل: ${dbError.message}`, 'error');
                }
            }
        }


        async function addCustomer() {
            const name = document.getElementById('customerName').value.trim();
            const phone = document.getElementById('customerPhone').value.trim();
            const address = document.getElementById('customerAddress').value.trim();
            
            if (!name && !phone && !address) {
                 Swal.fire('خطأ', 'يجب إدخال معلومة واحدة على الأقل للزبون (الاسم أو الهاتف أو العنوان).', 'error');
                 return;
            }

            if (phone) { 
                const customers = await getAllCustomers();
                if (customers.some(c => c.phone === phone && phone !== '')) { // Ensure phone isn't empty string
                    Swal.fire('خطأ', 'رقم الهاتف هذا مُسجل لزبون آخر!', 'error');
                    return;
                }
            }


            const id = await generateUniqueId('customers');
            const customer = { 
                id, 
                name: name || null, // Store null if empty for consistency
                phone: phone || null, 
                address: address || null 
            };


            const transaction = db.transaction(['customers'], 'readwrite');
            const store = transaction.objectStore('customers');
            const request = store.add(customer);

            request.onsuccess = async () => {
                await updateCustomersTable();
                await populateCustomerSelect('invoiceCustomer');
                await populateCustomerSelect('editInvoiceCustomer');
                await populateCustomerSelect('statementCustomer');
                bootstrap.Modal.getInstance(document.getElementById('addCustomerModal')).hide();
                document.getElementById('addCustomerForm').reset();
                Swal.fire('نجاح', 'تم إضافة الزبون بنجاح!', 'success');
            };
            request.onerror = (e) => Swal.fire('خطأ', `فشل في إضافة الزبون: ${e.target.error}`, 'error');
        }

        async function editCustomer(customerId) {
            try {
                await ensureDBInitialized();
                const transaction = db.transaction(['customers'], 'readonly');
                const store = transaction.objectStore('customers');
                const request = store.get(customerId);

                request.onsuccess = () => {
                    const customer = request.result;
                    if (!customer) {
                        Swal.fire('خطأ', 'الزبون غير موجود!', 'error');
                        return;
                    }
                    document.getElementById('editCustomerId').value = customer.id;
                    document.getElementById('editCustomerName').value = customer.name || '';
                    document.getElementById('editCustomerPhone').value = customer.phone || '';
                    document.getElementById('editCustomerAddress').value = customer.address || '';
                    new bootstrap.Modal(document.getElementById('editCustomerModal')).show();
                };
                request.onerror = (e) => Swal.fire('خطأ', `فشل في جلب بيانات الزبون: ${e.target.error}`, 'error');
            } catch (dbError) {
                 Swal.fire('خطأ قاعدة البيانات', `فشل: ${dbError.message}`, 'error');
            }
        }

        async function updateCustomer() {
            const id = document.getElementById('editCustomerId').value;
            const name = document.getElementById('editCustomerName').value.trim();
            const phone = document.getElementById('editCustomerPhone').value.trim();
            const address = document.getElementById('editCustomerAddress').value.trim();

             if (!name && !phone && !address) {
                 Swal.fire('خطأ', 'يجب إدخال معلومة واحدة على الأقل للزبون.', 'error');
                 return;
            }

            if (phone) { 
                const customers = await getAllCustomers();
                if (customers.some(c => c.id !== id && c.phone === phone && phone !== '')) { 
                    Swal.fire('خطأ', 'رقم الهاتف هذا مُسجل لزبون آخر!', 'error');
                    return;
                }
            }

            const customer = { 
                id, 
                name: name || null, 
                phone: phone || null, 
                address: address || null 
            };
            const transaction = db.transaction(['customers'], 'readwrite');
            const store = transaction.objectStore('customers');
            const request = store.put(customer);

            request.onsuccess = async () => {
                await updateCustomersTable();
                await updateInvoicesTable(); // Refresh invoices in case customer name changed
                await populateCustomerSelect('invoiceCustomer');
                await populateCustomerSelect('editInvoiceCustomer');
                await populateCustomerSelect('statementCustomer');
                bootstrap.Modal.getInstance(document.getElementById('editCustomerModal')).hide();
                Swal.fire('نجاح', 'تم تعديل بيانات الزبون بنجاح!', 'success');
            };
            request.onerror = (e) => Swal.fire('خطأ', `فشل في تعديل بيانات الزبون: ${e.target.error}`, 'error');
        }

        async function deleteCustomer(customerId) {
            const invoices = await getAllInvoices();
            if (invoices.some(i => i.customerId === customerId)) {
                Swal.fire('لا يمكن الحذف', 'لا يمكن حذف هذا الزبون لأنه مرتبط بفواتير حالية. يرجى تعديل الفواتير المرتبطة به لزبون آخر أو حذفها (إذا كانت هذه الإمكانية متاحة).', 'error');
                return;
            }


            const result = await Swal.fire({
                title: 'تأكيد الحذف',
                text: 'هل أنت متأكد من حذف هذا الزبون؟ لا يمكن التراجع عن هذا الإجراء.',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'نعم، احذف',
                cancelButtonText: 'إلغاء',
                confirmButtonColor: '#dc3545'
            });

            if (result.isConfirmed) {
                const transaction = db.transaction(['customers'], 'readwrite');
                const store = transaction.objectStore('customers');
                const request = store.delete(customerId);

                request.onsuccess = async () => {
                    await updateCustomersTable();
                    await populateCustomerSelect('invoiceCustomer');
                    await populateCustomerSelect('editInvoiceCustomer');
                    await populateCustomerSelect('statementCustomer');
                    Swal.fire('نجاح', 'تم حذف الزبون بنجاح!', 'success');
                };
                request.onerror = (e) => Swal.fire('خطأ', `فشل في حذف الزبون: ${e.target.error}`, 'error');
            }
        }
        
        async function printInvoice(invoiceId) {
            try {
                await ensureDBInitialized();
                const transaction = db.transaction(['invoices', 'customers'], 'readonly');
                const invoiceStore = transaction.objectStore('invoices');
                const invoiceRequest = invoiceStore.get(invoiceId);

                invoiceRequest.onsuccess = async () => {
                    const invoice = invoiceRequest.result;
                    if (!invoice) { Swal.fire('خطأ', 'الفاتورة غير موجودة.', 'error'); return; }

                    const customers = await getAllCustomers(); 
                    const customer = customers.find(c => c.id === invoice.customerId);
                    
                    const printWindow = window.open('', '_blank', 'height=800,width=600');
                    if (!printWindow) {
                         Swal.fire('خطأ', 'فشل فتح نافذة الطباعة. يرجى التأكد من تعطيل مانع النوافذ المنبثقة.', 'error'); return;
                    }
                    printWindow.document.write(`
                        <!DOCTYPE html>
                        <html lang="ar" dir="rtl">
                        <head>
                            <meta charset="UTF-8">
                            <title>فاتورة رقم: ${invoice.id}</title>
                            <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
                            <style>
                                @page { size: A5 landscape; margin: 5mm; }
                                body { font-family: 'Cairo', sans-serif; direction: rtl; margin: 5mm; font-size: 10pt; }
                                .container { width: 100%; margin: 0 auto; }
                                .header-print { text-align: center; margin-bottom: 10px; border-bottom: 1px solid #ccc; padding-bottom: 5px;}
                                .header-print img { max-height: 40px; margin-bottom: 3px; }
                                .header-print h1 { font-size: 1.1rem; color: #3F2A56; margin:0; }
                                .invoice-info-grid { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px;}
                                .invoice-details-text { flex-basis: 70%;} 
                                .invoice-details, .customer-details { font-size: 0.85rem;}
                                .invoice-details p, .customer-details p { margin: 2px 0; }
                                .qr-code-container { 
                                    flex-basis: auto; /* Adjust to content */
                                    min-width: 75px; 
                                    text-align: center; /* Center the QR code if div is wider */
                                    padding-left: 5px; 
                                } 
                                #invoiceQrCodeElement { /* The div where QR will be generated */
                                    display: inline-block; /* Helps with sizing and centering */
                                }
                                #invoiceQrCodeElement canvas,
                                #invoiceQrCodeElement img {
                                    border: 1px solid #eee; /* Add border to the QR itself */
                                }
                                .products-table { width: 100%; border-collapse: collapse; margin-bottom: 8px; }
                                .products-table th, .products-table td { padding: 4px; border: 1px solid #ccc; text-align: center; font-size: 0.8rem;}
                                .products-table th { background-color: #f2f2f2; color: #333; font-weight:600; }
                                .totals-section { margin-top: 10px; padding-top: 8px; border-top: 1px solid #ccc; text-align:left; font-size: 0.85rem;}
                                .totals-section p { margin: 3px 0; font-weight: 600; }
                                .footer-print { text-align: center; font-size: 0.75rem; margin-top: 15px; color: #777; }
                                @media print {
                                    body { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
                                }
                            </style>
                        </head>
                        <body>
                            <div class="container">
                                <div class="header-print">
                                    <img src="logo.png" alt="شعار" onerror="this.style.display='none';">
                                    <h1>طيبة المدينة تلكوم</h1>
                                    <!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>بيع المنتجات</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!-- QR Code Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode@2.0.9/dist/html5-qrcode.min.js"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Cairo', sans-serif;
            background: linear-gradient(135deg, #f0f2f5, #d9e2ec);
            color: #333;
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .home-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: linear-gradient(90deg, #3F2A56, #5a3f73);
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            text-decoration: none;
            font-size: 1rem;
            font-weight: 600;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            transition: transform 0.2s ease, background 0.3s ease, box-shadow 0.3s ease;
            position: absolute;
            top: 20px;
            left: 20px;
        }
        .home-btn:hover {
            background: linear-gradient(90deg, #5a3f73, #3F2A56);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
        }
        .header {
            background: linear-gradient(135deg, #3F2A56, #5a3f73);
            color: white;
            padding: 40px 20px;
            border-radius: 25px;
            text-align: center;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
            margin-bottom: 30px;
            position: relative;
            z-index: 1;
            border: 2px solid rgba(255, 255, 255, 0.1);
        }
        .header img {
            height: 90px;
            margin-bottom: 15px;
            filter: drop-shadow(0 3px 6px rgba(0, 0, 0, 0.3));
        }
        .header h2 {
            font-size: 2.2rem;
            margin-bottom: 10px;
            font-weight: 700;
        }
        .header h4 {
            font-size: 1.4rem;
            opacity: 0.9;
            font-weight: 400;
        }
        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        .card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: #3F2A56;
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            text-align: center;
            transition: transform 0.3s ease;
        }
        .card:hover {
            transform: translateY(-10px);
        }
        .card i {
            font-size: 2.8rem;
            margin-bottom: 15px;
            color: #3F2A56;
        }
        .card h5 {
            font-size: 1.3rem;
            margin-bottom: 10px;
            font-weight: 600;
        }
        .card h3 {
            font-size: 1.8rem;
            font-weight: 700;
        }
        .section {
            background: white;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
            padding: 20px;
            margin: 20px 0;
        }
        .section h3 {
            font-size: 1.7rem;
            font-weight: 700;
            color: #3F2A56;
            margin-bottom: 15px;
            text-align: center;
        }
        .table-container {
            overflow-x: auto;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            padding: 12px;
            text-align: center;
            border-bottom: 1px solid #e0e0e0;
        }
        th {
            background: linear-gradient(90deg, #3F2A56, #5a3f73);
            color: white;
            font-weight: 700;
        }
        td {
            color: #3F2A56;
        }
        tr:hover {
            background-color: #f7f9fc;
        }
        .actions {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin: 25px 0;
            justify-content: center;
        }
        .btn {
            background: linear-gradient(90deg, #3F2A56, #5a3f73);
            color: white;
            padding: 12px 24px;
            border-radius: 30px;
            border: none;
            font-size: 1rem;
            cursor: pointer;
            transition: transform 0.2s ease, background 0.3s ease, box-shadow 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .btn:hover {
            background: linear-gradient(90deg, #5a3f73, #3F2A56);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.2);
        }
        .search-container {
            margin-bottom: 20px;
            display: flex;
            justify-content: center;
            align-items: flex-end; /* Align items to bottom for button */
            gap: 15px;
            flex-wrap: wrap;
        }
        .filter-group {
            display: flex;
            flex-direction: column;
            max-width: 200px;
        }
        .filter-group label {
            font-size: 0.9rem;
            font-weight: 600;
            color: #3F2A56;
            margin-bottom: 5px;
        }
        .filter-group input, .filter-group select {
            padding: 12px;
            border-radius: 30px;
            border: none;
            background: rgba(255, 255, 255, 0.1);
            color: #3F2A56;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        .filter-group input:focus, .filter-group select:focus {
            outline: none;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2);
        }
        #scanQrBtn {
            padding: 10px 15px; /* Adjust padding */
            height: 46px; /* Match input height */
            border-radius: 30px;
        }
         #qr-reader-container {
            margin-top: 10px;
            border: 1px solid #ccc;
            border-radius: 10px;
            padding:10px;
            background-color: #f9f9f9;
        }
        #qr-reader {
            width: 100%;
            max-width: 400px; /* Adjust as needed */
            margin: 0 auto;
        }

        .action-btn {
            cursor: pointer;
            margin: 0 6px;
            font-size: 1.3rem;
            transition: color 0.3s ease;
        }
        .action-btn.edit:hover { color: #007bff; }
        /* .action-btn.delete:hover { color: #dc3545; } */ /* Delete button removed from UI */
        .action-btn.print:hover { color: #28a745; }

        .modal-content {
            border-radius: 20px;
            background: linear-gradient(145deg, #ffffff, #f7f9fc);
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }
        .modal-header {
            background: linear-gradient(90deg, #3F2A56, #5a3f73);
            color: white;
            border-top-left-radius: 20px;
            border-top-right-radius: 20px;
            padding: 20px;
        }
        .modal-title {
            font-size: 1.5rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .modal-body {
            padding: 30px;
        }
        .modal-body .form-label {
            font-weight: 600;
            color: #3F2A56;
        }
        .modal-body .form-control, .modal-body .form-select {
            border-radius: 15px;
            padding: 12px;
            background: #f7f9fc;
            border: 1px solid #ddd;
        }
         .modal-body .form-control:focus, .modal-body .form-select:focus {
            border-color: #3F2A56;
            box-shadow: 0 0 0 0.25rem rgba(63, 42, 86, 0.25);
        }
        .modal-footer {
            padding: 20px;
            background: #f8f9fa;
            border-bottom-left-radius: 20px;
            border-bottom-right-radius: 20px;
        }
        .modal-footer .btn {
            padding: 12px 30px;
        }
        .product-table th, .product-table td {
            padding: 8px;
        }
        .modal-body .product-table th { /* Change header text color in modal product tables */
            color: white;
             background: linear-gradient(90deg, #3F2A56, #5a3f73); /* Optional: match main table header */
        }
        .status-paid { color: #198754; font-weight: 700; }
        .status-partial { color: #ffc107; font-weight: 700; }
        .status-unpaid { color: #dc3545; font-weight: 700; }
        .swal2-popup {
            font-family: 'Cairo', sans-serif !important;
            border-radius: 15px !important;
        }
        .swal2-title { color: #3F2A56 !important; }
        .swal2-html-container { text-align: right !important; }
        .swal2-confirm {
            background: linear-gradient(90deg, #3F2A56, #5a3f73) !important;
            border-radius: 20px !important;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2) !important;
        }
        .swal2-cancel, .swال2-deny {
            background: linear-gradient(90deg, #6c757d, #5a6268) !important;
            border-radius: 20px !important;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2) !important;
        }
        #productSuggestions div, #editProductSuggestions div {
            padding: 8px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        #productSuggestions div:hover, #editProductSuggestions div:hover {
            background-color: #f0f0f0;
        }

        @media (max-width: 768px) {
            .header { padding: 25px 15px; }
            .header img { height: 70px; }
            .header h2 { font-size: 1.7rem; }
            .btn { padding: 10px 18px; font-size: 0.9rem; }
            th, td { padding: 10px; font-size: 0.9rem; }
            .modal-body { padding: 20px; }
            .search-container { flex-direction: column; align-items: stretch;}
            .filter-group { max-width: none; }
            #scanQrBtn { width: 100%; margin-top: 10px;}
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <img src="logo.png" alt="شعار طيبة المدينة تلكوم" onerror="this.src='https://via.placeholder.com/90?text=Logo'; this.style.display='none';">
            <h2>طيبة المدينة تلكوم</h2>
            <h4>بيع المنتجات</h4>
            <a href="home.html" class="home-btn"><i class="fas fa-home"></i> للرئيسية</a>
        </div>
        <div class="dashboard">
            <div class="card">
                <i class="fas fa-check-circle"></i>
                <h5>الفواتير المدفوعة</h5>
                <h3 id="paidInvoices">0</h3>
            </div>
            <div class="card">
                <i class="fas fa-exclamation-circle"></i>
                <h5>الفواتير المدفوعة جزئيًا</h5>
                <h3 id="partialInvoices">0</h3>
            </div>
            <div class="card">
                <i class="fas fa-times-circle"></i>
                <h5>الفواتير غير المدفوعة</h5>
                <h3 id="unpaidInvoices">0</h3>
            </div>
        </div>
        <div class="actions">
            <button class="btn" data-bs-toggle="modal" data-bs-target="#addInvoiceModal"><i class="fas fa-plus"></i> إضافة فاتورة</button>
            <button class="btn" data-bs-toggle="modal" data-bs-target="#addCustomerModal"><i class="fas fa-user-plus"></i> إضافة زبون</button>
            <button class="btn" data-bs-toggle="modal" data-bs-target="#customerStatementModal"><i class="fas fa-file-alt"></i> كشف حساب زبون</button>
        </div>
        <div class="section">
            <h3>الفواتير</h3>
            <div class="search-container">
                <div class="filter-group">
                    <label for="searchInput">البحث</label>
                    <input type="text" id="searchInput" placeholder="ابحث بالزبون أو معرف الفاتورة" oninput="filterTable()">
                </div>
                <button id="scanQrBtn" class="btn btn-info" title="مسح QR Code للبحث عن فاتورة"><i class="fas fa-qrcode"></i> مسح</button>
                <div class="filter-group">
                    <label for="statusFilter">حالة الفاتورة</label>
                    <select id="statusFilter" onchange="filterTable()">
                        <option value="all">الكل</option>
                        <option value="paid">مدفوع</option>
                        <option value="partial">مدفوع جزئيًا</option>
                        <option value="unpaid">لم يتم الدفع</option>
                    </select>
                </div>
            </div>
             <div id="qr-reader-container" style="display: none;">
                <div id="qr-reader"></div>
                <button id="closeScannerBtn" class="btn btn-sm btn-danger mt-2" style="display:block; margin: 0 auto;">إغلاق الماسح</button>
            </div>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>معرف الفاتورة</th>
                            <th>الزبون</th>
                            <th>رقم الهاتف</th>
                            <th>المبلغ الكلي</th>
                            <th>حالة الفاتورة</th>
                            <th>الإجراءات</th>
                        </tr>
                    </thead>
                    <tbody id="invoicesTable"></tbody>
                </table>
            </div>
        </div>
        <div class="section">
            <h3>إدارة الزبائن</h3>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>الاسم</th>
                            <th>رقم الهاتف</th>
                            <th>العنوان</th>
                            <th>الإجراءات</th>
                        </tr>
                    </thead>
                    <tbody id="customersTable"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- نافذة إضافة فاتورة -->
    <div class="modal fade" id="addInvoiceModal" tabindex="-1" aria-labelledby="addInvoiceModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addInvoiceModalLabel"><i class="fas fa-file-invoice-dollar"></i> إضافة فاتورة جديدة</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="addInvoiceForm">
                        <div class="mb-3">
                            <label for="invoiceCustomer" class="form-label"><i class="fas fa-user"></i> الزبون</label>
                            <select class="form-select" id="invoiceCustomer" required>
                                <option value="">اختر زبونًا</option>
                            </select>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="customerPhoneDisplay" class="form-label"><i class="fas fa-phone"></i> رقم الهاتف</label>
                                <input type="text" class="form-control" id="customerPhoneDisplay" readonly>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="customerAddressDisplay" class="form-label"><i class="fas fa-map-marker-alt"></i> العنوان</label>
                                <input type="text" class="form-control" id="customerAddressDisplay" readonly>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="productSearch" class="form-label"><i class="fas fa-search"></i> البحث عن منتج</label>
                            <input type="text" class="form-control" id="productSearch" placeholder="ابحث بالاسم أو المعرف">
                            <div id="productSuggestions" class="mt-2 list-group" style="max-height: 150px; overflow-y: auto;"></div>
                        </div>
                        <h5><i class="fas fa-boxes"></i> المنتجات</h5>
                        <div class="table-container">
                            <table class="product-table table">
                                <thead>
                                    <tr>
                                        <th>اسم المنتج</th>
                                        <th>سعر البيع</th>
                                        <th>الكمية</th>
                                        <th>الملاحظة</th>
                                        <th>الإجمالي</th>
                                        <th>الإجراءات</th>
                                    </tr>
                                </thead>
                                <tbody id="invoiceProducts"></tbody>
                            </table>
                        </div>
                        <div class="mt-3">
                            <p><strong><i class="fas fa-calendar-alt"></i> التاريخ:</strong> <span id="invoiceDate"></span></p>
                            <p><strong><i class="fas fa-hashtag"></i> عدد المواد:</strong> <span id="totalItems">0</span></p>
                            <p><strong><i class="fas fa-coins"></i> المجموع الكلي:</strong> <span id="totalAmount">0.00</span></p>
                            <div class="mb-3">
                                <label for="amountPaid" class="form-label"><i class="fas fa-money-bill-wave"></i> المبلغ المدفوع</label>
                                <input type="number" class="form-control" id="amountPaid" step="0.01" min="0" value="0">
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
                    <button type="button" class="btn btn-primary" onclick="addInvoice()">حفظ الفاتورة</button>
                </div>
            </div>
        </div>
    </div>

    <!-- نافذة تعديل فاتورة -->
    <div class="modal fade" id="editInvoiceModal" tabindex="-1" aria-labelledby="editInvoiceModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editInvoiceModalLabel"><i class="fas fa-edit"></i> تعديل فاتورة</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="editInvoiceForm">
                        <input type="hidden" id="editInvoiceId">
                        <div class="mb-3">
                            <label for="editInvoiceCustomer" class="form-label"><i class="fas fa-user"></i> الزبون</label>
                            <select class="form-select" id="editInvoiceCustomer" required>
                                <option value="">اختر زبونًا</option>
                            </select>
                        </div>
                         <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="editCustomerPhoneDisplay" class="form-label"><i class="fas fa-phone"></i> رقم الهاتف</label>
                                <input type="text" class="form-control" id="editCustomerPhoneDisplay" readonly>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="editCustomerAddressDisplay" class="form-label"><i class="fas fa-map-marker-alt"></i> العنوان</label>
                                <input type="text" class="form-control" id="editCustomerAddressDisplay" readonly>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="editProductSearch" class="form-label"><i class="fas fa-search"></i> البحث عن منتج</label>
                            <input type="text" class="form-control" id="editProductSearch" placeholder="ابحث بالاسم أو المعرف">
                            <div id="editProductSuggestions" class="mt-2 list-group" style="max-height: 150px; overflow-y: auto;"></div>
                        </div>
                        <h5><i class="fas fa-boxes"></i> المنتجات</h5>
                        <div class="table-container">
                            <table class="product-table table">
                                <thead>
                                    <tr>
                                        <th>اسم المنتج</th>
                                        <th>سعر البيع</th>
                                        <th>الكمية</th>
                                        <th>الملاحظة</th>
                                        <th>الإجمالي</th>
                                        <th>الإجراءات</th>
                                    </tr>
                                </thead>
                                <tbody id="editInvoiceProducts"></tbody>
                            </table>
                        </div>
                        <div class="mt-3">
                            <p><strong><i class="fas fa-calendar-alt"></i> التاريخ:</strong> <span id="editInvoiceDate"></span></p>
                            <p><strong><i class="fas fa-hashtag"></i> عدد المواد:</strong> <span id="editTotalItems">0</span></p>
                            <p><strong><i class="fas fa-coins"></i> المجموع الكلي:</strong> <span id="editTotalAmount">0.00</span></p>
                            <div class="mb-3">
                                <label for="editAmountPaid" class="form-label"><i class="fas fa-money-bill-wave"></i> المبلغ المدفوع</label>
                                <input type="number" class="form-control" id="editAmountPaid" step="0.01" min="0" value="0">
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
                    <button type="button" class="btn btn-primary" onclick="updateInvoice()">حفظ التعديلات</button>
                </div>
            </div>
        </div>
    </div>

    <!-- نافذة إضافة زبون -->
    <div class="modal fade" id="addCustomerModal" tabindex="-1" aria-labelledby="addCustomerModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addCustomerModalLabel"><i class="fas fa-user-plus"></i> إضافة زبون</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="addCustomerForm">
                        <div class="mb-3">
                            <label for="customerName" class="form-label"><i class="fas fa-signature"></i> اسم الزبون (اختياري)</label>
                            <input type="text" class="form-control" id="customerName">
                        </div>
                        <div class="mb-3">
                            <label for="customerPhone" class="form-label"><i class="fas fa-mobile-alt"></i> رقم الهاتف (اختياري)</label>
                            <input type="tel" class="form-control" id="customerPhone">
                        </div>
                        <div class="mb-3">
                            <label for="customerAddress" class="form-label"><i class="fas fa-home"></i> العنوان (اختياري)</label>
                            <input type="text" class="form-control" id="customerAddress">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
                    <button type="button" class="btn btn-primary" onclick="addCustomer()">حفظ الزبون</button>
                </div>
            </div>
        </div>
    </div>

    <!-- نافذة تعديل زبون -->
    <div class="modal fade" id="editCustomerModal" tabindex="-1" aria-labelledby="editCustomerModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editCustomerModalLabel"><i class="fas fa-user-edit"></i> تعديل زبون</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="editCustomerForm">
                        <input type="hidden" id="editCustomerId">
                        <div class="mb-3">
                            <label for="editCustomerName" class="form-label"><i class="fas fa-signature"></i> اسم الزبون (اختياري)</label>
                            <input type="text" class="form-control" id="editCustomerName">
                        </div>
                        <div class="mb-3">
                            <label for="editCustomerPhone" class="form-label"><i class="fas fa-mobile-alt"></i> رقم الهاتف (اختياري)</label>
                            <input type="tel" class="form-control" id="editCustomerPhone">
                        </div>
                        <div class="mb-3">
                            <label for="editCustomerAddress" class="form-label"><i class="fas fa-home"></i> العنوان (اختياري)</label>
                            <input type="text" class="form-control" id="editCustomerAddress">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
                    <button type="button" class="btn btn-primary" onclick="updateCustomer()">حفظ التعديلات</button>
                </div>
            </div>
        </div>
    </div>

    <!-- نافذة كشف حساب زبون -->
    <div class="modal fade" id="customerStatementModal" tabindex="-1" aria-labelledby="customerStatementModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="customerStatementModalLabel"><i class="fas fa-file-invoice"></i> كشف حساب زبون</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="customerStatementForm">
                        <div class="mb-3">
                            <label for="statementCustomer" class="form-label"><i class="fas fa-user-check"></i> الزبون</label>
                            <select class="form-select" id="statementCustomer" required>
                                <option value="">اختر زبونًا</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="startDate" class="form-label"><i class="fas fa-calendar-day"></i> من تاريخ</label>
                            <input type="date" class="form-control" id="startDate" required>
                        </div>
                        <div class="mb-3">
                            <label for="endDate" class="form-label"><i class="fas fa-calendar-day"></i> إلى تاريخ</label>
                            <input type="date" class="form-control" id="endDate" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
                    <button type="button" class="btn btn-primary" onclick="generateCustomerStatement()">إنشاء الكشف</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let db;
        let html5QrCodeScanner; // For QR Code scanner instance

        // Helper function to format date as DD-MM-YYYY HH:MM
        function formatDateForDisplay(isoString) {
            if (!isoString) return 'N/A';
            const date = new Date(isoString);
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0'); // Months are 0-indexed
            const year = date.getFullYear();
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            return `${day}-${month}-${year} ${hours}:${minutes}`;
        }


        // إعداد IndexedDB
        function initDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open('InventoryDB', 2); 
                request.onupgradeneeded = (event) => {
                    db = event.target.result;
                    if (!db.objectStoreNames.contains('products')) {
                        db.createObjectStore('products', { keyPath: 'id' });
                    }
                    if (!db.objectStoreNames.contains('invoices')) {
                        const invoiceStore = db.createObjectStore('invoices', { keyPath: 'id' });
                        invoiceStore.createIndex('customerId', 'customerId', { unique: false });
                    }
                    if (!db.objectStoreNames.contains('customers')) {
                        const customerStore = db.createObjectStore('customers', { keyPath: 'id' });
                        customerStore.createIndex('phone', 'phone', { unique: false }); 
                    }
                };
                request.onsuccess = (event) => {
                    db = event.target.result;
                    resolve(db);
                };
                request.onerror = (event) => {
                    console.error("Database error: " + event.target.errorCode);
                    reject(event.target.error);
                };
            });
        }
        
        async function ensureDBInitialized() {
            if (!db) {
                try {
                    await initDB();
                } catch (error) {
                    console.error('Failed to initialize database:', error);
                    throw new Error('Failed to initialize database: ' + error.message);
                }
            }
            if (!db) { 
                throw new Error('Database not ready after initialization attempt.');
            }
        }

        async function generateUniqueId(storeName) {
            await ensureDBInitialized();
            let id;
            let isUnique = false;
            const existingIds = await getAllIds(storeName); 
            while (!isUnique) {
                id = Math.floor(10000 + Math.random() * 90000).toString();
                isUnique = !existingIds.includes(id);
            }
            return id;
        }

        function getAllIds(storeName) {
            return new Promise(async (resolve, reject) => {
                try {
                    await ensureDBInitialized();
                    const transaction = db.transaction([storeName], 'readonly');
                    const store = transaction.objectStore(storeName);
                    const request = store.getAllKeys(); 
                    request.onsuccess = () => {
                        resolve(request.result);
                    };
                    request.onerror = (event) => reject(event.target.error);
                } catch (error) {
                    reject(error);
                }
            });
        }

        function getAllProducts() {
            return new Promise(async (resolve, reject) => {
                try {
                    await ensureDBInitialized();
                    const transaction = db.transaction(['products'], 'readonly');
                    const store = transaction.objectStore('products');
                    const request = store.getAll();
                    request.onsuccess = () => resolve(request.result || []);
                    request.onerror = (event) => reject(event.target.error);
                } catch (error) {
                    reject(error);
                }
            });
        }
        
        function checkProductExists(productId) {
            return new Promise(async (resolve) => {
                try {
                    await ensureDBInitialized();
                    const transaction = db.transaction(['products'], 'readonly');
                    const store = transaction.objectStore('products');
                    const request = store.get(productId);
                    request.onsuccess = () => resolve(!!request.result); // True if product exists
                    request.onerror = () => resolve(false); // Error, assume not exists
                } catch (e) { resolve(false); }
            });
        }


        function getAllInvoices() {
            return new Promise(async (resolve, reject) => {
                try {
                    await ensureDBInitialized();
                    const transaction = db.transaction(['invoices'], 'readonly');
                    const store = transaction.objectStore('invoices');
                    const request = store.getAll();
                    request.onsuccess = () => resolve(request.result || []);
                    request.onerror = (event) => reject(event.target.error);
                } catch (error) {
                    reject(error);
                }
            });
        }

        function getAllCustomers() {
            return new Promise(async (resolve, reject) => {
                try {
                    await ensureDBInitialized();
                    const transaction = db.transaction(['customers'], 'readonly');
                    const store = transaction.objectStore('customers');
                    const request = store.getAll();
                    request.onsuccess = () => resolve(request.result || []);
                    request.onerror = (event) => reject(event.target.error);
                } catch (error) {
                    reject(error);
                }
            });
        }

        async function updateDashboard() {
            const invoices = await getAllInvoices();
            const paid = invoices.filter(i => parseFloat(i.amountPaid) >= parseFloat(i.totalAmount) && parseFloat(i.totalAmount) > 0).length;
            const partial = invoices.filter(i => parseFloat(i.amountPaid) > 0 && parseFloat(i.amountPaid) < parseFloat(i.totalAmount)).length;
            const unpaid = invoices.filter(i => parseFloat(i.amountPaid) === 0 && parseFloat(i.totalAmount) > 0).length;


            document.getElementById('paidInvoices').innerText = paid;
            document.getElementById('partialInvoices').innerText = partial;
            document.getElementById('unpaidInvoices').innerText = unpaid;
        }

        async function updateInvoicesTable() {
            const invoices = await getAllInvoices();
            const customers = await getAllCustomers();
            const tableBody = document.getElementById('invoicesTable');
            tableBody.innerHTML = '';

            invoices.sort((a, b) => new Date(b.date) - new Date(a.date)); 

            invoices.forEach((invoice, index) => {
                const customer = customers.find(c => c.id === invoice.customerId);
                const totalAmount = parseFloat(invoice.totalAmount);
                const amountPaid = parseFloat(invoice.amountPaid);
                let statusClass, statusText;

                if (totalAmount === 0 && amountPaid === 0) { // Consider invoices with 0 total and 0 paid (e.g. returns or empty)
                    statusClass = ''; // No specific class or a 'neutral' class
                    statusText = 'لا يوجد مبلغ';
                } else if (amountPaid >= totalAmount) {
                    statusClass = 'status-paid';
                    statusText = 'مدفوع';
                } else if (amountPaid > 0) {
                    statusClass = 'status-partial';
                    statusText = 'مدفوع جزئيًا';
                } else { // amountPaid is 0 and totalAmount > 0
                    statusClass = 'status-unpaid';
                    statusText = 'لم يتم الدفع';
                }


                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${invoice.id}</td>
                    <td>${customer?.name || 'زبون محذوف/غير معروف'}</td>
                    <td>${customer?.phone || '-'}</td>
                    <td>${totalAmount.toFixed(2)}</td>
                    <td class="${statusClass}">${statusText}</td>
                    <td>
                        <i class="fas fa-print action-btn print" onclick="printInvoice('${invoice.id}')" title="طباعة"></i>
                        <i class="fas fa-edit action-btn edit" onclick="editInvoice('${invoice.id}')" title="تعديل"></i>
                        <!-- Delete button removed from UI as requested -->
                    </td>
                `;
                tableBody.appendChild(row);
            });
            updateDashboard(); // Update dashboard after table is updated
            // filterTable(); // Call filterTable if you want to apply existing filters immediately after refresh
        }

        async function updateCustomersTable() {
            const customers = await getAllCustomers();
            const tableBody = document.getElementById('customersTable');
            tableBody.innerHTML = '';

            customers.forEach((customer, index) => {
                const row = document.createElement('tr');
                const displayName = customer.name || 'زبون بدون اسم';
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${displayName}</td>
                    <td>${customer.phone || '-'}</td>
                    <td>${customer.address || '-'}</td>
                    <td>
                        <i class="fas fa-edit action-btn edit" onclick="editCustomer('${customer.id}')" title="تعديل"></i>
                        <i class="fas fa-trash action-btn delete" onclick="deleteCustomer('${customer.id}')" title="حذف"></i>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }

        async function filterTable() {
            const searchInput = document.getElementById('searchInput').value.toLowerCase();
            const statusFilter = document.getElementById('statusFilter').value;
            const invoices = await getAllInvoices(); // Fetch fresh list
            const customers = await getAllCustomers(); // Fetch fresh list
            const tableBody = document.getElementById('invoicesTable');
            
            const filteredInvoices = invoices.filter(invoice => {
                const customer = customers.find(c => c.id === invoice.customerId);
                const customerName = customer?.name?.toLowerCase() || '';
                const matchesSearch = customerName.includes(searchInput) || invoice.id.includes(searchInput);
                
                if (!matchesSearch) return false;

                const totalAmount = parseFloat(invoice.totalAmount);
                const amountPaid = parseFloat(invoice.amountPaid);

                if (statusFilter === 'all') return true;
                if (statusFilter === 'paid') return amountPaid >= totalAmount && totalAmount > 0; // Ensure total > 0 for 'paid'
                if (statusFilter === 'partial') return amountPaid > 0 && amountPaid < totalAmount;
                if (statusFilter === 'unpaid') return amountPaid === 0 && totalAmount > 0; // Ensure total > 0 for 'unpaid'
                
                // This case should ideally not be reached if statusFilter has a valid value from the dropdown.
                // If it's reached, it means an unknown filter value, so include the item.
                return true; 
            });

            tableBody.innerHTML = ''; 
            filteredInvoices.sort((a, b) => new Date(b.date) - new Date(a.date)); // Re-sort filtered results

            filteredInvoices.forEach((invoice, index) => {
                const customer = customers.find(c => c.id === invoice.customerId);
                const totalAmount = parseFloat(invoice.totalAmount);
                const amountPaid = parseFloat(invoice.amountPaid);
                let statusClass, statusText;

                 if (totalAmount === 0 && amountPaid === 0) {
                    statusClass = ''; statusText = 'لا يوجد مبلغ';
                } else if (amountPaid >= totalAmount) {
                    statusClass = 'status-paid'; statusText = 'مدفوع';
                } else if (amountPaid > 0) {
                    statusClass = 'status-partial'; statusText = 'مدفوع جزئيًا';
                } else {
                    statusClass = 'status-unpaid'; statusText = 'لم يتم الدفع';
                }

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${invoice.id}</td>
                    <td>${customer?.name || 'زبون محذوف/غير معروف'}</td>
                    <td>${customer?.phone || '-'}</td>
                    <td>${totalAmount.toFixed(2)}</td>
                    <td class="${statusClass}">${statusText}</td>
                    <td>
                        <i class="fas fa-print action-btn print" onclick="printInvoice('${invoice.id}')" title="طباعة"></i>
                        <i class="fas fa-edit action-btn edit" onclick="editInvoice('${invoice.id}')" title="تعديل"></i>
                    </td>
                `;
                tableBody.appendChild(row);
            });
            // No need to call updateDashboard here as it's called in updateInvoicesTable which is called by other functions.
            // However, if filterTable is called independently (e.g., on search input), then dashboard might need update based on filtered view, or just reflect all invoices.
            // For simplicity, let dashboard always reflect all invoices. It's updated by main table update functions.
        }


        async function populateCustomerSelect(selectElementId) {
            const customers = await getAllCustomers();
            const select = document.getElementById(selectElementId);
            const currentValue = select.value; // Preserve current selection if possible
            select.innerHTML = '<option value="">اختر زبونًا...</option>'; 
            customers.forEach(customer => {
                const option = document.createElement('option');
                option.value = customer.id;
                option.textContent = customer.name || `زبون (${customer.phone || 'معرف: ' + customer.id.slice(0,5)})`;
                select.appendChild(option);
            });
            if (currentValue) { // Attempt to restore selection
                 select.value = currentValue;
            }
        }

        async function updateCustomerInfo(selectElementId, phoneElementId, addressElementId) {
            const customerId = document.getElementById(selectElementId).value;
            const phoneInput = document.getElementById(phoneElementId);
            const addressInput = document.getElementById(addressElementId);

            if (customerId) {
                const customers = await getAllCustomers(); // Fetch fresh customer data
                const customer = customers.find(c => c.id === customerId);
                phoneInput.value = customer?.phone || '';
                addressInput.value = customer?.address || '';
            } else {
                phoneInput.value = '';
                addressInput.value = '';
            }
        }
        
        async function setupProductSearch(searchElementId, suggestionsElementId, productsTableId, isEditModal = false) {
            const searchInput = document.getElementById(searchElementId);
            const suggestionsDiv = document.getElementById(suggestionsElementId);
            
            searchInput.addEventListener('input', async (e) => {
                const query = e.target.value.toLowerCase().trim();
                suggestionsDiv.innerHTML = ''; 
                if (query.length < 1) return; 

                const allProducts = await getAllProducts();
                const availableProducts = allProducts.filter(p => p.quantity > 0); 
                
                const filteredProducts = availableProducts.filter(p => 
                    p.name.toLowerCase().includes(query) || 
                    p.id.includes(query)
                ).slice(0, 10); 

                if (filteredProducts.length > 0) {
                    filteredProducts.forEach(product => {
                        const div = document.createElement('div');
                        div.className = 'list-group-item list-group-item-action';
                        
                        const salePriceFormatted = parseFloat(product.salePrice || 0).toFixed(2);
                        
                        // --- MODIFICATION FOR costPrice ---
                        let costPriceFormatted;
                        if (typeof product.costPrice === 'number') { // Handles 0 as a valid cost price
                            costPriceFormatted = parseFloat(product.costPrice).toFixed(2);
                        } else if (product.costPrice && !isNaN(parseFloat(product.costPrice))) { // Handles string numbers
                            costPriceFormatted = parseFloat(product.costPrice).toFixed(2);
                        } else {
                            costPriceFormatted = 'غ/م'; // Not available or not a valid number
                        }
                        // --- END MODIFICATION ---
                        
                        div.innerHTML = `
                            <strong>${product.name}</strong> (المعرف: ${product.id}) <br>
                            <small>
                                سعر البيع: ${salePriceFormatted} | 
                                سعر الشراء: ${costPriceFormatted} | 
                                الكمية المتوفرة: ${product.quantity}
                            </small>
                        `;
                        div.onclick = () => {
                            addProductToInvoice(product, productsTableId);
                            searchInput.value = ''; 
                            suggestionsDiv.innerHTML = ''; 
                        };
                        suggestionsDiv.appendChild(div);
                    });
                } else {
                    suggestionsDiv.innerHTML = '<div class="list-group-item">لا توجد منتجات مطابقة أو غير متوفرة.</div>';
                }
            });
        }


        function addProductToInvoice(product, productsTableId) {
            const tableBody = document.getElementById(productsTableId);
            const existingRow = Array.from(tableBody.rows).find(row => row.dataset.productId === product.id);

            if (existingRow) {
                const quantityInput = existingRow.querySelector('.quantity');
                const currentQuantity = parseInt(quantityInput.value);
                if (currentQuantity < product.quantity) { 
                    quantityInput.value = currentQuantity + 1;
                } else {
                    Swal.fire('تنبيه', `الكمية المطلوبة للمنتج "${product.name}" تتجاوز المخزون المتاح (${product.quantity}).`, 'warning');
                    return;
                }
            } else {
                if (product.quantity < 1) { 
                     Swal.fire('تنبيه', `المنتج "${product.name}" غير متوفر في المخزون.`, 'warning');
                    return;
                }
                const row = tableBody.insertRow();
                row.dataset.productId = product.id; 
                
                row.innerHTML = `
                    <td>${product.name}</td>
                    <td><input type="number" class="form-control form-control-sm sale-price" value="${parseFloat(product.salePrice || 0).toFixed(2)}" step="0.01" min="0.01"></td>
                    <td><input type="number" class="form-control form-control-sm quantity" value="1" min="1" max="${product.quantity}"></td>
                    <td><input type="text" class="form-control form-control-sm note" placeholder="ملاحظة (اختياري)"></td>
                    <td class="total">${parseFloat(product.salePrice || 0).toFixed(2)}</td>
                    <td><button type="button" class="btn btn-sm btn-danger" onclick="removeProductFromInvoice(this.closest('tr'), '${productsTableId}')"><i class="fas fa-trash-alt"></i></button></td>
                `;
                row.querySelector('.sale-price').addEventListener('input', () => updateInvoiceTotals(productsTableId));
                row.querySelector('.quantity').addEventListener('input', (e) => {
                    const requestedQuantity = parseInt(e.target.value);
                    const maxQuantityForThisProduct = parseInt(e.target.max); // Use the max attribute of the input

                    if (requestedQuantity > maxQuantityForThisProduct) {
                        e.target.value = maxQuantityForThisProduct; 
                        Swal.fire('تنبيه', `الكمية المطلوبة للمنتج "${product.name}" تتجاوز المخزون المتاح (${maxQuantityForThisProduct}). تم التعديل للحد الأقصى.`, 'warning');
                    }
                    updateInvoiceTotals(productsTableId);
                });
            }
            updateInvoiceTotals(productsTableId);
        }


        function removeProductFromInvoice(rowElement, productsTableId) {
            rowElement.remove();
            updateInvoiceTotals(productsTableId);
        }

        function updateInvoiceTotals(productsTableId) {
            const tableBody = document.getElementById(productsTableId);
            const rows = tableBody.querySelectorAll('tr');
            let totalAmount = 0;
            let totalItemsCount = 0; 

            rows.forEach(row => {
                const salePriceInput = row.querySelector('.sale-price');
                const quantityInput = row.querySelector('.quantity');
                
                const salePrice = parseFloat(salePriceInput.value) || 0;
                const quantity = parseInt(quantityInput.value) || 0;
                
                const itemTotal = salePrice * quantity;
                row.querySelector('.total').textContent = itemTotal.toFixed(2);
                totalAmount += itemTotal;
                totalItemsCount++; 
            });

            const isEditModal = productsTableId === 'editInvoiceProducts';
            document.getElementById(isEditModal ? 'editTotalItems' : 'totalItems').textContent = totalItemsCount; 
            document.getElementById(isEditModal ? 'editTotalAmount' : 'totalAmount').textContent = totalAmount.toFixed(2);
        }

        async function addInvoice() {
            const customerId = document.getElementById('invoiceCustomer').value;
            const amountPaidValue = document.getElementById('amountPaid').value;
            const productsTable = document.getElementById('invoiceProducts');
            const rows = productsTable.querySelectorAll('tr');

            if (!customerId) {
                Swal.fire('خطأ', 'الرجاء اختيار زبون!', 'error'); return;
            }
            if (rows.length === 0) {
                Swal.fire('خطأ', 'الرجاء إضافة منتج واحد على الأقل للفاتورة!', 'error'); return;
            }
            const amountPaid = parseFloat(amountPaidValue);
            if (isNaN(amountPaid) || amountPaid < 0) {
                 Swal.fire('خطأ', 'المبلغ المدفوع غير صحيح!', 'error'); return;
            }

            const productsInInvoice = [];
            let totalAmount = 0;
            let stockUpdatePromises = [];

            for (const row of rows) {
                const productId = row.dataset.productId;
                const name = row.cells[0].textContent;
                const salePrice = parseFloat(row.querySelector('.sale-price').value);
                const quantitySold = parseInt(row.querySelector('.quantity').value);
                const note = row.querySelector('.note').value;
                const itemTotal = salePrice * quantitySold;

                if (isNaN(salePrice) || salePrice <=0 || isNaN(quantitySold) || quantitySold <=0) {
                    Swal.fire('خطأ', `بيانات غير صالحة للمنتج "${name}". تأكد من السعر والكمية.`, 'error'); return;
                }

                productsInInvoice.push({ productId, name, salePrice, quantity: quantitySold, note, total: itemTotal });
                totalAmount += itemTotal;
                stockUpdatePromises.push(updateProductStock(productId, quantitySold));
            }
             if (amountPaid > totalAmount) {
                Swal.fire('خطأ', 'المبلغ المدفوع لا يمكن أن يكون أكبر من المجموع الكلي للفاتورة!', 'error'); return;
            }

            try {
                await Promise.all(stockUpdatePromises); 
            } catch (error) {
                Swal.fire('خطأ في تحديث المخزون', error.message, 'error');
                return;
            }

            const id = await generateUniqueId('invoices');
            const invoice = {
                id,
                customerId,
                products: productsInInvoice,
                totalAmount: totalAmount.toFixed(2),
                amountPaid: amountPaid.toFixed(2),
                date: new Date().toISOString()
            };

            const transaction = db.transaction(['invoices'], 'readwrite');
            const store = transaction.objectStore('invoices');
            const request = store.add(invoice);

            request.onsuccess = async () => {
                await updateInvoicesTable(); // This also updates dashboard
                bootstrap.Modal.getInstance(document.getElementById('addInvoiceModal')).hide();
                document.getElementById('addInvoiceForm').reset();
                document.getElementById('invoiceProducts').innerHTML = ''; 
                document.getElementById('totalItems').textContent = '0';
                document.getElementById('totalAmount').textContent = '0.00';
                document.getElementById('customerPhoneDisplay').value = '';
                document.getElementById('customerAddressDisplay').value = '';
                document.getElementById('invoiceDate').textContent = formatDateForDisplay(new Date().toISOString()); // Reset date
                await populateCustomerSelect('invoiceCustomer'); 
                Swal.fire('نجاح', 'تم إضافة الفاتورة وتحديث المخزون بنجاح!', 'success');
            };
            request.onerror = (e) => {
                console.error("Error adding invoice:", e.target.error);
                Swal.fire('خطأ', 'فشل في إضافة الفاتورة!', 'error');
            };
        }
        
        function updateProductStock(productId, quantitySold) {
            return new Promise(async (resolve, reject) => {
                try {
                    await ensureDBInitialized();
                    const transaction = db.transaction(['products'], 'readwrite');
                    const store = transaction.objectStore('products');
                    const getRequest = store.get(productId);

                    getRequest.onsuccess = () => {
                        const product = getRequest.result;
                        if (!product) {
                            reject(new Error(`المنتج بالمعرف ${productId} غير موجود.`));
                            return;
                        }
                        if (product.quantity < quantitySold) {
                            reject(new Error(`الكمية المطلوبة للمنتج "${product.name}" (${quantitySold}) تتجاوز المخزون المتاح (${product.quantity}).`));
                            return;
                        }
                        product.quantity -= quantitySold;
                        const updateRequest = store.put(product);
                        updateRequest.onsuccess = () => resolve();
                        updateRequest.onerror = (e) => reject(new Error(`فشل تحديث مخزون المنتج ${product.name}: ${e.target.error}`));
                    };
                    getRequest.onerror = (e) => reject(new Error(`فشل جلب المنتج ${productId} لتحديث المخزون: ${e.target.error}`));
                } catch (dbError) {
                    reject(dbError);
                }
            });
        }


        async function editInvoice(invoiceId) {
            try {
                await ensureDBInitialized();
                const transaction = db.transaction(['invoices', 'customers', 'products'], 'readonly'); 
                const invoiceStore = transaction.objectStore('invoices');
                const invoiceRequest = invoiceStore.get(invoiceId);

                invoiceRequest.onsuccess = async () => {
                    const invoice = invoiceRequest.result;
                    if (!invoice) {
                        Swal.fire('خطأ', 'الفاتورة غير موجودة!', 'error');
                        return;
                    }
                    
                    document.getElementById('editInvoiceModal').dataset.originalProducts = JSON.stringify(invoice.products);
                    document.getElementById('editInvoiceId').value = invoice.id;
                    
                    const customerSelect = document.getElementById('editInvoiceCustomer');
                    await populateCustomerSelect('editInvoiceCustomer'); 
                    customerSelect.value = invoice.customerId;
                    await updateCustomerInfo('editInvoiceCustomer', 'editCustomerPhoneDisplay', 'editCustomerAddressDisplay');

                    document.getElementById('editInvoiceDate').textContent = formatDateForDisplay(invoice.date);
                    document.getElementById('editAmountPaid').value = parseFloat(invoice.amountPaid).toFixed(2);

                    const tableBody = document.getElementById('editInvoiceProducts');
                    tableBody.innerHTML = ''; 

                    const allProductsFromDB = await getAllProducts(); 

                    invoice.products.forEach(pInInvoice => {
                        const productDetailsFromDB = allProductsFromDB.find(pDB => pDB.id === pInInvoice.productId);
                        const currentStockInDB = productDetailsFromDB ? productDetailsFromDB.quantity : 0;
                        const maxQuantityForInput = currentStockInDB + pInInvoice.quantity;


                        const row = tableBody.insertRow();
                        row.dataset.productId = pInInvoice.productId;
                        row.dataset.originalQuantityInInvoice = pInInvoice.quantity; 
                        row.dataset.maxEditableQuantity = maxQuantityForInput;


                        row.innerHTML = `
                            <td>${pInInvoice.name}</td>
                            <td><input type="number" class="form-control form-control-sm sale-price" value="${parseFloat(pInInvoice.salePrice).toFixed(2)}" step="0.01" min="0.01"></td>
                            <td><input type="number" class="form-control form-control-sm quantity" value="${pInInvoice.quantity}" min="1" max="${maxQuantityForInput}"></td>
                            <td><input type="text" class="form-control form-control-sm note" value="${pInInvoice.note || ''}" placeholder="ملاحظة"></td>
                            <td class="total">${parseFloat(pInInvoice.total).toFixed(2)}</td>
                            <td><button type="button" class="btn btn-sm btn-danger" onclick="removeProductFromInvoice(this.closest('tr'), 'editInvoiceProducts')"><i class="fas fa-trash-alt"></i></button></td>
                        `;
                        row.querySelector('.sale-price').addEventListener('input', () => updateInvoiceTotals('editInvoiceProducts'));
                        row.querySelector('.quantity').addEventListener('input', (e) => {
                             const requestedQuantity = parseInt(e.target.value);
                             const maxAllowed = parseInt(e.target.max); 
                             if (requestedQuantity > maxAllowed) {
                                e.target.value = maxAllowed;
                                Swal.fire('تنبيه', `الكمية المطلوبة للمنتج "${pInInvoice.name}" تتجاوز المخزون المتاح. تم التعديل للحد الأقصى (${maxAllowed}).`, 'warning');
                            }
                            updateInvoiceTotals('editInvoiceProducts');
                        });
                    });

                    updateInvoiceTotals('editInvoiceProducts');
                    new bootstrap.Modal(document.getElementById('editInvoiceModal')).show();
                };
                invoiceRequest.onerror = (e) => Swal.fire('خطأ', `فشل في جلب الفاتورة: ${e.target.error}`, 'error');
            } catch (dbError) {
                 Swal.fire('خطأ قاعدة البيانات', `فشل: ${dbError.message}`, 'error');
            }
        }


        async function updateInvoice() {
            const id = document.getElementById('editInvoiceId').value;
            const customerId = document.getElementById('editInvoiceCustomer').value;
            const amountPaidValue = document.getElementById('editAmountPaid').value;
            const productsTable = document.getElementById('editInvoiceProducts');
            const rows = productsTable.querySelectorAll('tr');
            
            const originalProductsJSON = document.getElementById('editInvoiceModal').dataset.originalProducts;
            const originalProductsInInvoice = JSON.parse(originalProductsJSON || "[]"); 


            if (!customerId) { Swal.fire('خطأ', 'الرجاء اختيار زبون!', 'error'); return; }
            if (rows.length === 0) { Swal.fire('خطأ', 'الفاتورة يجب أن تحتوي على منتج واحد على الأقل!', 'error'); return; }
            const amountPaid = parseFloat(amountPaidValue);
             if (isNaN(amountPaid) || amountPaid < 0) { Swal.fire('خطأ', 'المبلغ المدفوع غير صحيح!', 'error'); return; }


            const updatedProductsInInvoice = [];
            let newTotalAmount = 0;
            let stockAdjustmentPromises = []; 

            for (const row of rows) {
                const productId = row.dataset.productId;
                const name = row.cells[0].textContent;
                const salePrice = parseFloat(row.querySelector('.sale-price').value);
                const newQuantitySold = parseInt(row.querySelector('.quantity').value);
                const note = row.querySelector('.note').value;
                const itemTotal = salePrice * newQuantitySold;

                if (isNaN(salePrice) || salePrice <=0 || isNaN(newQuantitySold) || newQuantitySold <=0) {
                    Swal.fire('خطأ', `بيانات غير صالحة للمنتج "${name}". تأكد من السعر والكمية.`, 'error'); return;
                }

                updatedProductsInInvoice.push({ productId, name, salePrice, quantity: newQuantitySold, note, total: itemTotal });
                newTotalAmount += itemTotal;

                const originalProductInfo = originalProductsInInvoice.find(p => p.productId === productId);
                const originalQuantitySoldInThisInvoice = originalProductInfo ? originalProductInfo.quantity : 0;
                
                const quantityChangeForStock = originalQuantitySoldInThisInvoice - newQuantitySold; 
                
                if (quantityChangeForStock !== 0) {
                    const productExists = await checkProductExists(productId);
                    if (productExists) {
                         stockAdjustmentPromises.push(adjustProductStock(productId, quantityChangeForStock));
                    } else {
                        console.warn(`Product ${productId} not found in DB. Skipping stock adjustment for this item.`);
                    }
                }
            }
            
            originalProductsInInvoice.forEach(async origP => {
                if (!updatedProductsInInvoice.some(updP => updP.productId === origP.productId)) {
                    const productExists = await checkProductExists(origP.productId);
                     if (productExists) {
                        stockAdjustmentPromises.push(adjustProductStock(origP.productId, origP.quantity)); 
                     } else {
                        console.warn(`Product ${origP.productId} (removed from invoice) not found in DB. Skipping stock adjustment for this item.`);
                     }
                }
            });


            if (amountPaid > newTotalAmount) {
                Swal.fire('خطأ', 'المبلغ المدفوع لا يمكن أن يكون أكبر من المجموع الكلي للفاتورة!', 'error'); return;
            }

            try {
                if (stockAdjustmentPromises.length > 0) {
                    await Promise.all(stockAdjustmentPromises);
                }
            } catch (error) {
                Swal.fire('خطأ في تحديث المخزون', error.message, 'error');
                return; 
            }
            
            let invoiceDateStr = document.getElementById('editInvoiceDate').textContent;
            let invoiceDateISO;
            if (invoiceDateStr && invoiceDateStr !== 'N/A') {
                const parts = invoiceDateStr.match(/(\d{2})-(\d{2})-(\d{4}) (\d{2}):(\d{2})/);
                if (parts) {
                    // parts[1]=day, parts[2]=month, parts[3]=year, parts[4]=hour, parts[5]=minute
                    invoiceDateISO = new Date(Date.UTC(parts[3], parts[2] - 1, parts[1], parts[4], parts[5])).toISOString();
                } else {
                    invoiceDateISO = new Date().toISOString(); 
                }
            } else {
                 invoiceDateISO = new Date().toISOString(); 
            }


            const invoice = {
                id,
                customerId,
                products: updatedProductsInInvoice,
                totalAmount: newTotalAmount.toFixed(2),
                amountPaid: amountPaid.toFixed(2),
                date: invoiceDateISO 
            };

            const transaction = db.transaction(['invoices'], 'readwrite');
            const store = transaction.objectStore('invoices');
            const request = store.put(invoice);

            request.onsuccess = async () => {
                await updateInvoicesTable(); // This also updates dashboard
                bootstrap.Modal.getInstance(document.getElementById('editInvoiceModal')).hide();
                Swal.fire('نجاح', 'تم تعديل الفاتورة وتحديث المخزون بنجاح!', 'success');
            };
            request.onerror = (e) => {
                 console.error("Error updating invoice:", e.target.error);
                 Swal.fire('خطأ', 'فشل في تعديل الفاتورة!', 'error');
            };
        }

        function adjustProductStock(productId, quantityChange) {
            return new Promise(async (resolve, reject) => {
                try {
                    await ensureDBInitialized();
                    const transaction = db.transaction(['products'], 'readwrite');
                    const store = transaction.objectStore('products');
                    const getRequest = store.get(productId);

                    getRequest.onsuccess = () => {
                        const product = getRequest.result;
                        if (!product) {
                            // It's possible a product was deleted from inventory system externally
                            // while it was still in an invoice. Log this instead of hard failing the whole invoice update.
                            console.warn(`المنتج بالمعرف ${productId} غير موجود لتعديل المخزون. سيتم تخطي هذا المنتج.`);
                            resolve(); // Resolve to not block other stock adjustments
                            return;
                        }
                        
                        const newStock = product.quantity + quantityChange;
                        if (newStock < 0) { 
                             reject(new Error(`لا يمكن أن يكون مخزون المنتج "${product.name}" سالبًا. التغيير المطلوب للمخزون: ${quantityChange}, المخزون الحالي: ${product.quantity}.`));
                             return;
                        }
                        product.quantity = newStock;

                        const updateRequest = store.put(product);
                        updateRequest.onsuccess = () => resolve();
                        updateRequest.onerror = (e) => reject(new Error(`فشل تعديل مخزون المنتج ${product.name}: ${e.target.error}`));
                    };
                    getRequest.onerror = (e) => reject(new Error(`فشل جلب المنتج ${productId} لتعديل المخزون: ${e.target.error}`));
                } catch (dbError) {
                    reject(dbError);
                }
            });
        }

        async function deleteInvoice(invoiceId) { // This function is not called from UI but kept for potential use
            const result = await Swal.fire({
                title: 'تأكيد الحذف',
                text: 'هل أنت متأكد من حذف هذه الفاتورة؟ سيتم إرجاع الكميات المباعة إلى المخزون.',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'نعم، احذف',
                cancelButtonText: 'إلغاء',
                confirmButtonColor: '#dc3545',
                cancelButtonColor: '#6c757d'
            });

            if (result.isConfirmed) {
                try {
                    await ensureDBInitialized();
                    const readTx = db.transaction(['invoices'], 'readonly'); 
                    const invoiceStoreRead = readTx.objectStore('invoices');
                    const getInvoiceRequest = invoiceStoreRead.get(invoiceId);

                    getInvoiceRequest.onsuccess = async () => {
                        const invoiceToDelete = getInvoiceRequest.result;
                        if (!invoiceToDelete) {
                            Swal.fire('خطأ', 'الفاتورة غير موجودة.', 'error');
                            return;
                        }

                        let stockReturnPromises = [];
                        for (const p of invoiceToDelete.products) {
                            const productExists = await checkProductExists(p.productId);
                            if (productExists) {
                                stockReturnPromises.push(adjustProductStock(p.productId, p.quantity));
                            } else {
                                console.warn(`Product ${p.productId} from deleted invoice not found. Stock not returned for this item.`);
                            }
                        }
                        
                        try {
                            if (stockReturnPromises.length > 0) {
                                await Promise.all(stockReturnPromises); 
                            }

                            const writeTxDelete = db.transaction(['invoices'], 'readwrite');
                            const invoiceStoreWrite = writeTxDelete.objectStore('invoices');
                            const deleteRequest = invoiceStoreWrite.delete(invoiceId);

                            deleteRequest.onsuccess = async () => {
                                await updateInvoicesTable(); // This also updates dashboard
                                Swal.fire('نجاح', 'تم حذف الفاتورة وإرجاع المنتجات للمخزون بنجاح!', 'success');
                            };
                            deleteRequest.onerror = (e) => {
                                console.error("Error deleting invoice:", e.target.error);
                                Swal.fire('خطأ', 'فشل في حذف الفاتورة! (قد يكون المخزون أُرجع).', 'error');
                            };

                        } catch (stockError) {
                            Swal.fire('خطأ في إرجاع المخزون', stockError.message, 'error');
                        }
                    };
                    getInvoiceRequest.onerror = (e) => Swal.fire('خطأ', `فشل في جلب الفاتورة للحذف: ${e.target.error}`, 'error');

                } catch (dbError) {
                     Swal.fire('خطأ قاعدة البيانات', `فشل: ${dbError.message}`, 'error');
                }
            }
        }


        async function addCustomer() {
            const name = document.getElementById('customerName').value.trim();
            const phone = document.getElementById('customerPhone').value.trim();
            const address = document.getElementById('customerAddress').value.trim();
            
            if (!name && !phone && !address) {
                 Swal.fire('خطأ', 'يجب إدخال معلومة واحدة على الأقل للزبون (الاسم أو الهاتف أو العنوان).', 'error');
                 return;
            }

            if (phone) { 
                const customers = await getAllCustomers();
                if (customers.some(c => c.phone === phone && phone !== '')) { // Ensure phone isn't empty string
                    Swal.fire('خطأ', 'رقم الهاتف هذا مُسجل لزبون آخر!', 'error');
                    return;
                }
            }


            const id = await generateUniqueId('customers');
            const customer = { 
                id, 
                name: name || null, // Store null if empty for consistency
                phone: phone || null, 
                address: address || null 
            };


            const transaction = db.transaction(['customers'], 'readwrite');
            const store = transaction.objectStore('customers');
            const request = store.add(customer);

            request.onsuccess = async () => {
                await updateCustomersTable();
                await populateCustomerSelect('invoiceCustomer');
                await populateCustomerSelect('editInvoiceCustomer');
                await populateCustomerSelect('statementCustomer');
                bootstrap.Modal.getInstance(document.getElementById('addCustomerModal')).hide();
                document.getElementById('addCustomerForm').reset();
                Swal.fire('نجاح', 'تم إضافة الزبون بنجاح!', 'success');
            };
            request.onerror = (e) => Swal.fire('خطأ', `فشل في إضافة الزبون: ${e.target.error}`, 'error');
        }

        async function editCustomer(customerId) {
            try {
                await ensureDBInitialized();
                const transaction = db.transaction(['customers'], 'readonly');
                const store = transaction.objectStore('customers');
                const request = store.get(customerId);

                request.onsuccess = () => {
                    const customer = request.result;
                    if (!customer) {
                        Swal.fire('خطأ', 'الزبون غير موجود!', 'error');
                        return;
                    }
                    document.getElementById('editCustomerId').value = customer.id;
                    document.getElementById('editCustomerName').value = customer.name || '';
                    document.getElementById('editCustomerPhone').value = customer.phone || '';
                    document.getElementById('editCustomerAddress').value = customer.address || '';
                    new bootstrap.Modal(document.getElementById('editCustomerModal')).show();
                };
                request.onerror = (e) => Swal.fire('خطأ', `فشل في جلب بيانات الزبون: ${e.target.error}`, 'error');
            } catch (dbError) {
                 Swal.fire('خطأ قاعدة البيانات', `فشل: ${dbError.message}`, 'error');
            }
        }

        async function updateCustomer() {
            const id = document.getElementById('editCustomerId').value;
            const name = document.getElementById('editCustomerName').value.trim();
            const phone = document.getElementById('editCustomerPhone').value.trim();
            const address = document.getElementById('editCustomerAddress').value.trim();

             if (!name && !phone && !address) {
                 Swal.fire('خطأ', 'يجب إدخال معلومة واحدة على الأقل للزبون.', 'error');
                 return;
            }

            if (phone) { 
                const customers = await getAllCustomers();
                if (customers.some(c => c.id !== id && c.phone === phone && phone !== '')) { 
                    Swal.fire('خطأ', 'رقم الهاتف هذا مُسجل لزبون آخر!', 'error');
                    return;
                }
            }

            const customer = { 
                id, 
                name: name || null, 
                phone: phone || null, 
                address: address || null 
            };
            const transaction = db.transaction(['customers'], 'readwrite');
            const store = transaction.objectStore('customers');
            const request = store.put(customer);

            request.onsuccess = async () => {
                await updateCustomersTable();
                await updateInvoicesTable(); // Refresh invoices in case customer name changed
                await populateCustomerSelect('invoiceCustomer');
                await populateCustomerSelect('editInvoiceCustomer');
                await populateCustomerSelect('statementCustomer');
                bootstrap.Modal.getInstance(document.getElementById('editCustomerModal')).hide();
                Swal.fire('نجاح', 'تم تعديل بيانات الزبون بنجاح!', 'success');
            };
            request.onerror = (e) => Swal.fire('خطأ', `فشل في تعديل بيانات الزبون: ${e.target.error}`, 'error');
        }

        async function deleteCustomer(customerId) {
            const invoices = await getAllInvoices();
            if (invoices.some(i => i.customerId === customerId)) {
                Swal.fire('لا يمكن الحذف', 'لا يمكن حذف هذا الزبون لأنه مرتبط بفواتير حالية. يرجى تعديل الفواتير المرتبطة به لزبون آخر أو حذفها (إذا كانت هذه الإمكانية متاحة).', 'error');
                return;
            }


            const result = await Swal.fire({
                title: 'تأكيد الحذف',
                text: 'هل أنت متأكد من حذف هذا الزبون؟ لا يمكن التراجع عن هذا الإجراء.',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'نعم، احذف',
                cancelButtonText: 'إلغاء',
                confirmButtonColor: '#dc3545'
            });

            if (result.isConfirmed) {
                const transaction = db.transaction(['customers'], 'readwrite');
                const store = transaction.objectStore('customers');
                const request = store.delete(customerId);

                request.onsuccess = async () => {
                    await updateCustomersTable();
                    await populateCustomerSelect('invoiceCustomer');
                    await populateCustomerSelect('editInvoiceCustomer');
                    await populateCustomerSelect('statementCustomer');
                    Swal.fire('نجاح', 'تم حذف الزبون بنجاح!', 'success');
                };
                request.onerror = (e) => Swal.fire('خطأ', `فشل في حذف الزبون: ${e.target.error}`, 'error');
            }
        }
        
        async function printInvoice(invoiceId) {
            try {
                await ensureDBInitialized();
                const transaction = db.transaction(['invoices', 'customers'], 'readonly');
                const invoiceStore = transaction.objectStore('invoices');
                const invoiceRequest = invoiceStore.get(invoiceId);

                invoiceRequest.onsuccess = async () => {
                    const invoice = invoiceRequest.result;
                    if (!invoice) { Swal.fire('خطأ', 'الفاتورة غير موجودة.', 'error'); return; }

                    const customers = await getAllCustomers(); 
                    const customer = customers.find(c => c.id === invoice.customerId);
                    
                    const printWindow = window.open('', '_blank', 'height=800,width=600');
                    if (!printWindow) {
                         Swal.fire('خطأ', 'فشل فتح نافذة الطباعة. يرجى التأكد من تعطيل مانع النوافذ المنبثقة.', 'error'); return;
                    }
                    printWindow.document.write(`
                        <!DOCTYPE html>
                        <html lang="ar" dir="rtl">
                        <head>
                            <meta charset="UTF-8">
                            <title>فاتورة رقم: ${invoice.id}</title>
                            <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
                            <style>
                                @page { size: A5 landscape; margin: 5mm; }
                                body { font-family: 'Cairo', sans-serif; direction: rtl; margin: 5mm; font-size: 10pt; }
                                .container { width: 100%; margin: 0 auto; }
                                .header-print { text-align: center; margin-bottom: 10px; border-bottom: 1px solid #ccc; padding-bottom: 5px;}
                                .header-print img { max-height: 40px; margin-bottom: 3px; }
                                .header-print h1 { font-size: 1.1rem; color: #3F2A56; margin:0; }
                                .invoice-info-grid { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px;}
                                .invoice-details-text { flex-basis: 70%;} 
                                .invoice-details, .customer-details { font-size: 0.85rem;}
                                .invoice-details p, .customer-details p { margin: 2px 0; }
                                .qr-code-container { 
                                    flex-basis: auto; /* Adjust to content */
                                    min-width: 75px; 
                                    text-align: center; /* Center the QR code if div is wider */
                                    padding-left: 5px; 
                                } 
                                #invoiceQrCodeElement { /* The div where QR will be generated */
                                    display: inline-block; /* Helps with sizing and centering */
                                }
                                #invoiceQrCodeElement canvas,
                                #invoiceQrCodeElement img {
                                    border: 1px solid #eee; /* Add border to the QR itself */
                                }
                                .products-table { width: 100%; border-collapse: collapse; margin-bottom: 8px; }
                                .products-table th, .products-table td { padding: 4px; border: 1px solid #ccc; text-align: center; font-size: 0.8rem;}
                                .products-table th { background-color: #f2f2f2; color: #333; font-weight:600; }
                                .totals-section { margin-top: 10px; padding-top: 8px; border-top: 1px solid #ccc; text-align:left; font-size: 0.85rem;}
                                .totals-section p { margin: 3px 0; font-weight: 600; }
                                .footer-print { text-align: center; font-size: 0.75rem; margin-top: 15px; color: #777; }
                                @media print {
                                    body { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
                                }
                            </style>
                        </head>
                        <body>
                            <div class="container">
                                <div class="header-print">
                                    <img src="logo.png" alt="شعار" onerror="this.style.display='none';">
                                    <h1>طيبة المدينة تلكوم</h1>
                                    <p style="font-size:0.7rem;"><!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>بيع المنتجات</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!-- QR Code Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode@2.0.9/dist/html5-qrcode.min.js"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Cairo', sans-serif;
            background: linear-gradient(135deg, #f0f2f5, #d9e2ec);
            color: #333;
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .home-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: linear-gradient(90deg, #3F2A56, #5a3f73);
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            text-decoration: none;
            font-size: 1rem;
            font-weight: 600;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            transition: transform 0.2s ease, background 0.3s ease, box-shadow 0.3s ease;
            position: absolute;
            top: 20px;
            left: 20px;
        }
        .home-btn:hover {
            background: linear-gradient(90deg, #5a3f73, #3F2A56);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
        }
        .header {
            background: linear-gradient(135deg, #3F2A56, #5a3f73);
            color: white;
            padding: 40px 20px;
            border-radius: 25px;
            text-align: center;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
            margin-bottom: 30px;
            position: relative;
            z-index: 1;
            border: 2px solid rgba(255, 255, 255, 0.1);
        }
        .header img {
            height: 90px;
            margin-bottom: 15px;
            filter: drop-shadow(0 3px 6px rgba(0, 0, 0, 0.3));
        }
        .header h2 {
            font-size: 2.2rem;
            margin-bottom: 10px;
            font-weight: 700;
        }
        .header h4 {
            font-size: 1.4rem;
            opacity: 0.9;
            font-weight: 400;
        }
        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        .card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: #3F2A56;
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            text-align: center;
            transition: transform 0.3s ease;
        }
        .card:hover {
            transform: translateY(-10px);
        }
        .card i {
            font-size: 2.8rem;
            margin-bottom: 15px;
            color: #3F2A56;
        }
        .card h5 {
            font-size: 1.3rem;
            margin-bottom: 10px;
            font-weight: 600;
        }
        .card h3 {
            font-size: 1.8rem;
            font-weight: 700;
        }
        .section {
            background: white;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
            padding: 20px;
            margin: 20px 0;
        }
        .section h3 {
            font-size: 1.7rem;
            font-weight: 700;
            color: #3F2A56;
            margin-bottom: 15px;
            text-align: center;
        }
        .table-container {
            overflow-x: auto;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            padding: 12px;
            text-align: center;
            border-bottom: 1px solid #e0e0e0;
        }
        th {
            background: linear-gradient(90deg, #3F2A56, #5a3f73);
            color: white;
            font-weight: 700;
        }
        td {
            color: #3F2A56;
        }
        tr:hover {
            background-color: #f7f9fc;
        }
        .actions {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin: 25px 0;
            justify-content: center;
        }
        .btn {
            background: linear-gradient(90deg, #3F2A56, #5a3f73);
            color: white;
            padding: 12px 24px;
            border-radius: 30px;
            border: none;
            font-size: 1rem;
            cursor: pointer;
            transition: transform 0.2s ease, background 0.3s ease, box-shadow 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .btn:hover {
            background: linear-gradient(90deg, #5a3f73, #3F2A56);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.2);
        }
        .search-container {
            margin-bottom: 20px;
            display: flex;
            justify-content: center;
            align-items: flex-end; /* Align items to bottom for button */
            gap: 15px;
            flex-wrap: wrap;
        }
        .filter-group {
            display: flex;
            flex-direction: column;
            max-width: 200px;
        }
        .filter-group label {
            font-size: 0.9rem;
            font-weight: 600;
            color: #3F2A56;
            margin-bottom: 5px;
        }
        .filter-group input, .filter-group select {
            padding: 12px;
            border-radius: 30px;
            border: none;
            background: rgba(255, 255, 255, 0.1);
            color: #3F2A56;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        .filter-group input:focus, .filter-group select:focus {
            outline: none;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2);
        }
        #scanQrBtn {
            padding: 10px 15px; /* Adjust padding */
            height: 46px; /* Match input height */
            border-radius: 30px;
        }
         #qr-reader-container {
            margin-top: 10px;
            border: 1px solid #ccc;
            border-radius: 10px;
            padding:10px;
            background-color: #f9f9f9;
        }
        #qr-reader {
            width: 100%;
            max-width: 400px; /* Adjust as needed */
            margin: 0 auto;
        }

        .action-btn {
            cursor: pointer;
            margin: 0 6px;
            font-size: 1.3rem;
            transition: color 0.3s ease;
        }
        .action-btn.edit:hover { color: #007bff; }
        /* .action-btn.delete:hover { color: #dc3545; } */ /* Delete button removed from UI */
        .action-btn.print:hover { color: #28a745; }

        .modal-content {
            border-radius: 20px;
            background: linear-gradient(145deg, #ffffff, #f7f9fc);
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }
        .modal-header {
            background: linear-gradient(90deg, #3F2A56, #5a3f73);
            color: white;
            border-top-left-radius: 20px;
            border-top-right-radius: 20px;
            padding: 20px;
        }
        .modal-title {
            font-size: 1.5rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .modal-body {
            padding: 30px;
        }
        .modal-body .form-label {
            font-weight: 600;
            color: #3F2A56;
        }
        .modal-body .form-control, .modal-body .form-select {
            border-radius: 15px;
            padding: 12px;
            background: #f7f9fc;
            border: 1px solid #ddd;
        }
         .modal-body .form-control:focus, .modal-body .form-select:focus {
            border-color: #3F2A56;
            box-shadow: 0 0 0 0.25rem rgba(63, 42, 86, 0.25);
        }
        .modal-footer {
            padding: 20px;
            background: #f8f9fa;
            border-bottom-left-radius: 20px;
            border-bottom-right-radius: 20px;
        }
        .modal-footer .btn {
            padding: 12px 30px;
        }
        .product-table th, .product-table td {
            padding: 8px;
        }
        .modal-body .product-table th { /* Change header text color in modal product tables */
            color: white;
             background: linear-gradient(90deg, #3F2A56, #5a3f73); /* Optional: match main table header */
        }
        .status-paid { color: #198754; font-weight: 700; }
        .status-partial { color: #ffc107; font-weight: 700; }
        .status-unpaid { color: #dc3545; font-weight: 700; }
        .swal2-popup {
            font-family: 'Cairo', sans-serif !important;
            border-radius: 15px !important;
        }
        .swal2-title { color: #3F2A56 !important; }
        .swal2-html-container { text-align: right !important; }
        .swal2-confirm {
            background: linear-gradient(90deg, #3F2A56, #5a3f73) !important;
            border-radius: 20px !important;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2) !important;
        }
        .swal2-cancel, .swال2-deny {
            background: linear-gradient(90deg, #6c757d, #5a6268) !important;
            border-radius: 20px !important;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2) !important;
        }
        #productSuggestions div, #editProductSuggestions div {
            padding: 8px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        #productSuggestions div:hover, #editProductSuggestions div:hover {
            background-color: #f0f0f0;
        }

        @media (max-width: 768px) {
            .header { padding: 25px 15px; }
            .header img { height: 70px; }
            .header h2 { font-size: 1.7rem; }
            .btn { padding: 10px 18px; font-size: 0.9rem; }
            th, td { padding: 10px; font-size: 0.9rem; }
            .modal-body { padding: 20px; }
            .search-container { flex-direction: column; align-items: stretch;}
            .filter-group { max-width: none; }
            #scanQrBtn { width: 100%; margin-top: 10px;}
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <img src="logo.png" alt="شعار طيبة المدينة تلكوم" onerror="this.src='https://via.placeholder.com/90?text=Logo'; this.style.display='none';">
            <h2>طيبة المدينة تلكوم</h2>
            <h4>بيع المنتجات</h4>
            <a href="home.html" class="home-btn"><i class="fas fa-home"></i> للرئيسية</a>
        </div>
        <div class="dashboard">
            <div class="card">
                <i class="fas fa-check-circle"></i>
                <h5>الفواتير المدفوعة</h5>
                <h3 id="paidInvoices">0</h3>
            </div>
            <div class="card">
                <i class="fas fa-exclamation-circle"></i>
                <h5>الفواتير المدفوعة جزئيًا</h5>
                <h3 id="partialInvoices">0</h3>
            </div>
            <div class="card">
                <i class="fas fa-times-circle"></i>
                <h5>الفواتير غير المدفوعة</h5>
                <h3 id="unpaidInvoices">0</h3>
            </div>
        </div>
        <div class="actions">
            <button class="btn" data-bs-toggle="modal" data-bs-target="#addInvoiceModal"><i class="fas fa-plus"></i> إضافة فاتورة</button>
            <button class="btn" data-bs-toggle="modal" data-bs-target="#addCustomerModal"><i class="fas fa-user-plus"></i> إضافة زبون</button>
            <button class="btn" data-bs-toggle="modal" data-bs-target="#customerStatementModal"><i class="fas fa-file-alt"></i> كشف حساب زبون</button>
        </div>
        <div class="section">
            <h3>الفواتير</h3>
            <div class="search-container">
                <div class="filter-group">
                    <label for="searchInput">البحث</label>
                    <input type="text" id="searchInput" placeholder="ابحث بالزبون أو معرف الفاتورة" oninput="filterTable()">
                </div>
                <button id="scanQrBtn" class="btn btn-info" title="مسح QR Code للبحث عن فاتورة"><i class="fas fa-qrcode"></i> مسح</button>
                <div class="filter-group">
                    <label for="statusFilter">حالة الفاتورة</label>
                    <select id="statusFilter" onchange="filterTable()">
                        <option value="all">الكل</option>
                        <option value="paid">مدفوع</option>
                        <option value="partial">مدفوع جزئيًا</option>
                        <option value="unpaid">لم يتم الدفع</option>
                    </select>
                </div>
            </div>
             <div id="qr-reader-container" style="display: none;">
                <div id="qr-reader"></div>
                <button id="closeScannerBtn" class="btn btn-sm btn-danger mt-2" style="display:block; margin: 0 auto;">إغلاق الماسح</button>
            </div>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>معرف الفاتورة</th>
                            <th>الزبون</th>
                            <th>رقم الهاتف</th>
                            <th>المبلغ الكلي</th>
                            <th>حالة الفاتورة</th>
                            <th>الإجراءات</th>
                        </tr>
                    </thead>
                    <tbody id="invoicesTable"></tbody>
                </table>
            </div>
        </div>
        <div class="section">
            <h3>إدارة الزبائن</h3>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>الاسم</th>
                            <th>رقم الهاتف</th>
                            <th>العنوان</th>
                            <th>الإجراءات</th>
                        </tr>
                    </thead>
                    <tbody id="customersTable"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- نافذة إضافة فاتورة -->
    <div class="modal fade" id="addInvoiceModal" tabindex="-1" aria-labelledby="addInvoiceModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addInvoiceModalLabel"><i class="fas fa-file-invoice-dollar"></i> إضافة فاتورة جديدة</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="addInvoiceForm">
                        <div class="mb-3">
                            <label for="invoiceCustomer" class="form-label"><i class="fas fa-user"></i> الزبون</label>
                            <select class="form-select" id="invoiceCustomer" required>
                                <option value="">اختر زبونًا</option>
                            </select>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="customerPhoneDisplay" class="form-label"><i class="fas fa-phone"></i> رقم الهاتف</label>
                                <input type="text" class="form-control" id="customerPhoneDisplay" readonly>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="customerAddressDisplay" class="form-label"><i class="fas fa-map-marker-alt"></i> العنوان</label>
                                <input type="text" class="form-control" id="customerAddressDisplay" readonly>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="productSearch" class="form-label"><i class="fas fa-search"></i> البحث عن منتج</label>
                            <input type="text" class="form-control" id="productSearch" placeholder="ابحث بالاسم أو المعرف">
                            <div id="productSuggestions" class="mt-2 list-group" style="max-height: 150px; overflow-y: auto;"></div>
                        </div>
                        <h5><i class="fas fa-boxes"></i> المنتجات</h5>
                        <div class="table-container">
                            <table class="product-table table">
                                <thead>
                                    <tr>
                                        <th>اسم المنتج</th>
                                        <th>سعر البيع</th>
                                        <th>الكمية</th>
                                        <th>الملاحظة</th>
                                        <th>الإجمالي</th>
                                        <th>الإجراءات</th>
                                    </tr>
                                </thead>
                                <tbody id="invoiceProducts"></tbody>
                            </table>
                        </div>
                        <div class="mt-3">
                            <p><strong><i class="fas fa-calendar-alt"></i> التاريخ:</strong> <span id="invoiceDate"></span></p>
                            <p><strong><i class="fas fa-hashtag"></i> عدد المواد:</strong> <span id="totalItems">0</span></p>
                            <p><strong><i class="fas fa-coins"></i> المجموع الكلي:</strong> <span id="totalAmount">0.00</span></p>
                            <div class="mb-3">
                                <label for="amountPaid" class="form-label"><i class="fas fa-money-bill-wave"></i> المبلغ المدفوع</label>
                                <input type="number" class="form-control" id="amountPaid" step="0.01" min="0" value="0">
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
                    <button type="button" class="btn btn-primary" onclick="addInvoice()">حفظ الفاتورة</button>
                </div>
            </div>
        </div>
    </div>

    <!-- نافذة تعديل فاتورة -->
    <div class="modal fade" id="editInvoiceModal" tabindex="-1" aria-labelledby="editInvoiceModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editInvoiceModalLabel"><i class="fas fa-edit"></i> تعديل فاتورة</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="editInvoiceForm">
                        <input type="hidden" id="editInvoiceId">
                        <div class="mb-3">
                            <label for="editInvoiceCustomer" class="form-label"><i class="fas fa-user"></i> الزبون</label>
                            <select class="form-select" id="editInvoiceCustomer" required>
                                <option value="">اختر زبونًا</option>
                            </select>
                        </div>
                         <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="editCustomerPhoneDisplay" class="form-label"><i class="fas fa-phone"></i> رقم الهاتف</label>
                                <input type="text" class="form-control" id="editCustomerPhoneDisplay" readonly>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="editCustomerAddressDisplay" class="form-label"><i class="fas fa-map-marker-alt"></i> العنوان</label>
                                <input type="text" class="form-control" id="editCustomerAddressDisplay" readonly>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="editProductSearch" class="form-label"><i class="fas fa-search"></i> البحث عن منتج</label>
                            <input type="text" class="form-control" id="editProductSearch" placeholder="ابحث بالاسم أو المعرف">
                            <div id="editProductSuggestions" class="mt-2 list-group" style="max-height: 150px; overflow-y: auto;"></div>
                        </div>
                        <h5><i class="fas fa-boxes"></i> المنتجات</h5>
                        <div class="table-container">
                            <table class="product-table table">
                                <thead>
                                    <tr>
                                        <th>اسم المنتج</th>
                                        <th>سعر البيع</th>
                                        <th>الكمية</th>
                                        <th>الملاحظة</th>
                                        <th>الإجمالي</th>
                                        <th>الإجراءات</th>
                                    </tr>
                                </thead>
                                <tbody id="editInvoiceProducts"></tbody>
                            </table>
                        </div>
                        <div class="mt-3">
                            <p><strong><i class="fas fa-calendar-alt"></i> التاريخ:</strong> <span id="editInvoiceDate"></span></p>
                            <p><strong><i class="fas fa-hashtag"></i> عدد المواد:</strong> <span id="editTotalItems">0</span></p>
                            <p><strong><i class="fas fa-coins"></i> المجموع الكلي:</strong> <span id="editTotalAmount">0.00</span></p>
                            <div class="mb-3">
                                <label for="editAmountPaid" class="form-label"><i class="fas fa-money-bill-wave"></i> المبلغ المدفوع</label>
                                <input type="number" class="form-control" id="editAmountPaid" step="0.01" min="0" value="0">
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
                    <button type="button" class="btn btn-primary" onclick="updateInvoice()">حفظ التعديلات</button>
                </div>
            </div>
        </div>
    </div>

    <!-- نافذة إضافة زبون -->
    <div class="modal fade" id="addCustomerModal" tabindex="-1" aria-labelledby="addCustomerModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addCustomerModalLabel"><i class="fas fa-user-plus"></i> إضافة زبون</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="addCustomerForm">
                        <div class="mb-3">
                            <label for="customerName" class="form-label"><i class="fas fa-signature"></i> اسم الزبون (اختياري)</label>
                            <input type="text" class="form-control" id="customerName">
                        </div>
                        <div class="mb-3">
                            <label for="customerPhone" class="form-label"><i class="fas fa-mobile-alt"></i> رقم الهاتف (اختياري)</label>
                            <input type="tel" class="form-control" id="customerPhone">
                        </div>
                        <div class="mb-3">
                            <label for="customerAddress" class="form-label"><i class="fas fa-home"></i> العنوان (اختياري)</label>
                            <input type="text" class="form-control" id="customerAddress">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
                    <button type="button" class="btn btn-primary" onclick="addCustomer()">حفظ الزبون</button>
                </div>
            </div>
        </div>
    </div>

    <!-- نافذة تعديل زبون -->
    <div class="modal fade" id="editCustomerModal" tabindex="-1" aria-labelledby="editCustomerModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editCustomerModalLabel"><i class="fas fa-user-edit"></i> تعديل زبون</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="editCustomerForm">
                        <input type="hidden" id="editCustomerId">
                        <div class="mb-3">
                            <label for="editCustomerName" class="form-label"><i class="fas fa-signature"></i> اسم الزبون (اختياري)</label>
                            <input type="text" class="form-control" id="editCustomerName">
                        </div>
                        <div class="mb-3">
                            <label for="editCustomerPhone" class="form-label"><i class="fas fa-mobile-alt"></i> رقم الهاتف (اختياري)</label>
                            <input type="tel" class="form-control" id="editCustomerPhone">
                        </div>
                        <div class="mb-3">
                            <label for="editCustomerAddress" class="form-label"><i class="fas fa-home"></i> العنوان (اختياري)</label>
                            <input type="text" class="form-control" id="editCustomerAddress">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
                    <button type="button" class="btn btn-primary" onclick="updateCustomer()">حفظ التعديلات</button>
                </div>
            </div>
        </div>
    </div>

    <!-- نافذة كشف حساب زبون -->
    <div class="modal fade" id="customerStatementModal" tabindex="-1" aria-labelledby="customerStatementModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="customerStatementModalLabel"><i class="fas fa-file-invoice"></i> كشف حساب زبون</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="customerStatementForm">
                        <div class="mb-3">
                            <label for="statementCustomer" class="form-label"><i class="fas fa-user-check"></i> الزبون</label>
                            <select class="form-select" id="statementCustomer" required>
                                <option value="">اختر زبونًا</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="startDate" class="form-label"><i class="fas fa-calendar-day"></i> من تاريخ</label>
                            <input type="date" class="form-control" id="startDate" required>
                        </div>
                        <div class="mb-3">
                            <label for="endDate" class="form-label"><i class="fas fa-calendar-day"></i> إلى تاريخ</label>
                            <input type="date" class="form-control" id="endDate" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
                    <button type="button" class="btn btn-primary" onclick="generateCustomerStatement()">إنشاء الكشف</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let db;
        let html5QrCodeScanner; // For QR Code scanner instance

        // Helper function to format date as DD-MM-YYYY HH:MM
        function formatDateForDisplay(isoString) {
            if (!isoString) return 'N/A';
            const date = new Date(isoString);
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0'); // Months are 0-indexed
            const year = date.getFullYear();
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            return `${day}-${month}-${year} ${hours}:${minutes}`;
        }


        // إعداد IndexedDB
        function initDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open('InventoryDB', 2); 
                request.onupgradeneeded = (event) => {
                    db = event.target.result;
                    if (!db.objectStoreNames.contains('products')) {
                        db.createObjectStore('products', { keyPath: 'id' });
                    }
                    if (!db.objectStoreNames.contains('invoices')) {
                        const invoiceStore = db.createObjectStore('invoices', { keyPath: 'id' });
                        invoiceStore.createIndex('customerId', 'customerId', { unique: false });
                    }
                    if (!db.objectStoreNames.contains('customers')) {
                        const customerStore = db.createObjectStore('customers', { keyPath: 'id' });
                        customerStore.createIndex('phone', 'phone', { unique: false }); 
                    }
                };
                request.onsuccess = (event) => {
                    db = event.target.result;
                    resolve(db);
                };
                request.onerror = (event) => {
                    console.error("Database error: " + event.target.errorCode);
                    reject(event.target.error);
                };
            });
        }
        
        async function ensureDBInitialized() {
            if (!db) {
                try {
                    await initDB();
                } catch (error) {
                    console.error('Failed to initialize database:', error);
                    throw new Error('Failed to initialize database: ' + error.message);
                }
            }
            if (!db) { 
                throw new Error('Database not ready after initialization attempt.');
            }
        }

        async function generateUniqueId(storeName) {
            await ensureDBInitialized();
            let id;
            let isUnique = false;
            const existingIds = await getAllIds(storeName); 
            while (!isUnique) {
                id = Math.floor(10000 + Math.random() * 90000).toString();
                isUnique = !existingIds.includes(id);
            }
            return id;
        }

        function getAllIds(storeName) {
            return new Promise(async (resolve, reject) => {
                try {
                    await ensureDBInitialized();
                    const transaction = db.transaction([storeName], 'readonly');
                    const store = transaction.objectStore(storeName);
                    const request = store.getAllKeys(); 
                    request.onsuccess = () => {
                        resolve(request.result);
                    };
                    request.onerror = (event) => reject(event.target.error);
                } catch (error) {
                    reject(error);
                }
            });
        }

        function getAllProducts() {
            return new Promise(async (resolve, reject) => {
                try {
                    await ensureDBInitialized();
                    const transaction = db.transaction(['products'], 'readonly');
                    const store = transaction.objectStore('products');
                    const request = store.getAll();
                    request.onsuccess = () => resolve(request.result || []);
                    request.onerror = (event) => reject(event.target.error);
                } catch (error) {
                    reject(error);
                }
            });
        }
        
        function checkProductExists(productId) {
            return new Promise(async (resolve) => {
                try {
                    await ensureDBInitialized();
                    const transaction = db.transaction(['products'], 'readonly');
                    const store = transaction.objectStore('products');
                    const request = store.get(productId);
                    request.onsuccess = () => resolve(!!request.result); // True if product exists
                    request.onerror = () => resolve(false); // Error, assume not exists
                } catch (e) { resolve(false); }
            });
        }


        function getAllInvoices() {
            return new Promise(async (resolve, reject) => {
                try {
                    await ensureDBInitialized();
                    const transaction = db.transaction(['invoices'], 'readonly');
                    const store = transaction.objectStore('invoices');
                    const request = store.getAll();
                    request.onsuccess = () => resolve(request.result || []);
                    request.onerror = (event) => reject(event.target.error);
                } catch (error) {
                    reject(error);
                }
            });
        }

        function getAllCustomers() {
            return new Promise(async (resolve, reject) => {
                try {
                    await ensureDBInitialized();
                    const transaction = db.transaction(['customers'], 'readonly');
                    const store = transaction.objectStore('customers');
                    const request = store.getAll();
                    request.onsuccess = () => resolve(request.result || []);
                    request.onerror = (event) => reject(event.target.error);
                } catch (error) {
                    reject(error);
                }
            });
        }

        async function updateDashboard() {
            const invoices = await getAllInvoices();
            const paid = invoices.filter(i => parseFloat(i.amountPaid) >= parseFloat(i.totalAmount) && parseFloat(i.totalAmount) > 0).length;
            const partial = invoices.filter(i => parseFloat(i.amountPaid) > 0 && parseFloat(i.amountPaid) < parseFloat(i.totalAmount)).length;
            const unpaid = invoices.filter(i => parseFloat(i.amountPaid) === 0 && parseFloat(i.totalAmount) > 0).length;


            document.getElementById('paidInvoices').innerText = paid;
            document.getElementById('partialInvoices').innerText = partial;
            document.getElementById('unpaidInvoices').innerText = unpaid;
        }

        async function updateInvoicesTable() {
            const invoices = await getAllInvoices();
            const customers = await getAllCustomers();
            const tableBody = document.getElementById('invoicesTable');
            tableBody.innerHTML = '';

            invoices.sort((a, b) => new Date(b.date) - new Date(a.date)); 

            invoices.forEach((invoice, index) => {
                const customer = customers.find(c => c.id === invoice.customerId);
                const totalAmount = parseFloat(invoice.totalAmount);
                const amountPaid = parseFloat(invoice.amountPaid);
                let statusClass, statusText;

                if (totalAmount === 0 && amountPaid === 0) { // Consider invoices with 0 total and 0 paid (e.g. returns or empty)
                    statusClass = ''; // No specific class or a 'neutral' class
                    statusText = 'لا يوجد مبلغ';
                } else if (amountPaid >= totalAmount) {
                    statusClass = 'status-paid';
                    statusText = 'مدفوع';
                } else if (amountPaid > 0) {
                    statusClass = 'status-partial';
                    statusText = 'مدفوع جزئيًا';
                } else { // amountPaid is 0 and totalAmount > 0
                    statusClass = 'status-unpaid';
                    statusText = 'لم يتم الدفع';
                }


                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${invoice.id}</td>
                    <td>${customer?.name || 'زبون محذوف/غير معروف'}</td>
                    <td>${customer?.phone || '-'}</td>
                    <td>${totalAmount.toFixed(2)}</td>
                    <td class="${statusClass}">${statusText}</td>
                    <td>
                        <i class="fas fa-print action-btn print" onclick="printInvoice('${invoice.id}')" title="طباعة"></i>
                        <i class="fas fa-edit action-btn edit" onclick="editInvoice('${invoice.id}')" title="تعديل"></i>
                        <!-- Delete button removed from UI as requested -->
                    </td>
                `;
                tableBody.appendChild(row);
            });
            updateDashboard(); // Update dashboard after table is updated
            // filterTable(); // Call filterTable if you want to apply existing filters immediately after refresh
        }

        async function updateCustomersTable() {
            const customers = await getAllCustomers();
            const tableBody = document.getElementById('customersTable');
            tableBody.innerHTML = '';

            customers.forEach((customer, index) => {
                const row = document.createElement('tr');
                const displayName = customer.name || 'زبون بدون اسم';
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${displayName}</td>
                    <td>${customer.phone || '-'}</td>
                    <td>${customer.address || '-'}</td>
                    <td>
                        <i class="fas fa-edit action-btn edit" onclick="editCustomer('${customer.id}')" title="تعديل"></i>
                        <i class="fas fa-trash action-btn delete" onclick="deleteCustomer('${customer.id}')" title="حذف"></i>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }

        async function filterTable() {
            const searchInput = document.getElementById('searchInput').value.toLowerCase();
            const statusFilter = document.getElementById('statusFilter').value;
            const invoices = await getAllInvoices(); // Fetch fresh list
            const customers = await getAllCustomers(); // Fetch fresh list
            const tableBody = document.getElementById('invoicesTable');
            
            const filteredInvoices = invoices.filter(invoice => {
                const customer = customers.find(c => c.id === invoice.customerId);
                const customerName = customer?.name?.toLowerCase() || '';
                const matchesSearch = customerName.includes(searchInput) || invoice.id.includes(searchInput);
                
                if (!matchesSearch) return false;

                const totalAmount = parseFloat(invoice.totalAmount);
                const amountPaid = parseFloat(invoice.amountPaid);

                if (statusFilter === 'all') return true;
                if (statusFilter === 'paid') return amountPaid >= totalAmount && totalAmount > 0; // Ensure total > 0 for 'paid'
                if (statusFilter === 'partial') return amountPaid > 0 && amountPaid < totalAmount;
                if (statusFilter === 'unpaid') return amountPaid === 0 && totalAmount > 0; // Ensure total > 0 for 'unpaid'
                
                // This case should ideally not be reached if statusFilter has a valid value from the dropdown.
                // If it's reached, it means an unknown filter value, so include the item.
                return true; 
            });

            tableBody.innerHTML = ''; 
            filteredInvoices.sort((a, b) => new Date(b.date) - new Date(a.date)); // Re-sort filtered results

            filteredInvoices.forEach((invoice, index) => {
                const customer = customers.find(c => c.id === invoice.customerId);
                const totalAmount = parseFloat(invoice.totalAmount);
                const amountPaid = parseFloat(invoice.amountPaid);
                let statusClass, statusText;

                 if (totalAmount === 0 && amountPaid === 0) {
                    statusClass = ''; statusText = 'لا يوجد مبلغ';
                } else if (amountPaid >= totalAmount) {
                    statusClass = 'status-paid'; statusText = 'مدفوع';
                } else if (amountPaid > 0) {
                    statusClass = 'status-partial'; statusText = 'مدفوع جزئيًا';
                } else {
                    statusClass = 'status-unpaid'; statusText = 'لم يتم الدفع';
                }

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${invoice.id}</td>
                    <td>${customer?.name || 'زبون محذوف/غير معروف'}</td>
                    <td>${customer?.phone || '-'}</td>
                    <td>${totalAmount.toFixed(2)}</td>
                    <td class="${statusClass}">${statusText}</td>
                    <td>
                        <i class="fas fa-print action-btn print" onclick="printInvoice('${invoice.id}')" title="طباعة"></i>
                        <i class="fas fa-edit action-btn edit" onclick="editInvoice('${invoice.id}')" title="تعديل"></i>
                    </td>
                `;
                tableBody.appendChild(row);
            });
            // No need to call updateDashboard here as it's called in updateInvoicesTable which is called by other functions.
            // However, if filterTable is called independently (e.g., on search input), then dashboard might need update based on filtered view, or just reflect all invoices.
            // For simplicity, let dashboard always reflect all invoices. It's updated by main table update functions.
        }


        async function populateCustomerSelect(selectElementId) {
            const customers = await getAllCustomers();
            const select = document.getElementById(selectElementId);
            const currentValue = select.value; // Preserve current selection if possible
            select.innerHTML = '<option value="">اختر زبونًا...</option>'; 
            customers.forEach(customer => {
                const option = document.createElement('option');
                option.value = customer.id;
                option.textContent = customer.name || `زبون (${customer.phone || 'معرف: ' + customer.id.slice(0,5)})`;
                select.appendChild(option);
            });
            if (currentValue) { // Attempt to restore selection
                 select.value = currentValue;
            }
        }

        async function updateCustomerInfo(selectElementId, phoneElementId, addressElementId) {
            const customerId = document.getElementById(selectElementId).value;
            const phoneInput = document.getElementById(phoneElementId);
            const addressInput = document.getElementById(addressElementId);

            if (customerId) {
                const customers = await getAllCustomers(); // Fetch fresh customer data
                const customer = customers.find(c => c.id === customerId);
                phoneInput.value = customer?.phone || '';
                addressInput.value = customer?.address || '';
            } else {
                phoneInput.value = '';
                addressInput.value = '';
            }
        }
        
        async function setupProductSearch(searchElementId, suggestionsElementId, productsTableId, isEditModal = false) {
            const searchInput = document.getElementById(searchElementId);
            const suggestionsDiv = document.getElementById(suggestionsElementId);
            
            searchInput.addEventListener('input', async (e) => {
                const query = e.target.value.toLowerCase().trim();
                suggestionsDiv.innerHTML = ''; 
                if (query.length < 1) return; 

                const allProducts = await getAllProducts();
                const availableProducts = allProducts.filter(p => p.quantity > 0); 
                
                const filteredProducts = availableProducts.filter(p => 
                    p.name.toLowerCase().includes(query) || 
                    p.id.includes(query)
                ).slice(0, 10); 

                if (filteredProducts.length > 0) {
                    filteredProducts.forEach(product => {
                        const div = document.createElement('div');
                        div.className = 'list-group-item list-group-item-action';
                        
                        const salePriceFormatted = parseFloat(product.salePrice || 0).toFixed(2);
                        
                        // --- MODIFICATION FOR costPrice ---
                        let costPriceFormatted;
                        if (typeof product.costPrice === 'number') { // Handles 0 as a valid cost price
                            costPriceFormatted = parseFloat(product.costPrice).toFixed(2);
                        } else if (product.costPrice && !isNaN(parseFloat(product.costPrice))) { // Handles string numbers
                            costPriceFormatted = parseFloat(product.costPrice).toFixed(2);
                        } else {
                            costPriceFormatted = 'غ/م'; // Not available or not a valid number
                        }
                        // --- END MODIFICATION ---
                        
                        div.innerHTML = `
                            <strong>${product.name}</strong> (المعرف: ${product.id}) <br>
                            <small>
                                سعر البيع: ${salePriceFormatted} | 
                                سعر الشراء: ${costPriceFormatted} | 
                                الكمية المتوفرة: ${product.quantity}
                            </small>
                        `;
                        div.onclick = () => {
                            addProductToInvoice(product, productsTableId);
                            searchInput.value = ''; 
                            suggestionsDiv.innerHTML = ''; 
                        };
                        suggestionsDiv.appendChild(div);
                    });
                } else {
                    suggestionsDiv.innerHTML = '<div class="list-group-item">لا توجد منتجات مطابقة أو غير متوفرة.</div>';
                }
            });
        }


        function addProductToInvoice(product, productsTableId) {
            const tableBody = document.getElementById(productsTableId);
            const existingRow = Array.from(tableBody.rows).find(row => row.dataset.productId === product.id);

            if (existingRow) {
                const quantityInput = existingRow.querySelector('.quantity');
                const currentQuantity = parseInt(quantityInput.value);
                if (currentQuantity < product.quantity) { 
                    quantityInput.value = currentQuantity + 1;
                } else {
                    Swal.fire('تنبيه', `الكمية المطلوبة للمنتج "${product.name}" تتجاوز المخزون المتاح (${product.quantity}).`, 'warning');
                    return;
                }
            } else {
                if (product.quantity < 1) { 
                     Swal.fire('تنبيه', `المنتج "${product.name}" غير متوفر في المخزون.`, 'warning');
                    return;
                }
                const row = tableBody.insertRow();
                row.dataset.productId = product.id; 
                
                row.innerHTML = `
                    <td>${product.name}</td>
                    <td><input type="number" class="form-control form-control-sm sale-price" value="${parseFloat(product.salePrice || 0).toFixed(2)}" step="0.01" min="0.01"></td>
                    <td><input type="number" class="form-control form-control-sm quantity" value="1" min="1" max="${product.quantity}"></td>
                    <td><input type="text" class="form-control form-control-sm note" placeholder="ملاحظة (اختياري)"></td>
                    <td class="total">${parseFloat(product.salePrice || 0).toFixed(2)}</td>
                    <td><button type="button" class="btn btn-sm btn-danger" onclick="removeProductFromInvoice(this.closest('tr'), '${productsTableId}')"><i class="fas fa-trash-alt"></i></button></td>
                `;
                row.querySelector('.sale-price').addEventListener('input', () => updateInvoiceTotals(productsTableId));
                row.querySelector('.quantity').addEventListener('input', (e) => {
                    const requestedQuantity = parseInt(e.target.value);
                    const maxQuantityForThisProduct = parseInt(e.target.max); // Use the max attribute of the input

                    if (requestedQuantity > maxQuantityForThisProduct) {
                        e.target.value = maxQuantityForThisProduct; 
                        Swal.fire('تنبيه', `الكمية المطلوبة للمنتج "${product.name}" تتجاوز المخزون المتاح (${maxQuantityForThisProduct}). تم التعديل للحد الأقصى.`, 'warning');
                    }
                    updateInvoiceTotals(productsTableId);
                });
            }
            updateInvoiceTotals(productsTableId);
        }


        function removeProductFromInvoice(rowElement, productsTableId) {
            rowElement.remove();
            updateInvoiceTotals(productsTableId);
        }

        function updateInvoiceTotals(productsTableId) {
            const tableBody = document.getElementById(productsTableId);
            const rows = tableBody.querySelectorAll('tr');
            let totalAmount = 0;
            let totalItemsCount = 0; 

            rows.forEach(row => {
                const salePriceInput = row.querySelector('.sale-price');
                const quantityInput = row.querySelector('.quantity');
                
                const salePrice = parseFloat(salePriceInput.value) || 0;
                const quantity = parseInt(quantityInput.value) || 0;
                
                const itemTotal = salePrice * quantity;
                row.querySelector('.total').textContent = itemTotal.toFixed(2);
                totalAmount += itemTotal;
                totalItemsCount++; 
            });

            const isEditModal = productsTableId === 'editInvoiceProducts';
            document.getElementById(isEditModal ? 'editTotalItems' : 'totalItems').textContent = totalItemsCount; 
            document.getElementById(isEditModal ? 'editTotalAmount' : 'totalAmount').textContent = totalAmount.toFixed(2);
        }

        async function addInvoice() {
            const customerId = document.getElementById('invoiceCustomer').value;
            const amountPaidValue = document.getElementById('amountPaid').value;
            const productsTable = document.getElementById('invoiceProducts');
            const rows = productsTable.querySelectorAll('tr');

            if (!customerId) {
                Swal.fire('خطأ', 'الرجاء اختيار زبون!', 'error'); return;
            }
            if (rows.length === 0) {
                Swal.fire('خطأ', 'الرجاء إضافة منتج واحد على الأقل للفاتورة!', 'error'); return;
            }
            const amountPaid = parseFloat(amountPaidValue);
            if (isNaN(amountPaid) || amountPaid < 0) {
                 Swal.fire('خطأ', 'المبلغ المدفوع غير صحيح!', 'error'); return;
            }

            const productsInInvoice = [];
            let totalAmount = 0;
            let stockUpdatePromises = [];

            for (const row of rows) {
                const productId = row.dataset.productId;
                const name = row.cells[0].textContent;
                const salePrice = parseFloat(row.querySelector('.sale-price').value);
                const quantitySold = parseInt(row.querySelector('.quantity').value);
                const note = row.querySelector('.note').value;
                const itemTotal = salePrice * quantitySold;

                if (isNaN(salePrice) || salePrice <=0 || isNaN(quantitySold) || quantitySold <=0) {
                    Swal.fire('خطأ', `بيانات غير صالحة للمنتج "${name}". تأكد من السعر والكمية.`, 'error'); return;
                }

                productsInInvoice.push({ productId, name, salePrice, quantity: quantitySold, note, total: itemTotal });
                totalAmount += itemTotal;
                stockUpdatePromises.push(updateProductStock(productId, quantitySold));
            }
             if (amountPaid > totalAmount) {
                Swal.fire('خطأ', 'المبلغ المدفوع لا يمكن أن يكون أكبر من المجموع الكلي للفاتورة!', 'error'); return;
            }

            try {
                await Promise.all(stockUpdatePromises); 
            } catch (error) {
                Swal.fire('خطأ في تحديث المخزون', error.message, 'error');
                return;
            }

            const id = await generateUniqueId('invoices');
            const invoice = {
                id,
                customerId,
                products: productsInInvoice,
                totalAmount: totalAmount.toFixed(2),
                amountPaid: amountPaid.toFixed(2),
                date: new Date().toISOString()
            };

            const transaction = db.transaction(['invoices'], 'readwrite');
            const store = transaction.objectStore('invoices');
            const request = store.add(invoice);

            request.onsuccess = async () => {
                await updateInvoicesTable(); // This also updates dashboard
                bootstrap.Modal.getInstance(document.getElementById('addInvoiceModal')).hide();
                document.getElementById('addInvoiceForm').reset();
                document.getElementById('invoiceProducts').innerHTML = ''; 
                document.getElementById('totalItems').textContent = '0';
                document.getElementById('totalAmount').textContent = '0.00';
                document.getElementById('customerPhoneDisplay').value = '';
                document.getElementById('customerAddressDisplay').value = '';
                document.getElementById('invoiceDate').textContent = formatDateForDisplay(new Date().toISOString()); // Reset date
                await populateCustomerSelect('invoiceCustomer'); 
                Swal.fire('نجاح', 'تم إضافة الفاتورة وتحديث المخزون بنجاح!', 'success');
            };
            request.onerror = (e) => {
                console.error("Error adding invoice:", e.target.error);
                Swal.fire('خطأ', 'فشل في إضافة الفاتورة!', 'error');
            };
        }
        
        function updateProductStock(productId, quantitySold) {
            return new Promise(async (resolve, reject) => {
                try {
                    await ensureDBInitialized();
                    const transaction = db.transaction(['products'], 'readwrite');
                    const store = transaction.objectStore('products');
                    const getRequest = store.get(productId);

                    getRequest.onsuccess = () => {
                        const product = getRequest.result;
                        if (!product) {
                            reject(new Error(`المنتج بالمعرف ${productId} غير موجود.`));
                            return;
                        }
                        if (product.quantity < quantitySold) {
                            reject(new Error(`الكمية المطلوبة للمنتج "${product.name}" (${quantitySold}) تتجاوز المخزون المتاح (${product.quantity}).`));
                            return;
                        }
                        product.quantity -= quantitySold;
                        const updateRequest = store.put(product);
                        updateRequest.onsuccess = () => resolve();
                        updateRequest.onerror = (e) => reject(new Error(`فشل تحديث مخزون المنتج ${product.name}: ${e.target.error}`));
                    };
                    getRequest.onerror = (e) => reject(new Error(`فشل جلب المنتج ${productId} لتحديث المخزون: ${e.target.error}`));
                } catch (dbError) {
                    reject(dbError);
                }
            });
        }


        async function editInvoice(invoiceId) {
            try {
                await ensureDBInitialized();
                const transaction = db.transaction(['invoices', 'customers', 'products'], 'readonly'); 
                const invoiceStore = transaction.objectStore('invoices');
                const invoiceRequest = invoiceStore.get(invoiceId);

                invoiceRequest.onsuccess = async () => {
                    const invoice = invoiceRequest.result;
                    if (!invoice) {
                        Swal.fire('خطأ', 'الفاتورة غير موجودة!', 'error');
                        return;
                    }
                    
                    document.getElementById('editInvoiceModal').dataset.originalProducts = JSON.stringify(invoice.products);
                    document.getElementById('editInvoiceId').value = invoice.id;
                    
                    const customerSelect = document.getElementById('editInvoiceCustomer');
                    await populateCustomerSelect('editInvoiceCustomer'); 
                    customerSelect.value = invoice.customerId;
                    await updateCustomerInfo('editInvoiceCustomer', 'editCustomerPhoneDisplay', 'editCustomerAddressDisplay');

                    document.getElementById('editInvoiceDate').textContent = formatDateForDisplay(invoice.date);
                    document.getElementById('editAmountPaid').value = parseFloat(invoice.amountPaid).toFixed(2);

                    const tableBody = document.getElementById('editInvoiceProducts');
                    tableBody.innerHTML = ''; 

                    const allProductsFromDB = await getAllProducts(); 

                    invoice.products.forEach(pInInvoice => {
                        const productDetailsFromDB = allProductsFromDB.find(pDB => pDB.id === pInInvoice.productId);
                        const currentStockInDB = productDetailsFromDB ? productDetailsFromDB.quantity : 0;
                        const maxQuantityForInput = currentStockInDB + pInInvoice.quantity;


                        const row = tableBody.insertRow();
                        row.dataset.productId = pInInvoice.productId;
                        row.dataset.originalQuantityInInvoice = pInInvoice.quantity; 
                        row.dataset.maxEditableQuantity = maxQuantityForInput;


                        row.innerHTML = `
                            <td>${pInInvoice.name}</td>
                            <td><input type="number" class="form-control form-control-sm sale-price" value="${parseFloat(pInInvoice.salePrice).toFixed(2)}" step="0.01" min="0.01"></td>
                            <td><input type="number" class="form-control form-control-sm quantity" value="${pInInvoice.quantity}" min="1" max="${maxQuantityForInput}"></td>
                            <td><input type="text" class="form-control form-control-sm note" value="${pInInvoice.note || ''}" placeholder="ملاحظة"></td>
                            <td class="total">${parseFloat(pInInvoice.total).toFixed(2)}</td>
                            <td><button type="button" class="btn btn-sm btn-danger" onclick="removeProductFromInvoice(this.closest('tr'), 'editInvoiceProducts')"><i class="fas fa-trash-alt"></i></button></td>
                        `;
                        row.querySelector('.sale-price').addEventListener('input', () => updateInvoiceTotals('editInvoiceProducts'));
                        row.querySelector('.quantity').addEventListener('input', (e) => {
                             const requestedQuantity = parseInt(e.target.value);
                             const maxAllowed = parseInt(e.target.max); 
                             if (requestedQuantity > maxAllowed) {
                                e.target.value = maxAllowed;
                                Swal.fire('تنبيه', `الكمية المطلوبة للمنتج "${pInInvoice.name}" تتجاوز المخزون المتاح. تم التعديل للحد الأقصى (${maxAllowed}).`, 'warning');
                            }
                            updateInvoiceTotals('editInvoiceProducts');
                        });
                    });

                    updateInvoiceTotals('editInvoiceProducts');
                    new bootstrap.Modal(document.getElementById('editInvoiceModal')).show();
                };
                invoiceRequest.onerror = (e) => Swal.fire('خطأ', `فشل في جلب الفاتورة: ${e.target.error}`, 'error');
            } catch (dbError) {
                 Swal.fire('خطأ قاعدة البيانات', `فشل: ${dbError.message}`, 'error');
            }
        }


        async function updateInvoice() {
            const id = document.getElementById('editInvoiceId').value;
            const customerId = document.getElementById('editInvoiceCustomer').value;
            const amountPaidValue = document.getElementById('editAmountPaid').value;
            const productsTable = document.getElementById('editInvoiceProducts');
            const rows = productsTable.querySelectorAll('tr');
            
            const originalProductsJSON = document.getElementById('editInvoiceModal').dataset.originalProducts;
            const originalProductsInInvoice = JSON.parse(originalProductsJSON || "[]"); 


            if (!customerId) { Swal.fire('خطأ', 'الرجاء اختيار زبون!', 'error'); return; }
            if (rows.length === 0) { Swal.fire('خطأ', 'الفاتورة يجب أن تحتوي على منتج واحد على الأقل!', 'error'); return; }
            const amountPaid = parseFloat(amountPaidValue);
             if (isNaN(amountPaid) || amountPaid < 0) { Swal.fire('خطأ', 'المبلغ المدفوع غير صحيح!', 'error'); return; }


            const updatedProductsInInvoice = [];
            let newTotalAmount = 0;
            let stockAdjustmentPromises = []; 

            for (const row of rows) {
                const productId = row.dataset.productId;
                const name = row.cells[0].textContent;
                const salePrice = parseFloat(row.querySelector('.sale-price').value);
                const newQuantitySold = parseInt(row.querySelector('.quantity').value);
                const note = row.querySelector('.note').value;
                const itemTotal = salePrice * newQuantitySold;

                if (isNaN(salePrice) || salePrice <=0 || isNaN(newQuantitySold) || newQuantitySold <=0) {
                    Swal.fire('خطأ', `بيانات غير صالحة للمنتج "${name}". تأكد من السعر والكمية.`, 'error'); return;
                }

                updatedProductsInInvoice.push({ productId, name, salePrice, quantity: newQuantitySold, note, total: itemTotal });
                newTotalAmount += itemTotal;

                const originalProductInfo = originalProductsInInvoice.find(p => p.productId === productId);
                const originalQuantitySoldInThisInvoice = originalProductInfo ? originalProductInfo.quantity : 0;
                
                const quantityChangeForStock = originalQuantitySoldInThisInvoice - newQuantitySold; 
                
                if (quantityChangeForStock !== 0) {
                    const productExists = await checkProductExists(productId);
                    if (productExists) {
                         stockAdjustmentPromises.push(adjustProductStock(productId, quantityChangeForStock));
                    } else {
                        console.warn(`Product ${productId} not found in DB. Skipping stock adjustment for this item.`);
                    }
                }
            }
            
            originalProductsInInvoice.forEach(async origP => {
                if (!updatedProductsInInvoice.some(updP => updP.productId === origP.productId)) {
                    const productExists = await checkProductExists(origP.productId);
                     if (productExists) {
                        stockAdjustmentPromises.push(adjustProductStock(origP.productId, origP.quantity)); 
                     } else {
                        console.warn(`Product ${origP.productId} (removed from invoice) not found in DB. Skipping stock adjustment for this item.`);
                     }
                }
            });


            if (amountPaid > newTotalAmount) {
                Swal.fire('خطأ', 'المبلغ المدفوع لا يمكن أن يكون أكبر من المجموع الكلي للفاتورة!', 'error'); return;
            }

            try {
                if (stockAdjustmentPromises.length > 0) {
                    await Promise.all(stockAdjustmentPromises);
                }
            } catch (error) {
                Swal.fire('خطأ في تحديث المخزون', error.message, 'error');
                return; 
            }
            
            let invoiceDateStr = document.getElementById('editInvoiceDate').textContent;
            let invoiceDateISO;
            if (invoiceDateStr && invoiceDateStr !== 'N/A') {
                const parts = invoiceDateStr.match(/(\d{2})-(\d{2})-(\d{4}) (\d{2}):(\d{2})/);
                if (parts) {
                    // parts[1]=day, parts[2]=month, parts[3]=year, parts[4]=hour, parts[5]=minute
                    invoiceDateISO = new Date(Date.UTC(parts[3], parts[2] - 1, parts[1], parts[4], parts[5])).toISOString();
                } else {
                    invoiceDateISO = new Date().toISOString(); 
                }
            } else {
                 invoiceDateISO = new Date().toISOString(); 
            }


            const invoice = {
                id,
                customerId,
                products: updatedProductsInInvoice,
                totalAmount: newTotalAmount.toFixed(2),
                amountPaid: amountPaid.toFixed(2),
                date: invoiceDateISO 
            };

            const transaction = db.transaction(['invoices'], 'readwrite');
            const store = transaction.objectStore('invoices');
            const request = store.put(invoice);

            request.onsuccess = async () => {
                await updateInvoicesTable(); // This also updates dashboard
                bootstrap.Modal.getInstance(document.getElementById('editInvoiceModal')).hide();
                Swal.fire('نجاح', 'تم تعديل الفاتورة وتحديث المخزون بنجاح!', 'success');
            };
            request.onerror = (e) => {
                 console.error("Error updating invoice:", e.target.error);
                 Swal.fire('خطأ', 'فشل في تعديل الفاتورة!', 'error');
            };
        }

        function adjustProductStock(productId, quantityChange) {
            return new Promise(async (resolve, reject) => {
                try {
                    await ensureDBInitialized();
                    const transaction = db.transaction(['products'], 'readwrite');
                    const store = transaction.objectStore('products');
                    const getRequest = store.get(productId);

                    getRequest.onsuccess = () => {
                        const product = getRequest.result;
                        if (!product) {
                            // It's possible a product was deleted from inventory system externally
                            // while it was still in an invoice. Log this instead of hard failing the whole invoice update.
                            console.warn(`المنتج بالمعرف ${productId} غير موجود لتعديل المخزون. سيتم تخطي هذا المنتج.`);
                            resolve(); // Resolve to not block other stock adjustments
                            return;
                        }
                        
                        const newStock = product.quantity + quantityChange;
                        if (newStock < 0) { 
                             reject(new Error(`لا يمكن أن يكون مخزون المنتج "${product.name}" سالبًا. التغيير المطلوب للمخزون: ${quantityChange}, المخزون الحالي: ${product.quantity}.`));
                             return;
                        }
                        product.quantity = newStock;

                        const updateRequest = store.put(product);
                        updateRequest.onsuccess = () => resolve();
                        updateRequest.onerror = (e) => reject(new Error(`فشل تعديل مخزون المنتج ${product.name}: ${e.target.error}`));
                    };
                    getRequest.onerror = (e) => reject(new Error(`فشل جلب المنتج ${productId} لتعديل المخزون: ${e.target.error}`));
                } catch (dbError) {
                    reject(dbError);
                }
            });
        }

        async function deleteInvoice(invoiceId) { // This function is not called from UI but kept for potential use
            const result = await Swal.fire({
                title: 'تأكيد الحذف',
                text: 'هل أنت متأكد من حذف هذه الفاتورة؟ سيتم إرجاع الكميات المباعة إلى المخزون.',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'نعم، احذف',
                cancelButtonText: 'إلغاء',
                confirmButtonColor: '#dc3545',
                cancelButtonColor: '#6c757d'
            });

            if (result.isConfirmed) {
                try {
                    await ensureDBInitialized();
                    const readTx = db.transaction(['invoices'], 'readonly'); 
                    const invoiceStoreRead = readTx.objectStore('invoices');
                    const getInvoiceRequest = invoiceStoreRead.get(invoiceId);

                    getInvoiceRequest.onsuccess = async () => {
                        const invoiceToDelete = getInvoiceRequest.result;
                        if (!invoiceToDelete) {
                            Swal.fire('خطأ', 'الفاتورة غير موجودة.', 'error');
                            return;
                        }

                        let stockReturnPromises = [];
                        for (const p of invoiceToDelete.products) {
                            const productExists = await checkProductExists(p.productId);
                            if (productExists) {
                                stockReturnPromises.push(adjustProductStock(p.productId, p.quantity));
                            } else {
                                console.warn(`Product ${p.productId} from deleted invoice not found. Stock not returned for this item.`);
                            }
                        }
                        
                        try {
                            if (stockReturnPromises.length > 0) {
                                await Promise.all(stockReturnPromises); 
                            }

                            const writeTxDelete = db.transaction(['invoices'], 'readwrite');
                            const invoiceStoreWrite = writeTxDelete.objectStore('invoices');
                            const deleteRequest = invoiceStoreWrite.delete(invoiceId);

                            deleteRequest.onsuccess = async () => {
                                await updateInvoicesTable(); // This also updates dashboard
                                Swal.fire('نجاح', 'تم حذف الفاتورة وإرجاع المنتجات للمخزون بنجاح!', 'success');
                            };
                            deleteRequest.onerror = (e) => {
                                console.error("Error deleting invoice:", e.target.error);
                                Swal.fire('خطأ', 'فشل في حذف الفاتورة! (قد يكون المخزون أُرجع).', 'error');
                            };

                        } catch (stockError) {
                            Swal.fire('خطأ في إرجاع المخزون', stockError.message, 'error');
                        }
                    };
                    getInvoiceRequest.onerror = (e) => Swal.fire('خطأ', `فشل في جلب الفاتورة للحذف: ${e.target.error}`, 'error');

                } catch (dbError) {
                     Swal.fire('خطأ قاعدة البيانات', `فشل: ${dbError.message}`, 'error');
                }
            }
        }


        async function addCustomer() {
            const name = document.getElementById('customerName').value.trim();
            const phone = document.getElementById('customerPhone').value.trim();
            const address = document.getElementById('customerAddress').value.trim();
            
            if (!name && !phone && !address) {
                 Swal.fire('خطأ', 'يجب إدخال معلومة واحدة على الأقل للزبون (الاسم أو الهاتف أو العنوان).', 'error');
                 return;
            }

            if (phone) { 
                const customers = await getAllCustomers();
                if (customers.some(c => c.phone === phone && phone !== '')) { // Ensure phone isn't empty string
                    Swal.fire('خطأ', 'رقم الهاتف هذا مُسجل لزبون آخر!', 'error');
                    return;
                }
            }


            const id = await generateUniqueId('customers');
            const customer = { 
                id, 
                name: name || null, // Store null if empty for consistency
                phone: phone || null, 
                address: address || null 
            };


            const transaction = db.transaction(['customers'], 'readwrite');
            const store = transaction.objectStore('customers');
            const request = store.add(customer);

            request.onsuccess = async () => {
                await updateCustomersTable();
                await populateCustomerSelect('invoiceCustomer');
                await populateCustomerSelect('editInvoiceCustomer');
                await populateCustomerSelect('statementCustomer');
                bootstrap.Modal.getInstance(document.getElementById('addCustomerModal')).hide();
                document.getElementById('addCustomerForm').reset();
                Swal.fire('نجاح', 'تم إضافة الزبون بنجاح!', 'success');
            };
            request.onerror = (e) => Swal.fire('خطأ', `فشل في إضافة الزبون: ${e.target.error}`, 'error');
        }

        async function editCustomer(customerId) {
            try {
                await ensureDBInitialized();
                const transaction = db.transaction(['customers'], 'readonly');
                const store = transaction.objectStore('customers');
                const request = store.get(customerId);

                request.onsuccess = () => {
                    const customer = request.result;
                    if (!customer) {
                        Swal.fire('خطأ', 'الزبون غير موجود!', 'error');
                        return;
                    }
                    document.getElementById('editCustomerId').value = customer.id;
                    document.getElementById('editCustomerName').value = customer.name || '';
                    document.getElementById('editCustomerPhone').value = customer.phone || '';
                    document.getElementById('editCustomerAddress').value = customer.address || '';
                    new bootstrap.Modal(document.getElementById('editCustomerModal')).show();
                };
                request.onerror = (e) => Swal.fire('خطأ', `فشل في جلب بيانات الزبون: ${e.target.error}`, 'error');
            } catch (dbError) {
                 Swal.fire('خطأ قاعدة البيانات', `فشل: ${dbError.message}`, 'error');
            }
        }

        async function updateCustomer() {
            const id = document.getElementById('editCustomerId').value;
            const name = document.getElementById('editCustomerName').value.trim();
            const phone = document.getElementById('editCustomerPhone').value.trim();
            const address = document.getElementById('editCustomerAddress').value.trim();

             if (!name && !phone && !address) {
                 Swal.fire('خطأ', 'يجب إدخال معلومة واحدة على الأقل للزبون.', 'error');
                 return;
            }

            if (phone) { 
                const customers = await getAllCustomers();
                if (customers.some(c => c.id !== id && c.phone === phone && phone !== '')) { 
                    Swal.fire('خطأ', 'رقم الهاتف هذا مُسجل لزبون آخر!', 'error');
                    return;
                }
            }

            const customer = { 
                id, 
                name: name || null, 
                phone: phone || null, 
                address: address || null 
            };
            const transaction = db.transaction(['customers'], 'readwrite');
            const store = transaction.objectStore('customers');
            const request = store.put(customer);

            request.onsuccess = async () => {
                await updateCustomersTable();
                await updateInvoicesTable(); // Refresh invoices in case customer name changed
                await populateCustomerSelect('invoiceCustomer');
                await populateCustomerSelect('editInvoiceCustomer');
                await populateCustomerSelect('statementCustomer');
                bootstrap.Modal.getInstance(document.getElementById('editCustomerModal')).hide();
                Swal.fire('نجاح', 'تم تعديل بيانات الزبون بنجاح!', 'success');
            };
            request.onerror = (e) => Swal.fire('خطأ', `فشل في تعديل بيانات الزبون: ${e.target.error}`, 'error');
        }

        async function deleteCustomer(customerId) {
            const invoices = await getAllInvoices();
            if (invoices.some(i => i.customerId === customerId)) {
                Swal.fire('لا يمكن الحذف', 'لا يمكن حذف هذا الزبون لأنه مرتبط بفواتير حالية. يرجى تعديل الفواتير المرتبطة به لزبون آخر أو حذفها (إذا كانت هذه الإمكانية متاحة).', 'error');
                return;
            }


            const result = await Swal.fire({
                title: 'تأكيد الحذف',
                text: 'هل أنت متأكد من حذف هذا الزبون؟ لا يمكن التراجع عن هذا الإجراء.',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'نعم، احذف',
                cancelButtonText: 'إلغاء',
                confirmButtonColor: '#dc3545'
            });

            if (result.isConfirmed) {
                const transaction = db.transaction(['customers'], 'readwrite');
                const store = transaction.objectStore('customers');
                const request = store.delete(customerId);

                request.onsuccess = async () => {
                    await updateCustomersTable();
                    await populateCustomerSelect('invoiceCustomer');
                    await populateCustomerSelect('editInvoiceCustomer');
                    await populateCustomerSelect('statementCustomer');
                    Swal.fire('نجاح', 'تم حذف الزبون بنجاح!', 'success');
                };
                request.onerror = (e) => Swal.fire('خطأ', `فشل في حذف الزبون: ${e.target.error}`, 'error');
            }
        }
        
        async function printInvoice(invoiceId) {
            try {
                await ensureDBInitialized();
                const transaction = db.transaction(['invoices', 'customers'], 'readonly');
                const invoiceStore = transaction.objectStore('invoices');
                const invoiceRequest = invoiceStore.get(invoiceId);

                invoiceRequest.onsuccess = async () => {
                    const invoice = invoiceRequest.result;
                    if (!invoice) { Swal.fire('خطأ', 'الفاتورة غير موجودة.', 'error'); return; }

                    const customers = await getAllCustomers(); 
                    const customer = customers.find(c => c.id === invoice.customerId);
                    
                    const printWindow = window.open('', '_blank', 'height=800,width=600');
                    if (!printWindow) {
                         Swal.fire('خطأ', 'فشل فتح نافذة الطباعة. يرجى التأكد من تعطيل مانع النوافذ المنبثقة.', 'error'); return;
                    }
                    printWindow.document.write(`
                        <!DOCTYPE html>
                        <html lang="ar" dir="rtl">
                        <head>
                            <meta charset="UTF-8">
                            <title>فاتورة رقم: ${invoice.id}</title>
                            <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
                            <style>
                                @page { size: A5 landscape; margin: 5mm; }
                                body { font-family: 'Cairo', sans-serif; direction: rtl; margin: 5mm; font-size: 10pt; }
                                .container { width: 100%; margin: 0 auto; }
                                .header-print { text-align: center; margin-bottom: 10px; border-bottom: 1px solid #ccc; padding-bottom: 5px;}
                                .header-print img { max-height: 40px; margin-bottom: 3px; }
                                .header-print h1 { font-size: 1.1rem; color: #3F2A56; margin:0; }
                                .invoice-info-grid { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px;}
                                .invoice-details-text { flex-basis: 70%;} 
                                .invoice-details, .customer-details { font-size: 0.85rem;}
                                .invoice-details p, .customer-details p { margin: 2px 0; }
                                .qr-code-container { 
                                    flex-basis: auto; /* Adjust to content */
                                    min-width: 75px; 
                                    text-align: center; /* Center the QR code if div is wider */
                                    padding-left: 5px; 
                                } 
                                #invoiceQrCodeElement { /* The div where QR will be generated */
                                    display: inline-block; /* Helps with sizing and centering */
                                }
                                #invoiceQrCodeElement canvas,
                                #invoiceQrCodeElement img {
                                    border: 1px solid #eee; /* Add border to the QR itself */
                                }
                                .products-table { width: 100%; border-collapse: collapse; margin-bottom: 8px; }
                                .products-table th, .products-table td { padding: 4px; border: 1px solid #ccc; text-align: center; font-size: 0.8rem;}
                                .products-table th { background-color: #f2f2f2; color: #333; font-weight:600; }
                                .totals-section { margin-top: 10px; padding-top: 8px; border-top: 1px solid #ccc; text-align:left; font-size: 0.85rem;}
                                .totals-section p { margin: 3px 0; font-weight: 600; }
                                .footer-print { text-align: center; font-size: 0.75rem; margin-top: 15px; color: #777; }
                                @media print {
                                    body { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
                                }
                            </style>
                        </head>
                        <body>
                            <div class="container">
                                <div class="header-print">
                                    <img src="logo.png" alt="شعار" onerror="this.style.display='none';">
                                    <h1>طيبة المدينة تلكوم</h1>
                                    <p style="font-size:0.7rem;">للاتصالات وخدمات الجوال</p>
                                </div>
                                
                                <div class="invoice-info-grid">
                                    <div class="invoice-details-text">
                                        <div class="invoice-details">
                                            <p><strong>رقم الفاتورة:</strong> ${invoice.id}</p>
                                            <p><strong>التاريخ:</strong> ${formatDateForDisplay(invoice.date)}</p>
                                        </div>
                                        <div class="customer-details">
                                            <p><strong>الزبون:</strong> ${customer?.name || 'زبون نقدي'}</p>
                                            ${customer?.phone ? `<p><strong>الهاتف:</strong> ${customer.phone}</p>` : ''}
                                            ${customer?.address ? `<p><strong>العنوان:</strong> ${customer.address}</p>` : ''}
                                        </div>
                                    </div>
                                    <div class="qr-code-container">
                                        <div id="invoiceQrCodeElement"></div> <!-- Target for QRCode.js -->
                                    </div>
                                </div>

                                <table class="products-table">
                                    <thead>
                                        <tr>
                                            <th>م</th>
                                            <th>البيان (اسم المنتج)</th>
                                            <th>س. الوحدة</th>
                                            <th>الكمية</th>
                                            <th>الإجمالي</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${invoice.products.map((p, index) => `
                                            <tr>
                                                <td>${index + 1}</td>
                                                <td style="text-align:right;">${p.name} ${p.note ? `(${p.note})` : ''}</td>
                                                <td>${parseFloat(p.salePrice).toFixed(2)}</td>
                                                <td>${p.quantity}</td>
                                                <td>${parseFloat(p.total).toFixed(2)}</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                                <div class="totals-section">
                                    <p>المجموع الكلي: ${parseFloat(invoice.totalAmount).toFixed(2)}</p>
                                    <p>المبلغ المدفوع: ${parseFloat(invoice.amountPaid).toFixed(2)}</p>
                                    <p>المتبقي: ${(parseFloat(invoice.totalAmount) - parseFloat(invoice.amountPaid)).toFixed(2)}</p>
                                </div>
                                <div class="footer-print">
                                    <p>شكراً لتعاملكم معنا!</p>
                                </div>
                            </div>
                            <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"><\/script>
                            <script>
                                window.onload = function() { // This is the onload for the print window's content
                                    var qrElement = document.getElementById('invoiceQrCodeElement');
                                    if (qrElement && typeof QRCode !== 'undefined') {
                                        new QRCode(qrElement, {
                                            text: "${invoice.id}",
                                            width: 65,
                                            height: 65,
                                            colorDark : "#000000",
                                            colorLight : "#ffffff",
                                            correctLevel : QRCode.CorrectLevel.H
                                        });
                                    } else {
                                        console.error("QR Code generation failed in print window: Element or QRCode library not found.");
                                    }
                                };
                            <\/script>
                        </body>
                        </html>
                    `);
                    printWindow.document.close(); 
                    printWindow.onload = function() { // This is for the parent window's reference to the new window object
                        // The new window's own window.onload (for its content) should have fired by now.
                        // Add a slight delay to ensure rendering is complete before the print dialog.
                        setTimeout(function() {
                            printWindow.focus();
                            printWindow.print();
                            // printWindow.close(); // Optional: Close after print dialog
                        }, 300); // 300ms delay, adjust if needed.
                    }
                };
                invoiceRequest.onerror = (e) => Swal.fire('خطأ', `فشل في جلب الفاتورة للطباعة: ${e.target.error}`, 'error');
            } catch (dbError) {
                 Swal.fire('خطأ قاعدة البيانات', `فشل: ${dbError.message}`, 'error');
            }
        }

        async function generateCustomerStatement() {
            const customerId = document.getElementById('statementCustomer').value;
            const startDateValue = document.getElementById('startDate').value;
            const endDateValue = document.getElementById('endDate').value;

            if (!customerId || !startDateValue || !endDateValue) {
                Swal.fire('خطأ', 'الرجاء اختيار الزبون وتحديد نطاق التاريخ بشكل كامل!', 'error');
                return;
            }
            
            const startDate = new Date(startDateValue);
            const endDate = new Date(endDateValue);
            endDate.setHours(23, 59, 59, 999); 


            if (startDate > endDate) {
                Swal.fire('خطأ', 'تاريخ البداية يجب أن يكون قبل أو نفس تاريخ النهاية!', 'error');
                return;
            }

            const invoices = await getAllInvoices();
            const customers = await getAllCustomers();
            const customer = customers.find(c => c.id === customerId);

            const filteredInvoices = invoices.filter(i => {
                const invoiceDate = new Date(i.date);
                return i.customerId === customerId && invoiceDate >= startDate && invoiceDate <= endDate;
            }).sort((a, b) => new Date(a.date) - new Date(b.date)); 

            const printWindow = window.open('', '_blank', 'height=800,width=600');
             if (!printWindow) {
                 Swal.fire('خطأ', 'فشل فتح نافذة الطباعة. يرجى التأكد من تعطيل مانع النوافذ المنبثقة.', 'error'); return;
             }
            printWindow.document.write(`
                <!DOCTYPE html>
                <html lang="ar" dir="rtl">
                <head>
                    <meta charset="UTF-8">
                    <title>كشف حساب الزبون: ${customer?.name || 'غير معروف'}</title>
                    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
                    <style>
                        @page { size: A4; margin: 10mm; }
                        body { font-family: 'Cairo', sans-serif; direction: rtl; margin: 10mm; font-size:10pt; }
                        .container { width: 100%; margin: 0 auto; }
                        .header-print { text-align: center; margin-bottom: 20px; border-bottom: 1px solid #ccc; padding-bottom:10px;}
                        .header-print img { max-height: 60px; margin-bottom: 5px;}
                        .header-print h1 { font-size: 1.4rem; color: #3F2A56; margin:0; }
                        .info { margin-bottom: 15px; font-size:0.95rem; }
                        .info p { margin: 4px 0; }
                        .statement-table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
                        .statement-table th, .statement-table td { padding: 8px; border: 1px solid #ccc; text-align: center; font-size:0.9rem; }
                        .statement-table th { background-color: #f2f2f2; color: #333; font-weight:600; }
                        .status-paid { color: #198754; font-weight: 700; }
                        .status-partial { color: #ffc107; font-weight: 700; }
                        .status-unpaid { color: #dc3545; font-weight: 700; }
                        .summary { margin-top: 20px; padding-top:10px; border-top: 1px solid #ccc; text-align:left; font-size:1rem;}
                        .summary p {margin: 5px 0; font-weight:600;}
                         @media print {
                            body { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
                        }
                    </style>
                </head>
                <body>
                    <div class="container">
                        <div class="header-print">
                             <img src="logo.png" alt="شعار" onerror="this.style.display='none';">
                            <h1>طيبة المدينة تلكوم</h1>
                            <h2>كشف حساب زبون</h2>
                        </div>
                        <div class="info">
                            <p><strong>الزبون:</strong> ${customer?.name || 'زبون غير محدد'}</p>
                            ${customer?.phone ? `<p><strong>الهاتف:</strong> ${customer.phone}</p>` : ''}
                            <p><strong>الفترة من:</strong> ${new Date(startDateValue).toLocaleDateString('ar-SA-u-nu-latn', { year: 'numeric', month: '2-digit', day: '2-digit' })}</p>
                            <p><strong>إلى:</strong> ${new Date(endDateValue).toLocaleDateString('ar-SA-u-nu-latn', { year: 'numeric', month: '2-digit', day: '2-digit' })}</p>
                        </div>
                        <table class="statement-table">
                            <thead>
                                <tr>
                                    <th>رقم الفاتورة</th>
                                    <th>التاريخ</th>
                                    <th>إجمالي الفاتورة</th>
                                    <th>المدفوع</th>
                                    <th>المتبقي</th>
                                    <th>الحالة</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${filteredInvoices.length > 0 ? filteredInvoices.map(i => {
                                    const totalAmount = parseFloat(i.totalAmount);
                                    const amountPaid = parseFloat(i.amountPaid);
                                    const remaining = totalAmount - amountPaid;
                                    let statusText, statusClassSuffix;
                                    if (totalAmount === 0 && amountPaid === 0) { statusText = 'لا يوجد مبلغ'; statusClassSuffix = '';}
                                    else if (amountPaid >= totalAmount) { statusText = 'مدفوع'; statusClassSuffix = 'paid'; }
                                    else if (amountPaid > 0) { statusText = 'مدفوع جزئيًا'; statusClassSuffix = 'partial'; }
                                    else { statusText = 'لم يتم الدفع'; statusClassSuffix = 'unpaid'; }
                                    

                                    return `
                                        <tr>
                                            <td>${i.id}</td>
                                            <td>${formatDateForDisplay(i.date)}</td>
                                            <td>${totalAmount.toFixed(2)}</td>
                                            <td>${amountPaid.toFixed(2)}</td>
                                            <td>${remaining.toFixed(2)}</td>
                                            <td class="status-${statusClassSuffix}">${statusText}</td>
                                        </tr>
                                    `;
                                }).join('') : '<tr><td colspan="6">لا توجد فواتير لهذا الزبون في الفترة المحددة.</td></tr>'}
                            </tbody>
                        </table>
                        ${filteredInvoices.length > 0 ? `
                        <div class="summary">
                            <p>إجمالي قيمة الفواتير: ${filteredInvoices.reduce((sum, i) => sum + parseFloat(i.totalAmount), 0).toFixed(2)}</p>
                            <p>إجمالي المدفوعات: ${filteredInvoices.reduce((sum, i) => sum + parseFloat(i.amountPaid), 0).toFixed(2)}</p>
                            <p>إجمالي المتبقي: ${filteredInvoices.reduce((sum, i) => sum + (parseFloat(i.totalAmount) - parseFloat(i.amountPaid)), 0).toFixed(2)}</p>
                        </div>
                        ` : ''}
                    </div>
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.onload = function() { // Parent window's reference onload
                setTimeout(function() { // Delay to ensure rendering, especially if print window has complex content
                    printWindow.focus();
                    printWindow.print();
                }, 300);
            }
            bootstrap.Modal.getInstance(document.getElementById('customerStatementModal')).hide();
            document.getElementById('customerStatementForm').reset();
        }

        function startQrScanner() {
            const qrReaderContainer = document.getElementById('qr-reader-container');
            
            if (html5QrCodeScanner) {
                 try {
                    if (html5QrCodeScanner.getState() === Html5QrcodeScannerState.SCANNING) {
                        stopQrScanner(); 
                    }
                 } catch (e) { console.warn("Error checking scanner state, attempting to stop anyway:", e); stopQrScanner(); }
            }

            qrReaderContainer.style.display = 'block';
            
            if (typeof Html5Qrcode === "undefined") {
                Swal.fire('خطأ', 'مكتبة مسح QR غير محملة بشكل صحيح.', 'error');
                qrReaderContainer.style.display = 'none'; 
                return;
            }

            html5QrCodeScanner = new Html5Qrcode("qr-reader"); 
            const qrCodeSuccessCallback = (decodedText, decodedResult) => {
                document.getElementById('searchInput').value = decodedText;
                filterTable();
                stopQrScanner(); 
                Swal.fire('نجاح!', `تم العثور على الفاتورة: ${decodedText}`, 'success');
            };
            const config = { fps: 10, qrbox: {width: 250, height: 250}, aspectRatio: 1.0 }; 
            
             html5QrCodeScanner.start(
                { facingMode: "environment" }, 
                config,
                qrCodeSuccessCallback,
                (errorMessage) => {
                    // console.warn(`QR Code no match or error: ${errorMessage}`);
                })
            .catch((err) => {
                console.error(`Unable to start QR scanning, error: ${err}`);
                Swal.fire('خطأ', 'لم يتمكن من تشغيل ماسح QR. تأكد من صلاحيات الكاميرا أو أن الكاميرا غير مستخدمة بواسطة تطبيق آخر.', 'error');
                stopQrScanner(); 
            });
        }

        function stopQrScanner() {
            const qrReaderContainer = document.getElementById('qr-reader-container');
            if (html5QrCodeScanner) {
                html5QrCodeScanner.stop().then(ignore => {
                    console.log("QR Code scanning stopped.");
                    if (html5QrCodeScanner && typeof html5QrCodeScanner.clear === 'function') {
                        html5QrCodeScanner.clear(); 
                    }
                    // html5QrCodeScanner = null; // Do not nullify here if you want to reuse, but for safety, it's good
                }).catch(err => {
                    console.error("Failed to stop QR Code scanner.", err);
                    // html5QrCodeScanner = null; 
                }).finally(() => {
                     qrReaderContainer.style.display = 'none'; 
                });
            } else {
                 qrReaderContainer.style.display = 'none'; 
            }
        }


        document.addEventListener('DOMContentLoaded', async () => {
            try {
                await initDB();
                await Promise.all([
                    updateInvoicesTable(), 
                    updateCustomersTable(),
                    populateCustomerSelect('invoiceCustomer'),
                    populateCustomerSelect('editInvoiceCustomer'),
                    populateCustomerSelect('statementCustomer')
                ]);
                
                setupProductSearch('productSearch', 'productSuggestions', 'invoiceProducts');
                setupProductSearch('editProductSearch', 'editProductSuggestions', 'editInvoiceProducts', true);
                
                document.getElementById('invoiceDate').textContent = formatDateForDisplay(new Date().toISOString());
                
                document.getElementById('invoiceCustomer').addEventListener('change', (e) => updateCustomerInfo('invoiceCustomer', 'customerPhoneDisplay', 'customerAddressDisplay'));
                document.getElementById('editInvoiceCustomer').addEventListener('change', (e) => updateCustomerInfo('editInvoiceCustomer', 'editCustomerPhoneDisplay', 'editCustomerAddressDisplay'));

                document.getElementById('scanQrBtn').addEventListener('click', startQrScanner);
                document.getElementById('closeScannerBtn').addEventListener('click', stopQrScanner);


            } catch (error) {
                console.error("Initialization failed:", error);
                Swal.fire('فشل التهيئة', `حدث خطأ أثناء تحميل الصفحة: ${error.message}`, 'error');
            }
        });
    </script>
</body>
</html><!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>بيع المنتجات</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!-- QR Code Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode@2.0.9/dist/html5-qrcode.min.js"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Cairo', sans-serif;
            background: linear-gradient(135deg, #f0f2f5, #d9e2ec);
            color: #333;
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .home-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: linear-gradient(90deg, #3F2A56, #5a3f73);
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            text-decoration: none;
            font-size: 1rem;
            font-weight: 600;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            transition: transform 0.2s ease, background 0.3s ease, box-shadow 0.3s ease;
            position: absolute;
            top: 20px;
            left: 20px;
        }
        .home-btn:hover {
            background: linear-gradient(90deg, #5a3f73, #3F2A56);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
        }
        .header {
            background: linear-gradient(135deg, #3F2A56, #5a3f73);
            color: white;
            padding: 40px 20px;
            border-radius: 25px;
            text-align: center;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
            margin-bottom: 30px;
            position: relative;
            z-index: 1;
            border: 2px solid rgba(255, 255, 255, 0.1);
        }
        .header img {
            height: 90px;
            margin-bottom: 15px;
            filter: drop-shadow(0 3px 6px rgba(0, 0, 0, 0.3));
        }
        .header h2 {
            font-size: 2.2rem;
            margin-bottom: 10px;
            font-weight: 700;
        }
        .header h4 {
            font-size: 1.4rem;
            opacity: 0.9;
            font-weight: 400;
        }
        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        .card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: #3F2A56;
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            text-align: center;
            transition: transform 0.3s ease;
        }
        .card:hover {
            transform: translateY(-10px);
        }
        .card i {
            font-size: 2.8rem;
            margin-bottom: 15px;
            color: #3F2A56;
        }
        .card h5 {
            font-size: 1.3rem;
            margin-bottom: 10px;
            font-weight: 600;
        }
        .card h3 {
            font-size: 1.8rem;
            font-weight: 700;
        }
        .section {
            background: white;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
            padding: 20px;
            margin: 20px 0;
        }
        .section h3 {
            font-size: 1.7rem;
            font-weight: 700;
            color: #3F2A56;
            margin-bottom: 15px;
            text-align: center;
        }
        .table-container {
            overflow-x: auto;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            padding: 12px;
            text-align: center;
            border-bottom: 1px solid #e0e0e0;
        }
        th {
            background: linear-gradient(90deg, #3F2A56, #5a3f73);
            color: white;
            font-weight: 700;
        }
        td {
            color: #3F2A56;
        }
        tr:hover {
            background-color: #f7f9fc;
        }
        .actions {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin: 25px 0;
            justify-content: center;
        }
        .btn {
            background: linear-gradient(90deg, #3F2A56, #5a3f73);
            color: white;
            padding: 12px 24px;
            border-radius: 30px;
            border: none;
            font-size: 1rem;
            cursor: pointer;
            transition: transform 0.2s ease, background 0.3s ease, box-shadow 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .btn:hover {
            background: linear-gradient(90deg, #5a3f73, #3F2A56);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.2);
        }
        .search-container {
            margin-bottom: 20px;
            display: flex;
            justify-content: center;
            align-items: flex-end; /* Align items to bottom for button */
            gap: 15px;
            flex-wrap: wrap;
        }
        .filter-group {
            display: flex;
            flex-direction: column;
            max-width: 200px;
        }
        .filter-group label {
            font-size: 0.9rem;
            font-weight: 600;
            color: #3F2A56;
            margin-bottom: 5px;
        }
        .filter-group input, .filter-group select {
            padding: 12px;
            border-radius: 30px;
            border: none;
            background: rgba(255, 255, 255, 0.1);
            color: #3F2A56;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        .filter-group input:focus, .filter-group select:focus {
            outline: none;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2);
        }
        #scanQrBtn {
            padding: 10px 15px; /* Adjust padding */
            height: 46px; /* Match input height */
            border-radius: 30px;
        }
         #qr-reader-container {
            margin-top: 10px;
            border: 1px solid #ccc;
            border-radius: 10px;
            padding:10px;
            background-color: #f9f9f9;
        }
        #qr-reader {
            width: 100%;
            max-width: 400px; /* Adjust as needed */
            margin: 0 auto;
        }

        .action-btn {
            cursor: pointer;
            margin: 0 6px;
            font-size: 1.3rem;
            transition: color 0.3s ease;
        }
        .action-btn.edit:hover { color: #007bff; }
        /* .action-btn.delete:hover { color: #dc3545; } */ /* Delete button removed from UI */
        .action-btn.print:hover { color: #28a745; }

        .modal-content {
            border-radius: 20px;
            background: linear-gradient(145deg, #ffffff, #f7f9fc);
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }
        .modal-header {
            background: linear-gradient(90deg, #3F2A56, #5a3f73);
            color: white;
            border-top-left-radius: 20px;
            border-top-right-radius: 20px;
            padding: 20px;
        }
        .modal-title {
            font-size: 1.5rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .modal-body {
            padding: 30px;
        }
        .modal-body .form-label {
            font-weight: 600;
            color: #3F2A56;
        }
        .modal-body .form-control, .modal-body .form-select {
            border-radius: 15px;
            padding: 12px;
            background: #f7f9fc;
            border: 1px solid #ddd;
        }
         .modal-body .form-control:focus, .modal-body .form-select:focus {
            border-color: #3F2A56;
            box-shadow: 0 0 0 0.25rem rgba(63, 42, 86, 0.25);
        }
        .modal-footer {
            padding: 20px;
            background: #f8f9fa;
            border-bottom-left-radius: 20px;
            border-bottom-right-radius: 20px;
        }
        .modal-footer .btn {
            padding: 12px 30px;
        }
        .product-table th, .product-table td {
            padding: 8px;
        }
        .modal-body .product-table th { /* Change header text color in modal product tables */
            color: white;
             background: linear-gradient(90deg, #3F2A56, #5a3f73); /* Optional: match main table header */
        }
        .status-paid { color: #198754; font-weight: 700; }
        .status-partial { color: #ffc107; font-weight: 700; }
        .status-unpaid { color: #dc3545; font-weight: 700; }
        .swal2-popup {
            font-family: 'Cairo', sans-serif !important;
            border-radius: 15px !important;
        }
        .swal2-title { color: #3F2A56 !important; }
        .swal2-html-container { text-align: right !important; }
        .swal2-confirm {
            background: linear-gradient(90deg, #3F2A56, #5a3f73) !important;
            border-radius: 20px !important;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2) !important;
        }
        .swal2-cancel, .swال2-deny {
            background: linear-gradient(90deg, #6c757d, #5a6268) !important;
            border-radius: 20px !important;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2) !important;
        }
        #productSuggestions div, #editProductSuggestions div {
            padding: 8px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        #productSuggestions div:hover, #editProductSuggestions div:hover {
            background-color: #f0f0f0;
        }

        @media (max-width: 768px) {
            .header { padding: 25px 15px; }
            .header img { height: 70px; }
            .header h2 { font-size: 1.7rem; }
            .btn { padding: 10px 18px; font-size: 0.9rem; }
            th, td { padding: 10px; font-size: 0.9rem; }
            .modal-body { padding: 20px; }
            .search-container { flex-direction: column; align-items: stretch;}
            .filter-group { max-width: none; }
            #scanQrBtn { width: 100%; margin-top: 10px;}
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <img src="logo.png" alt="شعار طيبة المدينة تلكوم" onerror="this.src='https://via.placeholder.com/90?text=Logo'; this.style.display='none';">
            <h2>طيبة المدينة تلكوم</h2>
            <h4>بيع المنتجات</h4>
            <a href="home.html" class="home-btn"><i class="fas fa-home"></i> للرئيسية</a>
        </div>
        <div class="dashboard">
            <div class="card">
                <i class="fas fa-check-circle"></i>
                <h5>الفواتير المدفوعة</h5>
                <h3 id="paidInvoices">0</h3>
            </div>
            <div class="card">
                <i class="fas fa-exclamation-circle"></i>
                <h5>الفواتير المدفوعة جزئيًا</h5>
                <h3 id="partialInvoices">0</h3>
            </div>
            <div class="card">
                <i class="fas fa-times-circle"></i>
                <h5>الفواتير غير المدفوعة</h5>
                <h3 id="unpaidInvoices">0</h3>
            </div>
        </div>
        <div class="actions">
            <button class="btn" data-bs-toggle="modal" data-bs-target="#addInvoiceModal"><i class="fas fa-plus"></i> إضافة فاتورة</button>
            <button class="btn" data-bs-toggle="modal" data-bs-target="#addCustomerModal"><i class="fas fa-user-plus"></i> إضافة زبون</button>
            <button class="btn" data-bs-toggle="modal" data-bs-target="#customerStatementModal"><i class="fas fa-file-alt"></i> كشف حساب زبون</button>
        </div>
        <div class="section">
            <h3>الفواتير</h3>
            <div class="search-container">
                <div class="filter-group">
                    <label for="searchInput">البحث</label>
                    <input type="text" id="searchInput" placeholder="ابحث بالزبون أو معرف الفاتورة" oninput="filterTable()">
                </div>
                <button id="scanQrBtn" class="btn btn-info" title="مسح QR Code للبحث عن فاتورة"><i class="fas fa-qrcode"></i> مسح</button>
                <div class="filter-group">
                    <label for="statusFilter">حالة الفاتورة</label>
                    <select id="statusFilter" onchange="filterTable()">
                        <option value="all">الكل</option>
                        <option value="paid">مدفوع</option>
                        <option value="partial">مدفوع جزئيًا</option>
                        <option value="unpaid">لم يتم الدفع</option>
                    </select>
                </div>
            </div>
             <div id="qr-reader-container" style="display: none;">
                <div id="qr-reader"></div>
                <button id="closeScannerBtn" class="btn btn-sm btn-danger mt-2" style="display:block; margin: 0 auto;">إغلاق الماسح</button>
            </div>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>معرف الفاتورة</th>
                            <th>الزبون</th>
                            <th>رقم الهاتف</th>
                            <th>المبلغ الكلي</th>
                            <th>حالة الفاتورة</th>
                            <th>الإجراءات</th>
                        </tr>
                    </thead>
                    <tbody id="invoicesTable"></tbody>
                </table>
            </div>
        </div>
        <div class="section">
            <h3>إدارة الزبائن</h3>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>الاسم</th>
                            <th>رقم الهاتف</th>
                            <th>العنوان</th>
                            <th>الإجراءات</th>
                        </tr>
                    </thead>
                    <tbody id="customersTable"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- نافذة إضافة فاتورة -->
    <div class="modal fade" id="addInvoiceModal" tabindex="-1" aria-labelledby="addInvoiceModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addInvoiceModalLabel"><i class="fas fa-file-invoice-dollar"></i> إضافة فاتورة جديدة</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="addInvoiceForm">
                        <div class="mb-3">
                            <label for="invoiceCustomer" class="form-label"><i class="fas fa-user"></i> الزبون</label>
                            <select class="form-select" id="invoiceCustomer" required>
                                <option value="">اختر زبونًا</option>
                            </select>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="customerPhoneDisplay" class="form-label"><i class="fas fa-phone"></i> رقم الهاتف</label>
                                <input type="text" class="form-control" id="customerPhoneDisplay" readonly>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="customerAddressDisplay" class="form-label"><i class="fas fa-map-marker-alt"></i> العنوان</label>
                                <input type="text" class="form-control" id="customerAddressDisplay" readonly>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="productSearch" class="form-label"><i class="fas fa-search"></i> البحث عن منتج</label>
                            <input type="text" class="form-control" id="productSearch" placeholder="ابحث بالاسم أو المعرف">
                            <div id="productSuggestions" class="mt-2 list-group" style="max-height: 150px; overflow-y: auto;"></div>
                        </div>
                        <h5><i class="fas fa-boxes"></i> المنتجات</h5>
                        <div class="table-container">
                            <table class="product-table table">
                                <thead>
                                    <tr>
                                        <th>اسم المنتج</th>
                                        <th>سعر البيع</th>
                                        <th>الكمية</th>
                                        <th>الملاحظة</th>
                                        <th>الإجمالي</th>
                                        <th>الإجراءات</th>
                                    </tr>
                                </thead>
                                <tbody id="invoiceProducts"></tbody>
                            </table>
                        </div>
                        <div class="mt-3">
                            <p><strong><i class="fas fa-calendar-alt"></i> التاريخ:</strong> <span id="invoiceDate"></span></p>
                            <p><strong><i class="fas fa-hashtag"></i> عدد المواد:</strong> <span id="totalItems">0</span></p>
                            <p><strong><i class="fas fa-coins"></i> المجموع الكلي:</strong> <span id="totalAmount">0.00</span></p>
                            <div class="mb-3">
                                <label for="amountPaid" class="form-label"><i class="fas fa-money-bill-wave"></i> المبلغ المدفوع</label>
                                <input type="number" class="form-control" id="amountPaid" step="0.01" min="0" value="0">
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
                    <button type="button" class="btn btn-primary" onclick="addInvoice()">حفظ الفاتورة</button>
                </div>
            </div>
        </div>
    </div>

    <!-- نافذة تعديل فاتورة -->
    <div class="modal fade" id="editInvoiceModal" tabindex="-1" aria-labelledby="editInvoiceModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editInvoiceModalLabel"><i class="fas fa-edit"></i> تعديل فاتورة</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="editInvoiceForm">
                        <input type="hidden" id="editInvoiceId">
                        <div class="mb-3">
                            <label for="editInvoiceCustomer" class="form-label"><i class="fas fa-user"></i> الزبون</label>
                            <select class="form-select" id="editInvoiceCustomer" required>
                                <option value="">اختر زبونًا</option>
                            </select>
                        </div>
                         <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="editCustomerPhoneDisplay" class="form-label"><i class="fas fa-phone"></i> رقم الهاتف</label>
                                <input type="text" class="form-control" id="editCustomerPhoneDisplay" readonly>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="editCustomerAddressDisplay" class="form-label"><i class="fas fa-map-marker-alt"></i> العنوان</label>
                                <input type="text" class="form-control" id="editCustomerAddressDisplay" readonly>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="editProductSearch" class="form-label"><i class="fas fa-search"></i> البحث عن منتج</label>
                            <input type="text" class="form-control" id="editProductSearch" placeholder="ابحث بالاسم أو المعرف">
                            <div id="editProductSuggestions" class="mt-2 list-group" style="max-height: 150px; overflow-y: auto;"></div>
                        </div>
                        <h5><i class="fas fa-boxes"></i> المنتجات</h5>
                        <div class="table-container">
                            <table class="product-table table">
                                <thead>
                                    <tr>
                                        <th>اسم المنتج</th>
                                        <th>سعر البيع</th>
                                        <th>الكمية</th>
                                        <th>الملاحظة</th>
                                        <th>الإجمالي</th>
                                        <th>الإجراءات</th>
                                    </tr>
                                </thead>
                                <tbody id="editInvoiceProducts"></tbody>
                            </table>
                        </div>
                        <div class="mt-3">
                            <p><strong><i class="fas fa-calendar-alt"></i> التاريخ:</strong> <span id="editInvoiceDate"></span></p>
                            <p><strong><i class="fas fa-hashtag"></i> عدد المواد:</strong> <span id="editTotalItems">0</span></p>
                            <p><strong><i class="fas fa-coins"></i> المجموع الكلي:</strong> <span id="editTotalAmount">0.00</span></p>
                            <div class="mb-3">
                                <label for="editAmountPaid" class="form-label"><i class="fas fa-money-bill-wave"></i> المبلغ المدفوع</label>
                                <input type="number" class="form-control" id="editAmountPaid" step="0.01" min="0" value="0">
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
                    <button type="button" class="btn btn-primary" onclick="updateInvoice()">حفظ التعديلات</button>
                </div>
            </div>
        </div>
    </div>

    <!-- نافذة إضافة زبون -->
    <div class="modal fade" id="addCustomerModal" tabindex="-1" aria-labelledby="addCustomerModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addCustomerModalLabel"><i class="fas fa-user-plus"></i> إضافة زبون</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="addCustomerForm">
                        <div class="mb-3">
                            <label for="customerName" class="form-label"><i class="fas fa-signature"></i> اسم الزبون (اختياري)</label>
                            <input type="text" class="form-control" id="customerName">
                        </div>
                        <div class="mb-3">
                            <label for="customerPhone" class="form-label"><i class="fas fa-mobile-alt"></i> رقم الهاتف (اختياري)</label>
                            <input type="tel" class="form-control" id="customerPhone">
                        </div>
                        <div class="mb-3">
                            <label for="customerAddress" class="form-label"><i class="fas fa-home"></i> العنوان (اختياري)</label>
                            <input type="text" class="form-control" id="customerAddress">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
                    <button type="button" class="btn btn-primary" onclick="addCustomer()">حفظ الزبون</button>
                </div>
            </div>
        </div>
    </div>

    <!-- نافذة تعديل زبون -->
    <div class="modal fade" id="editCustomerModal" tabindex="-1" aria-labelledby="editCustomerModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editCustomerModalLabel"><i class="fas fa-user-edit"></i> تعديل زبون</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="editCustomerForm">
                        <input type="hidden" id="editCustomerId">
                        <div class="mb-3">
                            <label for="editCustomerName" class="form-label"><i class="fas fa-signature"></i> اسم الزبون (اختياري)</label>
                            <input type="text" class="form-control" id="editCustomerName">
                        </div>
                        <div class="mb-3">
                            <label for="editCustomerPhone" class="form-label"><i class="fas fa-mobile-alt"></i> رقم الهاتف (اختياري)</label>
                            <input type="tel" class="form-control" id="editCustomerPhone">
                        </div>
                        <div class="mb-3">
                            <label for="editCustomerAddress" class="form-label"><i class="fas fa-home"></i> العنوان (اختياري)</label>
                            <input type="text" class="form-control" id="editCustomerAddress">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
                    <button type="button" class="btn btn-primary" onclick="updateCustomer()">حفظ التعديلات</button>
                </div>
            </div>
        </div>
    </div>

    <!-- نافذة كشف حساب زبون -->
    <div class="modal fade" id="customerStatementModal" tabindex="-1" aria-labelledby="customerStatementModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="customerStatementModalLabel"><i class="fas fa-file-invoice"></i> كشف حساب زبون</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="customerStatementForm">
                        <div class="mb-3">
                            <label for="statementCustomer" class="form-label"><i class="fas fa-user-check"></i> الزبون</label>
                            <select class="form-select" id="statementCustomer" required>
                                <option value="">اختر زبونًا</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="startDate" class="form-label"><i class="fas fa-calendar-day"></i> من تاريخ</label>
                            <input type="date" class="form-control" id="startDate" required>
                        </div>
                        <div class="mb-3">
                            <label for="endDate" class="form-label"><i class="fas fa-calendar-day"></i> إلى تاريخ</label>
                            <input type="date" class="form-control" id="endDate" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
                    <button type="button" class="btn btn-primary" onclick="generateCustomerStatement()">إنشاء الكشف</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let db;
        let html5QrCodeScanner; // For QR Code scanner instance

        // Helper function to format date as DD-MM-YYYY HH:MM
        function formatDateForDisplay(isoString) {
            if (!isoString) return 'N/A';
            const date = new Date(isoString);
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0'); // Months are 0-indexed
            const year = date.getFullYear();
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            return `${day}-${month}-${year} ${hours}:${minutes}`;
        }


        // إعداد IndexedDB
        function initDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open('InventoryDB', 2); 
                request.onupgradeneeded = (event) => {
                    db = event.target.result;
                    if (!db.objectStoreNames.contains('products')) {
                        db.createObjectStore('products', { keyPath: 'id' });
                    }
                    if (!db.objectStoreNames.contains('invoices')) {
                        const invoiceStore = db.createObjectStore('invoices', { keyPath: 'id' });
                        invoiceStore.createIndex('customerId', 'customerId', { unique: false });
                    }
                    if (!db.objectStoreNames.contains('customers')) {
                        const customerStore = db.createObjectStore('customers', { keyPath: 'id' });
                        customerStore.createIndex('phone', 'phone', { unique: false }); 
                    }
                };
                request.onsuccess = (event) => {
                    db = event.target.result;
                    resolve(db);
                };
                request.onerror = (event) => {
                    console.error("Database error: " + event.target.errorCode);
                    reject(event.target.error);
                };
            });
        }
        
        async function ensureDBInitialized() {
            if (!db) {
                try {
                    await initDB();
                } catch (error) {
                    console.error('Failed to initialize database:', error);
                    throw new Error('Failed to initialize database: ' + error.message);
                }
            }
            if (!db) { 
                throw new Error('Database not ready after initialization attempt.');
            }
        }

        async function generateUniqueId(storeName) {
            await ensureDBInitialized();
            let id;
            let isUnique = false;
            const existingIds = await getAllIds(storeName); 
            while (!isUnique) {
                id = Math.floor(10000 + Math.random() * 90000).toString();
                isUnique = !existingIds.includes(id);
            }
            return id;
        }

        function getAllIds(storeName) {
            return new Promise(async (resolve, reject) => {
                try {
                    await ensureDBInitialized();
                    const transaction = db.transaction([storeName], 'readonly');
                    const store = transaction.objectStore(storeName);
                    const request = store.getAllKeys(); 
                    request.onsuccess = () => {
                        resolve(request.result);
                    };
                    request.onerror = (event) => reject(event.target.error);
                } catch (error) {
                    reject(error);
                }
            });
        }

        function getAllProducts() {
            return new Promise(async (resolve, reject) => {
                try {
                    await ensureDBInitialized();
                    const transaction = db.transaction(['products'], 'readonly');
                    const store = transaction.objectStore('products');
                    const request = store.getAll();
                    request.onsuccess = () => resolve(request.result || []);
                    request.onerror = (event) => reject(event.target.error);
                } catch (error) {
                    reject(error);
                }
            });
        }
        
        function checkProductExists(productId) {
            return new Promise(async (resolve) => {
                try {
                    await ensureDBInitialized();
                    const transaction = db.transaction(['products'], 'readonly');
                    const store = transaction.objectStore('products');
                    const request = store.get(productId);
                    request.onsuccess = () => resolve(!!request.result); // True if product exists
                    request.onerror = () => resolve(false); // Error, assume not exists
                } catch (e) { resolve(false); }
            });
        }


        function getAllInvoices() {
            return new Promise(async (resolve, reject) => {
                try {
                    await ensureDBInitialized();
                    const transaction = db.transaction(['invoices'], 'readonly');
                    const store = transaction.objectStore('invoices');
                    const request = store.getAll();
                    request.onsuccess = () => resolve(request.result || []);
                    request.onerror = (event) => reject(event.target.error);
                } catch (error) {
                    reject(error);
                }
            });
        }

        function getAllCustomers() {
            return new Promise(async (resolve, reject) => {
                try {
                    await ensureDBInitialized();
                    const transaction = db.transaction(['customers'], 'readonly');
                    const store = transaction.objectStore('customers');
                    const request = store.getAll();
                    request.onsuccess = () => resolve(request.result || []);
                    request.onerror = (event) => reject(event.target.error);
                } catch (error) {
                    reject(error);
                }
            });
        }

        async function updateDashboard() {
            const invoices = await getAllInvoices();
            const paid = invoices.filter(i => parseFloat(i.amountPaid) >= parseFloat(i.totalAmount) && parseFloat(i.totalAmount) > 0).length;
            const partial = invoices.filter(i => parseFloat(i.amountPaid) > 0 && parseFloat(i.amountPaid) < parseFloat(i.totalAmount)).length;
            const unpaid = invoices.filter(i => parseFloat(i.amountPaid) === 0 && parseFloat(i.totalAmount) > 0).length;


            document.getElementById('paidInvoices').innerText = paid;
            document.getElementById('partialInvoices').innerText = partial;
            document.getElementById('unpaidInvoices').innerText = unpaid;
        }

        async function updateInvoicesTable() {
            const invoices = await getAllInvoices();
            const customers = await getAllCustomers();
            const tableBody = document.getElementById('invoicesTable');
            tableBody.innerHTML = '';

            invoices.sort((a, b) => new Date(b.date) - new Date(a.date)); 

            invoices.forEach((invoice, index) => {
                const customer = customers.find(c => c.id === invoice.customerId);
                const totalAmount = parseFloat(invoice.totalAmount);
                const amountPaid = parseFloat(invoice.amountPaid);
                let statusClass, statusText;

                if (totalAmount === 0 && amountPaid === 0) { // Consider invoices with 0 total and 0 paid (e.g. returns or empty)
                    statusClass = ''; // No specific class or a 'neutral' class
                    statusText = 'لا يوجد مبلغ';
                } else if (amountPaid >= totalAmount) {
                    statusClass = 'status-paid';
                    statusText = 'مدفوع';
                } else if (amountPaid > 0) {
                    statusClass = 'status-partial';
                    statusText = 'مدفوع جزئيًا';
                } else { // amountPaid is 0 and totalAmount > 0
                    statusClass = 'status-unpaid';
                    statusText = 'لم يتم الدفع';
                }


                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${invoice.id}</td>
                    <td>${customer?.name || 'زبون محذوف/غير معروف'}</td>
                    <td>${customer?.phone || '-'}</td>
                    <td>${totalAmount.toFixed(2)}</td>
                    <td class="${statusClass}">${statusText}</td>
                    <td>
                        <i class="fas fa-print action-btn print" onclick="printInvoice('${invoice.id}')" title="طباعة"></i>
                        <i class="fas fa-edit action-btn edit" onclick="editInvoice('${invoice.id}')" title="تعديل"></i>
                        <!-- Delete button removed from UI as requested -->
                    </td>
                `;
                tableBody.appendChild(row);
            });
            updateDashboard(); // Update dashboard after table is updated
            // filterTable(); // Call filterTable if you want to apply existing filters immediately after refresh
        }

        async function updateCustomersTable() {
            const customers = await getAllCustomers();
            const tableBody = document.getElementById('customersTable');
            tableBody.innerHTML = '';

            customers.forEach((customer, index) => {
                const row = document.createElement('tr');
                const displayName = customer.name || 'زبون بدون اسم';
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${displayName}</td>
                    <td>${customer.phone || '-'}</td>
                    <td>${customer.address || '-'}</td>
                    <td>
                        <i class="fas fa-edit action-btn edit" onclick="editCustomer('${customer.id}')" title="تعديل"></i>
                        <i class="fas fa-trash action-btn delete" onclick="deleteCustomer('${customer.id}')" title="حذف"></i>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }

        async function filterTable() {
            const searchInput = document.getElementById('searchInput').value.toLowerCase();
            const statusFilter = document.getElementById('statusFilter').value;
            const invoices = await getAllInvoices(); // Fetch fresh list
            const customers = await getAllCustomers(); // Fetch fresh list
            const tableBody = document.getElementById('invoicesTable');
            
            const filteredInvoices = invoices.filter(invoice => {
                const customer = customers.find(c => c.id === invoice.customerId);
                const customerName = customer?.name?.toLowerCase() || '';
                const matchesSearch = customerName.includes(searchInput) || invoice.id.includes(searchInput);
                
                if (!matchesSearch) return false;

                const totalAmount = parseFloat(invoice.totalAmount);
                const amountPaid = parseFloat(invoice.amountPaid);

                if (statusFilter === 'all') return true;
                if (statusFilter === 'paid') return amountPaid >= totalAmount && totalAmount > 0; // Ensure total > 0 for 'paid'
                if (statusFilter === 'partial') return amountPaid > 0 && amountPaid < totalAmount;
                if (statusFilter === 'unpaid') return amountPaid === 0 && totalAmount > 0; // Ensure total > 0 for 'unpaid'
                
                // This case should ideally not be reached if statusFilter has a valid value from the dropdown.
                // If it's reached, it means an unknown filter value, so include the item.
                return true; 
            });

            tableBody.innerHTML = ''; 
            filteredInvoices.sort((a, b) => new Date(b.date) - new Date(a.date)); // Re-sort filtered results

            filteredInvoices.forEach((invoice, index) => {
                const customer = customers.find(c => c.id === invoice.customerId);
                const totalAmount = parseFloat(invoice.totalAmount);
                const amountPaid = parseFloat(invoice.amountPaid);
                let statusClass, statusText;

                 if (totalAmount === 0 && amountPaid === 0) {
                    statusClass = ''; statusText = 'لا يوجد مبلغ';
                } else if (amountPaid >= totalAmount) {
                    statusClass = 'status-paid'; statusText = 'مدفوع';
                } else if (amountPaid > 0) {
                    statusClass = 'status-partial'; statusText = 'مدفوع جزئيًا';
                } else {
                    statusClass = 'status-unpaid'; statusText = 'لم يتم الدفع';
                }

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${invoice.id}</td>
                    <td>${customer?.name || 'زبون محذوف/غير معروف'}</td>
                    <td>${customer?.phone || '-'}</td>
                    <td>${totalAmount.toFixed(2)}</td>
                    <td class="${statusClass}">${statusText}</td>
                    <td>
                        <i class="fas fa-print action-btn print" onclick="printInvoice('${invoice.id}')" title="طباعة"></i>
                        <i class="fas fa-edit action-btn edit" onclick="editInvoice('${invoice.id}')" title="تعديل"></i>
                    </td>
                `;
                tableBody.appendChild(row);
            });
            // No need to call updateDashboard here as it's called in updateInvoicesTable which is called by other functions.
            // However, if filterTable is called independently (e.g., on search input), then dashboard might need update based on filtered view, or just reflect all invoices.
            // For simplicity, let dashboard always reflect all invoices. It's updated by main table update functions.
        }


        async function populateCustomerSelect(selectElementId) {
            const customers = await getAllCustomers();
            const select = document.getElementById(selectElementId);
            const currentValue = select.value; // Preserve current selection if possible
            select.innerHTML = '<option value="">اختر زبونًا...</option>'; 
            customers.forEach(customer => {
                const option = document.createElement('option');
                option.value = customer.id;
                option.textContent = customer.name || `زبون (${customer.phone || 'معرف: ' + customer.id.slice(0,5)})`;
                select.appendChild(option);
            });
            if (currentValue) { // Attempt to restore selection
                 select.value = currentValue;
            }
        }

        async function updateCustomerInfo(selectElementId, phoneElementId, addressElementId) {
            const customerId = document.getElementById(selectElementId).value;
            const phoneInput = document.getElementById(phoneElementId);
            const addressInput = document.getElementById(addressElementId);

            if (customerId) {
                const customers = await getAllCustomers(); // Fetch fresh customer data
                const customer = customers.find(c => c.id === customerId);
                phoneInput.value = customer?.phone || '';
                addressInput.value = customer?.address || '';
            } else {
                phoneInput.value = '';
                addressInput.value = '';
            }
        }
        
        async function setupProductSearch(searchElementId, suggestionsElementId, productsTableId, isEditModal = false) {
            const searchInput = document.getElementById(searchElementId);
            const suggestionsDiv = document.getElementById(suggestionsElementId);
            
            searchInput.addEventListener('input', async (e) => {
                const query = e.target.value.toLowerCase().trim();
                suggestionsDiv.innerHTML = ''; 
                if (query.length < 1) return; 

                const allProducts = await getAllProducts();
                const availableProducts = allProducts.filter(p => p.quantity > 0); 
                
                const filteredProducts = availableProducts.filter(p => 
                    p.name.toLowerCase().includes(query) || 
                    p.id.includes(query)
                ).slice(0, 10); 

                if (filteredProducts.length > 0) {
                    filteredProducts.forEach(product => {
                        const div = document.createElement('div');
                        div.className = 'list-group-item list-group-item-action';
                        
                        const salePriceFormatted = parseFloat(product.salePrice || 0).toFixed(2);
                        
                        // --- MODIFICATION FOR costPrice ---
                        let costPriceFormatted;
                        if (typeof product.costPrice === 'number') { // Handles 0 as a valid cost price
                            costPriceFormatted = parseFloat(product.costPrice).toFixed(2);
                        } else if (product.costPrice && !isNaN(parseFloat(product.costPrice))) { // Handles string numbers
                            costPriceFormatted = parseFloat(product.costPrice).toFixed(2);
                        } else {
                            costPriceFormatted = 'غ/م'; // Not available or not a valid number
                        }
                        // --- END MODIFICATION ---
                        
                        div.innerHTML = `
                            <strong>${product.name}</strong> (المعرف: ${product.id}) <br>
                            <small>
                                سعر البيع: ${salePriceFormatted} | 
                                سعر الشراء: ${costPriceFormatted} | 
                                الكمية المتوفرة: ${product.quantity}
                            </small>
                        `;
                        div.onclick = () => {
                            addProductToInvoice(product, productsTableId);
                            searchInput.value = ''; 
                            suggestionsDiv.innerHTML = ''; 
                        };
                        suggestionsDiv.appendChild(div);
                    });
                } else {
                    suggestionsDiv.innerHTML = '<div class="list-group-item">لا توجد منتجات مطابقة أو غير متوفرة.</div>';
                }
            });
        }


        function addProductToInvoice(product, productsTableId) {
            const tableBody = document.getElementById(productsTableId);
            const existingRow = Array.from(tableBody.rows).find(row => row.dataset.productId === product.id);

            if (existingRow) {
                const quantityInput = existingRow.querySelector('.quantity');
                const currentQuantity = parseInt(quantityInput.value);
                if (currentQuantity < product.quantity) { 
                    quantityInput.value = currentQuantity + 1;
                } else {
                    Swal.fire('تنبيه', `الكمية المطلوبة للمنتج "${product.name}" تتجاوز المخزون المتاح (${product.quantity}).`, 'warning');
                    return;
                }
            } else {
                if (product.quantity < 1) { 
                     Swal.fire('تنبيه', `المنتج "${product.name}" غير متوفر في المخزون.`, 'warning');
                    return;
                }
                const row = tableBody.insertRow();
                row.dataset.productId = product.id; 
                
                row.innerHTML = `
                    <td>${product.name}</td>
                    <td><input type="number" class="form-control form-control-sm sale-price" value="${parseFloat(product.salePrice || 0).toFixed(2)}" step="0.01" min="0.01"></td>
                    <td><input type="number" class="form-control form-control-sm quantity" value="1" min="1" max="${product.quantity}"></td>
                    <td><input type="text" class="form-control form-control-sm note" placeholder="ملاحظة (اختياري)"></td>
                    <td class="total">${parseFloat(product.salePrice || 0).toFixed(2)}</td>
                    <td><button type="button" class="btn btn-sm btn-danger" onclick="removeProductFromInvoice(this.closest('tr'), '${productsTableId}')"><i class="fas fa-trash-alt"></i></button></td>
                `;
                row.querySelector('.sale-price').addEventListener('input', () => updateInvoiceTotals(productsTableId));
                row.querySelector('.quantity').addEventListener('input', (e) => {
                    const requestedQuantity = parseInt(e.target.value);
                    const maxQuantityForThisProduct = parseInt(e.target.max); // Use the max attribute of the input

                    if (requestedQuantity > maxQuantityForThisProduct) {
                        e.target.value = maxQuantityForThisProduct; 
                        Swal.fire('تنبيه', `الكمية المطلوبة للمنتج "${product.name}" تتجاوز المخزون المتاح (${maxQuantityForThisProduct}). تم التعديل للحد الأقصى.`, 'warning');
                    }
                    updateInvoiceTotals(productsTableId);
                });
            }
            updateInvoiceTotals(productsTableId);
        }


        function removeProductFromInvoice(rowElement, productsTableId) {
            rowElement.remove();
            updateInvoiceTotals(productsTableId);
        }

        function updateInvoiceTotals(productsTableId) {
            const tableBody = document.getElementById(productsTableId);
            const rows = tableBody.querySelectorAll('tr');
            let totalAmount = 0;
            let totalItemsCount = 0; 

            rows.forEach(row => {
                const salePriceInput = row.querySelector('.sale-price');
                const quantityInput = row.querySelector('.quantity');
                
                const salePrice = parseFloat(salePriceInput.value) || 0;
                const quantity = parseInt(quantityInput.value) || 0;
                
                const itemTotal = salePrice * quantity;
                row.querySelector('.total').textContent = itemTotal.toFixed(2);
                totalAmount += itemTotal;
                totalItemsCount++; 
            });

            const isEditModal = productsTableId === 'editInvoiceProducts';
            document.getElementById(isEditModal ? 'editTotalItems' : 'totalItems').textContent = totalItemsCount; 
            document.getElementById(isEditModal ? 'editTotalAmount' : 'totalAmount').textContent = totalAmount.toFixed(2);
        }

        async function addInvoice() {
            const customerId = document.getElementById('invoiceCustomer').value;
            const amountPaidValue = document.getElementById('amountPaid').value;
            const productsTable = document.getElementById('invoiceProducts');
            const rows = productsTable.querySelectorAll('tr');

            if (!customerId) {
                Swal.fire('خطأ', 'الرجاء اختيار زبون!', 'error'); return;
            }
            if (rows.length === 0) {
                Swal.fire('خطأ', 'الرجاء إضافة منتج واحد على الأقل للفاتورة!', 'error'); return;
            }
            const amountPaid = parseFloat(amountPaidValue);
            if (isNaN(amountPaid) || amountPaid < 0) {
                 Swal.fire('خطأ', 'المبلغ المدفوع غير صحيح!', 'error'); return;
            }

            const productsInInvoice = [];
            let totalAmount = 0;
            let stockUpdatePromises = [];

            for (const row of rows) {
                const productId = row.dataset.productId;
                const name = row.cells[0].textContent;
                const salePrice = parseFloat(row.querySelector('.sale-price').value);
                const quantitySold = parseInt(row.querySelector('.quantity').value);
                const note = row.querySelector('.note').value;
                const itemTotal = salePrice * quantitySold;

                if (isNaN(salePrice) || salePrice <=0 || isNaN(quantitySold) || quantitySold <=0) {
                    Swal.fire('خطأ', `بيانات غير صالحة للمنتج "${name}". تأكد من السعر والكمية.`, 'error'); return;
                }

                productsInInvoice.push({ productId, name, salePrice, quantity: quantitySold, note, total: itemTotal });
                totalAmount += itemTotal;
                stockUpdatePromises.push(updateProductStock(productId, quantitySold));
            }
             if (amountPaid > totalAmount) {
                Swal.fire('خطأ', 'المبلغ المدفوع لا يمكن أن يكون أكبر من المجموع الكلي للفاتورة!', 'error'); return;
            }

            try {
                await Promise.all(stockUpdatePromises); 
            } catch (error) {
                Swal.fire('خطأ في تحديث المخزون', error.message, 'error');
                return;
            }

            const id = await generateUniqueId('invoices');
            const invoice = {
                id,
                customerId,
                products: productsInInvoice,
                totalAmount: totalAmount.toFixed(2),
                amountPaid: amountPaid.toFixed(2),
                date: new Date().toISOString()
            };

            const transaction = db.transaction(['invoices'], 'readwrite');
            const store = transaction.objectStore('invoices');
            const request = store.add(invoice);

            request.onsuccess = async () => {
                await updateInvoicesTable(); // This also updates dashboard
                bootstrap.Modal.getInstance(document.getElementById('addInvoiceModal')).hide();
                document.getElementById('addInvoiceForm').reset();
                document.getElementById('invoiceProducts').innerHTML = ''; 
                document.getElementById('totalItems').textContent = '0';
                document.getElementById('totalAmount').textContent = '0.00';
                document.getElementById('customerPhoneDisplay').value = '';
                document.getElementById('customerAddressDisplay').value = '';
                document.getElementById('invoiceDate').textContent = formatDateForDisplay(new Date().toISOString()); // Reset date
                await populateCustomerSelect('invoiceCustomer'); 
                Swal.fire('نجاح', 'تم إضافة الفاتورة وتحديث المخزون بنجاح!', 'success');
            };
            request.onerror = (e) => {
                console.error("Error adding invoice:", e.target.error);
                Swal.fire('خطأ', 'فشل في إضافة الفاتورة!', 'error');
            };
        }
        
        function updateProductStock(productId, quantitySold) {
            return new Promise(async (resolve, reject) => {
                try {
                    await ensureDBInitialized();
                    const transaction = db.transaction(['products'], 'readwrite');
                    const store = transaction.objectStore('products');
                    const getRequest = store.get(productId);

                    getRequest.onsuccess = () => {
                        const product = getRequest.result;
                        if (!product) {
                            reject(new Error(`المنتج بالمعرف ${productId} غير موجود.`));
                            return;
                        }
                        if (product.quantity < quantitySold) {
                            reject(new Error(`الكمية المطلوبة للمنتج "${product.name}" (${quantitySold}) تتجاوز المخزون المتاح (${product.quantity}).`));
                            return;
                        }
                        product.quantity -= quantitySold;
                        const updateRequest = store.put(product);
                        updateRequest.onsuccess = () => resolve();
                        updateRequest.onerror = (e) => reject(new Error(`فشل تحديث مخزون المنتج ${product.name}: ${e.target.error}`));
                    };
                    getRequest.onerror = (e) => reject(new Error(`فشل جلب المنتج ${productId} لتحديث المخزون: ${e.target.error}`));
                } catch (dbError) {
                    reject(dbError);
                }
            });
        }


        async function editInvoice(invoiceId) {
            try {
                await ensureDBInitialized();
                const transaction = db.transaction(['invoices', 'customers', 'products'], 'readonly'); 
                const invoiceStore = transaction.objectStore('invoices');
                const invoiceRequest = invoiceStore.get(invoiceId);

                invoiceRequest.onsuccess = async () => {
                    const invoice = invoiceRequest.result;
                    if (!invoice) {
                        Swal.fire('خطأ', 'الفاتورة غير موجودة!', 'error');
                        return;
                    }
                    
                    document.getElementById('editInvoiceModal').dataset.originalProducts = JSON.stringify(invoice.products);
                    document.getElementById('editInvoiceId').value = invoice.id;
                    
                    const customerSelect = document.getElementById('editInvoiceCustomer');
                    await populateCustomerSelect('editInvoiceCustomer'); 
                    customerSelect.value = invoice.customerId;
                    await updateCustomerInfo('editInvoiceCustomer', 'editCustomerPhoneDisplay', 'editCustomerAddressDisplay');

                    document.getElementById('editInvoiceDate').textContent = formatDateForDisplay(invoice.date);
                    document.getElementById('editAmountPaid').value = parseFloat(invoice.amountPaid).toFixed(2);

                    const tableBody = document.getElementById('editInvoiceProducts');
                    tableBody.innerHTML = ''; 

                    const allProductsFromDB = await getAllProducts(); 

                    invoice.products.forEach(pInInvoice => {
                        const productDetailsFromDB = allProductsFromDB.find(pDB => pDB.id === pInInvoice.productId);
                        const currentStockInDB = productDetailsFromDB ? productDetailsFromDB.quantity : 0;
                        const maxQuantityForInput = currentStockInDB + pInInvoice.quantity;


                        const row = tableBody.insertRow();
                        row.dataset.productId = pInInvoice.productId;
                        row.dataset.originalQuantityInInvoice = pInInvoice.quantity; 
                        row.dataset.maxEditableQuantity = maxQuantityForInput;


                        row.innerHTML = `
                            <td>${pInInvoice.name}</td>
                            <td><input type="number" class="form-control form-control-sm sale-price" value="${parseFloat(pInInvoice.salePrice).toFixed(2)}" step="0.01" min="0.01"></td>
                            <td><input type="number" class="form-control form-control-sm quantity" value="${pInInvoice.quantity}" min="1" max="${maxQuantityForInput}"></td>
                            <td><input type="text" class="form-control form-control-sm note" value="${pInInvoice.note || ''}" placeholder="ملاحظة"></td>
                            <td class="total">${parseFloat(pInInvoice.total).toFixed(2)}</td>
                            <td><button type="button" class="btn btn-sm btn-danger" onclick="removeProductFromInvoice(this.closest('tr'), 'editInvoiceProducts')"><i class="fas fa-trash-alt"></i></button></td>
                        `;
                        row.querySelector('.sale-price').addEventListener('input', () => updateInvoiceTotals('editInvoiceProducts'));
                        row.querySelector('.quantity').addEventListener('input', (e) => {
                             const requestedQuantity = parseInt(e.target.value);
                             const maxAllowed = parseInt(e.target.max); 
                             if (requestedQuantity > maxAllowed) {
                                e.target.value = maxAllowed;
                                Swal.fire('تنبيه', `الكمية المطلوبة للمنتج "${pInInvoice.name}" تتجاوز المخزون المتاح. تم التعديل للحد الأقصى (${maxAllowed}).`, 'warning');
                            }
                            updateInvoiceTotals('editInvoiceProducts');
                        });
                    });

                    updateInvoiceTotals('editInvoiceProducts');
                    new bootstrap.Modal(document.getElementById('editInvoiceModal')).show();
                };
                invoiceRequest.onerror = (e) => Swal.fire('خطأ', `فشل في جلب الفاتورة: ${e.target.error}`, 'error');
            } catch (dbError) {
                 Swal.fire('خطأ قاعدة البيانات', `فشل: ${dbError.message}`, 'error');
            }
        }


        async function updateInvoice() {
            const id = document.getElementById('editInvoiceId').value;
            const customerId = document.getElementById('editInvoiceCustomer').value;
            const amountPaidValue = document.getElementById('editAmountPaid').value;
            const productsTable = document.getElementById('editInvoiceProducts');
            const rows = productsTable.querySelectorAll('tr');
            
            const originalProductsJSON = document.getElementById('editInvoiceModal').dataset.originalProducts;
            const originalProductsInInvoice = JSON.parse(originalProductsJSON || "[]"); 


            if (!customerId) { Swal.fire('خطأ', 'الرجاء اختيار زبون!', 'error'); return; }
            if (rows.length === 0) { Swal.fire('خطأ', 'الفاتورة يجب أن تحتوي على منتج واحد على الأقل!', 'error'); return; }
            const amountPaid = parseFloat(amountPaidValue);
             if (isNaN(amountPaid) || amountPaid < 0) { Swal.fire('خطأ', 'المبلغ المدفوع غير صحيح!', 'error'); return; }


            const updatedProductsInInvoice = [];
            let newTotalAmount = 0;
            let stockAdjustmentPromises = []; 

            for (const row of rows) {
                const productId = row.dataset.productId;
                const name = row.cells[0].textContent;
                const salePrice = parseFloat(row.querySelector('.sale-price').value);
                const newQuantitySold = parseInt(row.querySelector('.quantity').value);
                const note = row.querySelector('.note').value;
                const itemTotal = salePrice * newQuantitySold;

                if (isNaN(salePrice) || salePrice <=0 || isNaN(newQuantitySold) || newQuantitySold <=0) {
                    Swal.fire('خطأ', `بيانات غير صالحة للمنتج "${name}". تأكد من السعر والكمية.`, 'error'); return;
                }

                updatedProductsInInvoice.push({ productId, name, salePrice, quantity: newQuantitySold, note, total: itemTotal });
                newTotalAmount += itemTotal;

                const originalProductInfo = originalProductsInInvoice.find(p => p.productId === productId);
                const originalQuantitySoldInThisInvoice = originalProductInfo ? originalProductInfo.quantity : 0;
                
                const quantityChangeForStock = originalQuantitySoldInThisInvoice - newQuantitySold; 
                
                if (quantityChangeForStock !== 0) {
                    const productExists = await checkProductExists(productId);
                    if (productExists) {
                         stockAdjustmentPromises.push(adjustProductStock(productId, quantityChangeForStock));
                    } else {
                        console.warn(`Product ${productId} not found in DB. Skipping stock adjustment for this item.`);
                    }
                }
            }
            
            originalProductsInInvoice.forEach(async origP => {
                if (!updatedProductsInInvoice.some(updP => updP.productId === origP.productId)) {
                    const productExists = await checkProductExists(origP.productId);
                     if (productExists) {
                        stockAdjustmentPromises.push(adjustProductStock(origP.productId, origP.quantity)); 
                     } else {
                        console.warn(`Product ${origP.productId} (removed from invoice) not found in DB. Skipping stock adjustment for this item.`);
                     }
                }
            });


            if (amountPaid > newTotalAmount) {
                Swal.fire('خطأ', 'المبلغ المدفوع لا يمكن أن يكون أكبر من المجموع الكلي للفاتورة!', 'error'); return;
            }

            try {
                if (stockAdjustmentPromises.length > 0) {
                    await Promise.all(stockAdjustmentPromises);
                }
            } catch (error) {
                Swal.fire('خطأ في تحديث المخزون', error.message, 'error');
                return; 
            }
            
            let invoiceDateStr = document.getElementById('editInvoiceDate').textContent;
            let invoiceDateISO;
            if (invoiceDateStr && invoiceDateStr !== 'N/A') {
                const parts = invoiceDateStr.match(/(\d{2})-(\d{2})-(\d{4}) (\d{2}):(\d{2})/);
                if (parts) {
                    // parts[1]=day, parts[2]=month, parts[3]=year, parts[4]=hour, parts[5]=minute
                    invoiceDateISO = new Date(Date.UTC(parts[3], parts[2] - 1, parts[1], parts[4], parts[5])).toISOString();
                } else {
                    invoiceDateISO = new Date().toISOString(); 
                }
            } else {
                 invoiceDateISO = new Date().toISOString(); 
            }


            const invoice = {
                id,
                customerId,
                products: updatedProductsInInvoice,
                totalAmount: newTotalAmount.toFixed(2),
                amountPaid: amountPaid.toFixed(2),
                date: invoiceDateISO 
            };

            const transaction = db.transaction(['invoices'], 'readwrite');
            const store = transaction.objectStore('invoices');
            const request = store.put(invoice);

            request.onsuccess = async () => {
                await updateInvoicesTable(); // This also updates dashboard
                bootstrap.Modal.getInstance(document.getElementById('editInvoiceModal')).hide();
                Swal.fire('نجاح', 'تم تعديل الفاتورة وتحديث المخزون بنجاح!', 'success');
            };
            request.onerror = (e) => {
                 console.error("Error updating invoice:", e.target.error);
                 Swal.fire('خطأ', 'فشل في تعديل الفاتورة!', 'error');
            };
        }

        function adjustProductStock(productId, quantityChange) {
            return new Promise(async (resolve, reject) => {
                try {
                    await ensureDBInitialized();
                    const transaction = db.transaction(['products'], 'readwrite');
                    const store = transaction.objectStore('products');
                    const getRequest = store.get(productId);

                    getRequest.onsuccess = () => {
                        const product = getRequest.result;
                        if (!product) {
                            // It's possible a product was deleted from inventory system externally
                            // while it was still in an invoice. Log this instead of hard failing the whole invoice update.
                            console.warn(`المنتج بالمعرف ${productId} غير موجود لتعديل المخزون. سيتم تخطي هذا المنتج.`);
                            resolve(); // Resolve to not block other stock adjustments
                            return;
                        }
                        
                        const newStock = product.quantity + quantityChange;
                        if (newStock < 0) { 
                             reject(new Error(`لا يمكن أن يكون مخزون المنتج "${product.name}" سالبًا. التغيير المطلوب للمخزون: ${quantityChange}, المخزون الحالي: ${product.quantity}.`));
                             return;
                        }
                        product.quantity = newStock;

                        const updateRequest = store.put(product);
                        updateRequest.onsuccess = () => resolve();
                        updateRequest.onerror = (e) => reject(new Error(`فشل تعديل مخزون المنتج ${product.name}: ${e.target.error}`));
                    };
                    getRequest.onerror = (e) => reject(new Error(`فشل جلب المنتج ${productId} لتعديل المخزون: ${e.target.error}`));
                } catch (dbError) {
                    reject(dbError);
                }
            });
        }

        async function deleteInvoice(invoiceId) { // This function is not called from UI but kept for potential use
            const result = await Swal.fire({
                title: 'تأكيد الحذف',
                text: 'هل أنت متأكد من حذف هذه الفاتورة؟ سيتم إرجاع الكميات المباعة إلى المخزون.',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'نعم، احذف',
                cancelButtonText: 'إلغاء',
                confirmButtonColor: '#dc3545',
                cancelButtonColor: '#6c757d'
            });

            if (result.isConfirmed) {
                try {
                    await ensureDBInitialized();
                    const readTx = db.transaction(['invoices'], 'readonly'); 
                    const invoiceStoreRead = readTx.objectStore('invoices');
                    const getInvoiceRequest = invoiceStoreRead.get(invoiceId);

                    getInvoiceRequest.onsuccess = async () => {
                        const invoiceToDelete = getInvoiceRequest.result;
                        if (!invoiceToDelete) {
                            Swal.fire('خطأ', 'الفاتورة غير موجودة.', 'error');
                            return;
                        }

                        let stockReturnPromises = [];
                        for (const p of invoiceToDelete.products) {
                            const productExists = await checkProductExists(p.productId);
                            if (productExists) {
                                stockReturnPromises.push(adjustProductStock(p.productId, p.quantity));
                            } else {
                                console.warn(`Product ${p.productId} from deleted invoice not found. Stock not returned for this item.`);
                            }
                        }
                        
                        try {
                            if (stockReturnPromises.length > 0) {
                                await Promise.all(stockReturnPromises); 
                            }

                            const writeTxDelete = db.transaction(['invoices'], 'readwrite');
                            const invoiceStoreWrite = writeTxDelete.objectStore('invoices');
                            const deleteRequest = invoiceStoreWrite.delete(invoiceId);

                            deleteRequest.onsuccess = async () => {
                                await updateInvoicesTable(); // This also updates dashboard
                                Swal.fire('نجاح', 'تم حذف الفاتورة وإرجاع المنتجات للمخزون بنجاح!', 'success');
                            };
                            deleteRequest.onerror = (e) => {
                                console.error("Error deleting invoice:", e.target.error);
                                Swal.fire('خطأ', 'فشل في حذف الفاتورة! (قد يكون المخزون أُرجع).', 'error');
                            };

                        } catch (stockError) {
                            Swal.fire('خطأ في إرجاع المخزون', stockError.message, 'error');
                        }
                    };
                    getInvoiceRequest.onerror = (e) => Swal.fire('خطأ', `فشل في جلب الفاتورة للحذف: ${e.target.error}`, 'error');

                } catch (dbError) {
                     Swal.fire('خطأ قاعدة البيانات', `فشل: ${dbError.message}`, 'error');
                }
            }
        }


        async function addCustomer() {
            const name = document.getElementById('customerName').value.trim();
            const phone = document.getElementById('customerPhone').value.trim();
            const address = document.getElementById('customerAddress').value.trim();
            
            if (!name && !phone && !address) {
                 Swal.fire('خطأ', 'يجب إدخال معلومة واحدة على الأقل للزبون (الاسم أو الهاتف أو العنوان).', 'error');
                 return;
            }

            if (phone) { 
                const customers = await getAllCustomers();
                if (customers.some(c => c.phone === phone && phone !== '')) { // Ensure phone isn't empty string
                    Swal.fire('خطأ', 'رقم الهاتف هذا مُسجل لزبون آخر!', 'error');
                    return;
                }
            }


            const id = await generateUniqueId('customers');
            const customer = { 
                id, 
                name: name || null, // Store null if empty for consistency
                phone: phone || null, 
                address: address || null 
            };


            const transaction = db.transaction(['customers'], 'readwrite');
            const store = transaction.objectStore('customers');
            const request = store.add(customer);

            request.onsuccess = async () => {
                await updateCustomersTable();
                await populateCustomerSelect('invoiceCustomer');
                await populateCustomerSelect('editInvoiceCustomer');
                await populateCustomerSelect('statementCustomer');
                bootstrap.Modal.getInstance(document.getElementById('addCustomerModal')).hide();
                document.getElementById('addCustomerForm').reset();
                Swal.fire('نجاح', 'تم إضافة الزبون بنجاح!', 'success');
            };
            request.onerror = (e) => Swal.fire('خطأ', `فشل في إضافة الزبون: ${e.target.error}`, 'error');
        }

        async function editCustomer(customerId) {
            try {
                await ensureDBInitialized();
                const transaction = db.transaction(['customers'], 'readonly');
                const store = transaction.objectStore('customers');
                const request = store.get(customerId);

                request.onsuccess = () => {
                    const customer = request.result;
                    if (!customer) {
                        Swal.fire('خطأ', 'الزبون غير موجود!', 'error');
                        return;
                    }
                    document.getElementById('editCustomerId').value = customer.id;
                    document.getElementById('editCustomerName').value = customer.name || '';
                    document.getElementById('editCustomerPhone').value = customer.phone || '';
                    document.getElementById('editCustomerAddress').value = customer.address || '';
                    new bootstrap.Modal(document.getElementById('editCustomerModal')).show();
                };
                request.onerror = (e) => Swal.fire('خطأ', `فشل في جلب بيانات الزبون: ${e.target.error}`, 'error');
            } catch (dbError) {
                 Swal.fire('خطأ قاعدة البيانات', `فشل: ${dbError.message}`, 'error');
            }
        }

        async function updateCustomer() {
            const id = document.getElementById('editCustomerId').value;
            const name = document.getElementById('editCustomerName').value.trim();
            const phone = document.getElementById('editCustomerPhone').value.trim();
            const address = document.getElementById('editCustomerAddress').value.trim();

             if (!name && !phone && !address) {
                 Swal.fire('خطأ', 'يجب إدخال معلومة واحدة على الأقل للزبون.', 'error');
                 return;
            }

            if (phone) { 
                const customers = await getAllCustomers();
                if (customers.some(c => c.id !== id && c.phone === phone && phone !== '')) { 
                    Swal.fire('خطأ', 'رقم الهاتف هذا مُسجل لزبون آخر!', 'error');
                    return;
                }
            }

            const customer = { 
                id, 
                name: name || null, 
                phone: phone || null, 
                address: address || null 
            };
            const transaction = db.transaction(['customers'], 'readwrite');
            const store = transaction.objectStore('customers');
            const request = store.put(customer);

            request.onsuccess = async () => {
                await updateCustomersTable();
                await updateInvoicesTable(); // Refresh invoices in case customer name changed
                await populateCustomerSelect('invoiceCustomer');
                await populateCustomerSelect('editInvoiceCustomer');
                await populateCustomerSelect('statementCustomer');
                bootstrap.Modal.getInstance(document.getElementById('editCustomerModal')).hide();
                Swal.fire('نجاح', 'تم تعديل بيانات الزبون بنجاح!', 'success');
            };
            request.onerror = (e) => Swal.fire('خطأ', `فشل في تعديل بيانات الزبون: ${e.target.error}`, 'error');
        }

        async function deleteCustomer(customerId) {
            const invoices = await getAllInvoices();
            if (invoices.some(i => i.customerId === customerId)) {
                Swal.fire('لا يمكن الحذف', 'لا يمكن حذف هذا الزبون لأنه مرتبط بفواتير حالية. يرجى تعديل الفواتير المرتبطة به لزبون آخر أو حذفها (إذا كانت هذه الإمكانية متاحة).', 'error');
                return;
            }


            const result = await Swal.fire({
                title: 'تأكيد الحذف',
                text: 'هل أنت متأكد من حذف هذا الزبون؟ لا يمكن التراجع عن هذا الإجراء.',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'نعم، احذف',
                cancelButtonText: 'إلغاء',
                confirmButtonColor: '#dc3545'
            });

            if (result.isConfirmed) {
                const transaction = db.transaction(['customers'], 'readwrite');
                const store = transaction.objectStore('customers');
                const request = store.delete(customerId);

                request.onsuccess = async () => {
                    await updateCustomersTable();
                    await populateCustomerSelect('invoiceCustomer');
                    await populateCustomerSelect('editInvoiceCustomer');
                    await populateCustomerSelect('statementCustomer');
                    Swal.fire('نجاح', 'تم حذف الزبون بنجاح!', 'success');
                };
                request.onerror = (e) => Swal.fire('خطأ', `فشل في حذف الزبون: ${e.target.error}`, 'error');
            }
        }
        
        async function printInvoice(invoiceId) {
            try {
                await ensureDBInitialized();
                const transaction = db.transaction(['invoices', 'customers'], 'readonly');
                const invoiceStore = transaction.objectStore('invoices');
                const invoiceRequest = invoiceStore.get(invoiceId);

                invoiceRequest.onsuccess = async () => {
                    const invoice = invoiceRequest.result;
                    if (!invoice) { Swal.fire('خطأ', 'الفاتورة غير موجودة.', 'error'); return; }

                    const customers = await getAllCustomers(); 
                    const customer = customers.find(c => c.id === invoice.customerId);
                    
                    const printWindow = window.open('', '_blank', 'height=800,width=600');
                    if (!printWindow) {
                         Swal.fire('خطأ', 'فشل فتح نافذة الطباعة. يرجى التأكد من تعطيل مانع النوافذ المنبثقة.', 'error'); return;
                    }
                    printWindow.document.write(`
                        <!DOCTYPE html>
                        <html lang="ar" dir="rtl">
                        <head>
                            <meta charset="UTF-8">
                            <title>فاتورة رقم: ${invoice.id}</title>
                            <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
                            <style>
                                @page { size: A5 landscape; margin: 5mm; }
                                body { font-family: 'Cairo', sans-serif; direction: rtl; margin: 5mm; font-size: 10pt; }
                                .container { width: 100%; margin: 0 auto; }
                                .header-print { text-align: center; margin-bottom: 10px; border-bottom: 1px solid #ccc; padding-bottom: 5px;}
                                .header-print img { max-height: 40px; margin-bottom: 3px; }
                                .header-print h1 { font-size: 1.1rem; color: #3F2A56; margin:0; }
                                .invoice-info-grid { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px;}
                                .invoice-details-text { flex-basis: 70%;} 
                                .invoice-details, .customer-details { font-size: 0.85rem;}
                                .invoice-details p, .customer-details p { margin: 2px 0; }
                                .qr-code-container { 
                                    flex-basis: auto; /* Adjust to content */
                                    min-width: 75px; 
                                    text-align: center; /* Center the QR code if div is wider */
                                    padding-left: 5px; 
                                } 
                                #invoiceQrCodeElement { /* The div where QR will be generated */
                                    display: inline-block; /* Helps with sizing and centering */
                                }
                                #invoiceQrCodeElement canvas,
                                #invoiceQrCodeElement img {
                                    border: 1px solid #eee; /* Add border to the QR itself */
                                }
                                .products-table { width: 100%; border-collapse: collapse; margin-bottom: 8px; }
                                .products-table th, .products-table td { padding: 4px; border: 1px solid #ccc; text-align: center; font-size: 0.8rem;}
                                .products-table th { background-color: #f2f2f2; color: #333; font-weight:600; }
                                .totals-section { margin-top: 10px; padding-top: 8px; border-top: 1px solid #ccc; text-align:left; font-size: 0.85rem;}
                                .totals-section p { margin: 3px 0; font-weight: 600; }
                                .footer-print { text-align: center; font-size: 0.75rem; margin-top: 15px; color: #777; }
                                @media print {
                                    body { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
                                }
                            </style>
                        </head>
                        <body>
                            <div class="container">
                                <div class="header-print">
                                    <img src="logo.png" alt="شعار" onerror="this.style.display='none';">
                                    <h1>طيبة المدينة تلكوم</h1>
                                    <p style="font-size:0.7rem;">الهاتف: 27101138 - 41101138 </p>
                                       <p style="font-size:0.7rem;">الموقع: انواذيبوا - سوق موريتل</p>
                                </div>
                                
                                <div class="invoice-info-grid">
                                    <div class="invoice-details-text">
                                        <div class="invoice-details">
                                            <p><strong>رقم الفاتورة:</strong> ${invoice.id}</p>
                                            <p><strong>التاريخ:</strong> ${formatDateForDisplay(invoice.date)}</p>
                                        </div>
                                        <div class="customer-details">
                                            <p><strong>الزبون:</strong> ${customer?.name || 'زبون نقدي'}</p>
                                            ${customer?.phone ? `<p><strong>الهاتف:</strong> ${customer.phone}</p>` : ''}
                                            ${customer?.address ? `<p><strong>العنوان:</strong> ${customer.address}</p>` : ''}
                                        </div>
                                    </div>
                                    <div class="qr-code-container">
                                        <div id="invoiceQrCodeElement"></div> <!-- Target for QRCode.js -->
                                    </div>
                                </div>

                                <table class="products-table">
                                    <thead>
                                        <tr>
                                            <th>م</th>
                                            <th>البيان (اسم المنتج)</th>
                                            <th>س. الوحدة</th>
                                            <th>الكمية</th>
                                            <th>الإجمالي</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${invoice.products.map((p, index) => `
                                            <tr>
                                                <td>${index + 1}</td>
                                                <td style="text-align:right;">${p.name} ${p.note ? `(${p.note})` : ''}</td>
                                                <td>${parseFloat(p.salePrice).toFixed(2)}</td>
                                                <td>${p.quantity}</td>
                                                <td>${parseFloat(p.total).toFixed(2)}</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                                <div class="totals-section">
                                    <p>المجموع الكلي: ${parseFloat(invoice.totalAmount).toFixed(2)}</p>
                                    <p>المبلغ المدفوع: ${parseFloat(invoice.amountPaid).toFixed(2)}</p>
                                    <p>المتبقي: ${(parseFloat(invoice.totalAmount) - parseFloat(invoice.amountPaid)).toFixed(2)}</p>
                                </div>
                                <div class="footer-print">
                                    <p>شكراً لتعاملكم معنا!</p>
                                </div>
                            </div>
                            <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"><\/script>
                            <script>
                                window.onload = function() { // This is the onload for the print window's content
                                    var qrElement = document.getElementById('invoiceQrCodeElement');
                                    if (qrElement && typeof QRCode !== 'undefined') {
                                        new QRCode(qrElement, {
                                            text: "${invoice.id}",
                                            width: 65,
                                            height: 65,
                                            colorDark : "#000000",
                                            colorLight : "#ffffff",
                                            correctLevel : QRCode.CorrectLevel.H
                                        });
                                    } else {
                                        console.error("QR Code generation failed in print window: Element or QRCode library not found.");
                                    }
                                };
                            <\/script>
                        </body>
                        </html>
                    `);
                    printWindow.document.close(); 
                    printWindow.onload = function() { // This is for the parent window's reference to the new window object
                        // The new window's own window.onload (for its content) should have fired by now.
                        // Add a slight delay to ensure rendering is complete before the print dialog.
                        setTimeout(function() {
                            printWindow.focus();
                            printWindow.print();
                            // printWindow.close(); // Optional: Close after print dialog
                        }, 300); // 300ms delay, adjust if needed.
                    }
                };
                invoiceRequest.onerror = (e) => Swal.fire('خطأ', `فشل في جلب الفاتورة للطباعة: ${e.target.error}`, 'error');
            } catch (dbError) {
                 Swal.fire('خطأ قاعدة البيانات', `فشل: ${dbError.message}`, 'error');
            }
        }

        async function generateCustomerStatement() {
            const customerId = document.getElementById('statementCustomer').value;
            const startDateValue = document.getElementById('startDate').value;
            const endDateValue = document.getElementById('endDate').value;

            if (!customerId || !startDateValue || !endDateValue) {
                Swal.fire('خطأ', 'الرجاء اختيار الزبون وتحديد نطاق التاريخ بشكل كامل!', 'error');
                return;
            }
            
            const startDate = new Date(startDateValue);
            const endDate = new Date(endDateValue);
            endDate.setHours(23, 59, 59, 999); 


            if (startDate > endDate) {
                Swal.fire('خطأ', 'تاريخ البداية يجب أن يكون قبل أو نفس تاريخ النهاية!', 'error');
                return;
            }

            const invoices = await getAllInvoices();
            const customers = await getAllCustomers();
            const customer = customers.find(c => c.id === customerId);

            const filteredInvoices = invoices.filter(i => {
                const invoiceDate = new Date(i.date);
                return i.customerId === customerId && invoiceDate >= startDate && invoiceDate <= endDate;
            }).sort((a, b) => new Date(a.date) - new Date(b.date)); 

            const printWindow = window.open('', '_blank', 'height=800,width=600');
             if (!printWindow) {
                 Swal.fire('خطأ', 'فشل فتح نافذة الطباعة. يرجى التأكد من تعطيل مانع النوافذ المنبثقة.', 'error'); return;
             }
            printWindow.document.write(`
                <!DOCTYPE html>
                <html lang="ar" dir="rtl">
                <head>
                    <meta charset="UTF-8">
                    <title>كشف حساب الزبون: ${customer?.name || 'غير معروف'}</title>
                    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
                    <style>
                        @page { size: A4; margin: 10mm; }
                        body { font-family: 'Cairo', sans-serif; direction: rtl; margin: 10mm; font-size:10pt; }
                        .container { width: 100%; margin: 0 auto; }
                        .header-print { text-align: center; margin-bottom: 20px; border-bottom: 1px solid #ccc; padding-bottom:10px;}
                        .header-print img { max-height: 60px; margin-bottom: 5px;}
                        .header-print h1 { font-size: 1.4rem; color: #3F2A56; margin:0; }
                        .info { margin-bottom: 15px; font-size:0.95rem; }
                        .info p { margin: 4px 0; }
                        .statement-table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
                        .statement-table th, .statement-table td { padding: 8px; border: 1px solid #ccc; text-align: center; font-size:0.9rem; }
                        .statement-table th { background-color: #f2f2f2; color: #333; font-weight:600; }
                        .status-paid { color: #198754; font-weight: 700; }
                        .status-partial { color: #ffc107; font-weight: 700; }
                        .status-unpaid { color: #dc3545; font-weight: 700; }
                        .summary { margin-top: 20px; padding-top:10px; border-top: 1px solid #ccc; text-align:left; font-size:1rem;}
                        .summary p {margin: 5px 0; font-weight:600;}
                         @media print {
                            body { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
                        }
                    </style>
                </head>
                <body>
                    <div class="container">
                        <div class="header-print">
                             <img src="logo.png" alt="شعار" onerror="this.style.display='none';">
                            <h1>طيبة المدينة تلكوم</h1>
                             <p style="font-size:0.7rem;">الهاتف: 27101138 - 41101138 </p>
                                       <p style="font-size:0.7rem;">الموقع: انواذيبوا - سوق موريتل</p>
                            <h2>كشف حساب زبون</h2>
                        </div>
                        <div class="info">
                            <p><strong>الزبون:</strong> ${customer?.name || 'زبون غير محدد'}</p>
                            ${customer?.phone ? `<p><strong>الهاتف:</strong> ${customer.phone}</p>` : ''}
                        <p><strong>From:</strong> ${new Date(startDateValue).toLocaleDateString('en-GB', { year: 'numeric', month: '2-digit', day: '2-digit' })}</p>
<p><strong>To:</strong> ${new Date(endDateValue).toLocaleDateString('en-GB', { year: 'numeric', month: '2-digit', day: '2-digit' })}</p>

                        </div>
                        <table class="statement-table">
                            <thead>
                                <tr>
                                    <th>رقم الفاتورة</th>
                                    <th>التاريخ</th>
                                    <th>إجمالي الفاتورة</th>
                                    <th>المدفوع</th>
                                    <th>المتبقي</th>
                                    <th>الحالة</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${filteredInvoices.length > 0 ? filteredInvoices.map(i => {
                                    const totalAmount = parseFloat(i.totalAmount);
                                    const amountPaid = parseFloat(i.amountPaid);
                                    const remaining = totalAmount - amountPaid;
                                    let statusText, statusClassSuffix;
                                    if (totalAmount === 0 && amountPaid === 0) { statusText = 'لا يوجد مبلغ'; statusClassSuffix = '';}
                                    else if (amountPaid >= totalAmount) { statusText = 'مدفوع'; statusClassSuffix = 'paid'; }
                                    else if (amountPaid > 0) { statusText = 'مدفوع جزئيًا'; statusClassSuffix = 'partial'; }
                                    else { statusText = 'لم يتم الدفع'; statusClassSuffix = 'unpaid'; }
                                    

                                    return `
                                        <tr>
                                            <td>${i.id}</td>
                                            <td>${formatDateForDisplay(i.date)}</td>
                                            <td>${totalAmount.toFixed(2)}</td>
                                            <td>${amountPaid.toFixed(2)}</td>
                                            <td>${remaining.toFixed(2)}</td>
                                            <td class="status-${statusClassSuffix}">${statusText}</td>
                                        </tr>
                                    `;
                                }).join('') : '<tr><td colspan="6">لا توجد فواتير لهذا الزبون في الفترة المحددة.</td></tr>'}
                            </tbody>
                        </table>
                        ${filteredInvoices.length > 0 ? `
                        <div class="summary">
                            <p>إجمالي قيمة الفواتير: ${filteredInvoices.reduce((sum, i) => sum + parseFloat(i.totalAmount), 0).toFixed(2)}</p>
                            <p>إجمالي المدفوعات: ${filteredInvoices.reduce((sum, i) => sum + parseFloat(i.amountPaid), 0).toFixed(2)}</p>
                            <p>إجمالي المتبقي: ${filteredInvoices.reduce((sum, i) => sum + (parseFloat(i.totalAmount) - parseFloat(i.amountPaid)), 0).toFixed(2)}</p>
                        </div>
                        ` : ''}
                    </div>
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.onload = function() { // Parent window's reference onload
                setTimeout(function() { // Delay to ensure rendering, especially if print window has complex content
                    printWindow.focus();
                    printWindow.print();
                }, 300);
            }
            bootstrap.Modal.getInstance(document.getElementById('customerStatementModal')).hide();
            document.getElementById('customerStatementForm').reset();
        }

        function startQrScanner() {
            const qrReaderContainer = document.getElementById('qr-reader-container');
            
            if (html5QrCodeScanner) {
                 try {
                    if (html5QrCodeScanner.getState() === Html5QrcodeScannerState.SCANNING) {
                        stopQrScanner(); 
                    }
                 } catch (e) { console.warn("Error checking scanner state, attempting to stop anyway:", e); stopQrScanner(); }
            }

            qrReaderContainer.style.display = 'block';
            
            if (typeof Html5Qrcode === "undefined") {
                Swal.fire('خطأ', 'مكتبة مسح QR غير محملة بشكل صحيح.', 'error');
                qrReaderContainer.style.display = 'none'; 
                return;
            }

            html5QrCodeScanner = new Html5Qrcode("qr-reader"); 
            const qrCodeSuccessCallback = (decodedText, decodedResult) => {
                document.getElementById('searchInput').value = decodedText;
                filterTable();
                stopQrScanner(); 
                Swal.fire('نجاح!', `تم العثور على الفاتورة: ${decodedText}`, 'success');
            };
            const config = { fps: 10, qrbox: {width: 250, height: 250}, aspectRatio: 1.0 }; 
            
             html5QrCodeScanner.start(
                { facingMode: "environment" }, 
                config,
                qrCodeSuccessCallback,
                (errorMessage) => {
                    // console.warn(`QR Code no match or error: ${errorMessage}`);
                })
            .catch((err) => {
                console.error(`Unable to start QR scanning, error: ${err}`);
                Swal.fire('خطأ', 'لم يتمكن من تشغيل ماسح QR. تأكد من صلاحيات الكاميرا أو أن الكاميرا غير مستخدمة بواسطة تطبيق آخر.', 'error');
                stopQrScanner(); 
            });
        }

        function stopQrScanner() {
            const qrReaderContainer = document.getElementById('qr-reader-container');
            if (html5QrCodeScanner) {
                html5QrCodeScanner.stop().then(ignore => {
                    console.log("QR Code scanning stopped.");
                    if (html5QrCodeScanner && typeof html5QrCodeScanner.clear === 'function') {
                        html5QrCodeScanner.clear(); 
                    }
                    // html5QrCodeScanner = null; // Do not nullify here if you want to reuse, but for safety, it's good
                }).catch(err => {
                    console.error("Failed to stop QR Code scanner.", err);
                    // html5QrCodeScanner = null; 
                }).finally(() => {
                     qrReaderContainer.style.display = 'none'; 
                });
            } else {
                 qrReaderContainer.style.display = 'none'; 
            }
        }


        document.addEventListener('DOMContentLoaded', async () => {
            try {
                await initDB();
                await Promise.all([
                    updateInvoicesTable(), 
                    updateCustomersTable(),
                    populateCustomerSelect('invoiceCustomer'),
                    populateCustomerSelect('editInvoiceCustomer'),
                    populateCustomerSelect('statementCustomer')
                ]);
                
                setupProductSearch('productSearch', 'productSuggestions', 'invoiceProducts');
                setupProductSearch('editProductSearch', 'editProductSuggestions', 'editInvoiceProducts', true);
                
                document.getElementById('invoiceDate').textContent = formatDateForDisplay(new Date().toISOString());
                
                document.getElementById('invoiceCustomer').addEventListener('change', (e) => updateCustomerInfo('invoiceCustomer', 'customerPhoneDisplay', 'customerAddressDisplay'));
                document.getElementById('editInvoiceCustomer').addEventListener('change', (e) => updateCustomerInfo('editInvoiceCustomer', 'editCustomerPhoneDisplay', 'editCustomerAddressDisplay'));

                document.getElementById('scanQrBtn').addEventListener('click', startQrScanner);
                document.getElementById('closeScannerBtn').addEventListener('click', stopQrScanner);


            } catch (error) {
                console.error("Initialization failed:", error);
                Swal.fire('فشل التهيئة', `حدث خطأ أثناء تحميل الصفحة: ${error.message}`, 'error');
            }
        });
    </script>
</body>
</html></p>
                                </div>
                                
                                <div class="invoice-info-grid">
                                    <div class="invoice-details-text">
                                        <div class="invoice-details">
                                            <p><strong>رقم الفاتورة:</strong> ${invoice.id}</p>
                                            <p><strong>التاريخ:</strong> ${formatDateForDisplay(invoice.date)}</p>
                                        </div>
                                        <div class="customer-details">
                                            <p><strong>الزبون:</strong> ${customer?.name || 'زبون نقدي'}</p>
                                            ${customer?.phone ? `<p><strong>الهاتف:</strong> ${customer.phone}</p>` : ''}
                                            ${customer?.address ? `<p><strong>العنوان:</strong> ${customer.address}</p>` : ''}
                                        </div>
                                    </div>
                                    <div class="qr-code-container">
                                        <div id="invoiceQrCodeElement"></div> <!-- Target for QRCode.js -->
                                    </div>
                                </div>

                                <table class="products-table">
                                    <thead>
                                        <tr>
                                            <th>م</th>
                                            <th>البيان (اسم المنتج)</th>
                                            <th>س. الوحدة</th>
                                            <th>الكمية</th>
                                            <th>الإجمالي</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${invoice.products.map((p, index) => `
                                            <tr>
                                                <td>${index + 1}</td>
                                                <td style="text-align:right;">${p.name} ${p.note ? `(${p.note})` : ''}</td>
                                                <td>${parseFloat(p.salePrice).toFixed(2)}</td>
                                                <td>${p.quantity}</td>
                                                <td>${parseFloat(p.total).toFixed(2)}</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                                <div class="totals-section">
                                    <p>المجموع الكلي: ${parseFloat(invoice.totalAmount).toFixed(2)}</p>
                                    <p>المبلغ المدفوع: ${parseFloat(invoice.amountPaid).toFixed(2)}</p>
                                    <p>المتبقي: ${(parseFloat(invoice.totalAmount) - parseFloat(invoice.amountPaid)).toFixed(2)}</p>
                                </div>
                                <div class="footer-print">
                                    <p>شكراً لتعاملكم معنا!</p>
                                </div>
                            </div>
                            <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"><\/script>
                            <script>
                                window.onload = function() { // This is the onload for the print window's content
                                    var qrElement = document.getElementById('invoiceQrCodeElement');
                                    if (qrElement && typeof QRCode !== 'undefined') {
                                        new QRCode(qrElement, {
                                            text: "${invoice.id}",
                                            width: 65,
                                            height: 65,
                                            colorDark : "#000000",
                                            colorLight : "#ffffff",
                                            correctLevel : QRCode.CorrectLevel.H
                                        });
                                    } else {
                                        console.error("QR Code generation failed in print window: Element or QRCode library not found.");
                                    }
                                };
                            <\/script>
                        </body>
                        </html>
                    `);
                    printWindow.document.close(); 
                    printWindow.onload = function() { // This is for the parent window's reference to the new window object
                        // The new window's own window.onload (for its content) should have fired by now.
                        // Add a slight delay to ensure rendering is complete before the print dialog.
                        setTimeout(function() {
                            printWindow.focus();
                            printWindow.print();
                            // printWindow.close(); // Optional: Close after print dialog
                        }, 300); // 300ms delay, adjust if needed.
                    }
                };
                invoiceRequest.onerror = (e) => Swal.fire('خطأ', `فشل في جلب الفاتورة للطباعة: ${e.target.error}`, 'error');
            } catch (dbError) {
                 Swal.fire('خطأ قاعدة البيانات', `فشل: ${dbError.message}`, 'error');
            }
        }

        async function generateCustomerStatement() {
            const customerId = document.getElementById('statementCustomer').value;
            const startDateValue = document.getElementById('startDate').value;
            const endDateValue = document.getElementById('endDate').value;

            if (!customerId || !startDateValue || !endDateValue) {
                Swal.fire('خطأ', 'الرجاء اختيار الزبون وتحديد نطاق التاريخ بشكل كامل!', 'error');
                return;
            }
            
            const startDate = new Date(startDateValue);
            const endDate = new Date(endDateValue);
            endDate.setHours(23, 59, 59, 999); 


            if (startDate > endDate) {
                Swal.fire('خطأ', 'تاريخ البداية يجب أن يكون قبل أو نفس تاريخ النهاية!', 'error');
                return;
            }

            const invoices = await getAllInvoices();
            const customers = await getAllCustomers();
            const customer = customers.find(c => c.id === customerId);

            const filteredInvoices = invoices.filter(i => {
                const invoiceDate = new Date(i.date);
                return i.customerId === customerId && invoiceDate >= startDate && invoiceDate <= endDate;
            }).sort((a, b) => new Date(a.date) - new Date(b.date)); 

            const printWindow = window.open('', '_blank', 'height=800,width=600');
             if (!printWindow) {
                 Swal.fire('خطأ', 'فشل فتح نافذة الطباعة. يرجى التأكد من تعطيل مانع النوافذ المنبثقة.', 'error'); return;
             }
            printWindow.document.write(`
                <!DOCTYPE html>
                <html lang="ar" dir="rtl">
                <head>
                    <meta charset="UTF-8">
                    <title>كشف حساب الزبون: ${customer?.name || 'غير معروف'}</title>
                    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
                    <style>
                        @page { size: A4; margin: 10mm; }
                        body { font-family: 'Cairo', sans-serif; direction: rtl; margin: 10mm; font-size:10pt; }
                        .container { width: 100%; margin: 0 auto; }
                        .header-print { text-align: center; margin-bottom: 20px; border-bottom: 1px solid #ccc; padding-bottom:10px;}
                        .header-print img { max-height: 60px; margin-bottom: 5px;}
                        .header-print h1 { font-size: 1.4rem; color: #3F2A56; margin:0; }
                        .info { margin-bottom: 15px; font-size:0.95rem; }
                        .info p { margin: 4px 0; }
                        .statement-table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
                        .statement-table th, .statement-table td { padding: 8px; border: 1px solid #ccc; text-align: center; font-size:0.9rem; }
                        .statement-table th { background-color: #f2f2f2; color: #333; font-weight:600; }
                        .status-paid { color: #198754; font-weight: 700; }
                        .status-partial { color: #ffc107; font-weight: 700; }
                        .status-unpaid { color: #dc3545; font-weight: 700; }
                        .summary { margin-top: 20px; padding-top:10px; border-top: 1px solid #ccc; text-align:left; font-size:1rem;}
                        .summary p {margin: 5px 0; font-weight:600;}
                         @media print {
                            body { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
                        }
                    </style>
                </head>
                <body>
                    <div class="container">
                        <div class="header-print">
                             <img src="logo.png" alt="شعار" onerror="this.style.display='none';">
                            <h1>طيبة المدينة تلكوم</h1>
                         <p style="font-size:0.7rem;">الهاتف: 27101138 - 41101138 </p>
                                       <p style="font-size:0.7rem;">الموقع: انواذيبوا - سوق موريتل</p>
                            <h2>كشف حساب زبون</h2>
                        </div>
                        <div class="info">
                            <p><strong>الزبون:</strong> ${customer?.name || 'زبون غير محدد'}</p>
                            ${customer?.phone ? `<p><strong>الهاتف:</strong> ${customer.phone}</p>` : ''}
                           <p><strong>From:</strong> ${new Date(startDateValue).toLocaleDateString('en-GB', { year: 'numeric', month: '2-digit', day: '2-digit' })}</p>
<p><strong>To:</strong> ${new Date(endDateValue).toLocaleDateString('en-GB', { year: 'numeric', month: '2-digit', day: '2-digit' })}</p>
                        </div>
                        <table class="statement-table">
                            <thead>
                                <tr>
                                    <th>رقم الفاتورة</th>
                                    <th>التاريخ</th>
                                    <th>إجمالي الفاتورة</th>
                                    <th>المدفوع</th>
                                    <th>المتبقي</th>
                                    <th>الحالة</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${filteredInvoices.length > 0 ? filteredInvoices.map(i => {
                                    const totalAmount = parseFloat(i.totalAmount);
                                    const amountPaid = parseFloat(i.amountPaid);
                                    const remaining = totalAmount - amountPaid;
                                    let statusText, statusClassSuffix;
                                    if (totalAmount === 0 && amountPaid === 0) { statusText = 'لا يوجد مبلغ'; statusClassSuffix = '';}
                                    else if (amountPaid >= totalAmount) { statusText = 'مدفوع'; statusClassSuffix = 'paid'; }
                                    else if (amountPaid > 0) { statusText = 'مدفوع جزئيًا'; statusClassSuffix = 'partial'; }
                                    else { statusText = 'لم يتم الدفع'; statusClassSuffix = 'unpaid'; }
                                    

                                    return `
                                        <tr>
                                            <td>${i.id}</td>
                                            <td>${formatDateForDisplay(i.date)}</td>
                                            <td>${totalAmount.toFixed(2)}</td>
                                            <td>${amountPaid.toFixed(2)}</td>
                                            <td>${remaining.toFixed(2)}</td>
                                            <td class="status-${statusClassSuffix}">${statusText}</td>
                                        </tr>
                                    `;
                                }).join('') : '<tr><td colspan="6">لا توجد فواتير لهذا الزبون في الفترة المحددة.</td></tr>'}
                            </tbody>
                        </table>
                        ${filteredInvoices.length > 0 ? `
                        <div class="summary">
                            <p>إجمالي قيمة الفواتير: ${filteredInvoices.reduce((sum, i) => sum + parseFloat(i.totalAmount), 0).toFixed(2)}</p>
                            <p>إجمالي المدفوعات: ${filteredInvoices.reduce((sum, i) => sum + parseFloat(i.amountPaid), 0).toFixed(2)}</p>
                            <p>إجمالي المتبقي: ${filteredInvoices.reduce((sum, i) => sum + (parseFloat(i.totalAmount) - parseFloat(i.amountPaid)), 0).toFixed(2)}</p>
                        </div>
                        ` : ''}
                    </div>
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.onload = function() { // Parent window's reference onload
                setTimeout(function() { // Delay to ensure rendering, especially if print window has complex content
                    printWindow.focus();
                    printWindow.print();
                }, 300);
            }
            bootstrap.Modal.getInstance(document.getElementById('customerStatementModal')).hide();
            document.getElementById('customerStatementForm').reset();
        }

        function startQrScanner() {
            const qrReaderContainer = document.getElementById('qr-reader-container');
            
            if (html5QrCodeScanner) {
                 try {
                    if (html5QrCodeScanner.getState() === Html5QrcodeScannerState.SCANNING) {
                        stopQrScanner(); 
                    }
                 } catch (e) { console.warn("Error checking scanner state, attempting to stop anyway:", e); stopQrScanner(); }
            }

            qrReaderContainer.style.display = 'block';
            
            if (typeof Html5Qrcode === "undefined") {
                Swal.fire('خطأ', 'مكتبة مسح QR غير محملة بشكل صحيح.', 'error');
                qrReaderContainer.style.display = 'none'; 
                return;
            }

            html5QrCodeScanner = new Html5Qrcode("qr-reader"); 
            const qrCodeSuccessCallback = (decodedText, decodedResult) => {
                document.getElementById('searchInput').value = decodedText;
                filterTable();
                stopQrScanner(); 
                Swal.fire('نجاح!', `تم العثور على الفاتورة: ${decodedText}`, 'success');
            };
            const config = { fps: 10, qrbox: {width: 250, height: 250}, aspectRatio: 1.0 }; 
            
             html5QrCodeScanner.start(
                { facingMode: "environment" }, 
                config,
                qrCodeSuccessCallback,
                (errorMessage) => {
                    // console.warn(`QR Code no match or error: ${errorMessage}`);
                })
            .catch((err) => {
                console.error(`Unable to start QR scanning, error: ${err}`);
                Swal.fire('خطأ', 'لم يتمكن من تشغيل ماسح QR. تأكد من صلاحيات الكاميرا أو أن الكاميرا غير مستخدمة بواسطة تطبيق آخر.', 'error');
                stopQrScanner(); 
            });
        }

        function stopQrScanner() {
            const qrReaderContainer = document.getElementById('qr-reader-container');
            if (html5QrCodeScanner) {
                html5QrCodeScanner.stop().then(ignore => {
                    console.log("QR Code scanning stopped.");
                    if (html5QrCodeScanner && typeof html5QrCodeScanner.clear === 'function') {
                        html5QrCodeScanner.clear(); 
                    }
                    // html5QrCodeScanner = null; // Do not nullify here if you want to reuse, but for safety, it's good
                }).catch(err => {
                    console.error("Failed to stop QR Code scanner.", err);
                    // html5QrCodeScanner = null; 
                }).finally(() => {
                     qrReaderContainer.style.display = 'none'; 
                });
            } else {
                 qrReaderContainer.style.display = 'none'; 
            }
        }


        document.addEventListener('DOMContentLoaded', async () => {
            try {
                await initDB();
                await Promise.all([
                    updateInvoicesTable(), 
                    updateCustomersTable(),
                    populateCustomerSelect('invoiceCustomer'),
                    populateCustomerSelect('editInvoiceCustomer'),
                    populateCustomerSelect('statementCustomer')
                ]);
                
                setupProductSearch('productSearch', 'productSuggestions', 'invoiceProducts');
                setupProductSearch('editProductSearch', 'editProductSuggestions', 'editInvoiceProducts', true);
                
                document.getElementById('invoiceDate').textContent = formatDateForDisplay(new Date().toISOString());
                
                document.getElementById('invoiceCustomer').addEventListener('change', (e) => updateCustomerInfo('invoiceCustomer', 'customerPhoneDisplay', 'customerAddressDisplay'));
                document.getElementById('editInvoiceCustomer').addEventListener('change', (e) => updateCustomerInfo('editInvoiceCustomer', 'editCustomerPhoneDisplay', 'editCustomerAddressDisplay'));

                document.getElementById('scanQrBtn').addEventListener('click', startQrScanner);
                document.getElementById('closeScannerBtn').addEventListener('click', stopQrScanner);


            } catch (error) {
                console.error("Initialization failed:", error);
                Swal.fire('فشل التهيئة', `حدث خطأ أثناء تحميل الصفحة: ${error.message}`, 'error');
            }
        });
    </script>
</body>
</html>p style="font-size:0.7rem;"> TEL/p>
                                </div>
                                
                                <div class="invoice-info-grid">
                                    <div class="invoice-details-text">
                                        <div class="invoice-details">
                                            <p><strong>رقم الفاتورة:</strong> ${invoice.id}</p>
                                            <p><strong>التاريخ:</strong> ${formatDateForDisplay(invoice.date)}</p>
                                        </div>
                                        <div class="customer-details">
                                            <p><strong>الزبون:</strong> ${customer?.name || 'زبون نقدي'}</p>
                                            ${customer?.phone ? `<p><strong>الهاتف:</strong> ${customer.phone}</p>` : ''}
                                            ${customer?.address ? `<p><strong>العنوان:</strong> ${customer.address}</p>` : ''}
                                        </div>
                                    </div>
                                    <div class="qr-code-container">
                                        <div id="invoiceQrCodeElement"></div> <!-- Target for QRCode.js -->
                                    </div>
                                </div>

                                <table class="products-table">
                                    <thead>
                                        <tr>
                                            <th>م</th>
                                            <th>البيان (اسم المنتج)</th>
                                            <th>س. الوحدة</th>
                                            <th>الكمية</th>
                                            <th>الإجمالي</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${invoice.products.map((p, index) => `
                                            <tr>
                                                <td>${index + 1}</td>
                                                <td style="text-align:right;">${p.name} ${p.note ? `(${p.note})` : ''}</td>
                                                <td>${parseFloat(p.salePrice).toFixed(2)}</td>
                                                <td>${p.quantity}</td>
                                                <td>${parseFloat(p.total).toFixed(2)}</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                                <div class="totals-section">
                                    <p>المجموع الكلي: ${parseFloat(invoice.totalAmount).toFixed(2)}</p>
                                    <p>المبلغ المدفوع: ${parseFloat(invoice.amountPaid).toFixed(2)}</p>
                                    <p>المتبقي: ${(parseFloat(invoice.totalAmount) - parseFloat(invoice.amountPaid)).toFixed(2)}</p>
                                </div>
                                <div class="footer-print">
                                    <p>شكراً لتعاملكم معنا!</p>
                                </div>
                            </div>
                            <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"><\/script>
                            <script>
                                window.onload = function() { // This is the onload for the print window's content
                                    var qrElement = document.getElementById('invoiceQrCodeElement');
                                    if (qrElement && typeof QRCode !== 'undefined') {
                                        new QRCode(qrElement, {
                                            text: "${invoice.id}",
                                            width: 65,
                                            height: 65,
                                            colorDark : "#000000",
                                            colorLight : "#ffffff",
                                            correctLevel : QRCode.CorrectLevel.H
                                        });
                                    } else {
                                        console.error("QR Code generation failed in print window: Element or QRCode library not found.");
                                    }
                                };
                            <\/script>
                        </body>
                        </html>
                    `);
                    printWindow.document.close(); 
                    printWindow.onload = function() { // This is for the parent window's reference to the new window object
                        // The new window's own window.onload (for its content) should have fired by now.
                        // Add a slight delay to ensure rendering is complete before the print dialog.
                        setTimeout(function() {
                            printWindow.focus();
                            printWindow.print();
                            // printWindow.close(); // Optional: Close after print dialog
                        }, 300); // 300ms delay, adjust if needed.
                    }
                };
                invoiceRequest.onerror = (e) => Swal.fire('خطأ', `فشل في جلب الفاتورة للطباعة: ${e.target.error}`, 'error');
            } catch (dbError) {
                 Swal.fire('خطأ قاعدة البيانات', `فشل: ${dbError.message}`, 'error');
            }
        }

        async function generateCustomerStatement() {
            const customerId = document.getElementById('statementCustomer').value;
            const startDateValue = document.getElementById('startDate').value;
            const endDateValue = document.getElementById('endDate').value;

            if (!customerId || !startDateValue || !endDateValue) {
                Swal.fire('خطأ', 'الرجاء اختيار الزبون وتحديد نطاق التاريخ بشكل كامل!', 'error');
                return;
            }
            
            const startDate = new Date(startDateValue);
            const endDate = new Date(endDateValue);
            endDate.setHours(23, 59, 59, 999); 


            if (startDate > endDate) {
                Swal.fire('خطأ', 'تاريخ البداية يجب أن يكون قبل أو نفس تاريخ النهاية!', 'error');
                return;
            }

            const invoices = await getAllInvoices();
            const customers = await getAllCustomers();
            const customer = customers.find(c => c.id === customerId);

            const filteredInvoices = invoices.filter(i => {
                const invoiceDate = new Date(i.date);
                return i.customerId === customerId && invoiceDate >= startDate && invoiceDate <= endDate;
            }).sort((a, b) => new Date(a.date) - new Date(b.date)); 

            const printWindow = window.open('', '_blank', 'height=800,width=600');
             if (!printWindow) {
                 Swal.fire('خطأ', 'فشل فتح نافذة الطباعة. يرجى التأكد من تعطيل مانع النوافذ المنبثقة.', 'error'); return;
             }
            printWindow.document.write(`
                <!DOCTYPE html>
                <html lang="ar" dir="rtl">
                <head>
                    <meta charset="UTF-8">
                    <title>كشف حساب الزبون: ${customer?.name || 'غير معروف'}</title>
                    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
                    <style>
                        @page { size: A4; margin: 10mm; }
                        body { font-family: 'Cairo', sans-serif; direction: rtl; margin: 10mm; font-size:10pt; }
                        .container { width: 100%; margin: 0 auto; }
                        .header-print { text-align: center; margin-bottom: 20px; border-bottom: 1px solid #ccc; padding-bottom:10px;}
                        .header-print img { max-height: 60px; margin-bottom: 5px;}
                        .header-print h1 { font-size: 1.4rem; color: #3F2A56; margin:0; }
                        .info { margin-bottom: 15px; font-size:0.95rem; }
                        .info p { margin: 4px 0; }
                        .statement-table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
                        .statement-table th, .statement-table td { padding: 8px; border: 1px solid #ccc; text-align: center; font-size:0.9rem; }
                        .statement-table th { background-color: #f2f2f2; color: #333; font-weight:600; }
                        .status-paid { color: #198754; font-weight: 700; }
                        .status-partial { color: #ffc107; font-weight: 700; }
                        .status-unpaid { color: #dc3545; font-weight: 700; }
                        .summary { margin-top: 20px; padding-top:10px; border-top: 1px solid #ccc; text-align:left; font-size:1rem;}
                        .summary p {margin: 5px 0; font-weight:600;}
                         @media print {
                            body { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
                        }
                    </style>
                </head>
                <body>
                    <div class="container">
                        <div class="header-print">
                             <img src="logo.png" alt="شعار" onerror="this.style.display='none';">
                            <h1>طيبة المدينة تلكوم</h1>
                            <h2>كشف حساب زبون</h2>
                        </div>
                        <div class="info">
                            <p><strong>الزبون:</strong> ${customer?.name || 'زبون غير محدد'}</p>
                            ${customer?.phone ? `<p><strong>الهاتف:</strong> ${customer.phone}</p>` : ''}
                            <p><strong>الفترة من:</strong> ${new Date(startDateValue).toLocaleDateString('ar-SA-u-nu-latn', { year: 'numeric', month: '2-digit', day: '2-digit' })}</p>
                            <p><strong>إلى:</strong> ${new Date(endDateValue).toLocaleDateString('ar-SA-u-nu-latn', { year: 'numeric', month: '2-digit', day: '2-digit' })}</p>
                        </div>
                        <table class="statement-table">
                            <thead>
                                <tr>
                                    <th>رقم الفاتورة</th>
                                    <th>التاريخ</th>
                                    <th>إجمالي الفاتورة</th>
                                    <th>المدفوع</th>
                                    <th>المتبقي</th>
                                    <th>الحالة</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${filteredInvoices.length > 0 ? filteredInvoices.map(i => {
                                    const totalAmount = parseFloat(i.totalAmount);
                                    const amountPaid = parseFloat(i.amountPaid);
                                    const remaining = totalAmount - amountPaid;
                                    let statusText, statusClassSuffix;
                                    if (totalAmount === 0 && amountPaid === 0) { statusText = 'لا يوجد مبلغ'; statusClassSuffix = '';}
                                    else if (amountPaid >= totalAmount) { statusText = 'مدفوع'; statusClassSuffix = 'paid'; }
                                    else if (amountPaid > 0) { statusText = 'مدفوع جزئيًا'; statusClassSuffix = 'partial'; }
                                    else { statusText = 'لم يتم الدفع'; statusClassSuffix = 'unpaid'; }
                                    

                                    return `
                                        <tr>
                                            <td>${i.id}</td>
                                            <td>${formatDateForDisplay(i.date)}</td>
                                            <td>${totalAmount.toFixed(2)}</td>
                                            <td>${amountPaid.toFixed(2)}</td>
                                            <td>${remaining.toFixed(2)}</td>
                                            <td class="status-${statusClassSuffix}">${statusText}</td>
                                        </tr>
                                    `;
                                }).join('') : '<tr><td colspan="6">لا توجد فواتير لهذا الزبون في الفترة المحددة.</td></tr>'}
                            </tbody>
                        </table>
                        ${filteredInvoices.length > 0 ? `
                        <div class="summary">
                            <p>إجمالي قيمة الفواتير: ${filteredInvoices.reduce((sum, i) => sum + parseFloat(i.totalAmount), 0).toFixed(2)}</p>
                            <p>إجمالي المدفوعات: ${filteredInvoices.reduce((sum, i) => sum + parseFloat(i.amountPaid), 0).toFixed(2)}</p>
                            <p>إجمالي المتبقي: ${filteredInvoices.reduce((sum, i) => sum + (parseFloat(i.totalAmount) - parseFloat(i.amountPaid)), 0).toFixed(2)}</p>
                        </div>
                        ` : ''}
                    </div>
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.onload = function() { // Parent window's reference onload
                setTimeout(function() { // Delay to ensure rendering, especially if print window has complex content
                    printWindow.focus();
                    printWindow.print();
                }, 300);
            }
            bootstrap.Modal.getInstance(document.getElementById('customerStatementModal')).hide();
            document.getElementById('customerStatementForm').reset();
        }

        function startQrScanner() {
            const qrReaderContainer = document.getElementById('qr-reader-container');
            
            if (html5QrCodeScanner) {
                 try {
                    if (html5QrCodeScanner.getState() === Html5QrcodeScannerState.SCANNING) {
                        stopQrScanner(); 
                    }
                 } catch (e) { console.warn("Error checking scanner state, attempting to stop anyway:", e); stopQrScanner(); }
            }

            qrReaderContainer.style.display = 'block';
            
            if (typeof Html5Qrcode === "undefined") {
                Swal.fire('خطأ', 'مكتبة مسح QR غير محملة بشكل صحيح.', 'error');
                qrReaderContainer.style.display = 'none'; 
                return;
            }

            html5QrCodeScanner = new Html5Qrcode("qr-reader"); 
            const qrCodeSuccessCallback = (decodedText, decodedResult) => {
                document.getElementById('searchInput').value = decodedText;
                filterTable();
                stopQrScanner(); 
                Swal.fire('نجاح!', `تم العثور على الفاتورة: ${decodedText}`, 'success');
            };
            const config = { fps: 10, qrbox: {width: 250, height: 250}, aspectRatio: 1.0 }; 
            
             html5QrCodeScanner.start(
                { facingMode: "environment" }, 
                config,
                qrCodeSuccessCallback,
                (errorMessage) => {
                    // console.warn(`QR Code no match or error: ${errorMessage}`);
                })
            .catch((err) => {
                console.error(`Unable to start QR scanning, error: ${err}`);
                Swal.fire('خطأ', 'لم يتمكن من تشغيل ماسح QR. تأكد من صلاحيات الكاميرا أو أن الكاميرا غير مستخدمة بواسطة تطبيق آخر.', 'error');
                stopQrScanner(); 
            });
        }

        function stopQrScanner() {
            const qrReaderContainer = document.getElementById('qr-reader-container');
            if (html5QrCodeScanner) {
                html5QrCodeScanner.stop().then(ignore => {
                    console.log("QR Code scanning stopped.");
                    if (html5QrCodeScanner && typeof html5QrCodeScanner.clear === 'function') {
                        html5QrCodeScanner.clear(); 
                    }
                    // html5QrCodeScanner = null; // Do not nullify here if you want to reuse, but for safety, it's good
                }).catch(err => {
                    console.error("Failed to stop QR Code scanner.", err);
                    // html5QrCodeScanner = null; 
                }).finally(() => {
                     qrReaderContainer.style.display = 'none'; 
                });
            } else {
                 qrReaderContainer.style.display = 'none'; 
            }
        }


        document.addEventListener('DOMContentLoaded', async () => {
            try {
                await initDB();
                await Promise.all([
                    updateInvoicesTable(), 
                    updateCustomersTable(),
                    populateCustomerSelect('invoiceCustomer'),
                    populateCustomerSelect('editInvoiceCustomer'),
                    populateCustomerSelect('statementCustomer')
                ]);
                
                setupProductSearch('productSearch', 'productSuggestions', 'invoiceProducts');
                setupProductSearch('editProductSearch', 'editProductSuggestions', 'editInvoiceProducts', true);
                
                document.getElementById('invoiceDate').textContent = formatDateForDisplay(new Date().toISOString());
                
                document.getElementById('invoiceCustomer').addEventListener('change', (e) => updateCustomerInfo('invoiceCustomer', 'customerPhoneDisplay', 'customerAddressDisplay'));
                document.getElementById('editInvoiceCustomer').addEventListener('change', (e) => updateCustomerInfo('editInvoiceCustomer', 'editCustomerPhoneDisplay', 'editCustomerAddressDisplay'));

                document.getElementById('scanQrBtn').addEventListener('click', startQrScanner);
                document.getElementById('closeScannerBtn').addEventListener('click', stopQrScanner);


            } catch (error) {
                console.error("Initialization failed:", error);
                Swal.fire('فشل التهيئة', `حدث خطأ أثناء تحميل الصفحة: ${error.message}`, 'error');
            }
        });
    </script>
</body>
</html>ل</p>
                                </div>
                                
                                <div class="invoice-info-grid">
                                    <div class="invoice-details-text">
                                        <div class="invoice-details">
                                            <p><strong>رقم الفاتورة:</strong> ${invoice.id}</p>
                                            <p><strong>التاريخ:</strong> ${formatDateForDisplay(invoice.date)}</p>
                                        </div>
                                        <div class="customer-details">
                                            <p><strong>الزبون:</strong> ${customer?.name || 'زبون نقدي'}</p>
                                            ${customer?.phone ? `<p><strong>الهاتف:</strong> ${customer.phone}</p>` : ''}
                                            ${customer?.address ? `<p><strong>العنوان:</strong> ${customer.address}</p>` : ''}
                                        </div>
                                    </div>
                                    <div class="qr-code-container">
                                        <div id="invoiceQrCodeElement"></div> <!-- Target for QRCode.js -->
                                    </div>
                                </div>

                                <table class="products-table">
                                    <thead>
                                        <tr>
                                            <th>م</th>
                                            <th>البيان (اسم المنتج)</th>
                                            <th>س. الوحدة</th>
                                            <th>الكمية</th>
                                            <th>الإجمالي</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${invoice.products.map((p, index) => `
                                            <tr>
                                                <td>${index + 1}</td>
                                                <td style="text-align:right;">${p.name} ${p.note ? `(${p.note})` : ''}</td>
                                                <td>${parseFloat(p.salePrice).toFixed(2)}</td>
                                                <td>${p.quantity}</td>
                                                <td>${parseFloat(p.total).toFixed(2)}</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                                <div class="totals-section">
                                    <p>المجموع الكلي: ${parseFloat(invoice.totalAmount).toFixed(2)}</p>
                                    <p>المبلغ المدفوع: ${parseFloat(invoice.amountPaid).toFixed(2)}</p>
                                    <p>المتبقي: ${(parseFloat(invoice.totalAmount) - parseFloat(invoice.amountPaid)).toFixed(2)}</p>
                                </div>
                                <div class="footer-print">
                                    <p>شكراً لتعاملكم معنا!</p>
                                </div>
                            </div>
                            <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"><\/script>
                            <script>
                                window.onload = function() { // This is the onload for the print window's content
                                    var qrElement = document.getElementById('invoiceQrCodeElement');
                                    if (qrElement && typeof QRCode !== 'undefined') {
                                        new QRCode(qrElement, {
                                            text: "${invoice.id}",
                                            width: 65,
                                            height: 65,
                                            colorDark : "#000000",
                                            colorLight : "#ffffff",
                                            correctLevel : QRCode.CorrectLevel.H
                                        });
                                    } else {
                                        console.error("QR Code generation failed in print window: Element or QRCode library not found.");
                                    }
                                };
                            <\/script>
                        </body>
                        </html>
                    `);
                    printWindow.document.close(); 
                    printWindow.onload = function() { // This is for the parent window's reference to the new window object
                        // The new window's own window.onload (for its content) should have fired by now.
                        // Add a slight delay to ensure rendering is complete before the print dialog.
                        setTimeout(function() {
                            printWindow.focus();
                            printWindow.print();
                            // printWindow.close(); // Optional: Close after print dialog
                        }, 300); // 300ms delay, adjust if needed.
                    }
                };
                invoiceRequest.onerror = (e) => Swal.fire('خطأ', `فشل في جلب الفاتورة للطباعة: ${e.target.error}`, 'error');
            } catch (dbError) {
                 Swal.fire('خطأ قاعدة البيانات', `فشل: ${dbError.message}`, 'error');
            }
        }

        async function generateCustomerStatement() {
            const customerId = document.getElementById('statementCustomer').value;
            const startDateValue = document.getElementById('startDate').value;
            const endDateValue = document.getElementById('endDate').value;

            if (!customerId || !startDateValue || !endDateValue) {
                Swal.fire('خطأ', 'الرجاء اختيار الزبون وتحديد نطاق التاريخ بشكل كامل!', 'error');
                return;
            }
            
            const startDate = new Date(startDateValue);
            const endDate = new Date(endDateValue);
            endDate.setHours(23, 59, 59, 999); 


            if (startDate > endDate) {
                Swal.fire('خطأ', 'تاريخ البداية يجب أن يكون قبل أو نفس تاريخ النهاية!', 'error');
                return;
            }

            const invoices = await getAllInvoices();
            const customers = await getAllCustomers();
            const customer = customers.find(c => c.id === customerId);

            const filteredInvoices = invoices.filter(i => {
                const invoiceDate = new Date(i.date);
                return i.customerId === customerId && invoiceDate >= startDate && invoiceDate <= endDate;
            }).sort((a, b) => new Date(a.date) - new Date(b.date)); 

            const printWindow = window.open('', '_blank', 'height=800,width=600');
             if (!printWindow) {
                 Swal.fire('خطأ', 'فشل فتح نافذة الطباعة. يرجى التأكد من تعطيل مانع النوافذ المنبثقة.', 'error'); return;
             }
            printWindow.document.write(`
                <!DOCTYPE html>
                <html lang="ar" dir="rtl">
                <head>
                    <meta charset="UTF-8">
                    <title>كشف حساب الزبون: ${customer?.name || 'غير معروف'}</title>
                    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
                    <style>
                        @page { size: A4; margin: 10mm; }
                        body { font-family: 'Cairo', sans-serif; direction: rtl; margin: 10mm; font-size:10pt; }
                        .container { width: 100%; margin: 0 auto; }
                        .header-print { text-align: center; margin-bottom: 20px; border-bottom: 1px solid #ccc; padding-bottom:10px;}
                        .header-print img { max-height: 60px; margin-bottom: 5px;}
                        .header-print h1 { font-size: 1.4rem; color: #3F2A56; margin:0; }
                        .info { margin-bottom: 15px; font-size:0.95rem; }
                        .info p { margin: 4px 0; }
                        .statement-table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
                        .statement-table th, .statement-table td { padding: 8px; border: 1px solid #ccc; text-align: center; font-size:0.9rem; }
                        .statement-table th { background-color: #f2f2f2; color: #333; font-weight:600; }
                        .status-paid { color: #198754; font-weight: 700; }
                        .status-partial { color: #ffc107; font-weight: 700; }
                        .status-unpaid { color: #dc3545; font-weight: 700; }
                        .summary { margin-top: 20px; padding-top:10px; border-top: 1px solid #ccc; text-align:left; font-size:1rem;}
                        .summary p {margin: 5px 0; font-weight:600;}
                         @media print {
                            body { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
                        }
                    </style>
                </head>
                <body>
                    <div class="container">
                        <div class="header-print">
                             <img src="logo.png" alt="شعار" onerror="this.style.display='none';">
                            <h1>طيبة المدينة تلكوم</h1>
                            <h2>كشف حساب زبون</h2>
                        </div>
                        <div class="info">
                            <p><strong>الزبون:</strong> ${customer?.name || 'زبون غير محدد'}</p>
                            ${customer?.phone ? `<p><strong>الهاتف:</strong> ${customer.phone}</p>` : ''}
                          <p><strong>From:</strong> ${new Date(startDateValue).toLocaleDateString('en-GB', { year: 'numeric', month: '2-digit', day: '2-digit' })}</p>
<p><strong>To:</strong> ${new Date(endDateValue).toLocaleDateString('en-GB', { year: 'numeric', month: '2-digit', day: '2-digit' })}</p>
  </div>
                        <table class="statement-table">
                            <thead>
                                <tr>
                                    <th>رقم الفاتورة</th>
                                    <th>التاريخ</th>
                                    <th>إجمالي الفاتورة</th>
                                    <th>المدفوع</th>
                                    <th>المتبقي</th>
                                    <th>الحالة</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${filteredInvoices.length > 0 ? filteredInvoices.map(i => {
                                    const totalAmount = parseFloat(i.totalAmount);
                                    const amountPaid = parseFloat(i.amountPaid);
                                    const remaining = totalAmount - amountPaid;
                                    let statusText, statusClassSuffix;
                                    if (totalAmount === 0 && amountPaid === 0) { statusText = 'لا يوجد مبلغ'; statusClassSuffix = '';}
                                    else if (amountPaid >= totalAmount) { statusText = 'مدفوع'; statusClassSuffix = 'paid'; }
                                    else if (amountPaid > 0) { statusText = 'مدفوع جزئيًا'; statusClassSuffix = 'partial'; }
                                    else { statusText = 'لم يتم الدفع'; statusClassSuffix = 'unpaid'; }
                                    

                                    return `
                                        <tr>
                                            <td>${i.id}</td>
                                            <td>${formatDateForDisplay(i.date)}</td>
                                            <td>${totalAmount.toFixed(2)}</td>
                                            <td>${amountPaid.toFixed(2)}</td>
                                            <td>${remaining.toFixed(2)}</td>
                                            <td class="status-${statusClassSuffix}">${statusText}</td>
                                        </tr>
                                    `;
                                }).join('') : '<tr><td colspan="6">لا توجد فواتير لهذا الزبون في الفترة المحددة.</td></tr>'}
                            </tbody>
                        </table>
                        ${filteredInvoices.length > 0 ? `
                        <div class="summary">
                            <p>إجمالي قيمة الفواتير: ${filteredInvoices.reduce((sum, i) => sum + parseFloat(i.totalAmount), 0).toFixed(2)}</p>
                            <p>إجمالي المدفوعات: ${filteredInvoices.reduce((sum, i) => sum + parseFloat(i.amountPaid), 0).toFixed(2)}</p>
                            <p>إجمالي المتبقي: ${filteredInvoices.reduce((sum, i) => sum + (parseFloat(i.totalAmount) - parseFloat(i.amountPaid)), 0).toFixed(2)}</p>
                        </div>
                        ` : ''}
                    </div>
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.onload = function() { // Parent window's reference onload
                setTimeout(function() { // Delay to ensure rendering, especially if print window has complex content
                    printWindow.focus();
                    printWindow.print();
                }, 300);
            }
            bootstrap.Modal.getInstance(document.getElementById('customerStatementModal')).hide();
            document.getElementById('customerStatementForm').reset();
        }

        function startQrScanner() {
            const qrReaderContainer = document.getElementById('qr-reader-container');
            
            if (html5QrCodeScanner) {
                 try {
                    if (html5QrCodeScanner.getState() === Html5QrcodeScannerState.SCANNING) {
                        stopQrScanner(); 
                    }
                 } catch (e) { console.warn("Error checking scanner state, attempting to stop anyway:", e); stopQrScanner(); }
            }

            qrReaderContainer.style.display = 'block';
            
            if (typeof Html5Qrcode === "undefined") {
                Swal.fire('خطأ', 'مكتبة مسح QR غير محملة بشكل صحيح.', 'error');
                qrReaderContainer.style.display = 'none'; 
                return;
            }

            html5QrCodeScanner = new Html5Qrcode("qr-reader"); 
            const qrCodeSuccessCallback = (decodedText, decodedResult) => {
                document.getElementById('searchInput').value = decodedText;
                filterTable();
                stopQrScanner(); 
                Swal.fire('نجاح!', `تم العثور على الفاتورة: ${decodedText}`, 'success');
            };
            const config = { fps: 10, qrbox: {width: 250, height: 250}, aspectRatio: 1.0 }; 
            
             html5QrCodeScanner.start(
                { facingMode: "environment" }, 
                config,
                qrCodeSuccessCallback,
                (errorMessage) => {
                    // console.warn(`QR Code no match or error: ${errorMessage}`);
                })
            .catch((err) => {
                console.error(`Unable to start QR scanning, error: ${err}`);
                Swal.fire('خطأ', 'لم يتمكن من تشغيل ماسح QR. تأكد من صلاحيات الكاميرا أو أن الكاميرا غير مستخدمة بواسطة تطبيق آخر.', 'error');
                stopQrScanner(); 
            });
        }

        function stopQrScanner() {
            const qrReaderContainer = document.getElementById('qr-reader-container');
            if (html5QrCodeScanner) {
                html5QrCodeScanner.stop().then(ignore => {
                    console.log("QR Code scanning stopped.");
                    if (html5QrCodeScanner && typeof html5QrCodeScanner.clear === 'function') {
                        html5QrCodeScanner.clear(); 
                    }
                    // html5QrCodeScanner = null; // Do not nullify here if you want to reuse, but for safety, it's good
                }).catch(err => {
                    console.error("Failed to stop QR Code scanner.", err);
                    // html5QrCodeScanner = null; 
                }).finally(() => {
                     qrReaderContainer.style.display = 'none'; 
                });
            } else {
                 qrReaderContainer.style.display = 'none'; 
            }
        }


        document.addEventListener('DOMContentLoaded', async () => {
            try {
                await initDB();
                await Promise.all([
                    updateInvoicesTable(), 
                    updateCustomersTable(),
                    populateCustomerSelect('invoiceCustomer'),
                    populateCustomerSelect('editInvoiceCustomer'),
                    populateCustomerSelect('statementCustomer')
                ]);
                
                setupProductSearch('productSearch', 'productSuggestions', 'invoiceProducts');
                setupProductSearch('editProductSearch', 'editProductSuggestions', 'editInvoiceProducts', true);
                
                document.getElementById('invoiceDate').textContent = formatDateForDisplay(new Date().toISOString());
                
                document.getElementById('invoiceCustomer').addEventListener('change', (e) => updateCustomerInfo('invoiceCustomer', 'customerPhoneDisplay', 'customerAddressDisplay'));
                document.getElementById('editInvoiceCustomer').addEventListener('change', (e) => updateCustomerInfo('editInvoiceCustomer', 'editCustomerPhoneDisplay', 'editCustomerAddressDisplay'));

                document.getElementById('scanQrBtn').addEventListener('click', startQrScanner);
                document.getElementById('closeScannerBtn').addEventListener('click', stopQrScanner);


            } catch (error) {
                console.error("Initialization failed:", error);
                Swal.fire('فشل التهيئة', `حدث خطأ أثناء تحميل الصفحة: ${error.message}`, 'error');
            }
        });
    </script>
</body>
</html>
