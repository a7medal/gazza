<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>بيع المنتجات</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Cairo', sans-serif;
            background: linear-gradient(135deg, #f0f2f5, #d9e2ec);
            color: #333;
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .home-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: linear-gradient(90deg, #3F2A56, #5a3f73);
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            text-decoration: none;
            font-size: 1rem;
            font-weight: 600;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            transition: transform 0.2s ease, background 0.3s ease, box-shadow 0.3s ease;
            position: absolute;
            top: 20px;
            left: 20px;
        }
        .home-btn:hover {
            background: linear-gradient(90deg, #5a3f73, #3F2A56);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
        }
        .header {
            background: linear-gradient(135deg, #3F2A56, #5a3f73);
            color: white;
            padding: 40px 20px;
            border-radius: 25px;
            text-align: center;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
            margin-bottom: 30px;
            position: relative;
            z-index: 1;
            border: 2px solid rgba(255, 255, 255, 0.1);
        }
        .header img {
            height: 90px;
            margin-bottom: 15px;
            filter: drop-shadow(0 3px 6px rgba(0, 0, 0, 0.3));
        }
        .header h2 {
            font-size: 2.2rem;
            margin-bottom: 10px;
            font-weight: 700;
        }
        .header h4 {
            font-size: 1.4rem;
            opacity: 0.9;
            font-weight: 400;
        }
        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        .card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: #3F2A56;
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            text-align: center;
            transition: transform 0.3s ease;
        }
        .card:hover {
            transform: translateY(-10px);
        }
        .card i {
            font-size: 2.8rem;
            margin-bottom: 15px;
            color: #3F2A56;
        }
        .card h5 {
            font-size: 1.3rem;
            margin-bottom: 10px;
            font-weight: 600;
        }
        .card h3 {
            font-size: 1.8rem;
            font-weight: 700;
        }
        .section {
            background: white;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
            padding: 20px;
            margin: 20px 0;
        }
        .section h3 {
            font-size: 1.7rem;
            font-weight: 700;
            color: #3F2A56;
            margin-bottom: 15px;
            text-align: center;
        }
        .table-container {
            overflow-x: auto;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            padding: 12px;
            text-align: center;
            border-bottom: 1px solid #e0e0e0;
        }
        th {
            background: linear-gradient(90deg, #3F2A56, #5a3f73);
            color: white;
            font-weight: 700;
        }
        td {
            color: #3F2A56;
        }
        tr:hover {
            background-color: #f7f9fc;
        }
        .actions {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin: 25px 0;
            justify-content: center;
        }
        .btn {
            background: linear-gradient(90deg, #3F2A56, #5a3f73);
            color: white;
            padding: 12px 24px;
            border-radius: 30px;
            border: none;
            font-size: 1rem;
            cursor: pointer;
            transition: transform 0.2s ease, background 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .btn:hover {
            background: linear-gradient(90deg, #5a3f73, #3F2A56);
            transform: translateY(-2px);
        }
        .search-container {
            margin-bottom: 20px;
            display: flex;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
        }
        .filter-group {
            display: flex;
            flex-direction: column;
            max-width: 200px;
        }
        .filter-group label {
            font-size: 0.9rem;
            font-weight: 600;
            color: #3F2A56;
            margin-bottom: 5px;
        }
        .filter-group input, .filter-group select {
            padding: 12px;
            border-radius: 30px;
            border: none;
            background: rgba(255, 255, 255, 0.1);
            color: #3F2A56;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        .filter-group input:focus, .filter-group select:focus {
            outline: none;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2);
        }
        .action-btn {
            cursor: pointer;
            margin: 0 6px;
            font-size: 1.3rem;
        }
        .action-btn.edit:hover { color: #007bff; }
        .action-btn.delete:hover { color: #dc3545; }
        .action-btn.print:hover { color: #28a745; }
        .modal-content {
            border-radius: 20px;
            background: linear-gradient(145deg, #ffffff, #f7f9fc);
        }
        .modal-header {
            background: linear-gradient(90deg, #3F2A56, #5a3f73);
            color: white;
            border-top-left-radius: 20px;
            border-top-right-radius: 20px;
        }
        .modal-title {
            font-size: 1.5rem;
            font-weight: 700;
        }
        .modal-body {
            padding: 30px;
        }
        .modal-body .form-label {
            font-weight: 600;
            color: #3F2A56;
        }
        .modal-body .form-control, .modal-body .form-select {
            border-radius: 15px;
            padding: 12px;
            background: #f7f9fc;
        }
        .modal-footer .btn {
            padding: 12px 30px;
        }
        .product-table th, .product-table td {
            padding: 8px;
        }
        .status-paid { color: #28a745; font-weight: 700; }
        .status-partial { color: #ffc107; font-weight: 700; }
        .status-unpaid { color: #dc3545; font-weight: 700; }
        .swal2-popup {
            font-family: 'Cairo', sans-serif;
            border-radius: 15px;
        }
        .swal2-title { color: #3F2A56; }
        .swal2-confirm {
            background: linear-gradient(90deg, #3F2A56, #5a3f73);
            border-radius: 20px;
        }
        .swal2-cancel {
            background: linear-gradient(90deg, #6c757d, #5a6268);
            border-radius: 20px;
        }
        @media (max-width: 768px) {
            .header { padding: 25px 15px; }
            .header img { height: 70px; }
            .header h2 { font-size: 1.7rem; }
            .btn { padding: 10px 18px; font-size: 0.9rem; }
            th, td { padding: 10px; font-size: 0.9rem; }
            .modal-body { padding: 20px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <img src="logo.png" alt="شعار طيبة المدينة تلكوم">
            <h2>طيبة المدينة تلكوم</h2>
            <h4>بيع المنتجات</h4>
            <a href="home.html" class="home-btn"><i class="fas fa-home"></i> للرئيسية</a>
        </div>
        <div class="dashboard">
            <div class="card">
                <i class="fas fa-check-circle"></i>
                <h5>الفواتير المدفوعة</h5>
                <h3 id="paidInvoices">0</h3>
            </div>
            <div class="card">
                <i class="fas fa-exclamation-circle"></i>
                <h5>الفواتير المدفوعة جزئيًا</h5>
                <h3 id="partialInvoices">0</h3>
            </div>
            <div class="card">
                <i class="fas fa-times-circle"></i>
                <h5>الفواتير غير المدفوعة</h5>
                <h3 id="unpaidInvoices">0</h3>
            </div>
        </div>
        <div class="actions">
            <button class="btn" data-bs-toggle="modal" data-bs-target="#addInvoiceModal"><i class="fas fa-plus"></i> إضافة فاتورة</button>
            <button class="btn" data-bs-toggle="modal" data-bs-target="#addCustomerModal"><i class="fas fa-user-plus"></i> إضافة زبون</button>
            <button class="btn" data-bs-toggle="modal" data-bs-target="#customerStatementModal"><i class="fas fa-file-alt"></i> كشف حساب زبون</button>
        </div>
        <div class="section">
            <h3>الفواتير</h3>
            <div class="search-container">
                <div class="filter-group">
                    <label for="searchInput">البحث</label>
                    <input type="text" id="searchInput" placeholder="ابحث بالزبون أو معرف الفاتورة" oninput="filterTable()">
                </div>
                <div class="filter-group">
                    <label for="statusFilter">حالة الفاتورة</label>
                    <select id="statusFilter" onchange="filterTable()">
                        <option value="all">الكل</option>
                        <option value="paid">مدفوع</option>
                        <option value="partial">مدفوع جزئيًا</option>
                        <option value="unpaid">لم يتم الدفع</option>
                    </select>
                </div>
            </div>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>معرف الفاتورة</th>
                            <th>الزبون</th>
                            <th>رقم الهاتف</th>
                            <th>المبلغ الكلي</th>
                            <th>حالة الفاتورة</th>
                            <th>الإجراءات</th>
                        </tr>
                    </thead>
                    <tbody id="invoicesTable"></tbody>
                </table>
            </div>
        </div>
        <div class="section">
            <h3>إدارة الزبائن</h3>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>الاسم</th>
                            <th>رقم الهاتف</th>
                            <th>العنوان</th>
                            <th>الإجراءات</th>
                        </tr>
                    </thead>
                    <tbody id="customersTable"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- نافذة إضافة فاتورة -->
    <div class="modal fade" id="addInvoiceModal" tabindex="-1" aria-labelledby="addInvoiceModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addInvoiceModalLabel"><i class="fas fa-plus"></i> إضافة فاتورة جديدة</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="addInvoiceForm">
                        <div class="mb-3">
                            <label for="invoiceCustomer" class="form-label">الزبون</label>
                            <select class="form-select" id="invoiceCustomer" required>
                                <option value="">اختر زبونًا</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="customerPhone" class="form-label">رقم الهاتف</label>
                            <input type="text" class="form-control" id="customerPhone" readonly>
                        </div>
                        <div class="mb-3">
                            <label for="customerAddress" class="form-label">العنوان</label>
                            <input type="text" class="form-control" id="customerAddress" readonly>
                        </div>
                        <div class="mb-3">
                            <label for="productSearch" class="form-label">البحث عن منتج</label>
                            <input type="text" class="form-control" id="productSearch" placeholder="ابحث بالاسم أو المعرف">
                            <div id="productSuggestions" class="mt-2"></div>
                        </div>
                        <h5>المنتجات</h5>
                        <div class="table-container">
                            <table class="product-table">
                                <thead>
                                    <tr>
                                        <th>اسم المنتج</th>
                                        <th>سعر البيع</th>
                                        <th>الكمية</th>
                                        <th>الملاحظة</th>
                                        <th>الإجمالي</th>
                                        <th>الإجراءات</th>
                                    </tr>
                                </thead>
                                <tbody id="invoiceProducts"></tbody>
                            </table>
                        </div>
                        <div class="mt-3">
                            <p><strong>التاريخ:</strong> <span id="invoiceDate"></span></p>
                            <p><strong>عدد المواد:</strong> <span id="totalItems">0</span></p>
                            <p><strong>المجموع الكلي:</strong> <span id="totalAmount">0.00</span></p>
                            <div class="mb-3">
                                <label for="amountPaid" class="form-label">المبلغ المدفوع</label>
                                <input type="number" class="form-control" id="amountPaid" step="0.01" min="0" value="0">
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
                    <button type="button" class="btn" onclick="addInvoice()">حفظ</button>
                </div>
            </div>
        </div>
    </div>

    <!-- نافذة تعديل فاتورة -->
    <div class="modal fade" id="editInvoiceModal" tabindex="-1" aria-labelledby="editInvoiceModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editInvoiceModalLabel"><i class="fas fa-edit"></i> تعديل فاتورة</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="editInvoiceForm">
                        <input type="hidden" id="editInvoiceId">
                        <div class="mb-3">
                            <label for="editInvoiceCustomer" class="form-label">الزبون</label>
                            <select class="form-select" id="editInvoiceCustomer" required>
                                <option value="">اختر زبونًا</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="editCustomerPhone" class="form-label">رقم الهاتف</label>
                            <input type="text" class="form-control" id="editCustomerPhone" readonly>
                        </div>
                        <div class="mb-3">
                            <label for="editCustomerAddress" class="form-label">العنوان</label>
                            <input type="text" class="form-control" id="editCustomerAddress" readonly>
                        </div>
                        <div class="mb-3">
                            <label for="editProductSearch" class="form-label">البحث عن منتج</label>
                            <input type="text" class="form-control" id="editProductSearch" placeholder="ابحث بالاسم أو المعرف">
                            <div id="editProductSuggestions" class="mt-2"></div>
                        </div>
                        <h5>المنتجات</h5>
                        <div class="table-container">
                            <table class="product-table">
                                <thead>
                                    <tr>
                                        <th>اسم المنتج</th>
                                        <th>سعر البيع</th>
                                        <th>الكمية</th>
                                        <th>الملاحظة</th>
                                        <th>الإجمالي</th>
                                        <th>الإجراءات</th>
                                    </tr>
                                </thead>
                                <tbody id="editInvoiceProducts"></tbody>
                            </table>
                        </div>
                        <div class="mt-3">
                            <p><strong>التاريخ:</strong> <span id="editInvoiceDate"></span></p>
                            <p><strong>عدد المواد:</strong> <span id="editTotalItems">0</span></p>
                            <p><strong>المجموع الكلي:</strong> <span id="editTotalAmount">0.00</span></p>
                            <div class="mb-3">
                                <label for="editAmountPaid" class="form-label">المبلغ المدفوع</label>
                                <input type="number" class="form-control" id="editAmountPaid" step="0.01" min="0" value="0">
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
                    <button type="button" class="btn" onclick="updateInvoice()">حفظ</button>
                </div>
            </div>
        </div>
    </div>

    <!-- نافذة إضافة زبون -->
    <div class="modal fade" id="addCustomerModal" tabindex="-1" aria-labelledby="addCustomerModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addCustomerModalLabel"><i class="fas fa-user-plus"></i> إضافة زبون</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="addCustomerForm">
                        <div class="mb-3">
                            <label for="customerName" class="form-label">اسم الزبون (اختياري)</label>
                            <input type="text" class="form-control" id="customerName">
                        </div>
                        <div class="mb-3">
                            <label for="customerPhone" class="form-label">رقم الهاتف (اختياري)</label>
                            <input type="text" class="form-control" id="customerPhone">
                        </div>
                        <div class="mb-3">
                            <label for="customerAddress" class="form-label">العنوان (اختياري)</label>
                            <input type="text" class="form-control" id="customerAddress">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
                    <button type="button" class="btn" onclick="addCustomer()">حفظ</button>
                </div>
            </div>
        </div>
    </div>

    <!-- نافذة تعديل زبون -->
    <div class="modal fade" id="editCustomerModal" tabindex="-1" aria-labelledby="editCustomerModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editCustomerModalLabel"><i class="fas fa-edit"></i> تعديل زبون</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="editCustomerForm">
                        <input type="hidden" id="editCustomerId">
                        <div class="mb-3">
                            <label for="editCustomerName" class="form-label">اسم الزبون (اختياري)</label>
                            <input type="text" class="form-control" id="editCustomerName">
                        </div>
                        <div class="mb-3">
                            <label for="editCustomerPhone" class="form-label">رقم الهاتف (اختياري)</label>
                            <input type="text" class="form-control" id="editCustomerPhone">
                        </div>
                        <div class="mb-3">
                            <label for="editCustomerAddress" class="form-label">العنوان (اختياري)</label>
                            <input type="text" class="form-control" id="editCustomerAddress">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
                    <button type="button" class="btn" onclick="updateCustomer()">حفظ</button>
                </div>
            </div>
        </div>
    </div>

    <!-- نافذة كشف حساب زبون -->
    <div class="modal fade" id="customerStatementModal" tabindex="-1" aria-labelledby="customerStatementModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="customerStatementModalLabel"><i class="fas fa-file-alt"></i> كشف حساب زبون</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="customerStatementForm">
                        <div class="mb-3">
                            <label for="statementCustomer" class="form-label">الزبون</label>
                            <select class="form-select" id="statementCustomer" required>
                                <option value="">اختر زبونًا</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="startDate" class="form-label">من تاريخ</label>
                            <input type="date" class="form-control" id="startDate" required>
                        </div>
                        <div class="mb-3">
                            <label for="endDate" class="form-label">إلى تاريخ</label>
                            <input type="date" class="form-control" id="endDate" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
                    <button type="button" class="btn" onclick="generateCustomerStatement()">إنشاء الكشف</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let db;

        // إعداد IndexedDB
        function initDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open('InventoryDB', 2);
                request.onupgradeneeded = (event) => {
                    db = event.target.result;
                    if (!db.objectStoreNames.contains('products')) {
                        db.createObjectStore('products', { keyPath: 'id' });
                    }
                    if (!db.objectStoreNames.contains('invoices')) {
                        db.createObjectStore('invoices', { keyPath: 'id' });
                    }
                    if (!db.objectStoreNames.contains('customers')) {
                        db.createObjectStore('customers', { keyPath: 'id' });
                    }
                };
                request.onsuccess = (event) => {
                    db = event.target.result;
                    resolve(db);
                };
                request.onerror = (event) => reject(event.target.error);
            });
        }

        // إنشاء معرف عشوائي مكون من 5 أرقام
        async function generateUniqueId(storeName) {
            let id;
            let isUnique = false;
            const existingIds = await getAllIds(storeName);
            while (!isUnique) {
                id = Math.floor(10000 + Math.random() * 90000).toString();
                isUnique = !existingIds.includes(id);
            }
            return id;
        }

        // جلب جميع المعرفات من متجر معين
        function getAllIds(storeName) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([storeName], 'readonly');
                const store = transaction.objectStore(storeName);
                const request = store.getAll();
                request.onsuccess = () => {
                    const ids = request.result.map(item => item.id);
                    resolve(ids);
                };
                request.onerror = () => reject(request.error);
            });
        }

        // جلب جميع المنتجات
        function getAllProducts() {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['products'], 'readonly');
                const store = transaction.objectStore('products');
                const request = store.getAll();
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        // جلب جميع الفواتير
        function getAllInvoices() {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['invoices'], 'readonly');
                const store = transaction.objectStore('invoices');
                const request = store.getAll();
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        // جلب جميع الزبائن
        function getAllCustomers() {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['customers'], 'readonly');
                const store = transaction.objectStore('customers');
                const request = store.getAll();
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        // تحديث لوحة المعلومات
        async function updateDashboard() {
            const invoices = await getAllInvoices();
            const paid = invoices.filter(i => parseFloat(i.amountPaid) >= parseFloat(i.totalAmount)).length;
            const partial = invoices.filter(i => parseFloat(i.amountPaid) > 0 && parseFloat(i.amountPaid) < parseFloat(i.totalAmount)).length;
            const unpaid = invoices.filter(i => parseFloat(i.amountPaid) === 0).length;

            document.getElementById('paidInvoices').innerText = paid;
            document.getElementById('partialInvoices').innerText = partial;
            document.getElementById('unpaidInvoices').innerText = unpaid;
        }

        // تحديث جدول الفواتير
        async function updateInvoicesTable() {
            const invoices = await getAllInvoices();
            const customers = await getAllCustomers();
            const tableBody = document.getElementById('invoicesTable');
            tableBody.innerHTML = '';

            invoices.forEach((invoice, index) => {
                const customer = customers.find(c => c.id === invoice.customerId);
                const totalAmount = parseFloat(invoice.totalAmount);
                const amountPaid = parseFloat(invoice.amountPaid);
                let statusClass, statusText;
                if (amountPaid >= totalAmount) {
                    statusClass = 'status-paid';
                    statusText = 'مدفوع';
                } else if (amountPaid > 0) {
                    statusClass = 'status-partial';
                    statusText = 'مدفوع جزئيًا';
                } else {
                    statusClass = 'status-unpaid';
                    statusText = 'لم يتم الدفع';
                }

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${invoice.id}</td>
                    <td>${customer && customer.name ? customer.name : 'غير معروف'}</td>
                    <td>${customer && customer.phone ? customer.phone : '-'}</td>
                    <td>${totalAmount.toFixed(2)}</td>
                    <td class="${statusClass}">${statusText}</td>
                    <td>
                        <i class="fas fa-print action-btn print" onclick="printInvoice('${invoice.id}');event.stopPropagation();"></i>
                        <i class="fas fa-edit action-btn edit" onclick="editInvoice('${invoice.id}');event.stopPropagation();"></i>
                        <i class="fas fa-trash action-btn delete" onclick="deleteInvoice('${invoice.id}');event.stopPropagation();"></i>
                    </td>
                `;
                tableBody.appendChild(row);
            });

            filterTable();
        }

        // تحديث جدول الزبائن
        async function updateCustomersTable() {
            const customers = await getAllCustomers();
            const tableBody = document.getElementById('customersTable');
            tableBody.innerHTML = '';

            customers.forEach((customer, index) => {
                const row = document.createElement('tr');
                const displayName = customer.name || 'غير محدد';
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${displayName}</td>
                    <td>${customer.phone || '-'}</td>
                    <td>${customer.address || '-'}</td>
                    <td>
                        <i class="fas fa-edit action-btn edit" onclick="editCustomer('${customer.id}');event.stopPropagation();"></i>
                        <i class="fas fa-trash action-btn delete" onclick="deleteCustomer('${customer.id}');event.stopPropagation();"></i>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }

        // تصفية جدول الفواتير
        async function filterTable() {
            const searchInput = document.getElementById('searchInput').value.toLowerCase();
            const statusFilter = document.getElementById('statusFilter').value;
            const invoices = await getAllInvoices();
            const customers = await getAllCustomers();
            const tableBody = document.getElementById('invoicesTable');
            tableBody.innerHTML = '';

            let filteredInvoices = invoices.filter(invoice => {
                const customer = customers.find(c => c.id === invoice.customerId);
                const customerName = customer && customer.name ? customer.name.toLowerCase() : '';
                const matchesSearch = customerName.includes(searchInput) || invoice.id.includes(searchInput);
                if (!matchesSearch) return false;
                const totalAmount = parseFloat(invoice.totalAmount);
                const amountPaid = parseFloat(invoice.amountPaid);
                if (statusFilter === 'all') return true;
                if (statusFilter === 'paid') return amountPaid >= totalAmount;
                if (statusFilter === 'partial') return amountPaid > 0 && amountPaid < totalAmount;
                if (statusFilter === 'unpaid') return amountPaid === 0;
                return true;
            });

            filteredInvoices.forEach((invoice, index) => {
                const customer = customers.find(c => c.id === invoice.customerId);
                const totalAmount = parseFloat(invoice.totalAmount);
                const amountPaid = parseFloat(invoice.amountPaid);
                let statusClass, statusText;
                if (amountPaid >= totalAmount) {
                    statusClass = 'status-paid';
                    statusText = 'مدفوع';
                } else if (amountPaid > 0) {
                    statusClass = 'status-partial';
                    statusText = 'مدفوع جزئيًا';
                } else {
                    statusClass = 'status-unpaid';
                    statusText = 'لم يتم الدفع';
                }

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${invoice.id}</td>
                    <td>${customer && customer.name ? customer.name : 'غير معروف'}</td>
                    <td>${customer && customer.phone ? customer.phone : '-'}</td>
                    <td>${totalAmount.toFixed(2)}</td>
                    <td class="${statusClass}">${statusText}</td>
                    <td>
                        <i class="fas fa-print action-btn print" onclick="printInvoice('${invoice.id}');event.stopPropagation();"></i>
                        <i class="fas fa-edit action-btn edit" onclick="editInvoice('${invoice.id}');event.stopPropagation();"></i>
                        <i class="fas fa-trash action-btn delete" onclick="deleteInvoice('${invoice.id}');event.stopPropagation();"></i>
                    </td>
                `;
                tableBody.appendChild(row);
            });

            updateDashboard();
        }

        // ملء قائمة الزبائن
        async function populateCustomerSelect(selectId) {
            const customers = await getAllCustomers();
            const select = document.getElementById(selectId);
            select.innerHTML = '<option value="">اختر زبونًا</option>';
            customers.forEach(customer => {
                const option = document.createElement('option');
                option.value = customer.id;
                option.textContent = customer.name || `زبون بدون اسم (${customer.phone || 'معرف: ' + customer.id})`;
                select.appendChild(option);
            });
        }

        // تحديث معلومات الزبون عند اختياره
        async function updateCustomerInfo(selectId, phoneId, addressId) {
            const customerId = document.getElementById(selectId).value;
            const customers = await getAllCustomers();
            const customer = customers.find(c => c.id === customerId);
            document.getElementById(phoneId).value = customer && customer.phone ? customer.phone : '';
            document.getElementById(addressId).value = customer && customer.address ? customer.address : '';
        }

        // البحث عن منتج
        async function setupProductSearch(searchId, suggestionsId, productsTableId, isEdit = false) {
            const searchInput = document.getElementById(searchId);
            const suggestionsDiv = document.getElementById(suggestionsId);
            searchInput.addEventListener('input', async () => {
                const query = searchInput.value.toLowerCase();
                const products = await getAllProducts();
                const filteredProducts = products.filter(p => p.name.toLowerCase().includes(query) || p.id.includes(query));
                suggestionsDiv.innerHTML = '';
                if (query && filteredProducts.length > 0) {
                    filteredProducts.forEach(product => {
                        const div = document.createElement('div');
                        div.className = 'p-2 border-bottom';
                        div.style.cursor = 'pointer';
                        div.innerHTML = `
                            <strong>${product.name}</strong> (معرف: ${product.id})<br>
                            سعر البيع: ${parseFloat(product.salePrice).toFixed(2)} | سعر الشراء: ${parseFloat(product.purchasePrice).toFixed(2)}
                        `;
                        div.onclick = () => addProductToInvoice(product, productsTableId, isEdit);
                        suggestionsDiv.appendChild(div);
                    });
                }
            });
        }

        // إضافة منتج إلى الفاتورة
        function addProductToInvoice(product, productsTableId, isEdit) {
            const tableBody = document.getElementById(productsTableId);
            const row = document.createElement('tr');
            const rowId = `product-${product.id}-${Date.now()}`;
            row.id = rowId;
            row.innerHTML = `
                <td>${product.name}</td>
                <td><input type="number" class="form-control sale-price" value="${parseFloat(product.salePrice).toFixed(2)}" step="0.01" min="0"></td>
                <td><input type="number" class="form-control quantity" value="1" min="1"></td>
                <td><input type="text" class="form-control note"></td>
                <td class="total">${parseFloat(product.salePrice).toFixed(2)}</td>
                <td><i class="fas fa-trash action-btn delete" onclick="removeProductFromInvoice('${rowId}', '${productsTableId}')"></i></td>
            `;
            tableBody.appendChild(row);
            updateInvoiceTotals(productsTableId);
            row.querySelector('.sale-price').addEventListener('input', () => updateInvoiceTotals(productsTableId));
            row.querySelector('.quantity').addEventListener('input', () => updateInvoiceTotals(productsTableId));
        }

        // إزالة منتج من الفاتورة
        function removeProductFromInvoice(rowId, productsTableId) {
            document.getElementById(rowId).remove();
            updateInvoiceTotals(productsTableId);
        }

        // تحديث إجمالي الفاتورة
        function updateInvoiceTotals(productsTableId) {
            const tableBody = document.getElementById(productsTableId);
            const rows = tableBody.querySelectorAll('tr');
            let totalAmount = 0;
            let totalItems = rows.length;

            rows.forEach(row => {
                const salePrice = parseFloat(row.querySelector('.sale-price').value) || 0;
                const quantity = parseInt(row.querySelector('.quantity').value) || 1;
                const total = salePrice * quantity;
                row.querySelector('.total').textContent = total.toFixed(2);
                totalAmount += total;
            });

            document.getElementById(productsTableId === 'invoiceProducts' ? 'totalItems' : 'editTotalItems').textContent = totalItems;
            document.getElementById(productsTableId === 'invoiceProducts' ? 'totalAmount' : 'editTotalAmount').textContent = totalAmount.toFixed(2);
        }

        // إضافة فاتورة
        async function addInvoice() {
            const customerId = document.getElementById('invoiceCustomer').value;
            const amountPaid = document.getElementById('amountPaid').value;
            const productsTable = document.getElementById('invoiceProducts');
            const rows = productsTable.querySelectorAll('tr');

            if (!customerId || rows.length === 0) {
                Swal.fire({
                    title: 'خطأ',
                    text: 'الرجاء اختيار زبون وإضافة منتج واحد على الأقل!',
                    icon: 'error',
                    confirmButtonColor: '#3F2A56'
                });
                return;
            }

            const products = [];
            let totalAmount = 0;
            rows.forEach(row => {
                const name = row.cells[0].textContent;
                const salePrice = parseFloat(row.querySelector('.sale-price').value);
                const quantity = parseInt(row.querySelector('.quantity').value);
                const note = row.querySelector('.note').value;
                const total = salePrice * quantity;
                products.push({ name, salePrice, quantity, note, total });
                totalAmount += total;
            });

            const id = await generateUniqueId('invoices');
            const invoice = {
                id,
                customerId,
                products,
                totalAmount: totalAmount.toFixed(2),
                amountPaid: parseFloat(amountPaid).toFixed(2),
                date: new Date().toISOString()
            };

            const transaction = db.transaction(['invoices'], 'readwrite');
            const store = transaction.objectStore('invoices');
            const request = store.add(invoice);

            request.onsuccess = async () => {
                await updateInvoicesTable();
                bootstrap.Modal.getInstance(document.getElementById('addInvoiceModal')).hide();
                document.getElementById('addInvoiceForm').reset();
                document.getElementById('invoiceProducts').innerHTML = '';
                document.getElementById('totalItems').textContent = '0';
                document.getElementById('totalAmount').textContent = '0.00';
                document.getElementById('amountPaid').value = '0';
                Swal.fire({
                    title: 'نجاح',
                    text: 'تم إضافة الفاتورة بنجاح!',
                    icon: 'success',
                    confirmButtonColor: '#3F2A56'
                });
            };
            request.onerror = () => {
                Swal.fire({
                    title: 'خطأ',
                    text: 'فشل في إضافة الفاتورة!',
                    icon: 'error',
                    confirmButtonColor: '#3F2A56'
                });
            };
        }

        // تعديل فاتورة
        async function editInvoice(id) {
            const transaction = db.transaction(['invoices'], 'readonly');
            const store = transaction.objectStore('invoices');
            const request = store.get(id);

            request.onsuccess = async () => {
                const invoice = request.result;
                document.getElementById('editInvoiceId').value = invoice.id;
                document.getElementById('editInvoiceCustomer').value = invoice.customerId;
                await updateCustomerInfo('editInvoiceCustomer', 'editCustomerPhone', 'editCustomerAddress');
                document.getElementById('editInvoiceDate').textContent = new Date(invoice.date).toLocaleString('ar-SA');
                document.getElementById('editAmountPaid').value = invoice.amountPaid;

                const tableBody = document.getElementById('editInvoiceProducts');
                tableBody.innerHTML = '';
                invoice.products.forEach(product => {
                    const row = document.createElement('tr');
                    const rowId = `product-${Date.now()}`;
                   แรง
                    row.id = rowId;
                    row.innerHTML = `
                        <td>${product.name}</td>
                        <td><input type="number" class="form-control sale-price" value="${product.salePrice.toFixed(2)}" step="0.01" min="0"></td>
                        <td><input type="number" class="form-control quantity" value="${product.quantity}" min="1"></td>
                        <td><input type="text" class="form-control note" value="${product.note || ''}"></td>
                        <td class="total">${product.total.toFixed(2)}</td>
                        <td><i class="fas fa-trash action-btn delete" onclick="removeProductFromInvoice('${rowId}', 'editInvoiceProducts')"></i></td>
                    `;
                    tableBody.appendChild(row);
                    row.querySelector('.sale-price').addEventListener('input', () => updateInvoiceTotals('editInvoiceProducts'));
                    row.querySelector('.quantity').addEventListener('input', () => updateInvoiceTotals('editInvoiceProducts'));
                });

                updateInvoiceTotals('editInvoiceProducts');
                new bootstrap.Modal(document.getElementById('editInvoiceModal')).show();
            };
        }

        // تحديث فاتورة
        async function updateInvoice() {
            const id = document.getElementById('editInvoiceId').value;
            const customerId = document.getElementById('editInvoiceCustomer').value;
            const amountPaid = document.getElementById('editAmountPaid').value;
            const productsTable = document.getElementById('editInvoiceProducts');
            const rows = productsTable.querySelectorAll('tr');

            if (!customerId || rows.length === 0) {
                Swal.fire({
                    title: 'خطأ',
                    text: 'الرجاء اختيار زبون وإضافة منتج واحد على الأقل!',
                    icon: 'error',
                    confirmButtonColor: '#3F2A56'
                });
                return;
            }

            const products = [];
            let totalAmount = 0;
            rows.forEach(row => {
                const name = row.cells[0].textContent;
                const salePrice = parseFloat(row.querySelector('.sale-price').value);
                const quantity = parseInt(row.querySelector('.quantity').value);
                const note = row.querySelector('.note').value;
                const total = salePrice * quantity;
                products.push({ name, salePrice, quantity, note, total });
                totalAmount += total;
            });

            const invoice = {
                id,
                customerId,
                products,
                totalAmount: totalAmount.toFixed(2),
                amountPaid: parseFloat(amountPaid).toFixed(2),
                date: new Date().toISOString()
            };

            const transaction = db.transaction(['invoices'], 'readwrite');
            const store = transaction.objectStore('invoices');
            const request = store.put(invoice);

            request.onsuccess = async () => {
                await updateInvoicesTable();
                bootstrap.Modal.getInstance(document.getElementById('editInvoiceModal')).hide();
                Swal.fire({
                    title: 'نجاح',
                    text: 'تم تعديل الفاتورة بنجاح!',
                    icon: 'success',
                    confirmButtonColor: '#3F2A56'
                });
            };
            request.onerror = () => {
                Swal.fire({
                    title: 'خطأ',
                    text: 'فشل في تعديل الفاتورة!',
                    icon: 'error',
                    confirmButtonColor: '#3F2A56'
                });
            };
        }

        // حذف فاتورة
        async function deleteInvoice(id) {
            const result = await Swal.fire({
                title: 'تأكيد الحذف',
                text: 'هل أنت متأكد من حذف هذه الفاتورة؟ لا يمكن التراجع عن هذا الإجراء.',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'حذف',
                cancelButtonText: 'إلغاء',
                confirmButtonColor: '#dc3545'
            });

            if (result.isConfirmed) {
                const transaction = db.transaction(['invoices'], 'readwrite');
                const store = transaction.objectStore('invoices');
                const request = store.delete(id);

                request.onsuccess = async () => {
                    await updateInvoicesTable();
                    Swal.fire({
                        title: 'نجاح',
                        text: 'تم حذف الفاتورة بنجاح!',
                        icon: 'success',
                        confirmButtonColor: '#3F2A56'
                    });
                };
                request.onerror = () => {
                    Swal.fire({
                        title: 'خطأ',
                        text: 'فشل في حذف الفاتورة!',
                        icon: 'error',
                        confirmButtonColor: '#3F2A56'
                    });
                };
            }
        }

        // إضافة زبون
        async function addCustomer() {
            const name = document.getElementById('customerName').value.trim();
            const phone = document.getElementById('customerPhone').value.trim();
            const address = document.getElementById('customerAddress').value.trim();

            const id = await generateUniqueId('customers');
            const customer = { id, name, phone, address };

            if (phone) {
                const customers = await getAllCustomers();
                if (customers.some(c => c.phone === phone)) {
                    Swal.fire({
                        title: 'خطأ',
                        text: 'رقم الهاتف موجود مسبقًا!',
                        icon: 'error',
                        confirmButtonColor: '#3F2A56'
                    });
                    return;
                }
            }

            const transaction = db.transaction(['customers'], 'readwrite');
            const store = transaction.objectStore('customers');
            const request = store.add(customer);

            request.onsuccess = async () => {
                await updateCustomersTable();
                await populateCustomerSelect('invoiceCustomer');
                await populateCustomerSelect('editInvoiceCustomer');
                await populateCustomerSelect('statementCustomer');
                bootstrap.Modal.getInstance(document.getElementById('addCustomerModal')).hide();
                document.getElementById('addCustomerForm').reset();
                Swal.fire({
                    title: 'نجاح',
                    text: 'تم إضافة الزبون بنجاح!',
                    icon: 'success',
                    confirmButtonColor: '#3F2A56'
                });
            };
            request.onerror = () => {
                Swal.fire({
                    title: 'خطأ',
                    text: 'فشل في إضافة الزبون!',
                    icon: 'error',
                    confirmButtonColor: '#3F2A56'
                });
            };
        }

        // تعديل زبون
        async function editCustomer(id) {
            const transaction = db.transaction(['customers'], 'readonly');
            const store = transaction.objectStore('customers');
            const request = store.get(id);

            request.onsuccess = () => {
                const customer = request.result;
                document.getElementById('editCustomerId').value = customer.id;
                document.getElementById('editCustomerName').value = customer.name || '';
                document.getElementById('editCustomerPhone').value = customer.phone || '';
                document.getElementById('editCustomerAddress').value = customer.address || '';
                new bootstrap.Modal(document.getElementById('editCustomerModal')).show();
            };
        }

        // تحديث زبون
        async function updateCustomer() {
            const id = document.getElementById('editCustomerId').value;
            const name = document.getElementById('editCustomerName').value.trim();
            const phone = document.getElementById('editCustomerPhone').value.trim();
            const address = document.getElementById('editCustomerAddress').value.trim();

            if (phone) {
                const customers = await getAllCustomers();
                const existingCustomer = customers.find(c => c.id === id);
                if (phone !== existingCustomer.phone && customers.some(c => c.phone === phone)) {
                    Swal.fire({
                        title: 'خطأ',
                        text: 'رقم الهاتف موجود مسبقًا!',
                        icon: 'error',
                        confirmButtonColor: '#3F2A56'
                    });
                    return;
                }
            }

            const customer = { id, name, phone, address };

            const transaction = db.transaction(['customers'], 'readwrite');
            const store = transaction.objectStore('customers');
            const request = store.put(customer);

            request.onsuccess = async () => {
                await updateCustomersTable();
                await updateInvoicesTable();
                await populateCustomerSelect('invoiceCustomer');
                await populateCustomerSelect('editInvoiceCustomer');
                await populateCustomerSelect('statementCustomer');
                bootstrap.Modal.getInstance(document.getElementById('editCustomerModal')).hide();
                Swal.fire({
                    title: 'نجاح',
                    text: 'تم تعديل الزبون بنجاح!',
                    icon: 'success',
                    confirmButtonColor: '#3F2A56'
                });
            };
            request.onerror = () => {
                Swal.fire({
                    title: 'خطأ',
                    text: 'فشل في تعديل الزبون!',
                    icon: 'error',
                    confirmButtonColor: '#3F2A56'
                });
            };
        }

        // حذف زبون
        async function deleteCustomer(id) {
            const invoices = await getAllInvoices();
            if (invoices.some(i => i.customerId === id)) {
                Swal.fire({
                    title: 'خطأ',
                    text: 'لا يمكن حذف الزبون لأنه مرتبط بفواتير!',
                    icon: 'error',
                    confirmButtonColor: '#3F2A56'
                });
                return;
            }

            const result = await Swal.fire({
                title: 'تأكيد الحذف',
                text: 'هل أنت متأكد من حذف هذا الزبون؟',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'حذف',
                cancelButtonText: 'إلغاء',
                confirmButtonColor: '#dc3545'
            });

            if (result.isConfirmed) {
                const transaction = db.transaction(['customers'], 'readwrite');
                const store = transaction.objectStore('customers');
                const request = store.delete(id);

                request.onsuccess = async () => {
                    await updateCustomersTable();
                    await populateCustomerSelect('invoiceCustomer');
                    await populateCustomerSelect('editInvoiceCustomer');
                    await populateCustomerSelect('statementCustomer');
                    Swal.fire({
                        title: 'نجاح',
                        text: 'تم حذف الزبون بنجاح!',
                        icon: 'success',
                        confirmButtonColor: '#3F2A56'
                    });
                };
                request.onerror = () => {
                    Swal.fire({
                        title: 'خطأ',
                        text: 'فشل في حذف الزبون!',
                        icon: 'error',
                        confirmButtonColor: '#3F2A56'
                    });
                };
            }
        }

        // طباعة فاتورة
        async function printInvoice(id) {
            const transaction = db.transaction(['invoices', 'customers'], 'readonly');
            const invoiceStore = transaction.objectStore('invoices');
            const customerStore = transaction.objectStore('customers');
            const invoiceRequest = invoiceStore.get(id);
            const customers = await getAllCustomers();

            invoiceRequest.onsuccess = () => {
                const invoice = invoiceRequest.result;
                const customer = customers.find(c => c.id === invoice.customerId);
                const printWindow = window.open('', '_blank');
                printWindow.document.write(`
                    <html>
                    <head>
                        <title>فاتورة #${invoice.id}</title>
                        <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
                        <style>
                            @page { size: A4; margin: 10mm; }
                            body { font-family: 'Cairo', sans-serif; direction: rtl; margin: 10mm; }
                            .container { max-width: 800px; margin: 0 auto; }
                            .header { text-align: center; margin-bottom: 20px; }
                            .header img { height: 70px; }
                            .header h1 { font-size: 1.6rem; color: #3F2A56; }
                            .info { margin-bottom: 20px; }
                            .info p { margin: 5px 0; }
                            table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
                            th, td { padding: 10px; border: 1px solid #000; text-align: center; }
                            th { background: linear-gradient(90deg, #3F2A56, #5a3f73); color: white; }
                            .totals { margin-top: 20px; }
                            .totals p { margin: 5px 0; font-weight: 600; }
                        </style>
                    </head>
                    <body>
                        <div class="container">
                            <div class="header">
                                <img src="logo.png" alt="شعار طيبة المدينة تلكوم">
                                <h1>طيبة المدينة تلكوم - فاتورة</h1>
                            </div>
                            <div class="info">
                                <p><strong>معرف الفاتورة:</strong> ${invoice.id}</p>
                                <p><strong>الزبون:</strong> ${customer && customer.name ? customer.name : 'غير معروف'}</p>
                                <p><strong>رقم الهاتف:</strong> ${customer && customer.phone ? customer.phone : '-'}</p>
                                <p><strong>العنوان:</strong> ${customer && customer.address ? customer.address : '-'}</p>
                                <p><strong>التاريخ:</strong> ${new Date(invoice.date).toLocaleString('ar-SA')}</p>
                            </div>
                            <table>
                                <thead>
                                    <tr>
                                        <th>اسم المنتج</th>
                                        <th>سعر البيع</th>
                                        <th>الكمية</th>
                                        <th>الملاحظة</th>
                                        <th>الإجمالي</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${invoice.products.map(p => `
                                        <tr>
                                            <td>${p.name}</td>
                                            <td>${p.salePrice.toFixed(2)}</td>
                                            <td>${p.quantity}</td>
                                            <td>${p.note || '-'}</td>
                                            <td>${p.total.toFixed(2)}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                            <div class="totals">
                                <p>عدد المواد: ${invoice.products.length}</p>
                                <p>المجموع الكلي: ${parseFloat(invoice.totalAmount).toFixed(2)}</p>
                                <p>المبلغ المدفوع: ${parseFloat(invoice.amountPaid).toFixed(2)}</p>
                                <p>المتبقي: ${(parseFloat(invoice.totalAmount) - parseFloat(invoice.amountPaid)).toFixed(2)}</p>
                            </div>
                        </div>
                    </body>
                    </html>
                `);
                printWindow.document.close();
                printWindow.focus();
            };
        }

        // إنشاء كشف حساب زبون
        async function generateCustomerStatement() {
            const customerId = document.getElementById('statementCustomer').value;
            const startDate = new Date(document.getElementById('startDate').value);
            const endDate = new Date(document.getElementById('endDate').value);

            if (!customerId || !startDate || !endDate) {
                Swal.fire({
                    title: 'خطأ',
                    text: 'الرجاء إدخال جميع الحقول المطلوبة!',
                    icon: 'error',
                    confirmButtonColor: '#3F2A56'
                });
                return;
            }

            if (startDate > endDate) {
                Swal.fire({
                    title: 'خطأ',
                    text: 'تاريخ البداية يجب أن يكون قبل تاريخ النهاية!',
                    icon: 'error',
                    confirmButtonColor: '#3F2A56'
                });
                return;
            }

            const invoices = await getAllInvoices();
            const customers = await getAllCustomers();
            const customer = customers.find(c => c.id === customerId);
            const filteredInvoices = invoices.filter(i => {
                const invoiceDate = new Date(i.date);
                return i.customerId === customerId && invoiceDate >= startDate && invoiceDate <= endDate;
            });

            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                <head>
                    <title>كشف حساب زبون</title>
                    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
                    <style>
                        @page { size: A4; margin: 10mm; }
                        body { font-family: 'Cairo', sans-serif; direction: rtl; margin: 10mm; }
                        .container { max-width: 800px; margin: 0 auto; }
                        .header { text-align: center; margin-bottom: 20px; }
                        .header img { height: 70px; }
                        .header h1 { font-size: 1.6rem; color: #3F2A56; }
                        .info { margin-bottom: 20px; }
                        .info p { margin: 5px 0; }
                        table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
                        th, td { padding: 10px; border: 1px solid #000; text-align: center; }
                        th { background: linear-gradient(90deg, #3F2A56, #5a3f73); color: white; }
                        .status-paid { color: #28a745; }
                        .status-partial { color: #ffc107; }
                        .status-unpaid { color: #dc3545; }
                    </style>
                </head>
                <body>
                    <div class="container">
                        <div class="header">
                            <img src="logo.png" alt="شعار طيبة المدينة تلكوم">
                            <h1>طيبة المدينة تلكوم - كشف حساب زبون</h1>
                        </div>
                        <div class="info">
                            <p><strong>الزبون:</strong> ${customer && customer.name ? customer.name : 'غير معروف'}</p>
                            <p><strong>رقم الهاتف:</strong> ${customer && customer.phone ? customer.phone : '-'}</p>
                            <p><strong>العنوان:</strong> ${customer && customer.address ? customer.address : '-'}</p>
                            <p><strong>من تاريخ:</strong> ${startDate.toLocaleDateString('ar-SA')}</p>
                            <p><strong>إلى تاريخ:</strong> ${endDate.toLocaleDateString('ar-SA')}</p>
                        </div>
                        <table>
                            <thead>
                                <tr>
                                    <th>معرف الفاتورة</th>
                                    <th>التاريخ</th>
                                    <th>المبلغ الكلي</th>
                                    <th>المبلغ المدفوع</th>
                                    <th>الحالة</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${filteredInvoices.length > 0 ? filteredInvoices.map(i => {
                                    const totalAmount = parseFloat(i.totalAmount);
                                    const amountPaid = parseFloat(i.amountPaid);
                                    let statusClass, statusText;
                                    if (amountPaid >= totalAmount) {
                                        statusClass = 'status-paid';
                                        statusText = 'مدفوع';
                                    } else if (amountPaid > 0) {
                                        statusClass = 'status-partial';
                                        statusText = 'مدفوع جزئيًا';
                                    } else {
                                        statusClass = 'status-unpaid';
                                        statusText = 'لم يتم الدفع';
                                    }
                                    return `
                                        <tr>
                                            <td>${i.id}</td>
                                            <td>${new Date(i.date).toLocaleString('ar-SA')}</td>
                                            <td>${totalAmount.toFixed(2)}</td>
                                            <td>${amountPaid.toFixed(2)}</td>
                                            <td class="${statusClass}">${statusText}</td>
                                        </tr>
                                    `;
                                }).join('') : '<tr><td colspan="5">لا توجد فواتير في هذا النطاق</td></tr>'}
                            </tbody>
                        </table>
                    </div>
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.focus();
            bootstrap.Modal.getInstance(document.getElementById('customerStatementModal')).hide();
        }

        // تهيئة الصفحة
        document.addEventListener('DOMContentLoaded', async () => {
            await initDB();
            await updateInvoicesTable();
            await updateCustomersTable();
            await populateCustomerSelect('invoiceCustomer');
            await populateCustomerSelect('editInvoiceCustomer');
            await populateCustomerSelect('statementCustomer');
            setupProductSearch('productSearch', 'productSuggestions', 'invoiceProducts');
            setupProductSearch('editProductSearch', 'editProductSuggestions', 'editInvoiceProducts', true);
            document.getElementById('invoiceDate').textContent = new Date().toLocaleString('ar-SA');
            document.getElementById('invoiceCustomer').addEventListener('change', () => updateCustomerInfo('invoiceCustomer', 'customerPhone', 'customerAddress'));
            document.getElementById('editInvoiceCustomer').addEventListener('change', () => updateCustomerInfo('editInvoiceCustomer', 'editCustomerPhone', 'editCustomerAddress'));
        });
    </script>
</body>
</html>