<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>لائحة موثقي غزة إبي</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jsqr/1.4.0/jsQR.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.1.0/pako.min.js"></script>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#f9ffff">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Cairo', sans-serif;
            background: linear-gradient(135deg, #f0f2f5, #d9e2ec);
            color: #333;
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .home-btn {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    background: linear-gradient(90deg, #3F2A56, #5a3f73);
    color: white;
    padding: 10px 20px;
    border-radius: 25px;
    text-decoration: none;
    font-size: 1rem;
    font-weight: 600;
    font-family: 'Cairo', sans-serif;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
    transition: transform 0.2s ease, background 0.3s ease, box-shadow 0.3s ease;
    position: absolute;
    top: 20px;
    left: 20px; /* وضع الزر في الزاوية العلوية اليسرى */
}

.home-btn i {
    font-size: 1.2rem;
}

.home-btn:hover {
    background: linear-gradient(90deg, #5a3f73, #3F2A56);
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
}

.home-btn:focus {
    outline: 2px solid #3F2A56;
    outline-offset: 2px;
}

/* للشاشات الصغيرة */
@media (max-width: 768px) {
    .home-btn {
        padding: 8px 16px;
        font-size: 0.9rem;
        top: 15px;
        left: 15px;
    }
    .home-btn i {
        font-size: 1rem;
    }
}
        .header {
            background: linear-gradient(135deg, #3F2A56, #5a3f73);
            color: white;
            padding: 40px 20px;
            border-radius: 25px;
            text-align: center;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
            margin-bottom: 30px;
            position: relative;
            z-index: 1;
            border: 2px solid rgba(255, 255, 255, 0.1);
            overflow: hidden;
        }
        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.1), transparent);
            z-index: -1;
        }
        .header img {
            height: 90px;
            margin-bottom: 15px;
            filter: drop-shadow(0 3px 6px rgba(0, 0, 0, 0.3));
            transition: transform 0.3s ease;
            clip-path: polygon(10% 0%, 100% 0%, 90% 100%, 0% 100%);
        }
        .header img:hover {
            transform: scale(1.05);
        }
        .header h2 {
            font-size: 2.2rem;
            margin-bottom: 10px;
            font-weight: 700;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.2);
        }
        .header h4 {
            font-size: 1.4rem;
            opacity: 0.9;
            font-weight: 400;
            letter-spacing: 1px;
        }
        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        .card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: #3F2A56;
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            text-align: center;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(145deg, rgba(63, 42, 86, 0.2), rgba(90, 63, 115, 0.2));
            z-index: -1;
        }
        .card:hover {
            transform: translateY(-10px) scale(1.02);
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.2);
        }
        .card i {
            font-size: 2.8rem;
            margin-bottom: 15px;
            color: #3F2A56;
            transition: transform 0.3s ease;
        }
        .card:hover i {
            transform: scale(1.2);
        }
        .card h5 {
            font-size: 1.3rem;
            margin-bottom: 10px;
            font-weight: 600;
            color: #3F2A56;
        }
        .card h3 {
            font-size: 1.8rem;
            font-weight: 700;
            color: #3F2A56;
        }
        .actions {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin: 25px 0;
            justify-content: center;
        }
        .btn {
            background: linear-gradient(90deg, #3F2A56, #5a3f73);
            color: white;
            padding: 12px 24px;
            border-radius: 30px;
            border: none;
            font-size: 1rem;
            cursor: pointer;
            transition: transform 0.2s ease, background 0.3s ease, box-shadow 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }
        .btn:hover {
            background: linear-gradient(90deg, #5a3f73, #3F2A56);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
        }
        .btn i {
            font-size: 1.3rem;
        }
        .search-container {
            margin-bottom: 20px;
            display: flex;
            justify-content: center;
        }
        .search-container input {
            width: 100%;
            max-width: 400px;
            padding: 12px 20px;
            border-radius: 30px;
            border: none;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            color: #3F2A56;
            font-size: 1rem;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            transition: box-shadow 0.3s ease;
        }
        .search-container input:focus {
            outline: none;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2);
        }
        .search-container input::placeholder {
            color: #3F2A56;
            opacity: 0.7;
        }
        .table-container {
            overflow-x: auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
            padding: 15px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            padding: 14px;
            text-align: center;
            border-bottom: 1px solid #e0e0e0;
        }
        th {
            background: linear-gradient(90deg, #3F2A56, #5a3f73);
            color: white;
            font-weight: 700;
        }
        td {
            color: #3F2A56;
        }
        tr {
            cursor: pointer;
        }
        tr:hover {
            background-color: #f7f9fc;
        }
        .action-btn {
            cursor: pointer;
            margin: 0 6px;
            font-size: 1.3rem;
            transition: color 0.3s ease;
        }
        .action-btn.edit:hover {
            color: #007bff;
        }
        .action-btn.delete:hover {
            color: #dc3545;
        }
        .modal-content {
            border-radius: 15px;
            box-shadow: 0 5px 25px rgba(0, 0, 0, 0.2);
            border: none;
        }
        .modal-header {
            background: linear-gradient(90deg, #3F2A56, #5a3f73);
            color: white;
            border-top-left-radius: 15px;
            border-top-right-radius: 15px;
            padding: 15px 20px;
        }
        .modal-title {
            font-size: 1.4rem;
            margin: 0;
        }
        .modal-body {
            padding: 25px;
            background: #fff;
        }
        .modal-body .form-label {
            font-weight: 600;
            color: #3F2A56;
        }
        .modal-body .form-control {
            border-radius: 10px;
            border: 1px solid #ddd;
            padding: 12px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }
        .modal-body .form-control:focus {
            border-color: #3F2A56;
            box-shadow: 0 0 5px rgba(63, 42, 86, 0.3);
        }
        .modal-footer {
            padding: 15px 20px;
            background: #f8f9fa;
            border-bottom-left-radius: 15px;
            border-bottom-right-radius: 15px;
            justify-content: center;
            gap: 12px;
        }
        .modal-footer .btn {
            background: linear-gradient(90deg, #3F2A56, #5a3f73);
            color: white;
            border-radius: 25px;
            padding: 10px 25px;
            font-size: 1rem;
            transition: background 0.3s ease;
        }
        .modal-footer .btn:hover {
            background: linear-gradient(90deg, #5a3f73, #3F2A56);
        }
        .modal-footer .btn-secondary {
            background: linear-gradient(90deg, #6c757d, #5a6268);
        }
        .modal-footer .btn-secondary:hover {
            background: linear-gradient(90deg, #5a6268, #495057);
        }
        @media (max-width: 768px) {
            .header { padding: 25px 15px; border-radius: 15px; }
            .header img { height: 70px; }
            .header h2 { font-size: 1.7rem; }
            .header h4 { font-size: 1.1rem; }
            .card h3 { font-size: 1.5rem; }
            .btn { padding: 10px 18px; font-size: 0.9rem; }
            th, td { padding: 10px; font-size: 0.9rem; }
            .modal-title { font-size: 1.2rem; }
            .modal-body .form-control { font-size: 0.9rem; }
            .search-container input { width: 100%; max-width: 100%; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <img src="logo.png" alt="شعار طيبة المدينة تلكوم">
            <h2>طيبة المدينة تلكوم</h2>
            <h4>لائحة موثقي غزة إبي</h4>
            <a href="home.html" class="home-btn"><i class="fas fa-home"></i>  للرئيسية</a>
        </div>
        <div class="dashboard">
            <div class="card">
                <i class="fas fa-users"></i>
                <h5>عدد الموثقين</h5>
                <h3 id="notariesCount">0</h3>
            </div>
            <div class="card">
                <i class="fas fa-clock"></i>
                <h5>آخر تحديث</h5>
                <h3 id="lastUpdate">01:12 PM GMT, 22 May 2025</h3>
            </div>
        </div>
        <div class="actions">
            <button class="btn" data-bs-toggle="modal" data-bs-target="#addNotaryModal"><i class="fas fa-plus"></i> إضافة موثق</button>
            <button class="btn" onclick="exportToExcel()"><i class="fas fa-file-excel"></i> تصدير إلى Excel</button>
            <button class="btn" onclick="printTable()"><i class="fas fa-print"></i> طباعة</button>
            <button class="btn" onclick="exportToJSON()"><i class="fas fa-file-code"></i> تصدير إلى JSON</button>
            <button class="btn" onclick="exportToCSV()"><i class="fas fa-file-csv"></i> تصدير إلى CSV</button>
            <input type="file" id="importFile" accept=".json,.csv" style="display: none;" onchange="importFile(event)">
            <button class="btn" onclick="document.getElementById('importFile').click()"><i class="fas fa-file-import"></i> استيراد ملف</button>
            <button class="btn" onclick="generateQRCode()"><i class="fas fa-qrcode"></i> إنشاء رمز QR</button>
            <button class="btn" onclick="scanQRCode()"><i class="fas fa-camera"></i> مسح رمز QR</button>
            <input type="file" id="importQRImage" accept="image/*" style="display: none;" onchange="importQRFromImage(event)">
        </div>
        <div class="search-container">
            <input type="text" id="searchInput" placeholder="ابحث في الجدول..." onkeyup="searchTable()">
        </div>
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>#</th>
                        <th>الاسم</th>
                        <th>رقم بطاقة التعريف</th>
                        <th>رقم الهاتف</th>
                        <th>التاريخ</th>
                        <th>الملاحظة</th>
                        <th>الإجراءات</th>
                    </tr>
                </thead>
                <tbody id="notariesTable"></tbody>
            </table>
        </div>
    </div>
    <div class="modal fade" id="addNotaryModal" tabindex="-1" aria-labelledby="addNotaryModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addNotaryModalLabel"><i class="fas fa-user-plus me-2"></i> إضافة موثق جديد</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="addNotaryForm">
                        <div class="mb-3">
                            <label for="name" class="form-label">الاسم <i class="fas fa-user"></i></label>
                            <input type="text" class="form-control" id="name" required>
                        </div>
                        <div class="mb-3">
                            <label for="idNumber" class="form-label">رقم بطاقة التعريف <i class="fas fa-id-card"></i></label>
                            <input type="number" class="form-control" id="idNumber" required>
                        </div>
                        <div class="mb-3">
                            <label for="phone" class="form-label">رقم الهاتف <i class="fas fa-phone"></i></label>
                            <input type="number" class="form-control" id="phone" required>
                        </div>
                        <div class="mb-3">
                            <label for="date" class="form-label">التاريخ <i class="fas fa-calendar"></i></label>
                            <input type="date" class="form-control" id="date" required>
                        </div>
                        <div class="mb-3">
                            <label for="note" class="form-label">الملاحظة <i class="fas fa-sticky-note"></i> (اختياري)</label>
                            <textarea class="form-control" id="note" rows="3"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
                    <button type="button" class="btn" onclick="addNotary()">حفظ</button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="editNotaryModal" tabindex="-1" aria-labelledby="editNotaryModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editNotaryModalLabel"><i class="fas fa-edit me-2"></i> تعديل موثق</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="editNotaryForm">
                        <input type="hidden" id="editIndex">
                        <div class="mb-3">
                            <label for="editName" class="form-label">الاسم <i class="fas fa-user"></i></label>
                            <input type="text" class="form-control" id="editName" required>
                        </div>
                        <div class="mb-3">
                            <label for="editIdNumber" class="form-label">رقم بطاقة التعريف <i class="fas fa-id-card"></i></label>
                            <input type="number" class="form-control" id="editIdNumber" required>
                        </div>
                        <div class="mb-3">
                            <label for="editPhone" class="form-label">رقم الهاتف <i class="fas fa-phone"></i></label>
                            <input type="number" class="form-control" id="editPhone" required>
                        </div>
                        <div class="mb-3">
                            <label for="editDate" class="form-label">التاريخ <i class="fas fa-calendar"></i></label>
                            <input type="date" class="form-control" id="editDate" required>
                        </div>
                        <div class="mb-3">
                            <label for="editNote" class="form-label">الملاحظة <i class="fas fa-sticky-note"></i> (اختياري)</label>
                            <textarea class="form-control" id="editNote" rows="3"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
                    <button type="button" class="btn" onclick="updateNotary()">حفظ</button>
                </div>
            </div>
        </div>
    </div>
    <audio id="successSound" src="https://www.soundjay.com/buttons/beep-01a.mp3" preload="auto"></audio>
    <script>
        let notaries = JSON.parse(localStorage.getItem('notaries')) || [];

        function sortNotariesByDate() {
            notaries.sort((a, b) => new Date(b.date) - new Date(a.date));
        }

        function renderTable(searchQuery = '') {
            const tableBody = document.getElementById('notariesTable');
            tableBody.innerHTML = '';
            sortNotariesByDate();
            const filteredNotaries = notaries.filter(notary =>
                notary.name.toLowerCase().includes(searchQuery.toLowerCase()) ||
                notary.idNumber.toString().includes(searchQuery.toLowerCase()) ||
                notary.phone.toString().includes(searchQuery.toLowerCase()) ||
                notary.date.toLowerCase().includes(searchQuery.toLowerCase()) ||
                (notary.note || '').toLowerCase().includes(searchQuery.toLowerCase())
            );
            filteredNotaries.forEach((notary, index) => {
                const originalIndex = notaries.indexOf(notary);
                const row = document.createElement('tr');
                row.setAttribute('data-index', originalIndex);
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${notary.name}</td>
                    <td>${notary.idNumber}</td>
                    <td>${notary.phone}</td>
                    <td>${notary.date}</td>
                    <td>${notary.note || '-'}</td>
                    <td>
                        <i class="fas fa-edit action-btn edit" onclick="editNotary(${originalIndex});event.stopPropagation();"></i>
                        <i class="fas fa-trash action-btn delete" onclick="deleteNotary(${originalIndex});event.stopPropagation();"></i>
                    </td>
                `;
                row.addEventListener('click', () => showNotaryDetails(originalIndex));
                tableBody.appendChild(row);
            });
            updateDashboard();
        }

        function showNotaryDetails(index) {
            const notary = notaries[index];
            Swal.fire({
                title: 'تفاصيل الموثق',
                html: `
                    <div style="text-align: right; font-family: 'Cairo', sans-serif; color: #3F2A56;">
                        <p><strong>الاسم:</strong> ${notary.name}</p>
                        <p><strong>رقم بطاقة التعريف:</strong> ${notary.idNumber}</p>
                        <p><strong>رقم الهاتف:</strong> ${notary.phone}</p>
                        <p><strong>التاريخ:</strong> ${notary.date}</p>
                        <p><strong>الملاحظة:</strong> ${notary.note || '-'}</p>
                    </div>
                `,
                icon: 'info',
                confirmButtonText: 'إغلاق',
                confirmButtonColor: '#3F2A56',
                customClass: {
                    popup: 'swal2-rtl',
                    title: 'swal2-title',
                    content: 'swal2-content'
                }
            });
        }

        function searchTable() {
            const searchQuery = document.getElementById('searchInput').value;
            renderTable(searchQuery);
        }

        function updateDashboard() {
            document.getElementById('notariesCount').innerText = notaries.length;
            const now = new Date();
            const time = now.toLocaleString('en-US', { 
                timeZone: 'GMT',
                hour: '2-digit',
                minute: '2-digit',
                hour12: true
            }).replace(/:/g, '');
            const date = now.toLocaleString('en-US', { 
                timeZone: 'GMT',
                day: '2-digit',
                month: 'long',
                year: 'numeric'
            });
            document.getElementById('lastUpdate').innerText = `${time} GMT, ${date}`;
        }

        function checkDuplicate(idNumber, phone, excludeIndex = -1) {
            return notaries.some((notary, index) => 
                index !== excludeIndex && (notary.idNumber == idNumber || notary.phone == phone)
            );
        }

        async function addNotary() {
            const name = document.getElementById('name').value;
            const idNumber = document.getElementById('idNumber').value;
            const phone = document.getElementById('phone').value;
            const date = document.getElementById('date').value;
            const note = document.getElementById('note').value;

            if (name && idNumber && phone && date) {
                if (checkDuplicate(idNumber, phone)) {
                    const result = await Swal.fire({
                        title: 'تكرار المعلومات',
                        text: 'رقم بطاقة التعريف أو رقم الهاتف موجود مسبقًا. هل تريد المتابعة؟',
                        icon: 'warning',
                        showCancelButton: true,
                        confirmButtonText: 'متابعة',
                        cancelButtonText: 'إلغاء',
                        confirmButtonColor: '#3F2A56',
                        cancelButtonColor: '#6c757d'
                    });
                    if (!result.isConfirmed) return;
                }
                notaries.push({ name, idNumber, phone, date, note });
                localStorage.setItem('notaries', JSON.stringify(notaries));
                renderTable();
                bootstrap.Modal.getInstance(document.getElementById('addNotaryModal')).hide();
                document.getElementById('addNotaryForm').reset();
                Swal.fire({
                    title: 'تم الإضافة',
                    text: 'تم إضافة الموثق بنجاح!',
                    icon: 'success',
                    confirmButtonColor: '#3F2A56'
                });
            }
        }

        function editNotary(index) {
            document.getElementById('editIndex').value = index;
            document.getElementById('editName').value = notaries[index].name;
            document.getElementById('editIdNumber').value = notaries[index].idNumber;
            document.getElementById('editPhone').value = notaries[index].phone;
            document.getElementById('editDate').value = notaries[index].date;
            document.getElementById('editNote').value = notaries[index].note || '';
            new bootstrap.Modal(document.getElementById('editNotaryModal')).show();
        }

        async function updateNotary() {
            const index = parseInt(document.getElementById('editIndex').value);
            const name = document.getElementById('editName').value;
            const idNumber = document.getElementById('editIdNumber').value;
            const phone = document.getElementById('editPhone').value;
            const date = document.getElementById('editDate').value;
            const note = document.getElementById('editNote').value;

            if (name && idNumber && phone && date) {
                const originalNotary = notaries[index];
                const idNumberChanged = idNumber != originalNotary.idNumber;
                const phoneChanged = phone != originalNotary.phone;

                if ((idNumberChanged || phoneChanged) && checkDuplicate(idNumber, phone, index)) {
                    const result = await Swal.fire({
                        title: 'تكرار المعلومات',
                        text: 'رقم بطاقة التعريف أو رقم الهاتف موجود مسبقًا. هل تريد المتابعة؟',
                        icon: 'warning',
                        showCancelButton: true,
                        confirmButtonText: 'متابعة',
                        cancelButtonText: 'إلغاء',
                        confirmButtonColor: '#3F2A56',
                        cancelButtonColor: '#6c757d'
                    });
                    if (!result.isConfirmed) return;
                }

                notaries[index] = { name, idNumber, phone, date, note };
                localStorage.setItem('notaries', JSON.stringify(notaries));
                renderTable();
                bootstrap.Modal.getInstance(document.getElementById('editNotaryModal')).hide();
                Swal.fire({
                    title: 'تم التعديل',
                    text: 'تم تعديل الموثق بنجاح!',
                    icon: 'success',
                    confirmButtonColor: '#3F2A56'
                });
            }
        }

        async function deleteNotary(index) {
            const result = await Swal.fire({
                title: 'هل أنت متأكد؟',
                text: 'هل تريد حذف هذا الموثق؟',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'حذف',
                cancelButtonText: 'إلغاء',
                confirmButtonColor: '#dc3545',
                cancelButtonColor: '#6c757d'
            });
            if (result.isConfirmed) {
                notaries.splice(index, 1);
                localStorage.setItem('notaries', JSON.stringify(notaries));
                renderTable();
                Swal.fire({
                    title: 'تم الحذف',
                    text: 'تم حذف الموثق بنجاح!',
                    icon: 'success',
                    confirmButtonColor: '#3F2A56'
                });
            }
        }

        function exportToExcel() {
            const titleRow = [{ '#': 'لائحة موثقي غزة إبي', 'الاسم': '', 'رقم بطاقة التعريف': '', 'رقم الهاتف': '', 'التاريخ': '', 'الملاحظة': '' }];
            sortNotariesByDate();
            const data = notaries.map((notary, index) => ({
                '#': index + 1,
                'الاسم': notary.name,
                'رقم بطاقة التعريف': notary.idNumber,
                'رقم الهاتف': notary.phone,
                'التاريخ': notary.date,
                'الملاحظة': notary.note || '-'
            }));
            const ws = XLSX.utils.json_to_sheet([...titleRow, ...data], { skipHeader: true });

            ws['!cols'] = [{ wpx: 50 }, { wpx: 150 }, { wpx: 150 }, { wpx: 120 }, { wpx: 100 }, { wpx: 200 }];
            const range = XLSX.utils.decode_range(ws['!ref']);
            for (let R = range.s.r; R <= range.e.r; ++R) {
                for (let C = range.s.c; C <= range.e.c; ++C) {
                    const cellAddress = { c: C, r: R };
                    const cellRef = XLSX.utils.encode_cell(cellAddress);
                    if (!ws[cellRef]) continue;
                    if (R === 0) {
                        ws[cellRef].s = { font: { bold: true, sz: 14 }, alignment: { horizontal: "center" } };
                    } else if (R === 1) {
                        ws[cellRef].s = {
                            font: { bold: true, color: { rgb: "FFFFFF" } },
                            fill: { fgColor: { rgb: "3F2A56" } },
                            alignment: { horizontal: "center", vertical: "center" }
                        };
                    } else {
                        ws[cellRef].s = {
                            alignment: { horizontal: "center", vertical: "center" },
                            border: {
                                top: { style: "thin", color: { rgb: "000000" } },
                                bottom: { style: "thin", color: { rgb: "000000" } },
                                left: { style: "thin", color: { rgb: "000000" } },
                                right: { style: "thin", color: { rgb: "000000" } }
                            }
                        };
                    }
                }
            }
            ws['!merges'] = [{ s: { r: 0, c: 0 }, e: { r: 0, c: 5 } }];
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Notaries');
            XLSX.writeFile(wb, 'notaries.xlsx');
        }

        function printTable() {
            const itemsPerPage = 20;
            const totalPages = Math.ceil(notaries.length / itemsPerPage);
            const printWindow = window.open('', '_blank');
            const printDate = new Date().toLocaleString('en-US', { 
                day: '2-digit', 
                month: '2-digit', 
                year: 'numeric'
            }).replace(/(\d+)\/(\d+)\/(\d+)/, '$1/$2/$3');
            printWindow.document.write(`
                <html>
                <head>
                    <title>لائحة موثقي غزة إبي</title>
                    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
                    <style>
                        body { 
                            font-family: 'Cairo', sans-serif; 
                            direction: rtl; 
                            margin: 15mm; 
                            background: #fff; 
                            color: #000; 
                        }
                        .container { 
                            max-width: 1000px; 
                            margin: 0 auto; 
                        }
                        .header { 
                            display: flex; 
                            justify-content: space-between; 
                            align-items: center; 
                            margin-bottom: 20px; 
                            padding-bottom: 10px; 
                        }
                        .header img { 
                            height: 70px; 
                            clip-path: polygon(10% 0%, 100% 0%, 90% 100%, 0% 100%); 
                            margin-right: 0; 
                        }
                        .header h1 { 
                            font-size: 1.6rem; 
                            font-weight: 700; 
                            margin: 0; 
                            text-align: center; 
                            flex-grow: 1; 
                        }
                        .agency-card { 
                            border: 1px solid #000; 
                            padding: 15px; 
                            margin-bottom: 20px; 
                            background: #fff; 
                            text-align: right; 
                            border-radius: 5px; 
                            position: relative; 
                        }
                        .agency-card h3 { 
                            font-size: 1.3rem; 
                            font-weight: 700; 
                            margin: 0 0 10px; 
                            border-bottom: 1px solid #000; 
                            padding-bottom: 5px; 
                        }
                        .agency-card p { 
                            margin: 5px 0; 
                            font-size: 1rem; 
                            line-height: 1.5; 
                        }
                        .agency-card strong { 
                            font-weight: 600; 
                        }
                        h2 { 
                            text-align: center; 
                            font-size: 1.7rem; 
                            font-weight: 700; 
                            margin: 20px 0; 
                            border-bottom: 1px solid #000; 
                            padding-bottom: 5px; 
                        }
                        .notaries-count { 
                            text-align: center; 
                            font-size: 1.1rem; 
                            font-weight: 600; 
                            margin-bottom: 10px; 
                        }
                        .print-date { 
                            text-align: center; 
                            font-size: 1.1rem; 
                            font-weight: 600; 
                            margin-bottom: 20px; 
                        }
                        table { 
                            width: 100%; 
                            border-collapse: collapse; 
                            margin: 20px 0; 
                            border: 1px solid #000; 
                        }
                        th, td { 
                            padding: 12px; 
                            text-align: center; 
                            border: 1px solid #000; 
                            font-size: 1rem; 
                        }
                        th { 
                            background: linear-gradient(90deg, #3F2A56, #5a3f73);
                            color: white; 
                            font-weight: 700; 
                            font-size: 1.1rem; 
                        }
                        td { 
                            background: #fff; 
                        }
                        .footer { 
                            position: fixed; 
                            bottom: 5mm; 
                            width: 100%; 
                            text-align: center; 
                            font-size: 0.8rem; 
                            font-weight: 600; 
                        }
                        .page-number { 
                            position: fixed; 
                            bottom: 5mm; 
                            left: 15mm; 
                            font-size: 0.8rem; 
                            font-weight: 600; 
                        }
                        @media print {
                            .page-break { page-break-before: always; }
                            .container { margin: 0; width: 100%; }
                            .footer, .page-number { position: fixed; }
                            body { margin: 10mm; }
                            @page { size: A4; margin: 10mm; }
                        }
                    </style>
                </head>
                <body>
                    <div class="container">
            `);

            sortNotariesByDate();
            for (let page = 0; page < totalPages; page++) {
                if (page > 0) {
                    printWindow.document.write('<div class="page-break"></div>');
                }
                printWindow.document.write(`
                    <div class="header">
                        <img src="logo.png" alt="شعار طيبة المدينة تلكوم">
                        <h1>طيبة المدينة تلكوم</h1>
                        <div style="width: 70px;"></div>
                    </div>
                    <div class="agency-card">
                        <h3>معلومات الوكالة</h3>
                        <p><strong>الرقم:</strong> 46361138</p>
                        <p><strong>الإسم:</strong> Ahmedbedy Ahmedal Mouhamedou Ammy</p>
                        <p><strong>قانون الوكالة:</strong> A0295</p>
                        <p><strong>المكتب:</strong> R'KIZ - BARAYNA - 436</p>
                    </div>
                    <h2>لائحة موثقي غزة إبي</h2>
                    <div class="notaries-count">عدد الموثقين: ${notaries.length}</div>
                    <div class="print-date">التاريخ : ${printDate}</div>
                    <table>
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>الاسم</th>
                                <th>رقم بطاقة التعريف</th>
                                <th>رقم الهاتف</th>
                                <th>التاريخ</th>
                                <th>الملاحظة</th>
                            </tr>
                        </thead>
                        <tbody>
                `);
                const start = page * itemsPerPage;
                const end = Math.min(start + itemsPerPage, notaries.length);
                for (let i = start; i < end; i++) {
                    const notary = notaries[i];
                    printWindow.document.write(`
                        <tr>
                            <td>${i + 1}</td>
                            <td>${notary.name}</td>
                            <td>${notary.idNumber}</td>
                            <td>${notary.phone}</td>
                            <td>${notary.date}</td>
                            <td>${notary.note || '-'}</td>
                        </tr>
                    `);
                }
                printWindow.document.write(`
                        </tbody>
                    </table>
                    <div class="footer">هذا المستند من نظام طيبة المدينة تلكوم وهو موقع رقميًا</div>
                    <div class="page-number">الصفحة ${page + 1} من ${totalPages}</div>
                `);
            }

            printWindow.document.write(`
                    </div>
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        }

        function exportToJSON() {
            sortNotariesByDate();
            const dataStr = JSON.stringify(notaries, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'notaries.json';
            a.click();
            URL.revokeObjectURL(url);
        }

        function exportToCSV() {
            sortNotariesByDate();
            const headers = ['الاسم,رقم بطاقة التعريف,رقم الهاتف,التاريخ,الملاحظة'];
            const rows = notaries.map(n => `${n.name},${n.idNumber},${n.phone},${n.date},${n.note || '-'}`);
            const csv = [headers, ...rows].join('\n');
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'notaries.csv';
            a.click();
            URL.revokeObjectURL(url);
        }

        async function importFile(event) {
    const file = event.target.files[0];
    const reader = new FileReader();
    
    reader.onload = async function(e) {
        try {
            let newNotaries = [];
            const fileContent = e.target.result;
            
            if (file.name.endsWith('.json')) {
                newNotaries = JSON.parse(fileContent);
                if (!Array.isArray(newNotaries)) {
                    throw new Error('تنسيق الملف غير صالح. يجب أن يحتوي على مصفوفة.');
                }
            } else if (file.name.endsWith('.csv')) {
                const rows = fileContent.split('\n')
                    .filter(row => row.trim())
                    .slice(1);
                
                newNotaries = rows.map(row => {
                    const [name, idNumber, phone, date, note] = row.split(',').map(field => field?.trim());
                    return {
                        name: name || '',
                        idNumber: idNumber || '',
                        phone: phone || '',
                        date: date || '',
                        note: note || ''
                    };
                });
            } else {
                throw new Error('نوع الملف غير مدعوم');
            }
            
            // التحقق من صحة البيانات
            const isValid = newNotaries.every(n => 
                n.name && n.idNumber && n.phone && n.date
            );
            
            if (!isValid) {
                throw new Error('الملف يحتوي على بيانات ناقصة أو غير صالحة.');
            }
            
            // الكشف عن التكرارات
            const duplicates = newNotaries.filter(n => 
                checkDuplicate(n.idNumber, n.phone)
            );
            
            if (duplicates.length > 0) {
                const result = await Swal.fire({
                    title: 'تكرار المعلومات',
                    text: 'تم العثور على معلومات مكررة في الملف. اختر خيارًا:',
                    icon: 'warning',
                    showCancelButton: true,
                    showDenyButton: true,
                    confirmButtonText: 'الاحتفاظ بالتكرارات',
                    denyButtonText: 'حذف التكرارات',
                    cancelButtonText: 'إلغاء',
                    confirmButtonColor: '#3F2A56',
                    denyButtonColor: '#007bff',
                    cancelButtonColor: '#6c757d'
                });
                
                if (result.isDismissed) return;
                if (result.isDenied) {
                    newNotaries = newNotaries.filter(n => 
                        !checkDuplicate(n.idNumber, n.phone)
                    );
                }
            }
            
            // دمج البيانات الجديدة
            notaries = [...notaries, ...newNotaries];
            localStorage.setItem('notaries', JSON.stringify(notaries));
            renderTable();
            
            // إعادة تعيين حقل الرفع
            event.target.value = '';
            
            Swal.fire({
                title: 'تم الاستيراد!',
                text: `تمت إضافة ${newNotaries.length} موثق بنجاح.`,
                icon: 'success',
                confirmButtonColor: '#3F2A56'
            });
            
        } catch (error) {
            console.error('خطأ في الاستيراد:', error);
            Swal.fire({
                title: 'خطأ في الاستيراد',
                text: error.message || 'حدث خطأ أثناء معالجة الملف. يرجى التحقق من التنسيق.',
                icon: 'error',
                confirmButtonColor: '#3F2A56'
            });
        }
    };
    
    if (file) {
        if (file.name.endsWith('.json') || file.name.endsWith('.csv')) {
            reader.readAsText(file);
        } else {
            Swal.fire({
                title: 'نوع ملف غير مدعوم',
                text: 'الرجاء اختيار ملف JSON أو CSV فقط.',
                icon: 'error',
                confirmButtonColor: '#3F2A56'
            });
        }
    }
}
        // دالة إنشاء رمز QR
        function generateQRCode() {
            try {
                const searchQuery = document.getElementById('searchInput').value.toLowerCase();
                const filteredNotaries = notaries.filter(notary =>
                    notary.name.toLowerCase().includes(searchQuery) ||
                    notary.idNumber.toString().includes(searchQuery) ||
                    notary.phone.toString().includes(searchQuery) ||
                    notary.date.toLowerCase().includes(searchQuery) ||
                    (notary.note || '').toLowerCase().includes(searchQuery)
                );

                if (filteredNotaries.length === 0) {
                    Swal.fire({
                        title: 'لا توجد بيانات',
                        text: 'لا توجد بيانات موثقين لإنشاء رمز QR بناءً على البحث الحالي.',
                        icon: 'warning',
                        confirmButtonColor: '#3F2A56'
                    });
                    return;
                }

                // تحويل البيانات إلى JSON وضغطها
                const qrData = JSON.stringify(filteredNotaries);
                console.log('حجم البيانات الأصلية:', qrData.length, 'بايت');

                // ضغط البيانات باستخدام pako
                const compressedData = pako.deflate(qrData, { to: 'string' });
                const encodedData = btoa(compressedData); // تحويل إلى base64
                console.log('حجم البيانات المضغوطة:', encodedData.length, 'بايت');

                // فحص حجم البيانات
                if (encodedData.length > 2953) { // الحد الأقصى لرمز QR (الإصدار 40)
                    Swal.fire({
                        title: 'البيانات كبيرة جدًا',
                        text: 'البيانات المختارة كبيرة جدًا لإنشاء رمز QR. جرب تقليل عدد الموثقين أو إزالة استعلام البحث.',
                        icon: 'warning',
                        confirmButtonColor: '#3F2A56'
                    });
                    return;
                }

                // إنشاء قماش مؤقت
                const tempCanvas = document.createElement('canvas');
                tempCanvas.id = 'tempQRCanvas';
                tempCanvas.style.display = 'none';
                document.body.appendChild(tempCanvas);

                // إنشاء رمز QR
                const qr = new QRCode(tempCanvas, {
                    text: encodedData,
                    width: 300,
                    height: 300,
                    colorDark: '#3F2A56',
                    colorLight: '#ffffff',
                    correctLevel: QRCode.CorrectLevel.H
                });

                // الانتظار للتأكد من اكتمال إنشاء رمز QR
                setTimeout(() => {
                    Swal.fire({
                        title: 'رمز QR للمعاملات',
                        html: `
                            <div style="text-align: center;">
                                <canvas id="qrDisplayCanvas" style="margin: 20px auto;"></canvas>
                                <div>
                                    <button class="btn btn-secondary" onclick="Swal.close()">إغلاق</button>
                                    <button class="btn" onclick="exportQRAsImage()">تصدير كصورة</button>
                                </div>
                            </div>
                        `,
                        showConfirmButton: false,
                        didOpen: () => {
                            try {
                                const qrDisplayCanvas = document.getElementById('qrDisplayCanvas');
                                qrDisplayCanvas.width = 300;
                                qrDisplayCanvas.height = 300;
                                const ctx = qrDisplayCanvas.getContext('2d');
                                ctx.drawImage(tempCanvas, 0, 0);
                                console.log('تم عرض رمز QR في النافذة المنبثقة');
                            } catch (error) {
                                console.error('خطأ أثناء عرض رمز QR:', error);
                                Swal.fire({
                                    title: 'خطأ',
                                    text: 'فشل عرض رمز QR. تحقق من وحدة التحكم للحصول على التفاصيل.',
                                    icon: 'error',
                                    confirmButtonColor: '#3F2A56'
                                });
                            }
                        },
                        willClose: () => {
                            tempCanvas.remove();
                        },
                        customClass: {
                            popup: 'swal2-rtl'
                        }
                    });
                }, 100);

            } catch (error) {
                console.error('خطأ في إنشاء رمز QR:', error);
                Swal.fire({
                    title: 'خطأ',
                    text: 'حدث خطأ أثناء إنشاء رمز QR. تحقق من وحدة التحكم للحصول على التفاصيل.',
                    icon: 'error',
                    confirmButtonColor: '#3F2A56'
                });
            }
        }

        // دالة تصدير رمز QR كصورة
        function exportQRAsImage() {
            try {
                const qrCanvas = document.getElementById('qrDisplayCanvas');
                if (!qrCanvas || qrCanvas.width === 0) {
                    Swal.fire({
                        title: 'خطأ',
                        text: 'لا يمكن تصدير رمز QR. القماش غير متوفر.',
                        icon: 'error',
                        confirmButtonColor: '#3F2A56'
                    });
                    return;
                }
                const dataURL = qrCanvas.toDataURL('image/png');
                const a = document.createElement('a');
                a.href = dataURL;
                a.download = 'notaries_qr.png';
                a.click();
                console.log('تم تصدير رمز QR كصورة');
            } catch (error) {
                console.error('خطأ أثناء تصدير رمز QR:', error);
                Swal.fire({
                    title: 'خطأ',
                    text: 'فشل تصدير رمز QR. تحقق من وحدة التحكم للحصول على التفاصيل.',
                    icon: 'error',
                    confirmButtonColor: '#3F2A56'
                });
            }
        }

        // دالة بدء مسح رمز QR
        function scanQRCode() {
            Swal.fire({
                title: 'مسح رمز QR',
                html: `
                    <div style="text-align: center;">
                        <video id="qrVideo" style="width: 100%; max-width: 400px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.2);"></video>
                        <div style="margin-top: 20px;">
                            <button class="btn btn-secondary" onclick="stopQRScanner(); Swal.close()">إيقاف المسح</button>
                            <button class="btn" onclick="document.getElementById('importQRImage').click()">استيراد من صورة</button>
                        </div>
                    </div>
                `,
                showConfirmButton: false,
                didOpen: () => {
                    startQRScanner();
                },
                willClose: () => {
                    stopQRScanner();
                },
                customClass: {
                    popup: 'swal2-rtl'
                }
            });
        }

        // دالة بدء الكاميرا لمسح رمز QR
        let videoStream = null;
        async function startQRScanner() {
            try {
                const video = document.getElementById('qrVideo');
                videoStream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: 'environment' }
                });
                video.srcObject = videoStream;
                video.play();

                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');

                function scanFrame() {
                    if (!video.videoWidth) {
                        requestAnimationFrame(scanFrame);
                        return;
                    }
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                    const code = jsQR(imageData.data, imageData.width, imageData.height);
                    if (code) {
                        processQRData(code.data);
                        stopQRScanner();
                        Swal.close();
                    } else {
                        requestAnimationFrame(scanFrame);
                    }
                }
                scanFrame();
            } catch (error) {
                console.error('خطأ في بدء الكاميرا:', error);
                Swal.fire({
                    title: 'خطأ',
                    text: 'تعذر الوصول إلى الكاميرا. تحقق من الأذونات أو المعدات.',
                    icon: 'error',
                    confirmButtonColor: '#3F2A56'
                });
                Swal.close();
            }
        }

        // دالة إيقاف الكاميرا
        function stopQRScanner() {
            if (videoStream) {
                videoStream.getTracks().forEach(track => track.stop());
                videoStream = null;
            }
        }

        // دالة معالجة بيانات رمز QR
        async function processQRData(data) {
            try {
                // فك ترميز base64 وفك الضغط
                const compressedData = atob(data);
                const decompressedData = pako.inflate(compressedData, { to: 'string' });
                const newNotaries = JSON.parse(decompressedData);

                if (!Array.isArray(newNotaries)) {
                    throw new Error('البيانات ليست قائمة موثقين صالحة.');
                }

                const valid = newNotaries.every(n => 
                    n.name && n.idNumber && n.phone && n.date
                );
                if (!valid) {
                    throw new Error('البيانات تحتوي على موثقين غير صالحين.');
                }

                const duplicates = newNotaries.filter(n => checkDuplicate(n.idNumber, n.phone));
                if (duplicates.length > 0) {
                    const result = await Swal.fire({
                        title: 'تكرار المعلومات',
                        text: 'تم العثور على معلومات مكررة في رمز QR. اختر خيارًا:',
                        icon: 'warning',
                        showCancelButton: true,
                        showDenyButton: true,
                        confirmButtonText: 'الاحتفاظ بالتكرارات',
                        denyButtonText: 'حذف التكرارات',
                        cancelButtonText: 'إلغاء',
                        confirmButtonColor: '#3F2A56',
                        denyButtonColor: '#007bff',
                        cancelButtonColor: '#6c757d'
                    });
                    if (result.isDismissed) return;
                    if (result.isDenied) {
                        newNotaries = newNotaries.filter(n => !checkDuplicate(n.idNumber, n.phone));
                    }
                }

                notaries = [...notaries, ...newNotaries];
                localStorage.setItem('notaries', JSON.stringify(notaries));
                renderTable();

                const successSound = document.getElementById('successSound');
                successSound.play().catch(error => console.warn('فشل تشغيل الصوت:', error));

                Swal.fire({
                    title: 'تم الاستيراد',
                    text: 'تم استيراد الموثقين من رمز QR بنجاح!',
                    icon: 'success',
                    confirmButtonColor: '#3F2A56'
                });
            } catch (error) {
                console.error('خطأ في معالجة بيانات QR:', error);
                Swal.fire({
                    title: 'خطأ',
                    text: 'البيانات في رمز QR غير صالحة أو تالفة.',
                    icon: 'error',
                    confirmButtonColor: '#3F2A56'
                });
            }
        }

        // دالة استيراد رمز QR من صورة
        function importQRFromImage(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    canvas.width = img.width;
                    canvas.height = img.height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0);
                    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                    const code = jsQR(imageData.data, imageData.width, imageData.height);
                    if (code) {
                        processQRData(code.data);
                        Swal.close();
                    } else {
                        Swal.fire({
                            title: 'خطأ',
                            text: 'تعذر العثور على رمز QR في الصورة.',
                            icon: 'error',
                            confirmButtonColor: '#3F2A56'
                        });
                    }
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        window.onload = () => {
            sortNotariesByDate();
            renderTable();
        };
    </script>
</body>
</html>
